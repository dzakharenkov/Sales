# Техническое задание
## Система управления продажами и дистрибуцией (SDS)

**Версия документа:** 1.3  
**Дата:** 2026-02-11  

---

## 1. Общие сведения

### 1.1 Наименование системы
**Система управления продажами и дистрибуцией (SDS)** — веб-приложение для автоматизации учёта товародвижения, взаимоотношений с клиентами, складских операций, логистики и кассовых операций.

### 1.2 Назначение
Система предназначена для:
- учёта товаров и остатков на складах;
- управления клиентами, визитами и заказами;
- документирования складских операций (приход, расход, перемещение, списание);
- ведения кассовых операций (приём наличных, передача от экспедиторов);
- формирования аналитической отчётности.

### 1.3 Разработчик
**Захаренков Дмитрий**
- Email: dima@zakharenkov.ru
- Сайт: https://zakharenkov.ru
- Telegram: @dmitry_zakharenkov
- LinkedIn: linkedin.com/in/dmity-zakharenkov

---

## 2. Справочник полей операций

Все операции в системе используют единый набор полей (таблица `operations`). Ниже — описание каждого поля.

| Поле | Тип | Описание |
|------|-----|----------|
| **operation_number** | Строка | Уникальный номер операции (генерируется автоматически, например OP-2026-02-000001). Только для чтения. |
| **type_code** | Строка | Код типа операции (warehouse_receipt, delivery и т.д.). Только для чтения. |
| **status** | Строка | Статус операции: pending, completed и др. Определяется default_status типа. |
| **operation_date** | Дата/время | Дата и время операции. Автоматически — текущее. Только для чтения. |
| **warehouse_from** | Строка | Склад-источник (код из справочника складов). Для прихода — пусто. |
| **warehouse_to** | Строка | Склад-назначение. Для расхода — пусто. |
| **product_code** | Строка | Код товара из справочника товаров. |
| **batch_code** | Строка | Код партии (например, 11_09022026). Обычно формируется как {product_code}_{DDMMYYYY} по сроку годности. |
| **batch_id** | UUID | Ссылка на запись в таблице партий. Заполняется автоматически по batch_code и product_code. |
| **quantity** | Целое | Количество единиц товара. Должно быть > 0. |
| **amount** | Число | Сумма в денежных единицах (для оплат, доставок). |
| **payment_type_code** | Строка | Тип оплаты: cash_sum (наличные), bank_sum (безналичные), card_sum (карта). |
| **customer_id** | Целое | ID клиента из справочника клиентов. |
| **order_id** | Целое | Номер заказа (order_no). |
| **expeditor_login** | Строка | Логин экспедитора (пользователь с ролью expeditor). |
| **cashier_login** | Строка | Логин кассира (пользователь с ролью paymaster). |
| **storekeeper_login** | Строка | Логин кладовщика. |
| **related_operation_id** | UUID | Ссылка на другую операцию (например, связь приёма наличных с передачей от экспедитора). |
| **created_by** | Строка | Логин пользователя, создавшего операцию. Заполняется автоматически. |
| **comment** | Текст | Комментарий к операции. |

### 2.4 Права доступа на создание операций

| Тип операции | Роли, которые могут создавать |
|--------------|------------------------------|
| **warehouse_receipt** | Администратор, кладовщик (stockman) |
| **allocation** | Администратор, кладовщик (stockman) |
| **transfer** | Администратор, кладовщик (stockman) |
| **delivery** | Администратор, экспедитор (expeditor) |
| **promotional_sample** | Администратор, кладовщик (stockman), экспедитор (expeditor) |
| **write_off** | Администратор, кладовщик (stockman) |
| **payment_receipt_from_customer** | Администратор, экспедитор (expeditor) |
| **cash_handover_from_expeditor** | Создаётся системой автоматически (при создании payment_receipt_from_customer) |
| **cash_receipt** | Администратор, кассир (paymaster) — приём от экспедитора (кнопка «Принять») и ручное создание безналичного платежа |

**Примечание:** Администратор (admin) имеет право создавать любую операцию. Остальные роли — только операции, указанные в таблице.

---

## 3. Операции в системе — полное описание

**Правило:** В ТЗ описываются только **активные** операции (active=true в operation_config). Операции, помеченные как неактивные в справочнике «Типы операций», в документ не включаются.

---

### 3.1 warehouse_receipt — Приход на склад

**Назначение:** Поступление товара от производителя (поставщика) на склад.

**Кто выполняет:** Кладовщик, администратор.

**Статус по умолчанию:** completed.

**Форма создания:** Пакетная — можно добавить несколько товаров за один запрос. Для каждой позиции: товар, срок годности, количество, код партии (автогенерация по товару и дате).

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_to | Склад поступления. |
| product_code | Код товара. |
| quantity | Количество единиц. |
| expiry_date | Срок годности (формат дд.мм.гггг или ГГГГ-ММ-ДД). |
| created_by | Автоматически — текущий пользователь. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
warehouse_from, customer_id, amount, payment_type_code, expeditor_login, cashier_login, order_id, related_operation_id, batch_code (генерируется автоматически).

---

### 3.2 allocation — Выдача экспедитору

**Назначение:** Выдача товара экспедитору со склада на его витрину.

**Кто выполняет:** Кладовщик, администратор.

**Статус по умолчанию:** completed.

**Особенности интерфейса:** При выборе «Склад от» загружаются доступные позиции по остаткам. При выборе экспедитора автоматически подставляется «Склад в» (склад, привязанный к экспедитору). Таблица: товар, партия, срок годности, дни до истечения, доступно, количество, вес, цена, сумма.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Склад-источник. |
| warehouse_to | Склад назначения (витрина экспедитора). |
| product_code | Код товара. |
| batch_code | Код партии. |
| quantity | Количество. |
| expeditor_login | Логин экспедитора. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
customer_id, amount, payment_type_code, cashier_login, order_id, related_operation_id.

---

### 3.3 transfer — Перемещение между складами

**Назначение:** Перемещение товара с одного склада на другой.

**Кто выполняет:** Кладовщик, администратор.

**Статус по умолчанию:** completed.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Склад-источник. |
| warehouse_to | Склад назначения. |
| product_code | Код товара. |
| batch_code | Код партии. |
| quantity | Количество. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
customer_id, amount, payment_type_code, expeditor_login, cashier_login, order_id, related_operation_id.

---

### 3.4 delivery — Доставка клиенту

**Назначение:** Экспедитор передаёт товар клиенту. Отражает факт доставки.

**Кто выполняет:** Экспедитор, администратор.

**Статус по умолчанию:** pending.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Склад, с которого отгружен товар. |
| product_code | Код товара. |
| batch_code | Код партии. |
| quantity | Количество. |
| customer_id | ID клиента. |
| amount | Сумма доставки/оплаты. |
| payment_type_code | Тип оплаты (наличные, карта и т.д.). |
| expeditor_login | Логин экспедитора. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| order_id | Номер заказа. |
| comment | Комментарий. |

#### Скрытые поля
cashier_login, related_operation_id.

---

### 3.5 promotional_sample — Раздача образцов

**Назначение:** Раздача товара в качестве образца (без оплаты) на склад экспедитора.

**Кто выполняет:** Кладовщик, экспедитор, администратор.

**Статус по умолчанию:** completed.

**Особенности интерфейса:** При выборе «Склад от» и «Экспедитор» подтягиваются остатки по партиям (сортировка от просрочки к нормальным). Таблица с колонкой «Количество образцов» — пользователь вводит количество по каждой строке. «Склад в» подставляется по экспедитору.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Склад-источник. |
| warehouse_to | Склад экспедитора (подставляется по экспедитору). |
| product_code | Код товара. |
| batch_code | Код партии. |
| quantity | Количество образцов. |
| expeditor_login | Логин экспедитора. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
customer_id, amount, payment_type_code, cashier_login, order_id, related_operation_id.

---

### 3.6 write_off — Списание

**Назначение:** Списание товара (порча, брак, истечение срока годности).

**Кто выполняет:** Кладовщик, администратор.

**Статус по умолчанию:** completed.

**Особенности интерфейса:** При выборе «Склад от» загружаются просроченные партии (сортировка: чёрный → красный → жёлтый → зелёный). Таблица с колонкой «Количество к списанию» — пользователь вводит количество по каждой строке и сохраняет (создаётся несколько операций — по одной на строку с количеством > 0).

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Склад, с которого списывается товар. |
| product_code | Код товара. |
| batch_code | Код партии. |
| quantity | Количество к списанию. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
warehouse_to, customer_id, amount, payment_type_code, expeditor_login, cashier_login, order_id, related_operation_id.

---

### 3.7 payment_receipt_from_customer — Получение оплаты от клиента

**Назначение:** Клиент отдал наличные/карту экспедитору при доставке. Отражает факт получения денег экспедитором.

**Кто выполняет:** Экспедитор.

**Статус по умолчанию:** completed.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| customer_id | ID клиента. |
| order_id | Номер заказа. |
| amount | Сумма полученной оплаты. |
| payment_type_code | Тип оплаты (например, cash_sum — наличные). |
| expeditor_login | Логин экспедитора, принявшего оплату. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий. |

#### Скрытые поля
warehouse_from, warehouse_to, product_code, batch_id, quantity, cashier_login, related_operation_id.

---

### 3.8 cash_handover_from_expeditor — Передача наличных от экспедитора

**Назначение:** Экспедитор передаёт накопленные наличные при возврате на склад. Ожидает приёма кассиром.

**Кто выполняет:** Экспедитор.

**Статус по умолчанию:** pending.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| warehouse_from | Витрина экспедитора (склад, с которого передаются деньги). |
| warehouse_to | Основной склад/касса. |
| amount | Сумма передаваемых наличных. |
| expeditor_login | Логин экспедитора. |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| comment | Комментарий (например, список номеров платежей). |

#### Скрытые поля
product_code, batch_id, quantity, customer_id, payment_type_code, cashier_login, order_id, related_operation_id.

---

### 3.9 cash_receipt — Приём денег в кассу

**Назначение:** Кассир подтверждает приём денег (наличных или безналичных): от экспедитора — через операцию cash_handover_from_expeditor; от клиента — вручную (банковский перевод и др.) или через раздел «Заказы для подтверждения оплаты» с привязкой к заказу.

**Кто выполняет:** Кассир (paymaster).

**Статус по умолчанию:** completed.

**Особенности интерфейса:** Выпадающий список «Ожидающие передачи» — выбор операции cash_handover со статусом pending. При выборе автоматически подставляется сумма. Обязательно указать связанную операцию (related_operation_id) при приёме от экспедитора. Для безналичных переводов — создаётся вручную без related_operation_id.

#### Поля операции (обязательные)
| Поле | Описание |
|------|----------|
| amount | Сумма принятых наличных. |
| payment_type_code | Тип оплаты (cash_sum). |
| cashier_login | Логин кассира. |
| related_operation_id | UUID операции «Передача наличных от экспедитора» (при приёме от экспедитора; при ручном создании — отсутствует). |
| created_by | Автоматически. |

#### Поля (необязательные)
| Поле | Описание |
|------|----------|
| expeditor_login | Логин экспедитора. |
| customer_id | ID клиента (при ручном создании безналичного платежа). |
| order_id | Номер заказа (при ручном создании). |
| comment | Комментарий. |

#### Скрытые поля
warehouse_from, warehouse_to, product_code, batch_id, quantity.

---

## 3.10 Операции кассы — полное описание (ТЗ)

### Обзор

Система управления кассовыми операциями с поддержкой двух каналов приёма платежей:

- **Наличные** — через экспедиторов (автоматический поток)
- **Банковские переводы и другие безналичные способы** — ручное подтверждение кассиром

### Три типа операций

| # | Тип операции | Создаёт | Статус | Назначение |
|---|--------------|---------|--------|------------|
| 1 | payment_receipt_from_customer | Экспедитор | completed | Приём наличных у клиента при доставке |
| 2 | cash_handover_from_expeditor | Система (автоматически) | pending → completed | Передача наличных на склад (по заказу) |
| 3 | cash_receipt | Кассир (автоматически или вручную) | completed | Приём денег в кассу: от экспедитора (наличные) или от клиента (безналичный перевод) |

### Бизнес-логика потоков

#### Поток НАЛИЧНЫХ (автоматический)

**День 1: Доставка**

- Экспедитор создаёт операцию: `payment_receipt_from_customer` (статус: completed).
- **Сразу после** (автоматически): система создаёт `cash_handover_from_expeditor` (статус: pending, связь с операцией 1 по заказу).

**День N: Приём на складе**

- Кассир переводит `cash_handover_from_expeditor` в статус completed.
- **Автоматически** создаётся `cash_receipt` (статус: completed, тип: наличные, источник: от экспедитора).

#### Поток БЕЗНАЛИЧНЫХ ПЕРЕВОДОВ (ручной)

- Операции 1 и 2 не создаются.
- Кассир вручную создаёт `cash_receipt` (статус: completed, тип: банковский перевод, источник: от клиента, без related_operation_id).
- Либо через раздел **«Заказы для подтверждения оплаты»** — кассир видит заказы с указанным типом оплаты и подтверждает приём денег по каждому заказу (создаётся cash_receipt с order_id и customer_id).

### Ключевые правила

- Экспедитор не накапливает платежи — по каждому заказу отдельная операция 2.
- Автоматизм цепочки наличных: операция 1 → сразу операция 2; операция 2 (completed) → сразу операция 3.
- Кассир вручную создаёт операцию 3 для любого безналичного способа оплаты.
- Разделение ответственности: операция 2 — «экспедитор передал», операция 3 — «кассир принял».

---

## 4. Сводная таблица операций (только активные)

| Код | Название | Статус по умолчанию | Основные обязательные поля |
|-----|----------|---------------------|---------------------------|
| warehouse_receipt | Приход на склад | completed | warehouse_to, product_code, quantity, expiry_date |
| allocation | Выдача экспедитору | completed | warehouse_from, warehouse_to, product_code, batch_code, quantity, expeditor_login |
| transfer | Перемещение | completed | warehouse_from, warehouse_to, product_code, batch_code, quantity |
| delivery | Доставка клиенту | pending | warehouse_from, product_code, batch_code, quantity, customer_id, amount, payment_type_code, expeditor_login |
| promotional_sample | Раздача образцов | completed | warehouse_from, warehouse_to, product_code, batch_code, quantity, expeditor_login |
| write_off | Списание | completed | warehouse_from, product_code, batch_code, quantity |
| payment_receipt_from_customer | Получение оплаты от клиента | completed | customer_id, order_id, amount, payment_type_code, expeditor_login |
| cash_handover_from_expeditor | Передача наличных от экспедитора | pending | warehouse_from, warehouse_to, amount, expeditor_login |
| cash_receipt | Приём денег в кассу | completed | amount, payment_type_code, cashier_login, related_operation_id |

---

## 5. Роли пользователей

| Роль | Описание | Основные возможности |
|------|----------|----------------------|
| **admin** | Администратор | Полный доступ: справочники, пользователи, все операции, отчёты |
| **agent** | Агент по продажам | Клиенты, визиты, заказы, отчёты по клиентам и агентам |
| **expeditor** | Экспедитор | Заказы, доставки, операции выдачи/раздачи, payment_receipt_from_customer |
| **stockman** | Кладовщик | Складские операции (приход, списание, перемещение, выдача), остатки |
| **paymaster** | Кассир | Приём денег от экспедиторов (кнопка «Принять»), ручное создание cash_receipt для безналичных, подтверждение оплаты по заказам, отчёты по кассе |

---

## 6. Справочники и сущности

### 6.1 Клиенты (customers)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Целое | Уникальный идентификатор. |
| name_client | Текст | Наименование клиента. |
| firm_name | Текст | Наименование организации. |
| category_client | Текст | Категория. |
| address | Текст | Адрес. |
| city | Текст | Город. |
| territory | Текст | Территория. |
| landmark | Текст | Ориентир. |
| phone | Текст | Телефон. |
| contact_person | Текст | Контактное лицо. |
| tax_id | Текст | ИНН. |
| status | Текст | Статус (активный и т.д.). |
| login_agent | Строка | Логин агента. |
| login_expeditor | Строка | Логин экспедитора. |
| latitude, longitude | Число | Координаты для карты. |
| pinfl | Текст | ПИНФЛ. |
| contract_no | Текст | Номер договора. |
| account_no | Текст | Расчётный счёт. |
| bank | Текст | Банк. |
| mfo | Текст | МФО. |
| oked | Текст | ОКЭД. |
| vat_code | Текст | ИНН плательщика НДС. |

### 6.2 Заказы (orders)
| Поле | Тип | Описание |
|------|-----|----------|
| order_no | Целое | Номер заказа (PK). |
| customer_id | Целое | ID клиента. |
| order_date | Дата/время | Дата заказа. |
| status_code | Строка | Статус (open, delivery, completed, canceled). |
| total_amount | Число | Сумма заказа. |
| payment_type_code | Строка | Тип оплаты. |
| created_by | Строка | Логин создателя. |
| scheduled_delivery_at | Дата/время | Плановая дата поставки. |
| status_delivery_at | Дата/время | Дата перевода в «Доставка». |
| closed_at | Дата/время | Дата закрытия. |

### 6.3 Позиции заказа (items)
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор. |
| order_id | Целое | Номер заказа. |
| product_code | Строка | Код товара. |
| quantity | Целое | Количество. |
| price | Число | Цена. |

### 6.4 Визиты (customers_visits)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Целое | Уникальный идентификатор. |
| customer_id | Целое | ID клиента. |
| visit_date | Дата | Дата визита. |
| visit_time | Время | Время визита. |
| status | Строка | planned, completed, canceled, postponed. |
| responsible_login | Строка | Логин агента (ответственного). |
| comment | Текст | Комментарий. |

### 6.5 Товары (product)
| Поле | Тип | Описание |
|------|-----|----------|
| code | Строка | Код товара (PK). |
| name | Текст | Наименование. |
| type_id | Строка | Тип продукта. |
| weight_g | Целое | Вес в граммах. |
| unit | Строка | Единица измерения. |
| price | Число | Цена. |
| expiry_days | Целое | Срок годности (дней). |
| currency_code | Строка | Валюта (по умолчанию sum). |
| active | Логический | Активен ли товар. |

### 6.6 Склады (warehouse)
| Поле | Тип | Описание |
|------|-----|----------|
| code | Строка | Код склада (PK). |
| name | Текст | Наименование. |
| type | Текст | Тип склада. |
| storekeeper | Строка | Логин кладовщика. |
| agent | Текст | Агент. |
| expeditor_login | Строка | Логин экспедитора (для витрины). |

### 6.7 Фотографии клиентов (customer_photo)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Целое | Уникальный идентификатор. |
| customer_id | Целое | ID клиента. Фото привязывается только к клиенту. |
| photo_path | Текст | Имя файла на диске (формат: КОД_ДДММГГГГ_ЧЧММСС.ext). |
| original_filename | Текст | Исходное имя файла. |
| file_size | Целое | Размер в байтах. |
| mime_type | Текст | MIME-тип (image/jpeg и т.д.). |
| description | Текст | Описание. |
| download_token | Строка | Уникальный токен для скачивания. |
| is_main | Логический | Основное фото клиента. |
| uploaded_by | Строка | Логин загрузившего. |
| uploaded_at | Дата/время | Дата и время загрузки. |
| photo_datetime | Дата/время | Дата и время съёмки. |

**Хранение:** Папка `photo/` (UPLOAD_DIR в .env, по умолчанию `/var/www/.../photo`). Максимум 10 MB, форматы: JPG, JPEG, PNG, GIF, WEBP. При удалении клиента все его фото удаляются (CASCADE).

---

## 7. Структура меню и модули

### 7.1 Пользователи
- Просмотр списка (логин, ФИО, роль, статус)
- Создание (admin)
- Редактирование ФИО, роли, статуса (admin)
- Установка/смена пароля (admin)

### 7.2 Справочники
- **Типы оплат** — код, название, описание
- **Типы продуктов** — наименование, описание
- **Типы операций** — код, название, описание, активность
- **Валюта** — код, название, страна, символ
- **Склады** — код, название, тип, кладовщик, агент, экспедитор
- **Товары** — код, название, тип, вес, единица, цена, срок годности, валюта

### 7.3 Клиенты
- Поиск (имя, ИНН, агент), автодополнение
- Создание клиента
- Клиенты на карте
- **Фото** — кнопка в карточке клиента: загрузка, просмотр, удаление фото. Имя файла: КОД_ДДММГГГГ_ЧЧММСС.ext. В выгрузке клиентов — колонка «Фото» (Да/Нет)

### 7.4 Визиты

**Кто выполняет:** Агент (agent), экспедитор (expeditor), администратор (admin).

- **Поиск визита** — фильтры: клиент (поиск по названию/ИНН или выбор из списка), статус (Все / Запланированы / Завершён / Отменён), ответственный, дата от/до (русский календарь дд.мм.гггг). Результаты в таблице с кнопкой «Открыть».
- **Создать визит** — выбор клиента, дата и время в одном поле (datetime-local), ответственный (агент/экспедитор из списка), статус из выпадающего списка (по умолчанию «Запланирован»), комментарий. При статусе «Завершён» комментарий обязателен (мин. 10 символов).
- **Календарь визитов** — один календарь на месяц с фильтром по ответственному: «Все визиты», «Мои визиты», либо выбор сотрудника. Клик по дню — список визитов на эту дату.

### 7.5 Заказы
- Поиск заказов
- Создание заказа
- Поиск позиций заказов

### 7.6 Операции
- **Поиск операций** — фильтры: тип, статус, клиент, товар, кто создал, дата с/по (русский календарь дд.мм.гггг)
- Создание операции (выбор типа и заполнение формы)

### 7.7 Остатки
- Просмотр по складам, партиям, срокам годности
- Светофор (зелёный, жёлтый, красный, чёрный)

### 7.8 Отчётность
- **По клиентам** — ФИО агента, ФИО экспедитора, «Визит завершён», кол-во и сумма заказов. Экспорт в Excel.
- **По агентам** — клиенты, визиты, % завершённости визитов и заказов, сумма заказов. Экспорт в Excel.
- **По экспедиторам** — заказы по статусам. Экспорт в Excel.
- **По визитам** — аналитика по датам. Экспорт в Excel.
- **Сводная аналитика** — дашборд, KPI, по категориям продуктов. Экспорт в Excel.
- **Фотографии клиентов** — всего фото, клиентов с фото, без фото; список клиентов без фото; последние загрузки. Экспорт в Excel.
- **Загрузка данных** — во всех отчётах данные загружаются только по нажатию «Показать» или «Фильтр».

### 7.9 Касса
- **Ожидающие передачи от экспедиторов** — список операций cash_handover_from_expeditor со статусом pending, кнопка «Принять» для подтверждения приёма
- **Принятые деньги за период** — операции cash_receipt (завершённые) за выбранный диапазон дат; фильтр «Дата с» и «по»; кнопка «Создать приём (безналичный)» для ручного создания приёма от клиента (банковский перевод и др.)
- **Заказы для подтверждения оплаты** — список заказов с указанным типом оплаты; по каждому заказу кнопка «Подтвердить оплату» для создания операции cash_receipt с привязкой к заказу

---

## 8. Технические требования

### 8.1 Инфраструктура
- **Backend:** FastAPI, SQLAlchemy, asyncpg
- **БД:** PostgreSQL 12+
- **Frontend:** HTML, JavaScript, CSS
- **Авторизация:** JWT, bcrypt

### 8.2 Локализация и календари
- **Русский календарь:** во всех формах с полями даты используется flatpickr с `locale: 'ru'` и `altFormat: 'd.m.Y'` (отображение в формате дд.мм.гггг)
- **Диапазон дат:** там, где нужен период («Принятые деньги за период», «Поиск операций», «Поиск визита»), используются два поля «Дата с» и «по»
- **Часовой пояс:** для интерпретации дат в API (например, cash-received) используется параметр `tz` (по умолчанию Asia/Tashkent)

### 8.3 API кассы (finances)
| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/api/v1/finances/pending-handovers` | GET | Ожидающие передачи от экспедиторов |
| `/api/v1/finances/accept-handover` | POST | Принять передачу (создаёт cash_receipt) |
| `/api/v1/finances/cash-received` | GET | Принятые деньги за период (date_from, date_to, tz) |
| `/api/v1/finances/cash-receipt-manual` | POST | Ручное создание приёма (безналичный) |
| `/api/v1/finances/orders-for-confirmation` | GET | Заказы с типом оплаты для подтверждения кассиром |

### 8.4 API фотографий клиентов (customer-photos)
| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/api/v1/customers/{id}/photos` | POST | Загрузить фото клиента |
| `/api/v1/customers/{id}/photos` | GET | Список фото клиента |
| `/api/v1/photos/{id}` | GET | Информация о фото |
| `/api/v1/photos/download/{token}` | GET | Скачать фото по токену (без авторизации) |
| `/api/v1/photos/{id}` | PUT | Обновить описание или main |
| `/api/v1/photos/{id}` | DELETE | Удалить фото |

---

## 9. История изменений

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.1 | 2026 | Первая полная версия |
| 1.2 | 2026 | Касса: «Принятые наличные за день» → «Принятые деньги за период»; «Заказы для подтверждения оплаты»; русский календарь; часовой пояс Asia/Tashkent |
| 1.3 | 2026-02-11 | Фотографии клиентов: загрузка в папку photo/, именование КОД_ДДММГГГГ_ЧЧММСС.ext; отчёт «Фотографии клиентов»; колонка «Фото» в выгрузке клиентов; отчёты загружаются по нажатию «Показать»; Excel-экспорт для всех отчётов |


