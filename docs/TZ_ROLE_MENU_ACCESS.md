# ТЗ: Динамическое меню по ролям (role_menu_access)

## Бизнес-требования

| access_level | Видно в меню? | Функционал |
|--------------|----------------|------------|
| none         | Нет            | Пункт скрыт полностью |
| view         | Да             | Только чтение (кнопки Edit/Delete/Create скрыты) |
| full         | Да             | Полный доступ |

- При загрузке приложения запрашивается список разрешённых пунктов меню для текущего пользователя (`GET /api/v1/menu`).
- В боковой панели отображаются только пункты с `access_level != 'none'`.
- При попытке открыть недоступный раздел — редирект на «Доступ запрещён» (Access Denied).
- На странице при `access_level === 'view'` скрываются кнопки создания/редактирования/удаления.

## SQL

- Таблицы: `"Sales".menu_items`, `"Sales".role_menu_access`.
- Миграция: `migrations/role_menu_access.sql`.
- После деплоя выполнить скрипт на сервере БД.

## API

| Метод | Путь | Описание |
|-------|------|----------|
| GET   | `/api/v1/menu` | Меню для текущего пользователя (по JWT). Только пункты с `access_level != 'none'`. |
| GET   | `/api/v1/admin/roles/{role}/menu-access` | Матрица прав по роли (только admin). Все пункты меню и их access_level. |
| POST  | `/api/v1/admin/roles/{role}/menu-access` | Сохранить права для роли (только admin). Body: `{ "menu_access": [ { "menu_item_id": 1, "access_level": "none" }, ... ] }`. |

## Фронтенд

- При старте: `loadMe()` → `loadMenu()` (GET /menu) → `renderSidebar(menu)` → `showSection(first)`.
- При клике по пункту: `showSection(name)` проверяет `menuByCode[code]`; если `none` — экран «Доступ запрещён»; иначе выставляется `currentSectionAccess` и вызывается `applyViewOnlyAccess()` при `view`.
- Админ: на странице «Пользователи» кнопка «Права доступа к меню» → выбор роли, таблица с радиокнопками (Скрыто / Просмотр / Полный), кнопка «Сохранить».

## Роли и начальные права

- **admin** — full на все пункты.
- **agent** — full: Клиенты, Визиты, Заказы; view: Отчётность; остальное none.
- **expeditor** — full: Визиты, Заказы, Операции; view: Клиенты, Остатки, Касса, Отчётность; остальное none.
- **stockman** — full: Операции, Остатки, Отчётность; view: Клиенты, Заказы; остальное none.
- **paymaster** — full: Операции, Касса; view: Отчётность; остальное none.

## Проверка

1. Войти как agent — в меню только: Клиенты, Визиты, Заказы, Отчётность.
2. Открыть «Отчётность» — кнопки экспорта/действий видны в зависимости от реализации (при view скрываются кнопки изменения).
3. Войти как admin → Пользователи → «Права доступа к меню» → выбрать agent → изменить «Операции» на «Полный» → Сохранить.
4. Перезагрузить страницу под agent — в меню должен появиться пункт «Операции».
