# Отчёт об исправлениях от 2026-02-09

## Исправление #1: Загрузка фотографии клиента
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `migrations/add_photo_datetime.sql`, `deploy_to_ubuntu.bat`
- **Строки кода**: deploy_to_ubuntu.bat строка 28; миграция — полный файл
- **Что было**: Ошибка `column "photo_datetime" of relation "customer_photo" does not exist`. Миграция существовала, но не копировалась на сервер при деплое.
- **Что стало**: Миграция копируется на сервер при деплое. В БД выполняется `ALTER TABLE "Sales".customer_photo ADD COLUMN IF NOT EXISTS photo_datetime TIMESTAMPTZ;`
- **Проверка**: После деплоя выполнить миграцию на сервере, затем загрузить фото клиента — ошибка не должна появляться.

## Исправление #2: Создание визита — Дата и время
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: ~4145 (поле даты/времени с flatpickr enableTime)
- **Что было**: Требовалось единое поле даты и времени.
- **Что стало**: Одно поле с flatpickr, формат 'd.m.Y H:i'.
- **Проверка**: Создать визит — поле «Дата и время визита» с календарём и временем.

## Исправление #3: Создание визита — Ширина комментария
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: форма создания визита (textarea width:100%)
- **Что было**: Комментарий мог быть узким.
- **Что стало**: Textarea на всю ширину контейнера.
- **Проверка**: Создать визит — комментарий на всю ширину.

## Исправление #4: Создание визита — Выравнивание кнопок
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: форма создания визита (text-align:center для кнопок)
- **Что было**: Кнопки без выравнивания.
- **Что стало**: Кнопки по центру.
- **Проверка**: Создать визит — кнопки по центру.

## Исправление #5: Поиск визитов — Дата и время в одно поле
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 4027, 4034–4036 (таблица результатов поиска визитов)
- **Что было**: Отдельные колонки «Дата» и «Время».
- **Что стало**: Одна колонка «Дата и время».
- **Проверка**: Поиск визитов → Найти — в таблице одна колонка даты и времени.

## Исправление #6: Поиск визитов — Ширина комментария и выравнивание кнопок
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 71 (.modal-actions), 4003 (карточка визита)
- **Что было**: Кнопки модалок не по центру.
- **Что стало**: justify-content: center у .modal-actions.
- **Проверка**: Открыть визит из поиска — кнопки по центру.

## Исправление #7: Открыть визит — Выравнивание кнопок
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 4003 (dtCombined, кнопка «Изменить»)
- **Что было**: Дата и время раздельно, кнопка не по центру.
- **Что стало**: Одно поле «Дата и время», кнопка по центру.
- **Проверка**: Поиск визитов → Открыть — одно поле даты/времени, кнопка по центру.

## Исправление #8: Изменить визит — Все элементы
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 4117–4134 (форма редактирования визита, flatpickr)
- **Что было**: Раздельные поля даты и времени.
- **Что стало**: Поле ve_datetime с flatpickr enableTime, комментарий на всю ширину, кнопки по центру.
- **Проверка**: Открыть визит → Изменить — одно поле даты/времени, комментарий на всю ширину.

## Исправление #9: Фильтр агентов при создании визита
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 4150–4153 (фильтр по роли)
- **Что было**: В списке «Агент (ответственный)》 были агенты и экспедиторы.
- **Что стало**: Только роль agent: `return r === 'agent';`
- **Проверка**: Создать визит — в списке только агенты.

## Исправление #10: API ключ Яндекс.Карт
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `.env.example`, `src/api/v1/routers/auth.py`
- **Строки кода**: auth.py ~74 (GET /api/v1/config), .env.example
- **Что было**: Ключ карт не отдавался фронту.
- **Что стало**: Ключ в .env.example; бэкенд возвращает yandexMapsApiKey в config.
- **Проверка**: Настроить YANDEX_MAPS_API_KEY в .env, открыть «Клиенты на карте» — карта отображается.

## Исправление #11: Статус Доставка — Сохранение даты
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/orders.py`
- **Строки кода**: 645–652
- **Что было**: status_delivery_at не всегда проставлялся при статусе «Доставка».
- **Что стало**: При status_code "2"/"delivery"/"доставка" выставляется order.status_delivery_at = now.
- **Проверка**: Перевести заказ в «Доставка» — в карточке заполняется «Перевод в статус «Доставка»».

## Исправление #12: Выделение просроченных доставок красным
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 1331–1345 (formatScheduledDelivery), 1390, 1778–1792 (formatScheduledDeliveryOi), 1872
- **Что было**: Просроченные даты поставки не выделялись.
- **Что стало**: formatScheduledDelivery/formatScheduledDeliveryOi — просроченная дата красным с подсказкой «Просрочена».
- **Проверка**: В списке заказов/позиций заказ с просроченной поставкой — дата красная.

## Исправление #13: Поиск позиций заказа — Кнопка открытия
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 1866 (колонка «Заказ», кнопка), 1875–1880 (data-order-open), 1546–1565 (_openOrderNo)
- **Что было**: Не было перехода от позиции к заказу.
- **Что стало**: Колонка «Заказ» с кнопкой; по нажатию — переход в раздел заказов и открытие формы заказа.
- **Проверка**: Позиции заказов → в строке нажать кнопку в колонке «Заказ» — открывается заказ.

## Исправление #14: Операции — Статусы на русском
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/operations.py`, `src/static/app.html`
- **Строки кода**: operations.py 169–179, 341–353; app.html ~2044
- **Что было**: Статусы на английском (pending, completed, cancelled).
- **Что стало**: API отдаёт status_name_ru; в таблице вывод «В ожидании»/«Выполнено»/«Отменено».
- **Проверка**: Операции → Найти — колонка «Статус» на русском.

## Исправление #15: Выдача экспедитору — Автоматический расчёт суммы
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/operations_flow.py`
- **Строки кода**: 49–60 (DeliveryDT amount опционально), 358–365, 386–398, 419–421
- **Что было**: amount обязательно, при нуле сумма не подставлялась.
- **Что стало**: amount опционально; при отсутствии/нуле считается price × quantity.
- **Проверка**: Создать выдачу без amount — в ответе и БД сумма = цена × количество.

## Исправление #16: Списание товара — Подтягивание остатков по складам
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`, `src/api/v1/routers/warehouse.py`, `src/api/v1/routers/operations_flow.py`
- **Строки кода**: app.html 2693–2838 (buildWriteOffForm: склад, loadStock, renderWriteOffTable — колонки Товар, Партия, Срок годности, Дней осталось, Доступно, Количество к списанию, Вес, Цена, Сумма; сохранение через POST /operations/write_off); warehouse.py 59–68, 141–147 (weight_g в ответе остатков); operations_flow.py 62–69 (WriteOffDT), 450–523 (post_write_off)
- **Что было**: При выборе склада не подтягивались товары с партиями, сроками годности и доступными количествами.
- **Что стало**: При выборе склада вызывается GET /api/v1/warehouse/stock?warehouse=…; таблица заполняется остатками с колонками Товар, Партия, Срок годности, Дней осталось, Доступно, Количество к списанию, Вес, Цена, Сумма; сохранение — по одной операции write_off на позицию.
- **Проверка**: Операции → Создать → Списание → выбрать склад — таблица заполняется остатками; ввести количество, сохранить — операции списания создаются.

## Исправление #17: Перемещение между складами — Реализация операции
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/operations_flow.py`, `src/static/app.html`
- **Строки кода**: operations_flow.py 71–80 (TransferDT), 536–611 (post_transfer); app.html 3268–3271 (ветка config.operation_type === 'transfer'), 2839–2982 (buildTransferForm: склад от, склад в, loadStock по складу от, таблица с теми же колонками, сохранение через POST /operations/transfer)
- **Что было**: Операция перемещения между складами не была реализована.
- **Что стало**: Добавлены TransferDT и POST /operations/transfer; форма «Перемещение между складами» с выбором склада от/в, подтягиванием остатков со склада «от», таблицей по партиям и сохранением нескольких операций transfer.
- **Проверка**: Операции → Создать → Перемещение между складами → выбрать склад от и склад в (разные) — таблица заполняется; ввести количества, сохранить — операции перемещения создаются.

## Исправление #18: Раздача образцов — Реализация операции
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: 3272–3275 (ветка config.operation_type === 'promotional_sample'), 2983–3138 (buildPromotionalSampleForm: Экспедитор, Склад в автозаполнение по экспедитору, Склад от, loadStock с сортировкой по days_until_expiry по возрастанию, таблица с колонкой «Количество образцов», сохранение через POST /operations/allocation)
- **Что было**: Операция раздачи образцов не была реализована.
- **Что стало**: Форма «Раздача образцов»: выбор экспедитора → «Склад в» подставляется по экспедитору; выбор «Склад от» → остатки подгружаются и сортируются от просроченных к нормальным; таблица с полем «Количество образцов»; сохранение через существующий API allocation.
- **Проверка**: Операции → Создать → Раздача образцов → выбрать экспедитора (склад в заполняется) → склад от → ввести количество образцов по строкам → сохранить — операции allocation создаются.

## Исправление #19: Касса — Принятые деньги за период
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: при открытии раздела кассы — вызов loadReceived() при загрузке блока «Принятые деньги за период»
- **Что было**: Принятые деньги не отображались в блоке (данные не подгружались).
- **Что стало**: При открытии раздела вызывается loadReceived() — запрос к GET /api/v1/finances/cash-received; таблица и выгрузка в Excel доступны.
- **Проверка**: Касса → Принятые деньги за период — таблица заполняется; кнопка выгрузки в Excel скачивает файл.

## Исправление #20: Создание операции приёма платежа — Порядок полей
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`, `src/api/v1/routers/customers.py`
- **Строки кода**: app.html — buildFormFromConfig: при payment_receipt_from_customer порядок полей prio = ['customer_id', 'order_id']; поле «Клиент» с поиском по ИНН или р/с (placeholder «ИНН или р/с»), «Заказ №» с кнопкой «Выбрать заказ» и неоплаченными заказами по клиенту; при выборе заказа сумма и тип оплаты подтягиваются из заказа (amount, payment_type_code). customers.py — поиск по search по name_client, tax_id, account_no.
- **Что было**: Порядок полей неправильный; сумма и тип оплаты не подтягивались из заказа.
- **Что стало**: «Клиент» первым (поиск по ИНН или р/с), «Заказ №» вторым (неоплаченные по клиенту); сумма и тип оплаты из заказа автоматически.
- **Проверка**: Операции → Создать → Приём платежа от клиента — Клиент (ИНН/р/с) → Найти → Выбрать заказ → сумма и тип оплаты подставляются.

## Исправление #21: Касса — Заказы для подтверждения оплаты
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/finances.py`, `src/static/app.html`
- **Строки кода**: finances.py — параметры scheduled_delivery_from, scheduled_delivery_to в get_orders_for_cashier_confirmation и export; app.html — поля «Дата поставки с» и «Дата поставки по» с flatpickr (ru), передача в loadCashierOrders и export
- **Что было**: Не было фильтра по дате поставки.
- **Что стало**: Добавлены календарные поля «Дата поставки с» и «Дата поставки по» с русским календарём; API фильтрует по scheduled_delivery_at.
- **Проверка**: Касса → Заказы для подтверждения оплаты — задать даты поставки → Показать — список отфильтрован; выгрузка в Excel с теми же фильтрами.

## Исправление #22: Отчётность по клиентам — Замена поля
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`, `src/api/v1/routers/reports.py`
- **Строки кода**: app.html — loadSectionReportCustomers (колонки total_visits, completed_visits); reports.py — customers/export (заголовки и данные Excel)
- **Что было**: Отображалось одно поле «визит завершен».
- **Что стало**: Две колонки: «Кол-во визитов агентом» и «Кол-во завершённых визитов агентом»; экспорт в Excel обновлён.
- **Проверка**: Отчётность → По клиентам → Показать — две колонки с числами; экспорт — те же колонки.

## Исправление #23: Отчётность сводная аналитика — Переименования и фильтры
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/static/app.html`
- **Строки кода**: loadSectionReportDashboard — подписи «Дата поставки заказа с» и «Дата поставки заказа по»; «Категория» с опцией «Все» и наименованиями категорий (CATEGORY_LABELS: Творог, Йогурт и т.д.); фильтры «Город» и «Территория» (rd_city, rd_territory) с плейсхолдерами; кнопка «Применить» (rd_load); API reports/dashboard принимает city, territory
- **Что было**: Неправильные названия полей дат, кнопка «Фильтр», категория без наименований.
- **Что стало**: Подписи «Дата поставки заказа с/по», категория с наименованиями и «Все», фильтры Город и Территория, кнопка «Применить».
- **Проверка**: Сводная аналитика — поля дат, категория «Все» + названия, фильтры Город/Территория, кнопка Применить.

## Исправление #24: Отчётность сводная аналитика — Удаление и добавление блоков
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/reports.py`, `src/static/app.html`
- **Строки кода**: reports.py — из report_dashboard удалены запросы и возврат по визитам (q_visits, q_photos, visits_by_day, kpi, inactive_customers); оставлены by_category, by_territory; dashboard/export — лист «По территориям» (Город, Территория, Количество клиентов, Количество заказов, Сумма); app.html — блок rd_territory_wrap с таблицей и кнопкой «Выгрузить в Excel»
- **Что было**: Блок статистики визитов; не было таблицы «По территориям».
- **Что стало**: Блок визитов удалён из ответа и расчёта; таблица «По территориям» с выгрузкой в Excel.
- **Проверка**: Сводная аналитика — нет блока визитов; таблица «По территориям» и кнопка выгрузки в Excel.

## Исправление #25: Отчёт фотографии клиентов — Новые колонки
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/api/v1/routers/reports.py`, `src/static/app.html`
- **Строки кода**: reports.py — report_photos: q3 с полями c.address, c.city, c.territory, c.phone, c.contact_person, c.tax_id в recent_uploads; photos/export — заголовки «Клиент», «Адрес», «Город», «Территория», «Телефон», «Контактное лицо», «ИНН», «Дата загрузки», «Загружено» и заполнение из p.get(); app.html — таблица «Последние загрузки» с колонками Клиент, Адрес, Город, Территория, Телефон, Контактное лицо, ИНН, Дата загрузки, Загружено
- **Что было**: В отчёте не было колонок Адрес, Город, Территория, Телефон, Контактное лицо, ИНН.
- **Что стало**: Отчёт и Excel содержат колонки: Адрес, Город, Территория, Телефон, Контактное лицо, ИНН.
- **Проверка**: Отчёт «Фотографии клиентов» → таблица и экспорт в Excel с указанными колонками.

## Исправление #26: Телеграмм бот — Обработка истёкшей сессии
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/telegram_bot/handlers_auth.py`, `src/telegram_bot/handlers_agent.py`, `src/telegram_bot/handlers_expeditor.py`
- **Строки кода**: handlers_auth — при 401 в cmd_start: delete_session, сообщение «Сессия истекла…», return ConversationHandler.END; handlers_agent — импорт delete_session, во всех except SDSApiError проверка e.status === 401; handlers_expeditor — уже были обработка 401
- **Что было**: При истечении сессии (401) бот не переводил на повторную авторизацию.
- **Что стало**: При 401 вызывается delete_session, отправляется сообщение о истекшей сессии и предложение нажать /start.
- **Проверка**: Инвалидировать сессию — при действии в боте приходит сообщение; после /start — форма авторизации.

## Исправление #27: Телеграмм бот — Ошибка загрузки фото под ролью агента
- **Статус**: ✅ Выполнено (связано с #1)
- **Файл(ы) изменены**: те же, что в #1 — `migrations/add_photo_datetime.sql`, деплой
- **Строки кода**: см. исправление #1
- **Что было**: Ошибка column "photo_datetime" of relation "customer_photo" does not exist.
- **Что стало**: После применения миграции колонка есть; загрузка фото в боте работает.
- **Проверка**: Применить миграцию; в боте загрузить фото — ошибка не появляется.

## Исправление #28: Телеграмм бот — Создание клиента — Доступность всех полей
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/telegram_bot/handlers_agent.py`
- **Строки кода**: _clear_agent_state (добавлены ключи add_cust_address, add_cust_city, add_cust_territory, add_cust_phone, add_cust_contact, add_cust_firm_name, add_cust_account_no, add_cust_editing_field); после ИНН шаг "fields", _show_add_customer_fields_menu; _field_btn, cb_agent_addcust_field, cb_agent_addcust_finish; _handle_add_customer_text (ветка "fields"); _handle_add_customer_location (step "fields"); _handle_add_customer_photo (ветка "fields" + editing_field "photo"); регистрация agent_addcust_field_.+, agent_addcust_finish
- **Что было**: После ввода ИНН поля для заполнения перестают появляться.
- **Что стало**: После ИНН показывается меню полей с галочкой у заполненных (Название, ИНН, Название фирмы, Р/с, Адрес, Город, Территория, Телефон, Контактное лицо, Координаты, Фото); геолокация сохраняется в координаты; кнопка «Завершить заведение клиента» создаёт клиента через API.
- **Проверка**: Ввод названия → ИНН (или Пропустить) → меню полей → поочерёдное заполнение и/или геолокация → «Завершить заведение клиента» → клиент сохраняется.

## Исправление #29: Телеграмм бот — Роль экспедитора — Просмотр заказов
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/telegram_bot/handlers_auth.py`, `src/telegram_bot/handlers_expeditor.py`
- **Строки кода**: handlers_auth — main_menu_keyboard для expeditor: кнопки «Мои заказы на сегодня» (exp_orders_today), «Выполненные сегодня» (exp_orders_done_today); handlers_expeditor — _exp_orders_list_today, cb_exp_orders_today, cb_exp_orders_done_today, регистрация обработчиков
- **Что было**: Экспедитор не видит «Мои заказы на сегодня» и «Выполненные мои заказы сегодня».
- **Что стало**: В меню экспедитора добавлены пункты «Мои заказы на сегодня» и «Выполненные сегодня»; по нажатию показываются списки заказов на сегодня (все и только выполненные).
- **Проверка**: Войти как экспедитор — в меню видны оба пункта; нажатие открывает соответствующие списки заказов.

## Исправление #30: Телеграмм бот — Подтверждение доставки без оплаты
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/telegram_bot/handlers_expeditor.py`
- **Строки кода**: В карточке заказа при status_code "delivery" кнопка «✅ Доставлен» (exp_delivered_{order_no}); обработчик cb_exp_delivered — сообщение без запроса суммы; оплата только через раздел «Получить оплату»
- **Что было**: Экспедитор указывает оплату при подтверждении доставки.
- **Что стало**: Подтверждение доставки только кнопкой «Доставлен», без ввода оплаты; приём оплаты — отдельно в разделе «Получить оплату».
- **Проверка**: Заказ в статусе «Доставка» → нажать «Доставлен» → сообщение без суммы; оплата вносится через «Получить оплату».

## Исправление #31: Телеграмм бот — Операция сдачи наличных в кассу
- **Статус**: ✅ Выполнено
- **Файл(ы) изменены**: `src/telegram_bot/sds_api.py`, `src/telegram_bot/handlers_expeditor.py`
- **Строки кода**: sds_api — create_payment_receipt (POST /api/v1/operations/payment_receipt_from_customer/create); handlers_expeditor — в cb_exp_pay_full и msg_exp_pay_amount после update_order(completed) вызов create_payment_receipt
- **Что было**: При завершении заказа экспедитором не создаётся операция сдачи наличных в кассу.
- **Что стало**: После подтверждения получения оплаты (полная сумма или другая) автоматически создаётся операция приёма платежа от клиента (сдача наличных в кассу).
- **Проверка**: «Получить оплату» → выбрать заказ → «Полная сумма» или ввести другую сумму → заказ завершён и операция сдачи в кассу создаётся.

---

## Статистика
- **Всего исправлений**: 31
- **Выполнено**: 31 (#1–#31)
- **Не выполнено**: 0
