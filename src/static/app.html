<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>СДС — Система управления</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/ru.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
    .layout { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #1a1a2e; color: #eee; padding: 16px 0; flex-shrink: 0; }
    .sidebar h2 { margin: 0 16px 12px; font-size: 14px; color: #888; text-transform: uppercase; }
    .sidebar a { display: block; padding: 10px 20px; color: #ccc; text-decoration: none; }
    .sidebar a:hover, .sidebar a.active { background: #16213e; color: #fff; }
    .sidebar a { cursor: pointer; }
    .sidebar .submenu { display: none; padding-left: 12px; }
    .sidebar .submenu.open { display: block; }
    .sidebar a.parent::after { content: ' \25BE'; font-size: 11px; }
    .sidebar a.parent.open::after { content: ' \25B4'; font-size: 11px; }
    .main { flex: 1; padding: 24px; overflow: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .header h1 { margin: 0; font-size: 20px; }
    .header .user { color: #666; font-size: 14px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #1877f2; color: #fff; }
    .btn-primary:hover { background: #166fe5; }
    .btn-secondary { background: #e0e0e0; color: #333; margin-left: 8px; }
    .btn-secondary:hover { background: #d0d0d0; }
    .btn-small { padding: 4px 10px; font-size: 12px; margin-right: 4px; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; font-size: 13px; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-inner { background: #fff; border-radius: 8px; padding: 24px; max-width: 440px; width: 100%; max-height: 90vh; overflow: auto; }
    .modal h3 { margin: 0 0 16px 0; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    .form-readonly { padding: 8px 0; font-size: 14px; color: #555; }
    .modal-actions { margin-top: 20px; display: flex; gap: 8px; }
    .err { color: #c00; font-size: 13px; margin-top: 8px; }
    .msg { color: #0a0; font-size: 13px; margin-top: 8px; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    #content { min-height: 200px; }
    #opWhReceiptItemsTable td { padding: 8px; }
    #opWhReceiptItemsTable td input, #opWhReceiptItemsTable td select { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
    #opWhReceiptItemsTable td input[readonly] { background: #f0f0f0; cursor: not-allowed; }
    #opWhReceiptItemsTable tfoot tr { border-top: 2px solid #ccc; }
    #opWhReceiptItemsTable .op-wh-receipt-price, #opWhReceiptItemsTable .op-wh-receipt-sum { font-family: monospace; }
    .badge { display: inline-block; }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <h2>Разделы</h2>
      <a href="#" data-section="users">Пользователи</a>
      <a href="#" class="parent" id="refParent" data-section="ref_parent">Справочники</a>
      <div class="submenu" id="refSubmenu">
        <a href="#" data-section="ref_payment">Типы оплат</a>
        <a href="#" data-section="ref_products">Типы продуктов</a>
        <a href="#" data-section="ref_operations">Типы операций</a>
        <a href="#" data-section="warehouses">Склады</a>
        <a href="#" data-section="products">Товары</a>
      </div>
      <a href="#" data-section="customers">Клиенты</a>
      <a href="#" class="parent" id="ordersParent" data-section="orders_parent">Заказы</a>
      <div class="submenu" id="ordersSubmenu">
        <a href="#" data-section="orders">Поиск заказов</a>
        <a href="#" data-section="orders_create">Создать заказ</a>
        <a href="#" data-section="order_items">Поиск позиций заказов</a>
      </div>
      <a href="#" class="parent" id="opsParent" data-section="ops_parent">Операции</a>
      <div class="submenu" id="opsSubmenu">
        <a href="#" data-section="operations">Поиск операций</a>
        <a href="#" data-section="operations_create">Создать операцию</a>
      </div>
      <a href="#" data-section="stock">Остатки</a>
    </nav>
    <div class="main">
      <div class="header">
        <div>
          <h1>СДС — Система управления продажами и дистрибуцией</h1>
          <p class="user">Вы вошли: <strong id="userName">—</strong></p>
        </div>
        <button type="button" class="btn btn-secondary" id="btnLogout">Выйти</button>
      </div>
      <div id="content"></div>
    </div>
  </div>
  <div id="modalContainer"></div>
  <script>
    (function () {
      var token = localStorage.getItem('sds_token');
      if (!token) { window.location.href = '/login'; return; }

      var api = function (path, opts) {
        opts = opts || {};
        var url = path.indexOf('http') === 0 ? path : (window.location.origin + path);
        var headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
        if (opts.headers) for (var k in opts.headers) headers[k] = opts.headers[k];
        return fetch(url, { method: opts.method || 'GET', headers: headers, body: opts.body }).then(function (r) {
          return r.text().then(function (text) {
            var data = null;
            try { data = text ? JSON.parse(text) : null; } catch (_) {}
            if (!r.ok) throw { status: r.status, data: data };
            return data;
          });
        });
      };

      var currentUser = { login: '', fio: '', role: '' };
      var isAdmin = function () { return (currentUser.role || '').toLowerCase() === 'admin'; };

      var loadMe = function () {
        return api('/api/v1/auth/me').then(function (u) {
          currentUser = u || {};
          var el = document.getElementById('userName');
          if (el) el.textContent = (currentUser.fio || currentUser.login || '—') + ' (' + (currentUser.role || '—') + ')';
        }).catch(function () {
          localStorage.removeItem('sds_token');
          window.location.href = '/login';
        });
      };

      var showModal = function (title, bodyHtml, onSave) {
        var wrap = document.getElementById('modalContainer');
        if (!wrap) return;
        var id = 'modal' + Date.now();
        wrap.innerHTML = '<div class="modal show" id="' + id + '"><div class="modal-inner"><h3>' + title + '</h3><div id="' + id + '_body">' + bodyHtml + '</div><div class="modal-actions"><button type="button" class="btn btn-primary" id="' + id + '_save">Сохранить</button><button type="button" class="btn btn-secondary" id="' + id + '_cancel">Отмена</button></div><div id="' + id + '_err" class="err"></div></div></div>';
        var errEl = document.getElementById(id + '_err');
        document.getElementById(id + '_cancel').onclick = function () { document.getElementById(id).classList.remove('show'); };
        document.getElementById(id + '_save').onclick = function () {
          if (errEl) errEl.textContent = '';
          var p = onSave(errEl);
          if (p && p.then) p.then(function () { document.getElementById(id).classList.remove('show'); }).catch(function (e) {
            if (!errEl) return;
            var detail = e && e.data && e.data.detail;
            if (!detail) { errEl.textContent = 'Ошибка соединения или сервера.'; return; }
            if (typeof detail === 'string') { errEl.textContent = detail; return; }
            if (Array.isArray(detail)) {
              var parts = detail.map(function (x) {
                var loc = x.loc && x.loc.slice ? x.loc.slice(-1).join(' ') : '';
                var msg = x.msg || x.message || '';
                if (msg && msg.indexOf('Value error, ') === 0) msg = msg.replace('Value error, ', '');
                return (loc ? loc + ': ' : '') + msg;
              });
              errEl.textContent = parts.join(' ');
            } else { errEl.textContent = typeof detail === 'object' ? JSON.stringify(detail) : String(detail); }
          }); else document.getElementById(id).classList.remove('show');
        };
      };
      function formatDateOnly(isoStr) {
        if (!isoStr) return '';
        try {
          var d = new Date(isoStr);
          return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch (e) { return isoStr; }
      }

      var showSection = function (name) {
        document.querySelectorAll('.sidebar a').forEach(function (a) {
          var s = a.getAttribute('data-section');
          a.classList.toggle('active', s === name);
          if (a.id === 'refParent') a.classList.toggle('open', (name === 'ref_payment' || name === 'ref_products' || name === 'ref_operations' || name === 'warehouses' || name === 'products'));
          if (a.id === 'ordersParent') a.classList.toggle('open', (name === 'orders' || name === 'orders_create' || name === 'order_items'));
          if (a.id === 'opsParent') a.classList.toggle('open', (name === 'operations' || name === 'operations_create'));
        });
        var sub = document.getElementById('refSubmenu');
        if (sub) sub.classList.toggle('open', name === 'ref_payment' || name === 'ref_products' || name === 'ref_operations' || name === 'warehouses' || name === 'products');
        var ordersSub = document.getElementById('ordersSubmenu');
        if (ordersSub) ordersSub.classList.toggle('open', name === 'orders' || name === 'orders_create' || name === 'order_items');
        var opsSub = document.getElementById('opsSubmenu');
        if (opsSub) opsSub.classList.toggle('open', name === 'operations' || name === 'operations_create');
        var content = document.getElementById('content');
        if (!content) return;
        if (name === 'ref_parent' || name === 'ops_parent' || name === 'orders_parent') return;
        // Для пункта меню "Создать операцию" сразу открываем форму без экрана поиска
        if (name === 'operations_create') {
          if (window.openOperationCreate) {
            window.openOperationCreate();
          }
          return;
        }
        // Для пункта меню "Создать заказ" открываем форму создания заказа
        if (name === 'orders_create') {
          // Используем существующую кнопку "Создать заказ" из раздела заказов
          loadSectionOrders();
          setTimeout(function () {
            var btn = document.getElementById('orderAdd');
            if (btn) btn.click();
          }, 0);
          return;
        }
        content.innerHTML = '<div class="card"><p>Загрузка раздела...</p></div>';
        if (name === 'users') loadSectionUsers();
        else if (name === 'products') loadSectionProducts();
        else if (name === 'ref_payment') loadSectionRefPayment();
        else if (name === 'ref_products') loadSectionRefProducts();
        else if (name === 'ref_operations') loadSectionRefOperations();
        else if (name === 'warehouses') loadSectionWarehouses();
        else if (name === 'customers') loadSectionCustomers();
        else if (name === 'orders') loadSectionOrders();
        else if (name === 'order_items') loadSectionOrderItems();
        else if (name === 'operations') loadSectionOperations(false);
        else if (name === 'stock') loadSectionStock();
      };

      function loadSectionUsers() {
        api('/api/v1/users').catch(function (e) { if (e && e.status === 403) return null; throw e; }).then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="sectionAdd">Добавить пользователя</button>' : '';
          var html = '<div class="card"><h2>Пользователи</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          var errDiv = document.getElementById('sectionErr');
          if (list === null || !Array.isArray(list)) { tableDiv.innerHTML = '<p>Доступ только для администратора.</p>'; return; }
          if (!list.length) { tableDiv.innerHTML = '<p>Нет пользователей.</p>'; return; }
          var t = '<table><thead><tr><th>Логин</th><th>ФИО</th><th>Роль</th><th>Статус</th><th>Пароль</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (u) {
            var login = (u.login || '').replace(/"/g, '&quot;');
            var fio = (u.fio || '').replace(/"/g, '&quot;');
            var status = (u.status || '').replace(/"/g, '&quot;');
            var phone = (u.phone || '').replace(/"/g, '&quot;');
            var email = (u.email || '').replace(/"/g, '&quot;');
            t += '<tr><td>' + (u.login || '') + '</td><td>' + (u.fio || '') + '</td><td>' + (u.role || '') + '</td><td>' + (u.status || '') + '</td><td>' + (u.has_password ? 'Да' : 'Нет') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit="' + login + '" data-fio="' + fio + '" data-role="' + (u.role || '') + '" data-status="' + status + '" data-phone="' + phone + '" data-email="' + email + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-pwd="' + (u.login || '') + '">Сменить пароль</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          if (isAdmin()) {
            document.getElementById('sectionAdd').onclick = function () {
              showModal('Добавить пользователя', '<div class="form-group"><label>Логин</label><input type="text" id="mu_login" required placeholder="Латиница или цифры"></div><div class="form-group"><label>ФИО</label><input type="text" id="mu_fio" required placeholder="Фамилия Имя"></div><div class="form-group"><label>Пароль</label><input type="password" id="mu_password" required></div><div class="form-group"><label>Роль</label><select id="mu_role"><option value="agent">agent</option><option value="admin">admin</option><option value="expeditor">expeditor</option><option value="stockman">stockman</option><option value="paymaster">paymaster</option></select></div><div class="form-group"><label>Телефон</label><input type="text" id="mu_phone" placeholder="+998901234567 или 901234567"></div><div class="form-group"><label>Email</label><input type="email" id="mu_email" placeholder="user@example.com"></div><p style="font-size:12px;color:#666;margin-top:4px;">Телефон: цифры, +, пробелы, скобки, дефис. Email: например user@mail.ru</p>', function (errEl) {
                return api('/api/v1/users', { method: 'POST', body: JSON.stringify({ login: document.getElementById('mu_login').value.trim(), fio: document.getElementById('mu_fio').value.trim(), password: document.getElementById('mu_password').value, role: document.getElementById('mu_role').value, phone: document.getElementById('mu_phone').value.trim() || null, email: document.getElementById('mu_email').value.trim() || null }) }).then(function () { loadSectionUsers(); });
              });
            };
          }
          tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              var login = el.getAttribute('data-edit').replace(/&quot;/g, '"');
              var fio = (el.getAttribute('data-fio') || '').replace(/&quot;/g, '"');
              var role = el.getAttribute('data-role') || 'agent';
              var status = (el.getAttribute('data-status') || '').replace(/&quot;/g, '"');
              var phone = (el.getAttribute('data-phone') || '').replace(/&quot;/g, '"');
              var email = (el.getAttribute('data-email') || '').replace(/&quot;/g, '"');
              var roles = ['agent', 'admin', 'expeditor', 'stockman', 'paymaster'];
              var roleOpts = roles.map(function (r) { return '<option value="' + r + '"' + (r === role ? ' selected' : '') + '>' + r + '</option>'; }).join('');
              var esc = function (s) { return (s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); };
              showModal('Изменить пользователя: ' + login, '<div class="form-group"><label>ФИО</label><input type="text" id="eu_fio" value="' + esc(fio) + '"></div><div class="form-group"><label>Роль</label><select id="eu_role">' + roleOpts + '</select></div><div class="form-group"><label>Статус</label><input type="text" id="eu_status" value="' + esc(status) + '" placeholder="активен"></div><div class="form-group"><label>Телефон</label><input type="text" id="eu_phone" value="' + esc(phone) + '"></div><div class="form-group"><label>Email</label><input type="email" id="eu_email" value="' + esc(email) + '"></div>', function (errEl) {
                return api('/api/v1/users/' + encodeURIComponent(login), { method: 'PATCH', body: JSON.stringify({ fio: document.getElementById('eu_fio').value.trim(), role: document.getElementById('eu_role').value, status: document.getElementById('eu_status').value.trim() || undefined, phone: document.getElementById('eu_phone').value.trim() || undefined, email: document.getElementById('eu_email').value.trim() || undefined }) }).then(function () { loadSectionUsers(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-pwd]').forEach(function (el) {
            el.onclick = function () {
              var login = el.getAttribute('data-pwd');
              showModal('Сменить пароль: ' + login, '<div class="form-group"><label>Новый пароль</label><input type="password" id="sp_password" required></div>', function (errEl) {
                return api('/api/v1/users/' + encodeURIComponent(login) + '/set-password', { method: 'POST', body: JSON.stringify({ password: document.getElementById('sp_password').value }) }).then(function () { loadSectionUsers(); });
              });
            };
          });
        }).catch(function (e) {
          if (document.getElementById('sectionErr')) document.getElementById('sectionErr').textContent = (e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : 'Ошибка') : 'Ошибка загрузки';
        });
      }

      function productTypeSelectHtml(typeList, selected) {
        selected = selected || '';
        var opts = '<option value="">—</option>';
        (typeList || []).forEach(function (ty) {
          var name = escAttr(ty.name);
          opts += '<option value="' + name + '"' + (ty.name === selected ? ' selected' : '') + '>' + (ty.name || '') + '</option>';
        });
        return opts;
      }
      function loadSectionProducts() {
        Promise.all([
          api('/api/v1/dictionary/products').catch(function () { return []; }),
          api('/api/v1/dictionary/products/types').catch(function () { return []; })
        ]).then(function (results) {
          var list = results[0] || [];
          var typeList = results[1] || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="prodAdd">Добавить товар</button>' : '';
          content.innerHTML = '<div class="card"><h2>Товары</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет товаров.</p>'; bindProdAdd(typeList); return; }
          var t = '<table><thead><tr><th>Код</th><th>Название</th><th>Тип</th><th>Вес</th><th>Ед.</th><th>Цена (сум)</th><th>Срок</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (p) {
            var code = escAttr(p.code), name = escAttr(p.name), typeId = escAttr(p.type_id), unit = escAttr(p.unit);
            t += '<tr><td>' + (p.code || '') + '</td><td>' + (p.name || '') + '</td><td>' + (p.type_id || '') + '</td><td>' + (p.weight_g != null ? p.weight_g : '') + '</td><td>' + (p.unit || '') + '</td><td>' + (p.price != null ? p.price : '') + '</td><td>' + (p.expiry_days != null ? p.expiry_days : '') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-prod-edit data-code="' + code + '" data-name="' + name + '" data-type="' + typeId + '" data-weight="' + (p.weight_g != null ? p.weight_g : '') + '" data-unit="' + unit + '" data-price="' + (p.price != null ? p.price : '') + '" data-expiry="' + (p.expiry_days != null ? p.expiry_days : '') + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-prod-del data-code="' + code + '">Удалить</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindProdAdd(typeList);
          tableDiv.querySelectorAll('[data-prod-edit]').forEach(function (el) {
            el.onclick = function () {
              var unesc = function (x) { return (x || '').replace(/&quot;/g, '"'); };
              var code = unesc(el.getAttribute('data-code'));
              var typeOpts = productTypeSelectHtml(typeList, unesc(el.getAttribute('data-type')));
              var bodyHtml = '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="prod_code" value="' + escAttr(code) + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="prod_name" value="' + (unesc(el.getAttribute('data-name')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div><div class="form-group"><label>Тип</label><select id="prod_type">' + typeOpts + '</select></div><div class="form-group"><label>Вес (г)</label><input type="number" id="prod_weight" value="' + (el.getAttribute('data-weight') || '') + '"></div><div class="form-group"><label>Ед.</label><input type="text" id="prod_unit" value="' + (unesc(el.getAttribute('data-unit')) || '').replace(/"/g, '&quot;') + '" placeholder="ШТ"></div><div class="form-group"><label>Цена (сум)</label><input type="number" step="0.01" id="prod_price" value="' + (el.getAttribute('data-price') || '') + '"></div><div class="form-group"><label>Срок годности (дней)</label><input type="number" id="prod_expiry" value="' + (el.getAttribute('data-expiry') || '') + '"></div>';
              showModal('Изменить товар', bodyHtml, function (errEl) {
                return api('/api/v1/dictionary/products/' + encodeURIComponent(code), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('prod_name').value.trim(), type_id: document.getElementById('prod_type').value || null, weight_g: document.getElementById('prod_weight').value ? parseInt(document.getElementById('prod_weight').value, 10) : null, unit: document.getElementById('prod_unit').value.trim() || null, price: document.getElementById('prod_price').value ? parseFloat(document.getElementById('prod_price').value) : null, expiry_days: document.getElementById('prod_expiry').value ? parseInt(document.getElementById('prod_expiry').value, 10) : null }) }).then(function () { loadSectionProducts(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-prod-del]').forEach(function (el) {
            el.onclick = function () {
              var code = (el.getAttribute('data-code') || '').replace(/&quot;/g, '"');
              if (!confirm('Удалить (деактивировать) товар «' + code + '»?')) return;
              api('/api/v1/dictionary/products/' + encodeURIComponent(code), { method: 'DELETE' }).then(function () { loadSectionProducts(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); });
            };
          });
        }).catch(function (e) {
          document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки товаров.</p></div>';
        });
        function bindProdAdd(typeList) {
          var btn = document.getElementById('prodAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            var typeOpts = productTypeSelectHtml(typeList, '');
            var bodyHtml = '<div class="form-group"><label>Название</label><input type="text" id="prod_name" placeholder="Название"></div><div class="form-group"><label>Тип</label><select id="prod_type">' + typeOpts + '</select></div><div class="form-group"><label>Вес (г)</label><input type="number" id="prod_weight" placeholder="0"></div><div class="form-group"><label>Ед.</label><input type="text" id="prod_unit" value="ШТ" placeholder="ШТ"></div><div class="form-group"><label>Цена (сум)</label><input type="number" step="0.01" id="prod_price" placeholder="0"></div><div class="form-group"><label>Срок годности (дней)</label><input type="number" id="prod_expiry" placeholder="0"></div>';
            showModal('Добавить товар', bodyHtml, function (errEl) {
              var name = document.getElementById('prod_name').value.trim();
              if (!name) return Promise.reject({ data: { detail: 'Укажите название.' } });
              return api('/api/v1/dictionary/products', { method: 'POST', body: JSON.stringify({ name: name, type_id: document.getElementById('prod_type').value || null, weight_g: document.getElementById('prod_weight').value ? parseInt(document.getElementById('prod_weight').value, 10) : null, unit: document.getElementById('prod_unit').value.trim() || 'ШТ', price: document.getElementById('prod_price').value ? parseFloat(document.getElementById('prod_price').value) : null, expiry_days: document.getElementById('prod_expiry').value ? parseInt(document.getElementById('prod_expiry').value, 10) : null }) }).then(function () { loadSectionProducts(); });
            });
          };
        }
      }

      function escAttr(s) { var str = (s == null || s === undefined) ? '' : String(s); return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
      function loadSectionRefPayment() {
        api('/api/v1/dictionary/payment-types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы оплат</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefPaymentAdd(); return; }
          var t = '<table><thead><tr><th>Код</th><th>Название</th><th>Описание</th><th>Активна</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (r) {
            var c = escAttr(r.code), n = escAttr(r.name), d = escAttr(r.description);
            var act = (r.active === false ? 'Нет' : 'Да');
            t += '<tr><td>' + (r.code || '') + '</td><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>' + act + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-code="' + c + '" data-name="' + n + '" data-desc="' + d + '" data-active="' + (r.active === false ? 'false' : 'true') + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-code="' + c + '">Удалить</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindRefPaymentAdd();
          tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              showModal('Изменить тип оплаты', '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="re_code" value="' + el.getAttribute('data-code') + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="re_name" value="' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '"></div><div class="form-group"><label>Описание</label><input type="text" id="re_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>', function (errEl) {
                return api('/api/v1/dictionary/payment-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('re_name').value.trim(), description: document.getElementById('re_desc').value.trim() || null }) }).then(function () { loadSectionRefPayment(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
            el.onclick = function () { if (!confirm('Удалить тип оплаты «' + el.getAttribute('data-code') + '»?')) return; api('/api/v1/dictionary/payment-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'DELETE' }).then(function () { loadSectionRefPayment(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов оплат.</p></div>'; });
        function bindRefPaymentAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип оплаты', '<div class="form-group"><label>Код</label><input type="text" id="re_code" placeholder="например card_sum"></div><div class="form-group"><label>Название</label><input type="text" id="re_name" placeholder="Название"></div><div class="form-group"><label>Описание</label><input type="text" id="re_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/dictionary/payment-types', { method: 'POST', body: JSON.stringify({ code: document.getElementById('re_code').value.trim(), name: document.getElementById('re_name').value.trim(), description: document.getElementById('re_desc').value.trim() || null }) }).then(function () { loadSectionRefPayment(); });
            });
          };
        }
      }
      function loadSectionRefProducts() {
        api('/api/v1/dictionary/products/types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы продуктов</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefProductsAdd(); return; }
          var t = '<table><thead><tr><th>Название</th><th>Описание</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (r) {
            var n = escAttr(r.name), d = escAttr(r.description);
            t += '<tr><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-name="' + n + '" data-desc="' + d + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-name="' + n + '">Удалить</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindRefProductsAdd();
          tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              var nameVal = (el.getAttribute('data-name') || '').replace(/&quot;/g, '"');
              showModal('Изменить тип продукта', '<div class="form-group"><label>Название (не изменяется)</label><input type="text" id="rp_name" value="' + el.getAttribute('data-name') + '" readonly></div><div class="form-group"><label>Описание</label><input type="text" id="rp_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>', function (errEl) {
                return api('/api/v1/dictionary/products/types/' + encodeURIComponent(nameVal), { method: 'PUT', body: JSON.stringify({ description: document.getElementById('rp_desc').value.trim() || null }) }).then(function () { loadSectionRefProducts(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
            el.onclick = function () { if (!confirm('Удалить тип продукта «' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '»?')) return; api('/api/v1/dictionary/products/types/' + encodeURIComponent((el.getAttribute('data-name') || '').replace(/&quot;/g, '"')), { method: 'DELETE' }).then(function () { loadSectionRefProducts(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов продуктов.</p></div>'; });
        function bindRefProductsAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип продукта', '<div class="form-group"><label>Название</label><input type="text" id="rp_name" placeholder="например Yogurt"></div><div class="form-group"><label>Описание</label><input type="text" id="rp_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/dictionary/products/types', { method: 'POST', body: JSON.stringify({ name: document.getElementById('rp_name').value.trim(), description: document.getElementById('rp_desc').value.trim() || null }) }).then(function () { loadSectionRefProducts(); });
            });
          };
        }
      }
      function loadSectionRefOperations() {
        api('/api/v1/operation-types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы операций</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefOpsAdd(); return; }
          var t = '<table><thead><tr><th>Код</th><th>Название</th><th>Описание</th><th>Активна</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (r) {
            var c = escAttr(r.code), n = escAttr(r.name), d = escAttr(r.description);
            var actText = (r.active === false ? 'Нет' : 'Да');
            var actAttr = (r.active === false ? 'false' : 'true');
            t += '<tr><td>' + (r.code || '') + '</td><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>' + actText + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-code="' + c + '" data-name="' + n + '" data-desc="' + d + '" data-active="' + actAttr + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-code="' + c + '">Удалить</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindRefOpsAdd();
          tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              var act = el.getAttribute('data-active') || 'true';
              var bodyHtml = ''
                + '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="ro_code" value="' + el.getAttribute('data-code') + '" readonly></div>'
                + '<div class="form-group"><label>Название</label><input type="text" id="ro_name" value="' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '"></div>'
                + '<div class="form-group"><label>Описание</label><input type="text" id="ro_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>'
                + '<div class="form-group"><label>Активна</label><select id="ro_active"><option value="true">Да</option><option value="false">Нет</option></select></div>';
              showModal('Изменить тип операции', bodyHtml, function (errEl) {
                var name = document.getElementById('ro_name').value.trim();
                var desc = document.getElementById('ro_desc').value.trim() || null;
                var activeVal = document.getElementById('ro_active').value === 'true';
                return api('/api/v1/operation-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'PUT', body: JSON.stringify({ name: name, description: desc, active: activeVal }) }).then(function () { loadSectionRefOperations(); });
              });
              var sel = document.getElementById('ro_active');
              if (sel) sel.value = (act === 'false' ? 'false' : 'true');
            };
          });
          tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
            el.onclick = function () { if (!confirm('Удалить тип операции «' + el.getAttribute('data-code') + '»?')) return; api('/api/v1/operation-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'DELETE' }).then(function () { loadSectionRefOperations(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов операций.</p></div>'; });
        function bindRefOpsAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип операции', '<div class="form-group"><label>Код</label><input type="text" id="ro_code" placeholder="например transfer"></div><div class="form-group"><label>Название</label><input type="text" id="ro_name" placeholder="Название"></div><div class="form-group"><label>Описание</label><input type="text" id="ro_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/operation-types', { method: 'POST', body: JSON.stringify({ code: document.getElementById('ro_code').value.trim(), name: document.getElementById('ro_name').value.trim(), description: document.getElementById('ro_desc').value.trim() || null }) }).then(function () { loadSectionRefOperations(); });
            });
          };
        }
      }

      function whUserSelectHtml(userList, selectedSk, selectedAg, selectedExp) {
        selectedSk = selectedSk || ''; selectedAg = selectedAg || ''; selectedExp = selectedExp || '';
        var optsAll = '<option value="">— Не назначен</option>';
        var optsExp = '<option value="">— Не назначен</option>';
        (userList || []).forEach(function (u) {
          var login = escAttr(u.login);
          var label = (u.login || '') + (u.fio ? ' — ' + (u.fio || '').replace(/</g, '&lt;') : '');
          optsAll += '<option value="' + login + '">' + label + '</option>';
          var role = (u.role || '').toLowerCase();
          if (role === 'expeditor') {
            optsExp += '<option value="' + login + '">' + label + '</option>';
          }
        });
        var escSk = escAttr(selectedSk), escAg = escAttr(selectedAg), escEx = escAttr(selectedExp);
        var skOpts = optsAll.replace('value="' + escSk + '"', 'value="' + escSk + '" selected');
        var agOpts = optsAll.replace('value="' + escAg + '"', 'value="' + escAg + '" selected');
        var exOpts = optsExp.replace('value="' + escEx + '"', 'value="' + escEx + '" selected');
        return '<div class="form-group"><label>Кладовщик</label><select id="wh_sk">' + skOpts + '</select></div><div class="form-group"><label>Агент</label><select id="wh_agent">' + agOpts + '</select></div><div class="form-group"><label>Экспедитор (login)</label><select id="wh_exp">' + exOpts + '</select></div>';
      }
      function loadSectionWarehouses() {
        Promise.all([
          api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; })
        ]).then(function (results) {
          var list = results[0] || [];
          var userList = results[1] || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="whAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Склады</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет складов.</p>'; bindWhAdd(userList); return; }
          var t = '<table><thead><tr><th>Код</th><th>Название</th><th>Тип</th><th>Кладовщик</th><th>Агент</th><th>Экспедитор (login)</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (w) {
            var c = escAttr(w.code), n = escAttr(w.name), ty = escAttr(w.type), sk = escAttr(w.storekeeper), ag = escAttr(w.agent), ex = escAttr(w.expeditor_login);
            t += '<tr><td>' + (w.code || '') + '</td><td>' + (w.name || '') + '</td><td>' + (w.type || '') + '</td><td>' + (w.storekeeper || '') + '</td><td>' + (w.agent || '') + '</td><td>' + (w.expeditor_login || '') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-wh-edit data-code="' + c + '" data-name="' + n + '" data-type="' + ty + '" data-storekeeper="' + sk + '" data-agent="' + ag + '" data-expeditor="' + ex + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-wh-del data-code="' + c + '">Удалить</button>';
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindWhAdd(userList);
          tableDiv.querySelectorAll('[data-wh-edit]').forEach(function (el) {
            el.onclick = function () {
              var unesc = function (x) { return (x || '').replace(/&quot;/g, '"'); };
              var sk = unesc(el.getAttribute('data-storekeeper'));
              var ag = unesc(el.getAttribute('data-agent'));
              var ex = unesc(el.getAttribute('data-expeditor'));
              var bodyHtml = '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="wh_code" value="' + el.getAttribute('data-code') + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="wh_name" value="' + (unesc(el.getAttribute('data-name')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div><div class="form-group"><label>Тип</label><input type="text" id="wh_type" value="' + (unesc(el.getAttribute('data-type')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div>' + whUserSelectHtml(userList, sk, ag, ex);
              showModal('Изменить склад', bodyHtml, function (errEl) {
                var skVal = document.getElementById('wh_sk').value || null;
                var agVal = document.getElementById('wh_agent').value || null;
                var exVal = document.getElementById('wh_exp').value || null;
                return api('/api/v1/dictionary/warehouses/' + encodeURIComponent(unesc(el.getAttribute('data-code'))), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('wh_name').value.trim(), type: document.getElementById('wh_type').value.trim() || null, storekeeper: skVal, agent: agVal, expeditor_login: exVal }) }).then(function () { loadSectionWarehouses(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-wh-del]').forEach(function (el) {
            el.onclick = function () { if (!confirm('Удалить склад «' + (el.getAttribute('data-code') || '').replace(/&quot;/g, '"') + '»?')) return; api('/api/v1/dictionary/warehouses/' + encodeURIComponent((el.getAttribute('data-code') || '').replace(/&quot;/g, '"')), { method: 'DELETE' }).then(function () { loadSectionWarehouses(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки складов.</p></div>'; });
        function bindWhAdd(userList) {
          var btn = document.getElementById('whAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            var bodyHtml = '<div class="form-group"><label>Код</label><input type="text" id="wh_code" placeholder="например WH01"></div><div class="form-group"><label>Название</label><input type="text" id="wh_name" placeholder="Название"></div><div class="form-group"><label>Тип</label><input type="text" id="wh_type" placeholder="основной"></div>' + whUserSelectHtml(userList, '', '', '');
            showModal('Добавить склад', bodyHtml, function (errEl) {
              var skVal = document.getElementById('wh_sk').value || null;
              var agVal = document.getElementById('wh_agent').value || null;
              var exVal = document.getElementById('wh_exp').value || null;
              return api('/api/v1/dictionary/warehouses', { method: 'POST', body: JSON.stringify({ code: document.getElementById('wh_code').value.trim(), name: document.getElementById('wh_name').value.trim(), type: document.getElementById('wh_type').value.trim() || null, storekeeper: skVal, agent: agVal, expeditor_login: exVal }) }).then(function () { loadSectionWarehouses(); });
            });
          };
        }
      }

      function custUserSelectHtml(userList, selected) {
        selected = selected || '';
        var opts = '<option value="">— Не назначен</option>';
        (userList || []).forEach(function (u) {
          var login = escAttr(u.login);
          var label = (u.login || '') + (u.fio ? ' — ' + (u.fio || '').replace(/</g, '&lt;') : '');
          opts += '<option value="' + login + '"' + (u.login === selected ? ' selected' : '') + '>' + label + '</option>';
        });
        return opts;
      }
      function custInputVal(v) { return (v != null && v !== '' ? String(v) : '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
      function custEditFormHtml(c, userList) {
        var agOpts = custUserSelectHtml(userList, c.login_agent || '');
        var expUsers = (userList || []).filter(function (u) { return (u.role || '').toLowerCase() === 'expeditor'; });
        var exOpts = custUserSelectHtml(expUsers, c.login_expeditor || '');
        var f = function (label, id, val) { return '<div class="form-group"><label>' + label + '</label><input type="text" id="' + id + '" value="' + custInputVal(val) + '"></div>'; };
        var num = function (label, id, val) { return '<div class="form-group"><label>' + label + '</label><input type="number" step="any" id="' + id + '" value="' + custInputVal(val) + '"></div>'; };
        return f('Название клиента', 'cust_name', c.name_client) + f('Название фирмы', 'cust_firm', c.firm_name) + f('Категория клиента', 'cust_category', c.category_client) + f('Адрес', 'cust_address', c.address) + f('Город', 'cust_city', c.city) + f('Территория', 'cust_territory', c.territory) + f('Ориентир', 'cust_landmark', c.landmark) + f('Телефон', 'cust_phone', c.phone) + f('Контактное лицо', 'cust_contact', c.contact_person) + f('ИНН', 'cust_tax_id', c.tax_id) + f('Статус', 'cust_status', c.status) + '<div class="form-group"><label>login агента</label><select id="cust_agent">' + agOpts + '</select></div><div class="form-group"><label>login экспедитора</label><select id="cust_expeditor">' + exOpts + '</select></div>' + num('Широта', 'cust_lat', c.latitude) + num('Долгота', 'cust_lon', c.longitude) + f('ПИНФЛ', 'cust_pinfl', c.PINFL) + f('Договор №', 'cust_contract_no', c.contract_no) + f('Р/С', 'cust_account_no', c.account_no) + f('Банк', 'cust_bank', c.bank) + f('МФО', 'cust_mfo', c.MFO) + f('ОКЭД', 'cust_oked', c.OKED) + f('Регистрационный код плательщика НДС', 'cust_vat_code', c.VAT_code);
      }
      function custFormBody() {
        var g = function (id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; };
        var gn = function (id) { var v = g(id); return v === '' ? null : (Number(v)); };
        return { name_client: g('cust_name') || null, firm_name: g('cust_firm') || null, category_client: g('cust_category') || null, address: g('cust_address') || null, city: g('cust_city') || null, territory: g('cust_territory') || null, landmark: g('cust_landmark') || null, phone: g('cust_phone') || null, contact_person: g('cust_contact') || null, tax_id: g('cust_tax_id') || null, status: g('cust_status') || null, login_agent: document.getElementById('cust_agent') ? document.getElementById('cust_agent').value || null : null, login_expeditor: document.getElementById('cust_expeditor') ? document.getElementById('cust_expeditor').value || null : null, latitude: gn('cust_lat'), longitude: gn('cust_lon'), PINFL: g('cust_pinfl') || null, contract_no: g('cust_contract_no') || null, account_no: g('cust_account_no') || null, bank: g('cust_bank') || null, MFO: g('cust_mfo') || null, OKED: g('cust_oked') || null, VAT_code: g('cust_vat_code') || null };
      }
      function loadSectionCustomers() {
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          userList = userList || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="custAdd">Добавить клиента</button>' : '';
          var exportBtn = isAdmin() ? '<button type="button" class="btn btn-secondary" id="custExport">Скачать в Excel всех клиентов</button>' : '';
          var agentOpts = '<option value="">— Все —</option>';
          var expeditorOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            agentOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorOpts += optHtml;
          });
          content.innerHTML = '<div class="card"><h2>Клиенты</h2><p style="margin:0 0 12px 0">' + addBtn + ' ' + exportBtn + '</p><div class="form-group" style="margin-bottom:12px"><label>Поиск</label></div><div style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"><input id="custSearchName" placeholder="Название клиента" style="max-width:180px"><input id="custSearchFirm" placeholder="Название фирмы" style="max-width:180px"><input id="custSearchCity" placeholder="Город" style="max-width:140px"><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">login агента</label><select id="custSearchAgent" style="max-width:160px">' + agentOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">login экспедитора</label><select id="custSearchExpeditor" style="max-width:160px">' + expeditorOpts + '</select></div><input id="custSearchPhone" placeholder="Телефон" style="max-width:140px"><input id="custSearchTaxId" placeholder="ИНН" style="max-width:120px"><button type="button" class="btn btn-primary" id="btnCustSearch">Найти</button></div><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          bindCustAdd(userList);
          var exportEl = document.getElementById('custExport');
          if (exportEl) exportEl.onclick = function () {
            var url = window.location.origin + '/api/v1/customers/export';
            fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clients.xlsx'; a.click(); URL.revokeObjectURL(a.href);
            }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
          };
          function runCustomerSearch() {
            var name_client = document.getElementById('custSearchName') ? document.getElementById('custSearchName').value.trim() : '';
            var firm_name = document.getElementById('custSearchFirm') ? document.getElementById('custSearchFirm').value.trim() : '';
            var city = document.getElementById('custSearchCity') ? document.getElementById('custSearchCity').value.trim() : '';
            var login_agent = document.getElementById('custSearchAgent') ? document.getElementById('custSearchAgent').value : '';
            var login_expeditor = document.getElementById('custSearchExpeditor') ? document.getElementById('custSearchExpeditor').value : '';
            var phone = document.getElementById('custSearchPhone') ? document.getElementById('custSearchPhone').value.trim() : '';
            var tax_id = document.getElementById('custSearchTaxId') ? document.getElementById('custSearchTaxId').value.trim() : '';
            var params = ['limit=500'];
            if (name_client) params.push('name_client=' + encodeURIComponent(name_client));
            if (firm_name) params.push('firm_name=' + encodeURIComponent(firm_name));
            if (city) params.push('city=' + encodeURIComponent(city));
            if (login_agent) params.push('login_agent=' + encodeURIComponent(login_agent));
            if (login_expeditor) params.push('login_expeditor=' + encodeURIComponent(login_expeditor));
            if (phone) params.push('phone=' + encodeURIComponent(phone));
            if (tax_id) params.push('tax_id=' + encodeURIComponent(tax_id));
            api('/api/v1/customers?' + params.join('&')).catch(function () { return []; }).then(function (list) {
              list = list || [];
              var tableDiv = document.getElementById('sectionTable');
              if (!tableDiv) return;
              if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет клиентов.</p>'; return; }
              var headers = ['Действия','ИД клиента','Название клиента','Название фирмы','Категория клиента','Адрес','Город','Территория','Ориентир','Телефон','Контактное лицо','ИНН','Статус','login агента','login экспедитора','Широта','Долгота','ПИНФЛ','Договор №','Р/С','Банк','МФО','ОКЭД','Регистрационный код плательщика НДС'];
              var t = '<div style="overflow-x:auto"><table><thead><tr>';
              headers.forEach(function (h) { t += '<th>' + h + '</th>'; });
              t += '</tr></thead><tbody>';
              list.forEach(function (c) {
                var id = c.id;
                var custJson = escAttr(JSON.stringify(c));
                t += '<tr><td>';
                if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-cust-edit data-id="' + id + '" data-cust-json="' + custJson + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-cust-del data-id="' + id + '">Удалить</button>';
                t += '</td><td>' + (c.id != null ? c.id : '') + '</td><td>' + (c.name_client || '') + '</td><td>' + (c.firm_name || '') + '</td><td>' + (c.category_client || '') + '</td><td>' + (c.address || '') + '</td><td>' + (c.city || '') + '</td><td>' + (c.territory || '') + '</td><td>' + (c.landmark || '') + '</td><td>' + (c.phone || '') + '</td><td>' + (c.contact_person || '') + '</td><td>' + (c.tax_id || '') + '</td><td>' + (c.status || '') + '</td><td>' + (c.login_agent || '') + '</td><td>' + (c.login_expeditor || '') + '</td><td>' + (c.latitude != null ? c.latitude : '') + '</td><td>' + (c.longitude != null ? c.longitude : '') + '</td><td>' + (c.PINFL || '') + '</td><td>' + (c.contract_no || '') + '</td><td>' + (c.account_no || '') + '</td><td>' + (c.bank || '') + '</td><td>' + (c.MFO || '') + '</td><td>' + (c.OKED || '') + '</td><td>' + (c.VAT_code || '') + '</td></tr>';
              });
              t += '</tbody></table></div>';
              tableDiv.innerHTML = t;
              tableDiv.querySelectorAll('[data-cust-edit]').forEach(function (el) {
                el.onclick = function () {
                  var id = el.getAttribute('data-id');
                  var jsonStr = (el.getAttribute('data-cust-json') || '').replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&amp;/g, '&');
                  var c = {}; try { c = JSON.parse(jsonStr); } catch (e) {}
                  showModal('Изменить клиента', custEditFormHtml(c, userList), function (errEl) {
                    return api('/api/v1/customers/' + id, { method: 'PATCH', body: JSON.stringify(custFormBody()) }).then(function () { loadSectionCustomers(); });
                  });
                };
              });
              tableDiv.querySelectorAll('[data-cust-del]').forEach(function (el) {
                el.onclick = function () {
                  var id = el.getAttribute('data-id');
                  if (!confirm('Удалить клиента ID ' + id + '?')) return;
                  api('/api/v1/customers/' + id, { method: 'DELETE' }).then(function () { loadSectionCustomers(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); });
                };
              });
            });
          }
          document.getElementById('btnCustSearch').onclick = runCustomerSearch;
          runCustomerSearch();
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки.</p></div>'; });
        function bindCustAdd(userList) {
          var btn = document.getElementById('custAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            var bodyHtml = custEditFormHtml({ status: 'Активный' }, userList);
            showModal('Добавить клиента', bodyHtml, function (errEl) {
              return api('/api/v1/customers', { method: 'POST', body: JSON.stringify(custFormBody()) }).then(function () { loadSectionCustomers(); });
            });
          };
        }
      }

      function loadSectionOrders() {
        var content = document.getElementById('content');
        if (!content) return;
        content.innerHTML = '<div class="card"><h2>Заказы</h2><p style="margin:0 0 12px 0"><button type="button" class="btn btn-primary" id="orderAdd">Создать заказ</button>' + (isAdmin() ? ' <button type="button" class="btn btn-secondary" id="orderExport">Скачать заказы в Excel</button>' : '') + '</p><div class="form-group" style="margin:12px 0"><label>Поиск заказов</label></div><div id="orderSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="sectionOrderErr" class="err"></div><div id="sectionTable"></div></div>';
        var tableDiv = document.getElementById('sectionTable');
        var errDiv = document.getElementById('sectionOrderErr');
        var searchRow = document.getElementById('orderSearchRow');
        bindOrderAdd();
        var orderExportBtn = document.getElementById('orderExport');
        if (orderExportBtn) orderExportBtn.onclick = function () {
          var url = window.location.origin + '/api/v1/orders/export';
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'orders.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
        };
        function formatDateTashkent(isoStr) {
          if (!isoStr) return '';
          try {
            var d = new Date(isoStr);
            return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
          } catch (e) { return isoStr; }
        }
        function renderOrderTable(list) {
          if (errDiv) errDiv.textContent = '';
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Заказов не найдено. Измените критерии поиска или создайте заказ.</p>'; return; }
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Действия</th><th>№</th><th>Клиент</th><th>Дата создания</th><th>Статус</th><th>Тип оплаты</th><th>Сумма</th><th>Агент</th><th>Экспедитор</th><th>Дата поставки</th><th>Перевод в статус «Доставка»</th><th>Дата закрытия</th><th>Последнее изменение</th><th>Кто изменил</th></tr></thead><tbody>';
          list.forEach(function (o) {
            t += '<tr><td><button type="button" class="btn btn-secondary btn-small" data-order-edit data-id="' + (o.order_no != null ? o.order_no : o.id) + '">Изменить</button></td><td>' + (o.order_no != null ? o.order_no : o.id) + '</td><td>' + escAttr(o.customer_name || (o.customer_id != null ? 'ID ' + o.customer_id : '')) + '</td><td>' + formatDateTashkent(o.order_date) + '</td><td>' + escAttr(o.status_name || o.status_code || '') + '</td><td>' + escAttr(o.payment_type_name || o.payment_type_code || '') + '</td><td>' + (o.total_amount != null ? o.total_amount : '') + '</td><td>' + escAttr(o.login_agent || '') + '</td><td>' + escAttr(o.login_expeditor || '') + '</td><td>' + formatDateTashkent(o.scheduled_delivery_at) + '</td><td>' + formatDateTashkent(o.status_delivery_at) + '</td><td>' + formatDateTashkent(o.closed_at) + '</td><td>' + formatDateTashkent(o.last_updated_at) + '</td><td>' + escAttr(o.last_updated_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('[data-order-edit]').forEach(function (el) {
            el.onclick = function () {
              var orderId = el.getAttribute('data-id') || '';
              api('/api/v1/orders/' + orderId).then(function (orderData) {
                Promise.all([
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/orders/statuses').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  var customers = results[0] || [];
                  var statuses = results[1] || [];
                  var products = results[2] || [];
                  var paymentTypes = results[3] || [];
                  var userList = results[4] || [];
                  openOrderForm(true, orderId, orderData, customers, statuses, products, paymentTypes, userList);
                });
              }).catch(function (e) {
                if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Не удалось загрузить заказ.';
              });
            };
          });
        }
        var ORDER_SEARCH_STORAGE = 'orderSearchFilters';
        var ORDER_PRESETS_STORAGE = 'orderSearchPresets';
        function getOrderSearchFilters() {
          var customer_id = document.getElementById('orderSearchCustomerId') ? document.getElementById('orderSearchCustomerId').value : '';
          var status_code = document.getElementById('orderSearchStatus') ? document.getElementById('orderSearchStatus').value : '';
          var date_from = document.getElementById('orderSearchDateFrom') ? document.getElementById('orderSearchDateFrom').value : '';
          var date_to = document.getElementById('orderSearchDateTo') ? document.getElementById('orderSearchDateTo').value : '';
          var login_agent = document.getElementById('orderSearchAgent') ? document.getElementById('orderSearchAgent').value : '';
          var login_expeditor = document.getElementById('orderSearchExpeditor') ? document.getElementById('orderSearchExpeditor').value : '';
          var last_updated_by = document.getElementById('orderSearchLastUpdatedBy') ? document.getElementById('orderSearchLastUpdatedBy').value : '';
          return { customer_id: customer_id, status_code: status_code, date_from: date_from, date_to: date_to, login_agent: login_agent, login_expeditor: login_expeditor, last_updated_by: last_updated_by };
        }
        function setOrderSearchFilters(f) {
          if (!f) return;
          var el;
          if (el = document.getElementById('orderSearchCustomerId')) el.value = f.customer_id || '';
          if (el = document.getElementById('orderSearchStatus')) el.value = f.status_code || '';
          if (el = document.getElementById('orderSearchDateFrom')) el.value = f.date_from || '';
          if (el = document.getElementById('orderSearchDateTo')) el.value = f.date_to || '';
          if (el = document.getElementById('orderSearchAgent')) el.value = f.login_agent || '';
          if (el = document.getElementById('orderSearchExpeditor')) el.value = f.login_expeditor || '';
          if (el = document.getElementById('orderSearchLastUpdatedBy')) el.value = f.last_updated_by || '';
        }
        function runOrderSearch() {
          var f = getOrderSearchFilters();
          try { localStorage.setItem(ORDER_SEARCH_STORAGE, JSON.stringify(f)); } catch (e) {}
          var params = [];
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.status_code) params.push('status_code=' + encodeURIComponent(f.status_code));
          if (f.date_from) params.push('scheduled_delivery_from=' + encodeURIComponent(f.date_from + 'T00:00:00'));
          if (f.date_to) params.push('scheduled_delivery_to=' + encodeURIComponent(f.date_to + 'T23:59:59'));
          if (f.login_agent) params.push('login_agent=' + encodeURIComponent(f.login_agent));
          if (f.login_expeditor) params.push('login_expeditor=' + encodeURIComponent(f.login_expeditor));
          if (f.last_updated_by) params.push('last_updated_by=' + encodeURIComponent(f.last_updated_by));
          api('/api/v1/orders' + (params.length ? '?' + params.join('&') : '')).then(renderOrderTable).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки заказов.';
            tableDiv.innerHTML = '<p>Список заказов не загружен.</p>';
          });
        }
        Promise.all([
          api('/api/v1/orders/statuses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; })
        ]).then(function (results) {
          var statuses = results[0] || [];
          var userList = results[1] || [];
          var customers = results[2] || [];
          if (!statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = '<option value="">— Все —</option>'; statuses.forEach(function (s) { statusOpts += '<option value="' + escAttr(s.code) + '">' + escAttr(s.name || s.code) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>';
          var expeditorUserOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            userOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorUserOpts += optHtml;
          });
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var presets = [];
          try { var p = localStorage.getItem(ORDER_PRESETS_STORAGE); if (p) presets = JSON.parse(p); } catch (e) {}
          var presetOpts = '<option value="">— Текущий поиск —</option>';
          presets.forEach(function (pr, i) { presetOpts += '<option value="' + i + '">' + escAttr(pr.name || 'Вариант ' + (i + 1)) + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Сохранённый поиск</label><select id="orderSearchPreset" style="max-width:180px">' + presetOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="orderSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="orderSearchStatus" style="max-width:140px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки с</label><input type="text" id="orderSearchDateFrom" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="orderSearchDateTo" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Агент</label><select id="orderSearchAgent" style="max-width:160px">' + userOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Экспедитор</label><select id="orderSearchExpeditor" style="max-width:160px">' + expeditorUserOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто изменил</label><select id="orderSearchLastUpdatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="orderSearchBtn">Найти</button> <button type="button" class="btn btn-secondary" id="orderSearchSavePreset">Сохранить вариант</button>';
          document.getElementById('orderSearchBtn').onclick = runOrderSearch;
          document.getElementById('orderSearchPreset').onchange = function () {
            var idx = this.value;
            if (idx === '') return;
            var pr = presets[parseInt(idx, 10)];
            if (pr && pr.filters) { setOrderSearchFilters(pr.filters); runOrderSearch(); }
          };
          document.getElementById('orderSearchSavePreset').onclick = function () {
            var name = prompt('Название варианта поиска (например: Мои заказы)');
            if (!name || !name.trim()) return;
            var f = getOrderSearchFilters();
            presets.push({ name: name.trim(), filters: f });
            try { localStorage.setItem(ORDER_PRESETS_STORAGE, JSON.stringify(presets)); } catch (e) {}
            var sel = document.getElementById('orderSearchPreset');
            var opt = document.createElement('option'); opt.value = presets.length - 1; opt.textContent = name.trim(); sel.appendChild(opt);
          };
          var savedFilters = null;
          try { var s = localStorage.getItem(ORDER_SEARCH_STORAGE); if (s) savedFilters = JSON.parse(s); } catch (e) {}
          if (window.flatpickr) {
            var df = document.getElementById('orderSearchDateFrom');
            var dt = document.getElementById('orderSearchDateTo');
            if (df) window.flatpickr(df, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
            if (dt) window.flatpickr(dt, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
          }
          if (savedFilters) { setOrderSearchFilters(savedFilters); runOrderSearch(); } else { tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти» или выберите сохранённый вариант.</p>'; }
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="orderSearchBtn">Загрузить заказы</button>';
          document.getElementById('orderSearchBtn').onclick = runOrderSearch;
        });
        function openOrderForm(isEdit, orderId, orderData, customers, statuses, products, paymentTypes, userList) {
          var sel = isEdit && orderData ? { cust: orderData.customer_id, status: orderData.status_code, payment: orderData.payment_type_code || '', agent: orderData.login_agent || '', exp: orderData.login_expeditor || '' } : { cust: '', status: 'open', payment: '', agent: '', exp: '' };
          var custOpts = '<option value="">— Выберите клиента —</option>';
          customers.forEach(function (c) { var s = (sel.cust != null && String(sel.cust) === String(c.id)) ? ' selected' : ''; custOpts += '<option value="' + (c.id != null ? c.id : '') + '"' + s + '>' + escAttr((c.name_client || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          if (!statuses || !statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = ''; statuses.forEach(function (s) { var o = (s.code === sel.status) ? ' selected' : ''; statusOpts += '<option value="' + escAttr(s.code) + '"' + o + '>' + escAttr(s.name || s.code) + '</option>'; });
          var payOpts = '<option value="">— Выберите тип оплаты —</option>'; paymentTypes.forEach(function (pt) { var o = (pt.code === sel.payment) ? ' selected' : ''; payOpts += '<option value="' + escAttr(pt.code) + '"' + o + '>' + escAttr(pt.name || pt.code) + '</option>'; });
          var productOpts = '<option value="">— Выберите товар —</option>';
          products.forEach(function (p) { productOpts += '<option value="' + escAttr(p.code) + '" data-price="' + (p.price != null ? p.price : '') + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var agentOpts = '<option value="">— Не назначен —</option>';
          var expeditorOpts = '<option value="">— Не назначен —</option>';
          userList.forEach(function (u) {
            var oAgent = (u.login === sel.agent) ? ' selected' : '';
            agentOpts += '<option value="' + escAttr(u.login) + '"' + oAgent + '>' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            if ((u.role || '').toLowerCase() === 'expeditor') {
              var oExp = (u.login === sel.exp) ? ' selected' : '';
              expeditorOpts += '<option value="' + escAttr(u.login) + '"' + oExp + '>' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            }
          });
          var content = document.getElementById('content');
          if (!content) return;
          content.innerHTML = '<div class="card"><h2 id="orderFormTitle">Создание заказа</h2><div id="orderCreateErr" class="err" style="margin-bottom:12px"></div><div id="orderFormMsg" class="msg" style="margin-bottom:12px;display:none"></div><div class="form-group"><label>Клиент</label><select id="orderCreateCustomer">' + custOpts + '</select></div><div class="form-group"><label>Агент</label><select id="orderCreateAgent">' + agentOpts + '</select></div><div class="form-group"><label>Экспедитор</label><select id="orderCreateExpeditor">' + expeditorOpts + '</select></div><div class="form-group"><label>Статус</label><select id="orderCreateStatus">' + statusOpts + '</select></div><div class="form-group"><label>Тип оплаты</label><select id="orderCreatePaymentType">' + payOpts + '</select></div><div class="form-group"><label>Назначенная дата поставки</label><input type="text" id="orderScheduledDelivery" placeholder="дд.мм.гггг чч:мм" autocomplete="off"></div><div class="form-group"><label>Позиции заказа</label></div><div style="overflow-x:auto"><table><thead><tr><th>Товар</th><th>Количество</th><th>Цена</th><th>Действия</th></tr></thead><tbody id="orderCreateItemsBody"></tbody></table></div><p style="margin:12px 0"><button type="button" class="btn btn-secondary" id="orderAddRow">Добавить позицию</button></p><div class="form-group"><label>Сумма</label><div id="orderCreateSum" style="padding:6px 0;font-weight:600">0</div></div><p><button type="button" class="btn btn-primary" id="orderCreateSave">Сохранить заказ</button> <button type="button" class="btn btn-secondary" id="orderCreateCancel">Отмена</button></p><div style="margin-top:24px;padding:12px;background:#f8f9fa;border-radius:6px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата создания заказа</label><div id="orderOrderDate" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Перевод в статус «Доставка»</label><div id="orderStatusDeliveryAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата и время закрытия заказа</label><div id="orderClosedAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата последнего изменения</label><div id="orderLastUpdatedAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:0"><label style="font-size:12px;color:#666">Кто изменил</label><div id="orderLastUpdatedBy" class="form-readonly">—</div></div></div></div>';
          document.getElementById('orderFormTitle').textContent = isEdit ? ('Редактирование заказа № ' + orderId) : 'Создание заказа';
          function formatDateTashkent(isoStr) {
            if (!isoStr) return '—';
            try {
              var d = new Date(isoStr);
              return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            } catch (e) { return isoStr; }
          }
          function isoToDatetimeLocal(isoStr) {
            if (!isoStr) return '';
            try {
              var d = new Date(isoStr);
              var y = d.getFullYear(); var m = String(d.getMonth() + 1).padStart(2, '0'); var day = String(d.getDate()).padStart(2, '0');
              var h = String(d.getHours()).padStart(2, '0'); var min = String(d.getMinutes()).padStart(2, '0');
              return y + '-' + m + '-' + day + 'T' + h + ':' + min;
            } catch (e) { return ''; }
          }
          if (isEdit && orderData) {
            document.getElementById('orderOrderDate').textContent = formatDateTashkent(orderData.order_date);
            document.getElementById('orderStatusDeliveryAt').textContent = formatDateTashkent(orderData.status_delivery_at);
            document.getElementById('orderClosedAt').textContent = formatDateTashkent(orderData.closed_at);
            document.getElementById('orderLastUpdatedAt').textContent = formatDateTashkent(orderData.last_updated_at);
            document.getElementById('orderLastUpdatedBy').textContent = orderData.last_updated_by || '—';
          } else {
            document.getElementById('orderOrderDate').textContent = '—';
          }
          var schedEl = document.getElementById('orderScheduledDelivery');
          if (window.flatpickr && schedEl) {
            var defaultDate = (isEdit && orderData && orderData.scheduled_delivery_at) ? orderData.scheduled_delivery_at : null;
            window.flatpickr(schedEl, {
              enableTime: true,
              time_24hr: true,
              locale: 'ru',
              dateFormat: 'Y-m-d H:i',
              defaultDate: defaultDate,
              allowInput: false,
              firstDayOfWeek: 1
            });
          }
          var tbody = document.getElementById('orderCreateItemsBody');
          function updateAgentExpeditor() {
            var cid = document.getElementById('orderCreateCustomer').value;
            var cust = customers.filter(function (c) { return String(c.id) === String(cid); })[0];
            var agSel = document.getElementById('orderCreateAgent'); var exSel = document.getElementById('orderCreateExpeditor');
            if (agSel) { agSel.value = cust && cust.login_agent ? cust.login_agent : ''; }
            if (exSel) { exSel.value = cust && cust.login_expeditor ? cust.login_expeditor : ''; }
          }
          function updateSum() {
            var rows = tbody.querySelectorAll('tr'); var sum = 0;
            for (var i = 0; i < rows.length; i++) {
              var qty = parseInt(rows[i].querySelector('.order-item-qty').value, 10) || 0;
              var priceVal = rows[i].querySelector('.order-item-price').value.trim();
              var price = priceVal !== '' ? parseFloat(priceVal) : 0;
              sum += qty * price;
            }
            var el = document.getElementById('orderCreateSum'); if (el) el.textContent = sum;
          }
          document.getElementById('orderCreateCustomer').onchange = updateAgentExpeditor;
          function addRow(existingItem) {
            var tr = document.createElement('tr');
            if (existingItem) tr.setAttribute('data-item-id', existingItem.id || '');
            var qty = (existingItem && existingItem.quantity != null) ? existingItem.quantity : 1;
            var priceStr = (existingItem && existingItem.price != null) ? existingItem.price : '';
            tr.innerHTML = '<td><select class="order-item-product" style="min-width:220px">' + productOpts + '</select></td><td><input type="number" min="1" class="order-item-qty" value="' + qty + '" style="width:80px"></td><td><input type="number" step="0.01" min="0" class="order-item-price" placeholder="по прайсу" value="' + priceStr + '" style="width:100px"></td><td><button type="button" class="btn btn-secondary btn-small order-item-del">Удалить</button></td>';
            tbody.appendChild(tr);
            if (existingItem && existingItem.product_code) { var selProd = tr.querySelector('.order-item-product'); selProd.value = existingItem.product_code; }
            tr.querySelector('.order-item-product').onchange = function () {
              var opt = this.options[this.selectedIndex];
              var price = opt && opt.getAttribute('data-price');
              var priceInput = tr.querySelector('.order-item-price');
              if (priceInput && price) priceInput.value = price;
              updateSum();
            };
            tr.querySelector('.order-item-qty').oninput = tr.querySelector('.order-item-price').oninput = updateSum;
            tr.querySelector('.order-item-del').onclick = function () { tr.remove(); updateSum(); };
          }
          if (isEdit && orderData && orderData.items && orderData.items.length) {
            orderData.items.forEach(function (it) { addRow(it); });
          } else {
            addRow(null);
          }
          updateSum();
          document.getElementById('orderAddRow').onclick = function () { addRow(null); };
          document.getElementById('orderCreateCancel').onclick = function () { loadSectionOrders(); };
          document.getElementById('orderCreateSave').onclick = function () {
            var errEl = document.getElementById('orderCreateErr');
            var msgEl = document.getElementById('orderFormMsg');
            var saveBtn = document.getElementById('orderCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var customer_id = document.getElementById('orderCreateCustomer').value;
            var status_code = document.getElementById('orderCreateStatus').value || 'open';
            var payment_type_code = document.getElementById('orderCreatePaymentType').value || null;
            if (!customer_id) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
            var rows = tbody.querySelectorAll('tr');
            var items = []; var total = 0;
            for (var i = 0; i < rows.length; i++) {
              var product = rows[i].querySelector('.order-item-product').value;
              var qty = parseInt(rows[i].querySelector('.order-item-qty').value, 10) || 0;
              var priceVal = rows[i].querySelector('.order-item-price').value.trim();
              var price = priceVal !== '' ? parseFloat(priceVal) : null;
              if (product && qty > 0) { items.push({ product_code: product, quantity: qty, price: price, itemId: rows[i].getAttribute('data-item-id') || null }); total += qty * (price || 0); }
            }
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы одну позицию с товаром и количеством.'; return; }
            function errText(e) {
              if (!e) return 'Неизвестная ошибка';
              var d = e.data;
              if (d && d.detail !== undefined) {
                if (typeof d.detail === 'string') return d.detail;
                if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || JSON.stringify(x); }).join(' ');
                return JSON.stringify(d.detail);
              }
              if (d) return JSON.stringify(d);
              return (e.message || e.status || 'Ошибка соединения или сервера') + '';
            }
            var login_agent = document.getElementById('orderCreateAgent').value || null;
            var login_expeditor = document.getElementById('orderCreateExpeditor').value || null;
            var schedInput = document.getElementById('orderScheduledDelivery');
            var scheduled_delivery_at = null;
            if (schedInput && schedInput.value) {
              try {
                var v = schedInput.value.trim().replace(' ', 'T');
                if (v && v.length >= 16) scheduled_delivery_at = new Date(v + (v.length === 16 ? ':00' : '')).toISOString();
              } catch (e) {}
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess() {
              if (msgEl) { msgEl.textContent = 'Заказ сохранён.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOrders(); }, 1500);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить заказ';
              if (errEl) errEl.textContent = errText(e);
            }
            if (isEdit) {
              api('/api/v1/orders/' + orderId, { method: 'PATCH', body: JSON.stringify({ customer_id: parseInt(customer_id, 10), status_code: status_code, payment_type_code: payment_type_code || null, total_amount: total, scheduled_delivery_at: scheduled_delivery_at }) }).then(function () {
                var keptIds = [];
                var chain = Promise.resolve();
                items.forEach(function (it) {
                  if (it.itemId) {
                    keptIds.push(it.itemId);
                    chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items/' + it.itemId, { method: 'PATCH', body: JSON.stringify({ quantity: it.quantity, price: it.price }) }); });
                  } else {
                    chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items', { method: 'POST', body: JSON.stringify({ product_code: it.product_code, quantity: it.quantity, price: it.price }) }); });
                  }
                });
                var toDelete = (orderData.items || []).filter(function (it) { return it.id && keptIds.indexOf(it.id) === -1; });
                toDelete.forEach(function (it) {
                  chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items/' + it.id, { method: 'DELETE' }); });
                });
                chain.then(function () {
                  return api('/api/v1/customers/' + customer_id, { method: 'PATCH', body: JSON.stringify({ login_agent: login_agent, login_expeditor: login_expeditor }) });
                }).then(doneSuccess).catch(doneError);
              }).catch(doneError);
            } else {
              api('/api/v1/orders', { method: 'POST', body: JSON.stringify({ customer_id: parseInt(customer_id, 10), status_code: status_code, payment_type_code: payment_type_code, scheduled_delivery_at: scheduled_delivery_at }) }).then(function (res) {
                var newOrderId = res && res.id;
                if (!newOrderId) { doneError({ data: { detail: 'Заказ не создан.' } }); return; }
                var chain = Promise.resolve();
                items.forEach(function (it) {
                  chain = chain.then(function () { return api('/api/v1/orders/' + newOrderId + '/items', { method: 'POST', body: JSON.stringify({ product_code: it.product_code, quantity: it.quantity, price: it.price }) }); });
                });
                chain.then(function () {
                  return api('/api/v1/orders/' + newOrderId, { method: 'PATCH', body: JSON.stringify({ total_amount: total }) });
                }).then(function () {
                  return api('/api/v1/customers/' + customer_id, { method: 'PATCH', body: JSON.stringify({ login_agent: login_agent, login_expeditor: login_expeditor }) });
                }).then(doneSuccess).catch(doneError);
              }).catch(doneError);
            }
          };
        }
        function bindOrderAdd() {
          var btn = document.getElementById('orderAdd');
          if (!btn) return;
          btn.onclick = function () {
            Promise.all([
              api('/api/v1/customers?limit=1000').catch(function () { return []; }),
              api('/api/v1/orders/statuses').catch(function () { return []; }),
              api('/api/v1/dictionary/products').catch(function () { return []; }),
              api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
              api('/api/v1/dictionary/user-logins').catch(function () { return []; })
            ]).then(function (results) {
              openOrderForm(false, null, null, results[0] || [], results[1] || [], results[2] || [], results[3] || [], results[4] || []);
            }).catch(function (e) {
              var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка';
              var content = document.getElementById('content');
              if (content) content.innerHTML = '<div class="card"><h2>Заказы</h2><p class="err">Ошибка загрузки данных для создания заказа: ' + msg + '</p><p><button type="button" class="btn btn-secondary" id="orderBackToList">Вернуться к списку</button> <button type="button" class="btn btn-primary" id="orderAdd">Создать заказ</button></p><div id="sectionTable"></div></div>';
              bindOrderAdd();
              var backBtn = document.getElementById('orderBackToList');
              if (backBtn) backBtn.onclick = function () { loadSectionOrders(); };
            });
          };
        }
      }
      function loadSectionOrderItems() {
        var content = document.getElementById('content');
        if (!content) return;
        content.innerHTML = '<div class="card"><h2>Позиции заказов</h2><p style="margin:0 0 12px 0">' + (isAdmin() ? '<button type="button" class="btn btn-secondary" id="orderItemsExport">Скачать позиции в Excel</button>' : '') + '</p><div class="form-group" style="margin:12px 0"><label>Поиск позиций заказов</label></div><div id="orderItemsSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="sectionOrderItemsErr" class="err"></div><div id="orderItemsTable"></div></div>';
        var tableDiv = document.getElementById('orderItemsTable');
        var errDiv = document.getElementById('sectionOrderItemsErr');
        var searchRow = document.getElementById('orderItemsSearchRow');
        var exportBtn = document.getElementById('orderItemsExport');
        function formatDateTashkent(isoStr) {
          if (!isoStr) return '';
          try {
            var d = new Date(isoStr);
            return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
          } catch (e) { return isoStr; }
        }
        function getFilters() {
          var customer_id = document.getElementById('orderItemsSearchCustomerId') ? document.getElementById('orderItemsSearchCustomerId').value : '';
          var status_code = document.getElementById('orderItemsSearchStatus') ? document.getElementById('orderItemsSearchStatus').value : '';
          var date_from = document.getElementById('orderItemsSearchDateFrom') ? document.getElementById('orderItemsSearchDateFrom').value : '';
          var date_to = document.getElementById('orderItemsSearchDateTo') ? document.getElementById('orderItemsSearchDateTo').value : '';
          var login_agent = document.getElementById('orderItemsSearchAgent') ? document.getElementById('orderItemsSearchAgent').value : '';
          var login_expeditor = document.getElementById('orderItemsSearchExpeditor') ? document.getElementById('orderItemsSearchExpeditor').value : '';
          var last_updated_by = document.getElementById('orderItemsSearchLastUpdatedBy') ? document.getElementById('orderItemsSearchLastUpdatedBy').value : '';
          return { customer_id: customer_id, status_code: status_code, date_from: date_from, date_to: date_to, login_agent: login_agent, login_expeditor: login_expeditor, last_updated_by: last_updated_by };
        }
        function buildQuery(f) {
          var params = [];
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.status_code) params.push('status_code=' + encodeURIComponent(f.status_code));
          if (f.date_from) params.push('scheduled_delivery_from=' + encodeURIComponent(f.date_from + 'T00:00:00'));
          if (f.date_to) params.push('scheduled_delivery_to=' + encodeURIComponent(f.date_to + 'T23:59:59'));
          if (f.login_agent) params.push('login_agent=' + encodeURIComponent(f.login_agent));
          if (f.login_expeditor) params.push('login_expeditor=' + encodeURIComponent(f.login_expeditor));
          if (f.last_updated_by) params.push('last_updated_by=' + encodeURIComponent(f.last_updated_by));
          return params.length ? '?' + params.join('&') : '';
        }
        function renderTable(list) {
          if (errDiv) errDiv.textContent = '';
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Позиции заказов не найдены. Измените критерии поиска.</p>'; return; }
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>№ заказа</th><th>Клиент</th><th>Дата заказа</th><th>Статус</th><th>Тип оплаты</th><th>Код товара</th><th>Товар</th><th>Количество</th><th>Цена</th><th>Сумма</th><th>Агент</th><th>Экспедитор</th><th>Дата поставки</th><th>Перевод в статус «Доставка»</th><th>Дата закрытия</th><th>Последнее изменение заказа</th><th>Кто изменил</th></tr></thead><tbody>';
          list.forEach(function (r) {
            var amt = (r.amount != null ? r.amount : ((r.quantity || 0) * (r.price != null ? r.price : 0)));
            t += '<tr><td>' + (r.order_no != null ? r.order_no : '') + '</td><td>' + escAttr(r.customer_name || (r.customer_id != null ? 'ID ' + r.customer_id : '')) + '</td><td>' + formatDateTashkent(r.order_date) + '</td><td>' + escAttr(r.status_name || r.status_code || '') + '</td><td>' + escAttr(r.payment_type_name || r.payment_type_code || '') + '</td><td>' + escAttr(r.product_code || '') + '</td><td>' + escAttr(r.product_name || '') + '</td><td>' + (r.quantity != null ? r.quantity : '') + '</td><td>' + (r.price != null ? r.price : '') + '</td><td>' + (amt != null ? amt : '') + '</td><td>' + escAttr(r.login_agent || '') + '</td><td>' + escAttr(r.login_expeditor || '') + '</td><td>' + formatDateTashkent(r.scheduled_delivery_at) + '</td><td>' + formatDateTashkent(r.status_delivery_at) + '</td><td>' + formatDateTashkent(r.closed_at) + '</td><td>' + formatDateTashkent(r.order_last_updated_at) + '</td><td>' + escAttr(r.order_last_updated_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
        }
        function runSearch() {
          var f = getFilters();
          var qs = buildQuery(f);
          api('/api/v1/orders/items' + qs).then(renderTable).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки позиций заказов.';
            tableDiv.innerHTML = '<p>Список позиций не загружен.</p>';
          });
        }
        if (exportBtn) {
          exportBtn.onclick = function () {
            var f = getFilters();
            var qs = buildQuery(f);
            var url = window.location.origin + '/api/v1/orders/items/export' + qs;
            fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order_items.xlsx'; a.click(); URL.revokeObjectURL(a.href);
            }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
          };
        }
        Promise.all([
          api('/api/v1/orders/statuses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; })
        ]).then(function (results) {
          var statuses = results[0] || [];
          var userList = results[1] || [];
          var customers = results[2] || [];
          if (!statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = '<option value="">— Все —</option>'; statuses.forEach(function (s) { statusOpts += '<option value="' + escAttr(s.code) + '">' + escAttr(s.name || s.code) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>';
          var expeditorUserOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            userOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorUserOpts += optHtml;
          });
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="orderItemsSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="orderItemsSearchStatus" style="max-width:140px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки с</label><input type="text" id="orderItemsSearchDateFrom" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="orderItemsSearchDateTo" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Агент</label><select id="orderItemsSearchAgent" style="max-width:160px">' + userOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Экспедитор</label><select id="orderItemsSearchExpeditor" style="max-width:160px">' + expeditorUserOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто изменил</label><select id="orderItemsSearchLastUpdatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="orderItemsSearchBtn">Найти</button>';
          document.getElementById('orderItemsSearchBtn').onclick = runSearch;
          if (window.flatpickr) {
            var df = document.getElementById('orderItemsSearchDateFrom');
            var dt = document.getElementById('orderItemsSearchDateTo');
            if (df) window.flatpickr(df, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
            if (dt) window.flatpickr(dt, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
          }
          tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти».</p>';
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="orderItemsSearchBtn">Загрузить позиции</button>';
          document.getElementById('orderItemsSearchBtn').onclick = runSearch;
        });
      }

      function loadSectionOperations(showCreate) {
        var content = document.getElementById('content');
        if (!content) return;
        var canCreate = (typeof showCreate === 'boolean') ? showCreate : true;
        var addBtn = (isAdmin() && canCreate) ? '<button type="button" class="btn btn-primary" id="opAdd">Создать операцию</button>' : '';
        var exportBtn = isAdmin() ? ' <button type="button" class="btn btn-secondary" id="opExport">Скачать в Excel</button>' : '';
        content.innerHTML = '<div class="card"><h2>Операции</h2><p style="margin:0 0 12px 0">' + addBtn + exportBtn + '</p><div class="form-group" style="margin:12px 0"><label>Поиск операций</label></div><div id="opSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="opSectionErr" class="err"></div><div id="opSectionTable"></div></div>';
        var tableDiv = document.getElementById('opSectionTable');
        var errDiv = document.getElementById('opSectionErr');
        var searchRow = document.getElementById('opSearchRow');
        bindOperationAdd();
        var opExportBtn = document.getElementById('opExport');
        if (opExportBtn) opExportBtn.onclick = function () {
          var url = window.location.origin + '/api/v1/operations/export';
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'operations.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
        };
        function formatDateOp(isoStr) {
          if (!isoStr) return '';
          try { var d = new Date(isoStr); return d.toLocaleDateString('ru-RU'); } catch (e) { return isoStr; }
        }
        function renderOpTable(list) {
          if (errDiv) errDiv.textContent = '';
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Операций не найдено. Измените критерии поиска или создайте операцию.</p>'; return; }
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Действия</th><th>№ операции</th><th>Дата</th><th>Тип</th><th>Статус</th><th>Клиент</th><th>Товар</th><th>Кол-во</th><th>Сумма</th><th>Заказ №</th><th>Кто создал</th></tr></thead><tbody>';
          list.forEach(function (o) {
            t += '<tr><td><button type="button" class="btn btn-secondary btn-small" data-op-edit data-id="' + escAttr(o.id) + '">Изменить</button></td><td>' + escAttr(o.operation_number || '') + '</td><td>' + formatDateOp(o.operation_date) + '</td><td>' + escAttr(o.type_name || o.type_code || '') + '</td><td>' + escAttr(o.status || '') + '</td><td>' + escAttr(o.customer_name || (o.customer_id != null ? 'ID ' + o.customer_id : '')) + '</td><td>' + escAttr(o.product_code || '') + '</td><td>' + (o.quantity != null ? o.quantity : '') + '</td><td>' + (o.amount != null ? o.amount : '') + '</td><td>' + (o.order_id != null ? o.order_id : '') + '</td><td>' + escAttr(o.created_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('[data-op-edit]').forEach(function (el) {
            el.onclick = function () {
              var opId = el.getAttribute('data-id') || '';
              api('/api/v1/operations/' + opId).then(function (opData) {
                Promise.all([
                  api('/api/v1/operation-types').catch(function () { return []; }),
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  openOperationForm(true, opId, opData, results[0] || [], results[1] || [], results[2] || [], results[3] || [], results[4] || [], results[5] || []);
                });
              }).catch(function (e) {
                if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Не удалось загрузить операцию.';
              });
            };
          });
        }
        var OP_SEARCH_STORAGE = 'opSearchFilters';
        function getOpSearchFilters() {
          return {
            type_code: document.getElementById('opSearchType') ? document.getElementById('opSearchType').value : '',
            status: document.getElementById('opSearchStatus') ? document.getElementById('opSearchStatus').value : '',
            customer_id: document.getElementById('opSearchCustomerId') ? document.getElementById('opSearchCustomerId').value : '',
            product_code: document.getElementById('opSearchProduct') ? document.getElementById('opSearchProduct').value : '',
            from_date: document.getElementById('opSearchDateFrom') ? document.getElementById('opSearchDateFrom').value : '',
            to_date: document.getElementById('opSearchDateTo') ? document.getElementById('opSearchDateTo').value : '',
            created_by: document.getElementById('opSearchCreatedBy') ? document.getElementById('opSearchCreatedBy').value : ''
          };
        }
        function setOpSearchFilters(f) {
          if (!f) return;
          var el;
          if (el = document.getElementById('opSearchType')) el.value = f.type_code || '';
          if (el = document.getElementById('opSearchStatus')) el.value = f.status || '';
          if (el = document.getElementById('opSearchCustomerId')) el.value = f.customer_id || '';
          if (el = document.getElementById('opSearchProduct')) el.value = f.product_code || '';
          if (el = document.getElementById('opSearchDateFrom')) el.value = f.from_date || '';
          if (el = document.getElementById('opSearchDateTo')) el.value = f.to_date || '';
          if (el = document.getElementById('opSearchCreatedBy')) el.value = f.created_by || '';
        }
        function runOpSearch() {
          var f = getOpSearchFilters();
          try { localStorage.setItem(OP_SEARCH_STORAGE, JSON.stringify(f)); } catch (e) {}
          var params = [];
          if (f.type_code) params.push('type_code=' + encodeURIComponent(f.type_code));
          if (f.status) params.push('status=' + encodeURIComponent(f.status));
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.product_code) params.push('product_code=' + encodeURIComponent(f.product_code));
          if (f.from_date) params.push('from_date=' + encodeURIComponent(f.from_date));
          if (f.to_date) params.push('to_date=' + encodeURIComponent(f.to_date));
          if (f.created_by) params.push('created_by=' + encodeURIComponent(f.created_by));
          api('/api/v1/operations' + (params.length ? '?' + params.join('&') : '')).then(renderOpTable).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки операций.';
            tableDiv.innerHTML = '<p>Список не загружен.</p>';
          });
        }
        Promise.all([
          api('/api/v1/operation-types').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; }),
          api('/api/v1/dictionary/products').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; })
        ]).then(function (results) {
          var types = results[0] || [];
          var customers = results[1] || [];
          var products = results[2] || [];
          var userList = results[3] || [];
          var typeOpts = '<option value="">— Все —</option>'; types.forEach(function (ty) { typeOpts += '<option value="' + escAttr(ty.code) + '">' + escAttr(ty.name || ty.code) + '</option>'; });
          var statusOpts = '<option value="">— Все —</option><option value="pending">pending</option><option value="completed">completed</option><option value="cancelled">cancelled</option>';
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var prodOpts = '<option value="">— Любой —</option>'; products.forEach(function (p) { prodOpts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>'; userList.forEach(function (u) { userOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Тип</label><select id="opSearchType" style="max-width:160px">' + typeOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="opSearchStatus" style="max-width:100px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="opSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Товар</label><select id="opSearchProduct" style="max-width:200px">' + prodOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата с</label><input type="date" id="opSearchDateFrom" style="max-width:130px"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="date" id="opSearchDateTo" style="max-width:130px"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто создал</label><select id="opSearchCreatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="opSearchBtn">Найти</button>';
          document.getElementById('opSearchBtn').onclick = runOpSearch;
          var savedFilters = null;
          try { var s = localStorage.getItem(OP_SEARCH_STORAGE); if (s) savedFilters = JSON.parse(s); } catch (e) {}
          if (savedFilters) {
            setOpSearchFilters(savedFilters);
          }
          tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти» или оставьте поля пустыми и нажмите «Найти» для полного списка. По умолчанию запрос не выполняется автоматически.</p>';
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="opSearchBtn">Загрузить операции</button>';
          document.getElementById('opSearchBtn').onclick = runOpSearch;
        });
        function openOperationForm(isEdit, operationId, opData, types, customers, products, warehouses, paymentTypes, userList) {
          warehouses = warehouses || []; paymentTypes = paymentTypes || []; userList = userList || [];
          var sel = isEdit && opData ? { type_code: opData.type_code || '', customer_id: opData.customer_id != null ? String(opData.customer_id) : '', product_code: opData.product_code || '', quantity: opData.quantity != null ? opData.quantity : '', amount: opData.amount != null ? opData.amount : '', comment: opData.comment || '', order_id: opData.order_id != null ? opData.order_id : '', operation_date: opData.operation_date ? opData.operation_date.slice(0, 10) : '', warehouse_from: opData.warehouse_from || '', warehouse_to: opData.warehouse_to || '', payment_type_code: opData.payment_type_code || '', status: opData.status || 'pending', expeditor_login: opData.expeditor_login || '', cashier_login: opData.cashier_login || '', storekeeper_login: opData.storekeeper_login || '' } : { type_code: '', customer_id: '', product_code: '', quantity: '1', amount: '', comment: '', order_id: '', operation_date: new Date().toISOString().slice(0, 10), warehouse_from: '', warehouse_to: '', payment_type_code: '', status: 'pending', expeditor_login: '', cashier_login: '', storekeeper_login: '' };
          var typeOpts = '<option value="">— Выберите тип —</option>'; types.forEach(function (ty) { var o = (ty.code === sel.type_code) ? ' selected' : ''; typeOpts += '<option value="' + escAttr(ty.code) + '"' + o + '>' + escAttr(ty.name || ty.code) + '</option>'; });
          var custOpts = '<option value="">— Не указан —</option>'; customers.forEach(function (c) { var o = (String(c.id) === sel.customer_id) ? ' selected' : ''; custOpts += '<option value="' + (c.id != null ? c.id : '') + '"' + o + '>' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var prodOpts = '<option value="">— Не указан —</option>'; products.forEach(function (p) { var o = (p.code === sel.product_code) ? ' selected' : ''; prodOpts += '<option value="' + escAttr(p.code) + '"' + o + '>' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var whOpts = '<option value="">— Не указан —</option>'; warehouses.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var payOpts = '<option value="">— Не указан —</option>'; paymentTypes.forEach(function (pt) { var o = (pt.code === sel.payment_type_code) ? ' selected' : ''; payOpts += '<option value="' + escAttr(pt.code) + '"' + o + '>' + escAttr(pt.name || pt.code) + '</option>'; });
          var statusOpts = '<option value="pending"' + (sel.status === 'pending' ? ' selected' : '') + '>pending</option><option value="completed"' + (sel.status === 'completed' ? ' selected' : '') + '>completed</option><option value="cancelled"' + (sel.status === 'cancelled' ? ' selected' : '') + '>cancelled</option>';
          var userOpts = '<option value="">— Не указан —</option>'; userList.forEach(function (u) { userOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>'; });
          var content = document.getElementById('content');
          if (!content) return;
          var statusBlock = isEdit ? ('<div class="form-group" id="opFormStatusBlock"><label>Статус</label><select id="opCreateStatus">' + statusOpts + '</select></div>') : '';
          content.innerHTML = '<div class="card"><h2 id="opFormTitle">Создание операции</h2><div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div><div class="form-group"><label>Дата операции</label><input type="text" id="opCreateDate" placeholder="дд.мм.гггг" autocomplete="off"></div><div class="form-group"><label>Тип операции</label><select id="opCreateType" required>' + typeOpts + '</select></div>' + statusBlock + '<div class="form-group"><label>Склад от</label><select id="opCreateWarehouseFrom">' + whOpts + '</select></div><div class="form-group"><label>Склад в</label><select id="opCreateWarehouseTo">' + whOpts + '</select></div><div class="form-group"><label>Клиент</label><select id="opCreateCustomer">' + custOpts + '</select></div><div class="form-group"><label>Товар</label><select id="opCreateProduct">' + prodOpts + '</select></div><div class="form-group"><label>Количество</label><input type="number" id="opCreateQuantity" min="0" placeholder="необяз."></div><div class="form-group"><label>Сумма</label><input type="number" id="opCreateAmount" step="0.01" placeholder="необяз."></div><div class="form-group"><label>Тип оплаты</label><select id="opCreatePaymentType">' + payOpts + '</select></div><div class="form-group"><label>Заказ №</label><input type="number" id="opCreateOrderId" placeholder="необяз." min="0"></div><div class="form-group"><label>Экспедитор</label><select id="opCreateExpeditor">' + userOpts + '</select></div><div class="form-group"><label>Кассир</label><select id="opCreateCashier">' + userOpts + '</select></div><div class="form-group"><label>Кладовщик</label><select id="opCreateStorekeeper">' + userOpts + '</select></div><div class="form-group"><label>Комментарий</label><input type="text" id="opCreateComment" placeholder="необяз."></div><div style="margin-top:24px;padding:12px;background:#f8f9fa;border-radius:6px"><div class="form-group" style="margin-bottom:0"><label style="font-size:12px;color:#666">Кто создал</label><div id="opCreatedBy" class="form-readonly">—</div></div></div><p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opCreateSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opCreateCancel">Отмена</button></p></div>';
          document.getElementById('opFormTitle').textContent = isEdit ? ('Редактирование ' + (opData.operation_number || operationId)) : 'Создание операции';
          var opDateEl = document.getElementById('opCreateDate');
          if (opDateEl) {
            opDateEl.value = sel.operation_date ? sel.operation_date.replace(/^(\d{4})-(\d{2})-(\d{2}).*/, '$3.$2.$1') : '';
            if (window.flatpickr) {
              window.flatpickr(opDateEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
            }
          }
          document.getElementById('opCreateQuantity').value = sel.quantity;
          document.getElementById('opCreateAmount').value = sel.amount;
          document.getElementById('opCreateComment').value = sel.comment;
          document.getElementById('opCreateOrderId').value = sel.order_id;
          var wFrom = document.getElementById('opCreateWarehouseFrom'); if (wFrom) wFrom.value = sel.warehouse_from || '';
          var wTo = document.getElementById('opCreateWarehouseTo'); if (wTo) wTo.value = sel.warehouse_to || '';
          document.getElementById('opCreatePaymentType').value = sel.payment_type_code || '';
          var statusSel = document.getElementById('opCreateStatus'); if (statusSel) statusSel.value = sel.status || 'pending';
          var exSel = document.getElementById('opCreateExpeditor'); if (exSel) exSel.value = sel.expeditor_login || '';
          var cashSel = document.getElementById('opCreateCashier'); if (cashSel) cashSel.value = sel.cashier_login || '';
          var stSel = document.getElementById('opCreateStorekeeper'); if (stSel) stSel.value = sel.storekeeper_login || '';
          if (isEdit && opData && opData.created_by) document.getElementById('opCreatedBy').textContent = opData.created_by; else document.getElementById('opCreatedBy').textContent = '—';
          document.getElementById('opCreateCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opCreateSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var operation_dateRaw = document.getElementById('opCreateDate').value || '';
            var operation_date = null;
            if (operation_dateRaw) {
              var m = operation_dateRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
              if (m) operation_date = m[3] + '-' + m[2].padStart(2, '0') + '-' + m[1].padStart(2, '0') + 'T12:00:00';
              else if (/^\d{4}-\d{2}-\d{2}/.test(operation_dateRaw)) operation_date = operation_dateRaw.slice(0, 10) + (operation_dateRaw.indexOf('T') >= 0 ? '' : 'T12:00:00');
            }
            var type_code = document.getElementById('opCreateType').value;
            var statusEl = document.getElementById('opCreateStatus');
            var status = (statusEl ? statusEl.value : null) || 'pending';
            var warehouse_from = document.getElementById('opCreateWarehouseFrom').value || null;
            var warehouse_to = document.getElementById('opCreateWarehouseTo').value || null;
            var customer_id = document.getElementById('opCreateCustomer').value;
            var product_code = document.getElementById('opCreateProduct').value || null;
            var qVal = document.getElementById('opCreateQuantity').value.trim();
            var quantity = qVal !== '' ? parseInt(qVal, 10) : null;
            var amountVal = document.getElementById('opCreateAmount').value.trim();
            var amount = amountVal !== '' ? parseFloat(amountVal) : null;
            var payment_type_code = document.getElementById('opCreatePaymentType').value || null;
            var orderIdVal = document.getElementById('opCreateOrderId').value.trim();
            var orderIdNum = orderIdVal !== '' ? parseInt(orderIdVal, 10) : NaN;
            var order_id = (orderIdNum > 0) ? orderIdNum : null;
            var comment = document.getElementById('opCreateComment').value.trim() || null;
            var expeditor_login = document.getElementById('opCreateExpeditor').value || null;
            var cashier_login = document.getElementById('opCreateCashier').value || null;
            var storekeeper_login = document.getElementById('opCreateStorekeeper').value || null;
            if (!type_code) { if (errEl) errEl.textContent = 'Выберите тип операции.'; return; }
            function errText(e) {
              if (!e) return 'Неизвестная ошибка';
              var d = e.data;
              if (d && d.detail !== undefined) { if (typeof d.detail === 'string') return d.detail; if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || JSON.stringify(x); }).join(' '); return JSON.stringify(d.detail); }
              if (d) return JSON.stringify(d);
              return (e.message || e.status || 'Ошибка') + '';
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess() {
              if (msgEl) { msgEl.textContent = 'Операция сохранена.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 1500);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              if (errEl) errEl.textContent = errText(e);
            }
            var payload = { type_code: type_code, operation_date: operation_date, status: status, warehouse_from: warehouse_from, warehouse_to: warehouse_to, customer_id: customer_id ? parseInt(customer_id, 10) : null, product_code: product_code, quantity: quantity, amount: amount, payment_type_code: payment_type_code, order_id: order_id, comment: comment, expeditor_login: expeditor_login, cashier_login: cashier_login, storekeeper_login: storekeeper_login };
            if (isEdit) {
              api('/api/v1/operations/' + operationId, { method: 'PATCH', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
            } else {
              api('/api/v1/operations', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
            }
          };
        }
        function buildWarehouseReceiptForm(config, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehouses.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var prodOpts = '<option value="">— Выберите товар —</option>';
          products.forEach(function (p) { prodOpts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Приход на склад') + '</h2>';
          if (config.description) formHtml += '<p style="color:#666;margin-bottom:16px">' + escAttr(config.description) + '</p>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          var productsMap = {};
          products.forEach(function (p) { productsMap[p.code] = p; });
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="opWhReceiptWarehouseTo" required>' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары</h3><div style="overflow-x:auto"><table id="opWhReceiptItemsTable" style="width:100%"><thead><tr><th>Товар <span style="color:#c00">*</span></th><th>Срок годности <span style="color:#c00">*</span></th><th>Количество <span style="color:#c00">*</span></th><th>Цена (из справочника)</th><th>Сумма</th><th>Код партии (авто)</th><th></th></tr></thead><tbody id="opWhReceiptItemsBody"><tr class="op-wh-receipt-row"><td><select class="op-wh-receipt-product" required>' + prodOpts + '</select></td><td><input type="text" class="op-wh-receipt-expiry" placeholder="дд.мм.гггг" required autocomplete="off"></td><td><input type="number" class="op-wh-receipt-quantity" min="1" required></td><td class="op-wh-receipt-price" style="text-align:right;padding:8px;font-weight:600">—</td><td class="op-wh-receipt-sum" style="text-align:right;padding:8px;font-weight:600">—</td><td><input type="text" class="op-wh-receipt-batch" readonly style="background:#f0f0f0"></td><td><button type="button" class="btn btn-secondary btn-small op-wh-receipt-remove" style="display:none">Удалить</button></td></tr></tbody><tfoot id="opWhReceiptItemsFooter"><tr style="background:#f8f9fa;font-weight:600"><td colspan="3" style="text-align:right;padding:10px">Итого:</td><td></td><td id="opWhReceiptTotalSum" style="text-align:right;padding:10px">0</td><td colspan="2"></td></tr></tfoot></table></div><button type="button" class="btn btn-secondary" id="opWhReceiptAddRow" style="margin-top:8px">+ Добавить товар</button></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="opWhReceiptComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opWhReceiptSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opWhReceiptCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var expiryInputs = content.querySelectorAll('.op-wh-receipt-expiry');
          expiryInputs.forEach(function (el) {
            if (window.flatpickr) window.flatpickr(el, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
          });
          function updateRowCalculations(row) {
            var productSel = row.querySelector('.op-wh-receipt-product');
            var expiryInp = row.querySelector('.op-wh-receipt-expiry');
            var quantityInp = row.querySelector('.op-wh-receipt-quantity');
            var batchInp = row.querySelector('.op-wh-receipt-batch');
            var priceCell = row.querySelector('.op-wh-receipt-price');
            var sumCell = row.querySelector('.op-wh-receipt-sum');
            if (!productSel || !expiryInp || !batchInp || !priceCell || !sumCell) return;
            var productCode = (productSel.value || '').trim();
            var expiryRaw = (expiryInp.value || '').trim();
            var quantity = parseInt(quantityInp ? quantityInp.value : 0, 10) || 0;
            var product = productsMap[productCode];
            var price = product && product.price ? parseFloat(product.price) : 0;
            if (productCode && expiryRaw) {
              var m = expiryRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
              if (!m) {
                var iso = expiryRaw.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (iso) m = [null, iso[3], iso[2], iso[1]];
              }
              if (m) {
                var ddmmyyyy = m[1].padStart(2, '0') + m[2].padStart(2, '0') + m[3];
                batchInp.value = productCode + '_' + ddmmyyyy;
              }
            } else {
              batchInp.value = '';
            }
            priceCell.textContent = price > 0 ? price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум' : '—';
            var sum = price * quantity;
            sumCell.textContent = sum > 0 ? sum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум' : '—';
            updateTotalSum();
          }
          function updateTotalSum() {
            var rows = document.querySelectorAll('.op-wh-receipt-row');
            var totalSum = 0;
            var totalQty = 0;
            rows.forEach(function (row) {
              var quantityInp = row.querySelector('.op-wh-receipt-quantity');
              var productSel = row.querySelector('.op-wh-receipt-product');
              if (!quantityInp || !productSel) return;
              var productCode = (productSel.value || '').trim();
              var quantity = parseInt(quantityInp.value, 10) || 0;
              var product = productsMap[productCode];
              var price = product && product.price ? parseFloat(product.price) : 0;
              totalQty += quantity;
              totalSum += price * quantity;
            });
            var totalSumEl = document.getElementById('opWhReceiptTotalSum');
            if (totalSumEl) {
              totalSumEl.innerHTML = totalSum > 0 ? totalSum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум<br><small style="font-weight:normal;color:#666">(' + totalQty + ' шт.)</small>' : '0';
            }
          }
          function attachRowHandlers(row) {
            var productSel = row.querySelector('.op-wh-receipt-product');
            var expiryInp = row.querySelector('.op-wh-receipt-expiry');
            var quantityInp = row.querySelector('.op-wh-receipt-quantity');
            var removeBtn = row.querySelector('.op-wh-receipt-remove');
            if (productSel) productSel.onchange = function () { updateRowCalculations(row); };
            if (expiryInp) {
              expiryInp.onchange = function () { updateRowCalculations(row); };
              expiryInp.oninput = function () { updateRowCalculations(row); };
            }
            if (quantityInp) {
              quantityInp.onchange = function () { updateRowCalculations(row); };
              quantityInp.oninput = function () { updateRowCalculations(row); };
            }
            if (removeBtn) removeBtn.onclick = function () { row.remove(); updateTotalSum(); };
          }
          var rows = content.querySelectorAll('.op-wh-receipt-row');
          rows.forEach(function (row) {
            attachRowHandlers(row);
            updateRowCalculations(row);
          });
          document.getElementById('opWhReceiptAddRow').onclick = function () {
            var tbody = document.getElementById('opWhReceiptItemsBody');
            var newRow = document.createElement('tr');
            newRow.className = 'op-wh-receipt-row';
            newRow.innerHTML = '<td><select class="op-wh-receipt-product" required>' + prodOpts + '</select></td><td><input type="text" class="op-wh-receipt-expiry" placeholder="дд.мм.гггг" required autocomplete="off"></td><td><input type="number" class="op-wh-receipt-quantity" min="1" required></td><td class="op-wh-receipt-price" style="text-align:right;padding:8px;font-weight:600">—</td><td class="op-wh-receipt-sum" style="text-align:right;padding:8px;font-weight:600">—</td><td><input type="text" class="op-wh-receipt-batch" readonly style="background:#f0f0f0"></td><td><button type="button" class="btn btn-secondary btn-small op-wh-receipt-remove">Удалить</button></td>';
            tbody.appendChild(newRow);
            var expiryEl = newRow.querySelector('.op-wh-receipt-expiry');
            if (expiryEl && window.flatpickr) window.flatpickr(expiryEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
            attachRowHandlers(newRow);
            var allRows = tbody.querySelectorAll('.op-wh-receipt-row');
            if (allRows.length > 1) allRows.forEach(function (r) { var btn = r.querySelector('.op-wh-receipt-remove'); if (btn) btn.style.display = 'inline-block'; });
          };
          document.getElementById('opWhReceiptCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opWhReceiptSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opWhReceiptSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var warehouseTo = document.getElementById('opWhReceiptWarehouseTo').value;
            if (!warehouseTo) { if (errEl) errEl.textContent = 'Выберите склад'; return; }
            var rows = document.querySelectorAll('.op-wh-receipt-row');
            if (!rows.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар'; return; }
            var items = [];
            var hasErrors = false;
            rows.forEach(function (row, idx) {
              var productSel = row.querySelector('.op-wh-receipt-product');
              var expiryInp = row.querySelector('.op-wh-receipt-expiry');
              var quantityInp = row.querySelector('.op-wh-receipt-quantity');
              var batchInp = row.querySelector('.op-wh-receipt-batch');
              if (!productSel || !expiryInp || !quantityInp || !batchInp) return;
              var productCode = (productSel.value || '').trim();
              var expiryDate = (expiryInp.value || '').trim();
              var quantity = parseInt(quantityInp.value, 10);
              var batchCode = (batchInp.value || '').trim();
              if (!productCode || !expiryDate || isNaN(quantity) || quantity <= 0) {
                hasErrors = true;
                return;
              }
              items.push({ product_code: productCode, expiry_date: expiryDate, quantity: quantity, batch_code: batchCode });
            });
            if (hasErrors) { if (errEl) errEl.textContent = 'Заполните все поля для всех товаров'; return; }
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар'; return; }
            var payload = { warehouse_to: warehouseTo, items: items, comment: (document.getElementById('opWhReceiptComment').value || '').trim() || null };
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess(result) {
              if (msgEl) { msgEl.textContent = 'Операции созданы: ' + (result.operations_count || items.length) + ' шт.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 2000);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              var detail = e && e.data && e.data.detail;
              if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
              if (detail && detail.errors) {
                var errs = [];
                for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                if (errEl) errEl.textContent = errs.join('; ');
              } else if (errEl) errEl.textContent = 'Ошибка сохранения';
            }
            api('/api/v1/operations/warehouse_receipt/create-batch', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
          };
        }
        function buildAllocationForm(config, customers, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var expOpts = '<option value="">— Не указан —</option>';
          (userList || []).forEach(function (u) {
            if ((u.role || '').toLowerCase() !== 'expeditor') return;
            expOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
          });
          // Список товаров будем ограничивать только теми, у которых есть остатки на выбранном складе
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Выдача экспедитору') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          // порядок: Склад от → Экспедитор → Склад в (серое, автозаполняется по экспедитору)
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="allocWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Экспедитор <span style="color:#c00">*</span></label><select id="allocExpeditor" required>' + expOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="allocWhTo" required disabled style="background-color:#eee; color:#555;">' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары</h3><div style="overflow-x:auto"><table id="allocItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество</th><th>Вес</th><th>Цена</th><th>Сумма</th><th></th></tr></thead><tbody id="allocItemsBody"><tr class="alloc-row"><td><select class="alloc-product" required><option value=\"\">— Выберите товар —</option></select></td><td><select class="alloc-batch" required><option value=\"\">— нет данных —</option></select></td><td class="alloc-expiry">—</td><td class="alloc-days" style="text-align:center">—</td><td class="alloc-available" style="text-align:right">0</td><td><input type="number" class="alloc-qty" min="1" required></td><td class="alloc-weight" style="text-align:right">—</td><td class="alloc-price" style="text-align:right">—</td><td class="alloc-sum" style="text-align:right">—</td><td><button type="button" class="btn btn-secondary btn-small alloc-remove" style="display:none">Удалить</button></td></tr></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="6" style="text-align:right;padding:8px">Итого:</td><td id="allocTotalWeight" style="text-align:right;padding:8px">0</td><td></td><td id="allocTotalQty" style="text-align:right;padding:8px">0</td><td></td><td id="allocTotalSum" style="text-align:right;padding:8px">0</td><td></td></tr></tfoot></table></div><button type="button" class="btn btn-secondary" id="allocAddRow" style="margin-top:8px">+ Добавить товар</button></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="allocComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="allocSave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="allocCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var stockCache = null;
          function loadStock(whCode) {
            if (!whCode) { stockCache = null; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
            }).catch(function () { stockCache = []; });
          }
          function buildProductOptionsFromStock() {
            var opts = '<option value="">— Выберите товар —</option>';
            if (!stockCache || !stockCache.length) return opts;
            var withStock = {};
            stockCache.forEach(function (s) {
              if (s.product_code) withStock[s.product_code] = true;
            });
            productsList.forEach(function (p) {
              if (withStock[p.code]) {
                opts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>';
              }
            });
            return opts;
          }
          function updateRowFromStock(row) {
            var productSel = row.querySelector('.alloc-product');
            var batchSel = row.querySelector('.alloc-batch');
            var expiryCell = row.querySelector('.alloc-expiry');
            var daysCell = row.querySelector('.alloc-days');
            var availCell = row.querySelector('.alloc-available');
            var weightCell = row.querySelector('.alloc-weight');
            var priceCell = row.querySelector('.alloc-price');
            var sumCell = row.querySelector('.alloc-sum');
            var qtyInp = row.querySelector('.alloc-qty');
            if (!productSel || !batchSel) return;
            var whFrom = document.getElementById('allocWhFrom').value;
            var productCode = productSel.value || '';
            var rows = (stockCache || []).filter(function (s) { return s.product_code === productCode && (!whFrom || s.warehouse_code === whFrom); });
            rows.sort(function (a, b) {
              var ea = a.expiry_date || ''; var eb = b.expiry_date || '';
              return ea.localeCompare(eb);
            });
            var opts = '<option value="">— Выберите партию —</option>';
            rows.forEach(function (r) {
              var days = (r.days_until_expiry != null ? r.days_until_expiry : '');
              var status = r.expiry_status || {};
              var color = status.color || '';
              var icon = status.icon || '';
              opts += '<option value="' + escAttr(r.batch_code || '') + '" data-batch-id="' + escAttr(r.batch_id || '') + '" data-expiry="' + escAttr(r.expiry_date || '') + '" data-available="' + (r.total_qty != null ? r.total_qty : 0) + '" data-days="' + days + '" data-color="' + escAttr(color) + '" data-icon="' + escAttr(icon) + '">' + escAttr((r.batch_code || '') + (r.expiry_date ? ' — ' + formatDateOnly(r.expiry_date) : '')) + '</option>';
            });
            batchSel.innerHTML = opts;
            if (rows.length) batchSel.selectedIndex = 1;
            updateBatchInfo();
            function updateBatchInfo() {
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var expiry = opt ? opt.getAttribute('data-expiry') || '' : '';
              var avail = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              var daysAttr = opt ? opt.getAttribute('data-days') : null;
              var color = opt ? opt.getAttribute('data-color') || '' : '';
              var icon = opt ? opt.getAttribute('data-icon') || '' : '';
              expiryCell.textContent = expiry ? formatDateOnly(expiry) : '—';
              availCell.textContent = avail;
              if (daysCell) {
                if (daysAttr === null || daysAttr === '' || isNaN(parseInt(daysAttr, 10))) {
                  daysCell.textContent = '—';
                } else {
                  var days = parseInt(daysAttr, 10);
                  var badgeColor = '#28a745';
                  if (color === 'YELLOW') badgeColor = '#ffc107';
                  else if (color === 'RED') badgeColor = '#dc3545';
                  else if (color === 'BLACK') badgeColor = '#343a40';
                  var iconChar = icon || (color === 'YELLOW' ? '🟡' : (color === 'RED' ? '🔴' : (color === 'BLACK' ? '⚫' : '🟢')));
                  var daysText = days + ' дн.';
                  daysCell.innerHTML = '<span class="badge" style="background-color:' + badgeColor + ';color:#fff;border-radius:4px;padding:2px 6px;font-size:11px;">' + iconChar + ' ' + daysText + '</span>';
                }
              }
              var prod = productsMap[productCode];
              var price = prod && prod.price ? parseFloat(prod.price) : 0;
              var weightG = prod && prod.weight_g ? parseFloat(prod.weight_g) : 0;
              priceCell.textContent = price ? price.toFixed(2) : '—';
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (qty > avail) qty = avail;
              if (qtyInp.value && parseInt(qtyInp.value, 10) !== qty) qtyInp.value = qty || '';
              var sum = price * qty;
              sumCell.textContent = sum ? sum.toFixed(2) : '—';
              if (weightCell) {
                var totalWeightG = weightG * qty;
                if (totalWeightG > 0) {
                  var totalWeightKg = (totalWeightG / 1000).toFixed(2);
                  weightCell.textContent = totalWeightKg + ' кг';
                } else {
                  weightCell.textContent = '—';
                }
              }
              updateTotals();
            }
            batchSel.onchange = updateBatchInfo;
            qtyInp.oninput = updateBatchInfo;
            qtyInp.onchange = updateBatchInfo;
          }
          function updateTotals() {
            var rows = document.querySelectorAll('.alloc-row');
            var totalQty = 0;
            var totalSum = 0;
            var totalWeightG = 0;
            rows.forEach(function (row) {
              var qty = parseInt((row.querySelector('.alloc-qty') || {}).value || '0', 10) || 0;
              var productSel = row.querySelector('.alloc-product');
              if (!productSel) return;
              var prod = productsMap[productSel.value || ''];
              var price = prod && prod.price ? parseFloat(prod.price) : 0;
              var weightG = prod && prod.weight_g ? parseFloat(prod.weight_g) : 0;
              totalQty += qty;
              totalSum += price * qty;
              totalWeightG += weightG * qty;
            });
            var qEl = document.getElementById('allocTotalQty');
            var sEl = document.getElementById('allocTotalSum');
            var wEl = document.getElementById('allocTotalWeight');
            if (qEl) qEl.textContent = totalQty;
            if (sEl) sEl.textContent = totalSum ? totalSum.toFixed(2) : '0';
            if (wEl) {
              if (totalWeightG > 0) {
                var totalWeightKg = (totalWeightG / 1000).toFixed(2);
                wEl.textContent = totalWeightKg + ' кг';
              } else {
                wEl.textContent = '0';
              }
            }
          }
          function attachAllocRowHandlers(row) {
            var prodSel = row.querySelector('.alloc-product');
            var qtyInp = row.querySelector('.alloc-qty');
            var batchSel = row.querySelector('.alloc-batch');
            var removeBtn = row.querySelector('.alloc-remove');
            if (prodSel) prodSel.onchange = function () { updateRowFromStock(row); updateTotals(); };
            if (qtyInp) qtyInp.oninput = function () { updateRowFromStock(row); updateTotals(); };
            if (batchSel) batchSel.onchange = function () { updateRowFromStock(row); updateTotals(); };
            if (removeBtn) removeBtn.onclick = function () { row.remove(); updateTotals(); };
          }
          document.getElementById('allocWhFrom').onchange = function () {
            loadStock(this.value).then(function () {
              var rows = document.querySelectorAll('.alloc-row');
              var prodOptsHtml = buildProductOptionsFromStock();
              rows.forEach(function (row) {
                var prodSel = row.querySelector('.alloc-product');
                if (prodSel) {
                  var prev = prodSel.value || '';
                  prodSel.innerHTML = prodOptsHtml;
                  if (prev) {
                    var opt = prodSel.querySelector('option[value="' + prev.replace(/"/g, '&quot;') + '"]');
                    if (opt) prodSel.value = prev;
                  }
                }
                updateRowFromStock(row);
              });
              updateTotals();
            });
          };
          var expSel = document.getElementById('allocExpeditor');
          if (expSel) {
            expSel.onchange = function () {
              var login = this.value || '';
              var whToSel = document.getElementById('allocWhTo');
              if (!whToSel) return;
              var match = null;
              if (login) {
                (warehousesList || []).forEach(function (w) {
                  if (!match && w.expeditor_login && w.expeditor_login === login) match = w;
                });
              }
              if (match && match.code) {
                // Автоподстановка склада по экспедитору, поле только для просмотра (серое)
                whToSel.value = match.code;
              } else {
                // Если связки нет — очищаем поле
                whToSel.value = '';
              }
            };
          }
          var firstRow = document.querySelector('.alloc-row');
          if (firstRow) attachAllocRowHandlers(firstRow);
          document.getElementById('allocAddRow').onclick = function () {
            var tbody = document.getElementById('allocItemsBody');
            var row = document.createElement('tr');
            row.className = 'alloc-row';
            var prodOptsNow = buildProductOptionsFromStock();
            row.innerHTML = '<td><select class="alloc-product" required>' + prodOptsNow + '</select></td><td><select class="alloc-batch" required><option value="">— нет данных —</option></select></td><td class="alloc-expiry">—</td><td class="alloc-days" style="text-align:center">—</td><td class="alloc-available" style="text-align:right">0</td><td><input type="number" class="alloc-qty" min="1" required></td><td class="alloc-weight" style="text-align:right">—</td><td class="alloc-price" style="text-align:right">—</td><td class="alloc-sum" style="text-align:right">—</td><td><button type="button" class="btn btn-secondary btn-small alloc-remove">Удалить</button></td>';
            tbody.appendChild(row);
            attachAllocRowHandlers(row);
          };
          document.getElementById('allocCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('allocSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('allocWhFrom').value;
            var whTo = document.getElementById('allocWhTo').value;
            var expeditor = document.getElementById('allocExpeditor').value;
            if (errEl) errEl.textContent = '';
            if (!whFrom || !whTo) { if (errEl) errEl.textContent = 'Выберите склады от и в.'; return; }
            if (!expeditor) { if (errEl) errEl.textContent = 'Выберите экспедитора.'; return; }
            var rows = document.querySelectorAll('.alloc-row');
            var items = [];
            rows.forEach(function (row) {
              var prodSel = row.querySelector('.alloc-product');
              var batchSel = row.querySelector('.alloc-batch');
              var qtyInp = row.querySelector('.alloc-qty');
              if (!prodSel || !batchSel || !qtyInp) return;
              var productCode = (prodSel.value || '').trim();
              var batchCode = (batchSel.value || '').trim();
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (!productCode || !batchCode || !qty) return;
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var available = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              if (qty > available) qty = available;
              items.push({ product_code: productCode, batch_code: batchCode, quantity: qty });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар.'; return; }
            var comment = (document.getElementById('allocComment').value || '').trim() || null;
            var createdBy = (window.currentUser && currentUser.login) ? currentUser.login : null;
            var saveBtn = document.getElementById('allocSave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0;
            var idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Операции созданы: ' + createdCount + ' шт.'; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              api('/api/v1/operations/allocation', {
                method: 'POST',
                body: JSON.stringify({
                  warehouse_from: whFrom,
                  warehouse_to: whTo,
                  product_code: it.product_code,
                  batch_code: it.batch_code,
                  quantity: it.quantity,
                  expeditor_login: expeditor,
                  created_by: createdBy,
                  comment: comment
                })
              }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) {
                  var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                  if (errEl) errEl.textContent = errs.join('; ');
                } else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildDeliveryForm(config, customers, products, warehouses, paymentTypes, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var expOpts = '<option value="">— Не указан —</option>';
          (userList || []).forEach(function (u) {
            if ((u.role || '').toLowerCase() !== 'expeditor') return;
            expOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
          });
          var custOpts = '<option value="">— Выберите клиента —</option>';
          customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var payOpts = '<option value="">— Выберите тип оплаты —</option>';
          paymentTypes.forEach(function (pt) { payOpts += '<option value="' + escAttr(pt.code) + '">' + escAttr(pt.name || pt.code) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Доставка клиенту') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Заказ № <span style="color:#c00">*</span></label><input type="number" id="deliveryOrderId" min="1" required placeholder="Введите номер заказа" autocomplete="off"></div>';
          formHtml += '<div id="deliveryOrderInfo" style="margin-bottom:16px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="deliveryWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Экспедитор <span style="color:#c00">*</span></label><select id="deliveryExpeditor" required>' + expOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Клиент <span style="color:#c00">*</span></label><select id="deliveryCustomer" required>' + custOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Тип оплаты <span style="color:#c00">*</span></label><select id="deliveryPaymentType" required>' + payOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары заказа</h3><div style="overflow-x:auto"><table id="deliveryItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество (заказ)</th><th>Количество (доставка)</th><th>Цена</th><th>Сумма</th></tr></thead><tbody id="deliveryItemsBody"></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="6" style="text-align:right;padding:8px">Итого:</td><td id="deliveryTotalQty" style="text-align:right;padding:8px">0</td><td></td><td id="deliveryTotalSum" style="text-align:right;padding:8px">0</td><td></td></tr></tfoot></table></div></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="deliveryComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="deliverySave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="deliveryCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var orderData = null;
          var stockCache = null;
          function loadStock(whCode) {
            if (!whCode) { stockCache = null; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
            }).catch(function () { stockCache = []; });
          }
          document.getElementById('deliveryOrderId').onchange = function () {
            var orderId = parseInt(this.value || '0', 10) || 0;
            var infoDiv = document.getElementById('deliveryOrderInfo');
            var tbody = document.getElementById('deliveryItemsBody');
            if (!orderId) {
              infoDiv.style.display = 'none';
              tbody.innerHTML = '';
              orderData = null;
              return;
            }
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = '<p style="color:#666">Загрузка заказа...</p>';
            api('/api/v1/orders/' + orderId).then(function (order) {
              orderData = order;
              var custSel = document.getElementById('deliveryCustomer');
              var paySel = document.getElementById('deliveryPaymentType');
              if (custSel && order.customer_id) custSel.value = order.customer_id;
              if (paySel && order.payment_type_code) paySel.value = order.payment_type_code;
              infoDiv.innerHTML = '<p style="color:#28a745;font-weight:600">Заказ №' + order.order_no + ' — ' + escAttr(order.customer_name || '') + '</p>';
              tbody.innerHTML = '';
              if (!order.items || !order.items.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:16px;color:#666">В заказе нет товаров</td></tr>';
                return;
              }
              var whFrom = document.getElementById('deliveryWhFrom').value;
              if (whFrom) loadStock(whFrom).then(function () { renderOrderItems(order.items); });
              else renderOrderItems(order.items);
            }).catch(function (e) {
              var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка загрузки заказа';
              infoDiv.innerHTML = '<p class="err">Ошибка: ' + escAttr(msg) + '</p>';
              tbody.innerHTML = '';
              orderData = null;
            });
          };
          document.getElementById('deliveryWhFrom').onchange = function () {
            var whCode = this.value || '';
            loadStock(whCode).then(function () {
              if (orderData && orderData.items) renderOrderItems(orderData.items);
            });
          };
          function renderOrderItems(items) {
            var tbody = document.getElementById('deliveryItemsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!items || !items.length) {
              tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:16px;color:#666">Нет товаров</td></tr>';
              return;
            }
            var whFrom = document.getElementById('deliveryWhFrom').value;
            items.forEach(function (item) {
              var product = productsMap[item.product_code] || {};
              var productName = (product.code || '') + ' — ' + (product.name || '');
              var stockRows = (stockCache || []).filter(function (s) { return s.product_code === item.product_code && (!whFrom || s.warehouse_code === whFrom); });
              stockRows.sort(function (a, b) {
                var ea = a.expiry_date || ''; var eb = b.expiry_date || '';
                return ea.localeCompare(eb);
              });
              var batchOpts = '<option value="">— Выберите партию —</option>';
              stockRows.forEach(function (r) {
                var days = (r.days_until_expiry != null ? r.days_until_expiry : '');
                var status = r.expiry_status || {};
                var color = status.color || '';
                var icon = status.icon || '';
                batchOpts += '<option value="' + escAttr(r.batch_code || '') + '" data-batch-id="' + escAttr(r.batch_id || '') + '" data-expiry="' + escAttr(r.expiry_date || '') + '" data-available="' + (r.total_qty != null ? r.total_qty : 0) + '" data-days="' + days + '" data-color="' + escAttr(color) + '" data-icon="' + escAttr(icon) + '">' + escAttr((r.batch_code || '') + (r.expiry_date ? ' — ' + formatDateOnly(r.expiry_date) : '')) + '</option>';
              });
              var price = (item.price != null ? parseFloat(item.price) : (product.price != null ? parseFloat(product.price) : 0)) || 0;
              var row = document.createElement('tr');
              row.className = 'delivery-row';
              row.setAttribute('data-product-code', item.product_code);
              row.setAttribute('data-order-qty', item.quantity || 0);
              row.setAttribute('data-price', price);
              row.innerHTML = '<td>' + escAttr(productName) + '</td><td><select class="delivery-batch" required>' + batchOpts + '</select></td><td class="delivery-expiry">—</td><td class="delivery-days" style="text-align:center">—</td><td class="delivery-available" style="text-align:right">0</td><td style="text-align:right;font-weight:600">' + (item.quantity || 0) + '</td><td><input type="number" class="delivery-qty" min="1" max="' + (item.quantity || 0) + '" value="' + (item.quantity || 0) + '" required></td><td class="delivery-price" style="text-align:right">' + (price ? price.toFixed(2) : '—') + '</td><td class="delivery-sum" style="text-align:right">—</td>';
              tbody.appendChild(row);
              attachDeliveryRowHandlers(row);
            });
            updateDeliveryTotals();
          }
          function attachDeliveryRowHandlers(row) {
            var batchSel = row.querySelector('.delivery-batch');
            var qtyInp = row.querySelector('.delivery-qty');
            var expiryCell = row.querySelector('.delivery-expiry');
            var daysCell = row.querySelector('.delivery-days');
            var availCell = row.querySelector('.delivery-available');
            var sumCell = row.querySelector('.delivery-sum');
            if (!batchSel || !qtyInp) return;
            function updateBatchInfo() {
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var expiry = opt ? opt.getAttribute('data-expiry') || '' : '';
              var avail = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              var daysAttr = opt ? opt.getAttribute('data-days') : null;
              var color = opt ? opt.getAttribute('data-color') || '' : '';
              var icon = opt ? opt.getAttribute('data-icon') || '' : '';
              expiryCell.textContent = expiry ? formatDateOnly(expiry) : '—';
              availCell.textContent = avail;
              var orderQty = parseInt(row.getAttribute('data-order-qty') || '0', 10) || 0;
              var maxQty = Math.min(orderQty, avail);
              qtyInp.max = maxQty;
              if (parseInt(qtyInp.value || '0', 10) > maxQty) qtyInp.value = maxQty;
              if (daysCell) {
                if (daysAttr === null || daysAttr === '' || isNaN(parseInt(daysAttr, 10))) {
                  daysCell.textContent = '—';
                } else {
                  var days = parseInt(daysAttr, 10);
                  var badgeColor = '#28a745';
                  if (color === 'YELLOW') badgeColor = '#ffc107';
                  else if (color === 'RED') badgeColor = '#dc3545';
                  else if (color === 'BLACK') badgeColor = '#343a40';
                  var iconChar = icon || (color === 'YELLOW' ? '🟡' : (color === 'RED' ? '🔴' : (color === 'BLACK' ? '⚫' : '🟢')));
                  var daysText = days + ' дн.';
                  daysCell.innerHTML = '<span style="display:inline-block;padding:2px 6px;border-radius:4px;background:' + badgeColor + ';color:#fff;font-size:11px;font-weight:600">' + iconChar + ' ' + daysText + '</span>';
                }
              }
              updateRowSum();
            }
            function updateRowSum() {
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var sum = qty * price;
              sumCell.textContent = sum ? sum.toFixed(2) : '—';
              updateDeliveryTotals();
            }
            batchSel.onchange = updateBatchInfo;
            qtyInp.onchange = updateRowSum;
            qtyInp.oninput = updateRowSum;
            updateBatchInfo();
          }
          function updateDeliveryTotals() {
            var rows = document.querySelectorAll('.delivery-row');
            var totalQty = 0;
            var totalSum = 0;
            rows.forEach(function (row) {
              var qtyInp = row.querySelector('.delivery-qty');
              var sumCell = row.querySelector('.delivery-sum');
              if (qtyInp && sumCell) {
                var qty = parseInt(qtyInp.value || '0', 10) || 0;
                var sum = parseFloat(sumCell.textContent || '0') || 0;
                totalQty += qty;
                totalSum += sum;
              }
            });
            var totalQtyEl = document.getElementById('deliveryTotalQty');
            var totalSumEl = document.getElementById('deliveryTotalSum');
            if (totalQtyEl) totalQtyEl.textContent = totalQty;
            if (totalSumEl) totalSumEl.textContent = totalSum ? totalSum.toFixed(2) : '0';
          }
          document.getElementById('deliveryCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('deliverySave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('deliveryWhFrom').value;
            var expeditor = document.getElementById('deliveryExpeditor').value;
            var customerId = document.getElementById('deliveryCustomer').value;
            var paymentType = document.getElementById('deliveryPaymentType').value;
            var orderId = parseInt(document.getElementById('deliveryOrderId').value || '0', 10) || 0;
            if (errEl) errEl.textContent = '';
            if (!whFrom) { if (errEl) errEl.textContent = 'Выберите склад от.'; return; }
            if (!expeditor) { if (errEl) errEl.textContent = 'Выберите экспедитора.'; return; }
            if (!customerId) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
            if (!paymentType) { if (errEl) errEl.textContent = 'Выберите тип оплаты.'; return; }
            if (!orderId) { if (errEl) errEl.textContent = 'Введите номер заказа.'; return; }
            var rows = document.querySelectorAll('.delivery-row');
            var items = [];
            rows.forEach(function (row) {
              var batchSel = row.querySelector('.delivery-batch');
              var qtyInp = row.querySelector('.delivery-qty');
              var productCode = row.getAttribute('data-product-code') || '';
              if (!batchSel || !qtyInp || !productCode) return;
              var batchCode = (batchSel.value || '').trim();
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (!batchCode || !qty) return;
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var available = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              if (qty > available) qty = available;
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var amount = qty * price;
              items.push({ product_code: productCode, batch_code: batchCode, quantity: qty, amount: amount });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Выберите партии для всех товаров.'; return; }
            var comment = (document.getElementById('deliveryComment').value || '').trim() || null;
            var createdBy = (window.currentUser && currentUser.login) ? currentUser.login : null;
            var saveBtn = document.getElementById('deliverySave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0;
            var idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Операции доставки созданы: ' + createdCount + ' шт.'; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              var payload = {
                warehouse_from: whFrom,
                product_code: it.product_code,
                batch_code: it.batch_code,
                quantity: it.quantity,
                customer_id: parseInt(customerId, 10),
                amount: it.amount,
                payment_type_code: paymentType,
                expeditor_login: expeditor,
                order_id: orderId,
                comment: comment
              };
              api('/api/v1/operations/' + encodeURIComponent(config.operation_type) + '/create', { method: 'POST', body: JSON.stringify(payload) }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) {
                  var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                  if (errEl) errEl.textContent = errs.join('; ');
                } else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildFormFromConfig(config, customers, products, warehouses, paymentTypes, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var fieldsToShow = (config.required_fields || []).concat(config.optional_fields || []);
          var hiddenFields = config.hidden_fields || [];
          var readonlyFields = config.readonly_fields || [];
          if (config.operation_type === 'warehouse_receipt') {
            buildWarehouseReceiptForm(config, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'allocation') {
            buildAllocationForm(config, customers, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'delivery') {
            buildDeliveryForm(config, customers, products, warehouses, paymentTypes, userList);
            return;
          }
          var formHtml = '<div class="card"><h2 id="opFormTitle">Создание операции: ' + escAttr(config.operation_name || config.operation_type) + '</h2>';
          if (config.description) formHtml += '<p style="color:#666;margin-bottom:16px">' + escAttr(config.description) + '</p>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          var fieldMap = {
            warehouse_from: { label: 'Склад от', type: 'select', options: warehouses, id: 'opCreateWarehouseFrom' },
            warehouse_to: { label: 'Склад в', type: 'select', options: warehouses, id: 'opCreateWarehouseTo' },
            product_code: { label: 'Товар', type: 'select', options: products, id: 'opCreateProduct' },
            batch_code: { label: 'Код партии', type: 'text', id: 'opCreateBatchCode', autoFromProductAndExpiry: true },
            expiry_date: { label: 'Срок годности', type: 'date', id: 'opCreateExpiryDate' },
            quantity: { label: 'Количество', type: 'number', id: 'opCreateQuantity', min: 0 },
            amount: { label: 'Сумма', type: 'number', id: 'opCreateAmount', step: '0.01' },
            payment_type_code: { label: 'Тип оплаты', type: 'select', options: paymentTypes, id: 'opCreatePaymentType' },
            customer_id: { label: 'Клиент', type: 'select', options: customers, id: 'opCreateCustomer' },
            order_id: { label: 'Заказ №', type: 'number', id: 'opCreateOrderId', min: 0 },
            expeditor_login: { label: 'Экспедитор', type: 'select', options: (userList || []).filter(function (u) { return (u.role || '').toLowerCase() === 'expeditor'; }), id: 'opCreateExpeditor' },
            cashier_login: { label: 'Кассир', type: 'select', options: userList, id: 'opCreateCashier' },
            storekeeper_login: { label: 'Кладовщик', type: 'select', options: userList, id: 'opCreateStorekeeper' },
            comment: { label: 'Комментарий', type: 'text', id: 'opCreateComment' },
            related_operation_id: { label: 'Связанная операция', type: 'text', id: 'opCreateRelatedOp' }
          };
          fieldsToShow.forEach(function (fieldName) {
            if (hiddenFields.indexOf(fieldName) >= 0) return;
            var field = fieldMap[fieldName];
            if (!field) return;
            var isRequired = (config.required_fields || []).indexOf(fieldName) >= 0;
            var isReadonly = readonlyFields.indexOf(fieldName) >= 0;
            formHtml += '<div class="form-group"><label>' + escAttr(field.label || fieldName) + (isRequired ? ' <span style="color:#c00">*</span>' : '') + '</label>';
            if (field.type === 'select') {
              var opts = '<option value="">— Не указан —</option>';
              if (field.options) {
                field.options.forEach(function (opt) {
                  if (fieldName === 'expeditor_login' && (opt.role || '').toLowerCase() !== 'expeditor') return;
                  var val = opt.code || opt.id || opt.login || '';
                  var text = (fieldName === 'customer_id')
                    ? ((opt.name_client || opt.firm_name || '') + ' (ID ' + (opt.id || '') + ')')
                    : ((fieldName === 'product_code')
                      ? ((opt.code || '') + ' — ' + (opt.name || ''))
                      : (opt.name || opt.code || opt.login || val));
                  opts += '<option value="' + escAttr(val) + '">' + escAttr(text) + '</option>';
                });
              }
              formHtml += '<select id="' + field.id + '"' + (isRequired ? ' required' : '') + (isReadonly ? ' disabled' : '') + '>' + opts + '</select></div>';
            } else {
              var inputType = field.type || 'text';
              var placeholder = (isRequired ? 'обязательно' : 'необяз.');
              if (fieldName === 'expiry_date') { inputType = 'text'; placeholder = 'дд.мм.гггг'; }
              formHtml += '<input type="' + inputType + '" id="' + field.id + '"' + (isRequired ? ' required' : '') + (isReadonly ? ' readonly' : '') + (field.min !== undefined ? ' min="' + field.min + '"' : '') + (field.step !== undefined ? ' step="' + field.step + '"' : '') + ' placeholder="' + placeholder + '" autocomplete="off"></div>';
            }
          });
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opCreateSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opCreateCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var expiryEl = document.getElementById('opCreateExpiryDate');
          if (expiryEl && window.flatpickr) {
            window.flatpickr(expiryEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
          }
          function updateBatchCodeFromProductAndExpiry() {
            var productEl = document.getElementById('opCreateProduct');
            var expiryEl = document.getElementById('opCreateExpiryDate');
            var batchEl = document.getElementById('opCreateBatchCode');
            if (!productEl || !expiryEl || !batchEl) return;
            var productCode = (productEl.value || '').trim();
            var expiryRaw = (expiryEl.value || '').trim();
            if (!productCode || !expiryRaw) return;
            var m = expiryRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
            if (!m) {
              var iso = expiryRaw.match(/^(\d{4})-(\d{2})-(\d{2})/);
              if (iso) m = [null, iso[3], iso[2], iso[1]];
            }
            if (m) {
              var ddmmyyyy = m[1].padStart(2, '0') + m[2].padStart(2, '0') + m[3];
              batchEl.value = productCode + '_' + ddmmyyyy;
            }
          }
          var productEl = document.getElementById('opCreateProduct');
          var expiryEl = document.getElementById('opCreateExpiryDate');
          var batchEl = document.getElementById('opCreateBatchCode');
          if (productEl && expiryEl && batchEl && fieldMap.batch_code && fieldMap.batch_code.autoFromProductAndExpiry) {
            productEl.onchange = updateBatchCodeFromProductAndExpiry;
            if (expiryEl) { expiryEl.onchange = updateBatchCodeFromProductAndExpiry; expiryEl.oninput = updateBatchCodeFromProductAndExpiry; }
          }
          document.getElementById('opCreateCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opCreateSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var payload = {};
            fieldsToShow.forEach(function (fieldName) {
              if (hiddenFields.indexOf(fieldName) >= 0) return;
              var field = fieldMap[fieldName];
              if (!field) return;
              var el = document.getElementById(field.id);
              if (!el) return;
              var val = el.value;
              if (val && val.trim() !== '') {
                if (fieldName === 'customer_id' || fieldName === 'order_id' || fieldName === 'quantity') {
                  var num = parseInt(val, 10);
                  if (!isNaN(num)) payload[fieldName] = num;
                } else if (fieldName === 'amount') {
                  var num = parseFloat(val);
                  if (!isNaN(num)) payload[fieldName] = num;
                } else {
                  payload[fieldName] = val.trim();
                }
              }
            });
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess(result) {
              if (msgEl) { msgEl.textContent = 'Операция создана: ' + (result.operation_number || 'OK'); msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 2000);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              var detail = e && e.data && e.data.detail;
              if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
              if (detail && detail.errors) {
                var errs = [];
                for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                if (errEl) errEl.textContent = errs.join('; ');
              } else if (errEl) errEl.textContent = 'Ошибка сохранения';
            }
            api('/api/v1/operations/' + encodeURIComponent(config.operation_type) + '/create', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
          };
        }
        function openOperationCreate() {
          Promise.all([
            api('/api/v1/operation-types').catch(function () { return []; }),
            api('/api/v1/customers?limit=1000').catch(function () { return []; }),
            api('/api/v1/dictionary/products').catch(function () { return []; }),
            api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
            api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
            api('/api/v1/dictionary/user-logins').catch(function () { return []; })
          ]).then(function (results) {
            var types = results[0] || [];
            var customers = results[1] || [];
            var products = results[2] || [];
            var warehouses = results[3] || [];
            var paymentTypes = results[4] || [];
            var userList = results[5] || [];
            var content = document.getElementById('content');
            if (!content) return;
            var typeOpts = '<option value="">— Выберите тип операции —</option>';
            types.forEach(function (ty) {
              if (ty.active === false) return; // не показываем неактивные типы при создании
              typeOpts += '<option value="' + escAttr(ty.code) + '">' + escAttr(ty.name || ty.code) + '</option>';
            });
            content.innerHTML = '<div class="card"><h2>Создание операции</h2><div id="opFormErr" class="err" style="margin-bottom:12px"></div><div class="form-group"><label>Тип операции <span style="color:#c00">*</span></label><select id="opSelectType" required>' + typeOpts + '</select></div><div id="opFormContainer"></div></div>';
            document.getElementById('opSelectType').onchange = function () {
              var typeCode = this.value;
              if (!typeCode) { document.getElementById('opFormContainer').innerHTML = ''; return; }
              document.getElementById('opFormContainer').innerHTML = '<p>Загрузка конфигурации...</p>';
              api('/api/v1/operations/' + encodeURIComponent(typeCode) + '/form-config').then(function (config) {
                buildFormFromConfig(config, customers, products, warehouses, paymentTypes, userList);
              }).catch(function (e) {
                var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка';
                document.getElementById('opFormContainer').innerHTML = '<p class="err">Ошибка загрузки конфига: ' + escAttr(msg) + '</p>';
              });
            };
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка';
            var content = document.getElementById('content');
            if (content) content.innerHTML = '<div class="card"><h2>Операции</h2><p class="err">Ошибка загрузки данных: ' + msg + '</p><p><button type="button" class="btn btn-secondary" id="opBackToList">Вернуться к списку</button> <button type="button" class="btn btn-primary" id="opAdd">Создать операцию</button></p><div id="opSectionTable"></div></div>';
            bindOperationAdd();
            var backBtn = document.getElementById('opBackToList');
            if (backBtn) backBtn.onclick = function () { loadSectionOperations(false); };
          });
        }
        // Делаем функцию доступной из глобальной области для showSection
        window.openOperationCreate = openOperationCreate;

        function bindOperationAdd() {
          var btn = document.getElementById('opAdd');
          if (!btn) return;
          btn.onclick = openOperationCreate;
        }
      }

      function loadSectionStock() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Остатки по складу</h2><p><label>Склад </label><select id="stock_wh"><option value="">—</option></select> <button type="button" class="btn btn-primary" id="stockLoad">Показать</button> <button type="button" class="btn btn-secondary" id="stockExport">Выгрузить в Excel</button></p><div id="sectionTable" style="margin-top:12px"></div></div>';
        api('/api/v1/dictionary/warehouses').then(function (list) {
          var sel = document.getElementById('stock_wh');
          if (sel && list) list.forEach(function (w) { var o = document.createElement('option'); o.value = w.code; o.textContent = w.name + ' (' + w.code + ')'; sel.appendChild(o); });
        });
        function renderStockTable(data) {
          var tableDiv = document.getElementById('sectionTable');
          if (!data.length) { tableDiv.innerHTML = '<p>Нет остатков.</p>'; return; }
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Склад</th><th>Товар (код)</th><th>Название товара</th><th>Партия (код)</th><th>Остаток</th><th>Цена за 1 шт</th><th>Сумма</th><th>Срок годности</th><th>Дней осталось</th></tr></thead><tbody>';
          var totalQty = 0;
          var totalCost = 0;
          data.forEach(function (r) {
            var expiryDate = r.expiry_date ? formatDateOnly(r.expiry_date) : '—';
            var days = r.days_until_expiry;
            var status = r.expiry_status || {};
            var color = status.color || null;
            var icon = status.icon || '';
            var badgeColor = '#28a745';
            if (color === 'YELLOW') badgeColor = '#ffc107';
            else if (color === 'RED') badgeColor = '#dc3545';
            else if (color === 'BLACK') badgeColor = '#343a40';
            var daysText = '';
            if (days == null) {
              daysText = '—';
            } else if (days <= 0) {
              daysText = (icon || '⚫') + ' Просрочен (дней: ' + days + ')';
            } else {
              daysText = (icon || '🟢') + ' ' + days + ' дн.';
            }
            var badgeHtml = daysText === '—'
              ? '—'
              : '<span class="badge" style="background-color:' + badgeColor + ';color:#fff;border-radius:4px;padding:4px 8px;font-size:12px;">' + escAttr(daysText) + '</span>';
            var price = (r.unit_price != null ? Number(r.unit_price) : 0);
            var cost = (r.total_cost != null ? Number(r.total_cost) : 0);
            var priceText = price ? price.toFixed(2) : '—';
            var costText = cost ? cost.toFixed(2) : '—';
            var qty = (r.total_qty != null ? r.total_qty : 0);
            totalQty += qty;
            totalCost += cost;
            t += '<tr><td>' + escAttr(r.warehouse_name || r.warehouse_code || '') + '</td><td>' + escAttr(r.product_code || '') + '</td><td>' + escAttr(r.product_name || '') + '</td><td>' + escAttr(r.batch_code || '—') + '</td><td style="text-align:right;font-weight:600">' + qty + '</td><td style="text-align:right;">' + priceText + '</td><td style="text-align:right;font-weight:600">' + costText + '</td><td>' + expiryDate + '</td><td style="text-align:center;">' + badgeHtml + '</td></tr>';
          });
          // строка ИТОГО
          t += '<tr style="background:#f8f9fa;font-weight:600"><td colspan="4" style="text-align:right;padding:8px">Итого:</td><td style="text-align:right;padding:8px">' + totalQty + '</td><td></td><td style="text-align:right;padding:8px">' + (totalCost ? totalCost.toFixed(2) : '0') + '</td><td></td><td></td></tr>';
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
        }
        document.getElementById('stockLoad').onclick = function () {
          var code = document.getElementById('stock_wh').value;
          var tableDiv = document.getElementById('sectionTable');
          tableDiv.innerHTML = '<p>Загрузка...</p>';
          var url = '/api/v1/warehouse/stock';
          if (code) url += '?warehouse=' + encodeURIComponent(code);
          api(url).then(function (response) {
            var data = (response && response.success && Array.isArray(response.data)) ? response.data : (Array.isArray(response) ? response : []);
            if (!data.length) { tableDiv.innerHTML = '<p>Нет остатков' + (code ? ' на выбранном складе' : '') + '.</p>'; return; }
            renderStockTable(data);
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.data && e.data.error) ? e.data.error : (e && e.message) || 'Ошибка загрузки';
            tableDiv.innerHTML = '<p class="err">Ошибка загрузки: ' + escAttr(msg) + '</p>';
          });
        };
        document.getElementById('stockExport').onclick = function () {
          var code = document.getElementById('stock_wh').value;
          var url = '/api/v1/warehouse/stock/export';
          if (code) url += '?warehouse=' + encodeURIComponent(code);
          fetch(url, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
          }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'warehouse_stock.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка выгрузки';
            alert(msg);
          });
        };
      }

      document.getElementById('btnLogout').onclick = function () { localStorage.removeItem('sds_token'); window.location.href = '/login'; };
      document.querySelectorAll('.sidebar a').forEach(function (a) {
        a.onclick = function (e) {
          e.preventDefault();
          var s = a.getAttribute('data-section');
          if (s === 'ref_parent') {
            var refSub = document.getElementById('refSubmenu');
            if (refSub) refSub.classList.toggle('open');
            a.classList.toggle('open');
          } else if (s === 'orders_parent') {
            var ordersSub = document.getElementById('ordersSubmenu');
            if (ordersSub) ordersSub.classList.toggle('open');
            a.classList.toggle('open');
          } else if (s === 'ops_parent') {
            var opsSub = document.getElementById('opsSubmenu');
            if (opsSub) opsSub.classList.toggle('open');
            a.classList.toggle('open');
          } else {
            showSection(s);
          }
        };
      });

      document.getElementById('userName').textContent = 'Загрузка...';
      loadMe().then(function () { showSection('users'); }).catch(function () { document.getElementById('userName').textContent = 'Ошибка'; showSection('users'); });
    })();
  </script>
</body>
</html>
