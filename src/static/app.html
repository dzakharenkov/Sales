<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Система управления продажами и дистрибуцией</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/ru.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
    .layout { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: #2d2d3a; color: #eee; padding: 20px 0; flex-shrink: 0; }
    .sidebar-header { display: flex; align-items: center; padding: 20px 20px 24px; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .sidebar-header .sidebar-favicon { width: 40px; height: 40px; margin-right: 14px; flex-shrink: 0; border-radius: 8px; object-fit: contain; }
    .sidebar-header .sidebar-title { font-size: 18px; font-weight: 600; color: #fff; letter-spacing: 0.02em; margin: 0; }
    .sidebar a { display: flex; align-items: center; padding: 14px 20px; color: #e0e0e0; text-decoration: none; font-size: 16px; font-weight: 500; cursor: pointer; transition: background 0.15s, color 0.15s; }
    .sidebar a:hover, .sidebar a.active { background: #0d9488; color: #fff; }
    .sidebar .nav-icon { width: 24px; height: 24px; margin-right: 14px; flex-shrink: 0; opacity: 0.95; display: flex; align-items: center; justify-content: center; }
    .sidebar .nav-icon svg { width: 100%; height: 100%; display: block; }
    .sidebar .submenu { display: none; padding-left: 0; background: rgba(0,0,0,0.15); margin: 0 0 4px 0; border-left: 3px solid #0d9488; }
    .sidebar .submenu.open { display: block; }
    .sidebar .submenu a { font-size: 14px; padding: 10px 20px 10px 44px; font-weight: 400; }
    .sidebar .submenu .nav-icon { width: 18px; height: 18px; margin-right: 10px; }
    .sidebar a.parent { position: relative; }
    .sidebar a.parent::after { content: '\25BE'; font-size: 12px; margin-left: auto; opacity: 0.8; }
    .sidebar a.parent.open::after { content: '\25B4'; }
    .main { flex: 1; padding: 0; overflow: auto; display: flex; flex-direction: column; }
    .main .content-inner { padding: 24px; flex: 1; }
    .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; padding: 16px 24px; background: #2d2d3a; color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .header-left { display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0; }
    .header .header-logo { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; flex-shrink: 0; }
    .header h1 { margin: 0; font-size: 20px; font-weight: 600; color: #fff; }
    .header .user { color: rgba(255,255,255,0.85); font-size: 14px; margin: 4px 0 0 0; }
    .header .btn-header { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.5); padding: 8px 18px; font-weight: 600; }
    .header .btn-header:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.7); color: #fff; }
    .header-right { display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    .header .header-right .user { margin: 0; font-size: 14px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: background 0.15s, box-shadow 0.15s; }
    .btn-primary { background: #0d9488; color: #fff; }
    .btn-primary:hover { background: #0f766e; box-shadow: 0 2px 8px rgba(13,148,136,0.35); }
    .btn-secondary { background: #e5e7eb; color: #374151; margin-left: 8px; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-small { padding: 8px 16px; font-size: 14px; font-weight: 600; margin-right: 6px; }
    .card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 24px; margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.04); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8fafc; font-weight: 600; font-size: 13px; color: #475569; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 999px; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .status-badge--completed { background: #d1fae5; color: #065f46; }
    .status-badge--delivery { background: #dbeafe; color: #1e40af; }
    .status-badge--open { background: #fef3c7; color: #92400e; }
    .status-badge--cancelled { background: #fee2e2; color: #991b1b; }
    .status-badge--pending { background: #e5e7eb; color: #4b5563; }
    .status-badge--default { background: #f1f5f9; color: #475569; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-inner { background: #fff; border-radius: 8px; padding: 24px; max-width: 440px; width: 100%; max-height: 90vh; overflow: auto; }
    .modal h3 { margin: 0 0 16px 0; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    select { accent-color: #0d9488; }
    select:focus { outline: 2px solid #0d9488; outline-offset: 2px; }
    option:checked, option:hover { background: #0d9488; color: #fff; }
    .form-readonly { padding: 8px 0; font-size: 14px; color: #555; }
    .modal-actions { margin-top: 20px; display: flex; gap: 8px; justify-content: center; }
    .err { color: #c00; font-size: 13px; margin-top: 8px; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .dashboard-sum-block { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); color: #fff; padding: 24px; border-radius: 12px; margin-bottom: 24px; }
    .dashboard-sum-block h3 { margin: 0 0 8px 0; font-size: 14px; opacity: 0.9; }
    .dashboard-sum-block .sum-value { font-size: 32px; font-weight: 700; }
    .kpi-card { padding: 16px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 16px; }
    .kpi-card--green { background: #ecfdf5; border-color: #a7f3d0; }
    .kpi-card--red { background: #fef2f2; border-color: #fecaca; }
    .kpi-card--orange { background: #fff7ed; border-color: #fed7aa; }
    .kpi-card--blue { background: #eff6ff; border-color: #bfdbfe; }
    .kpi-card h4 { margin: 0 0 8px 0; font-size: 13px; color: #475569; }
    .kpi-card .kpi-value { font-size: 24px; font-weight: 700; color: #1e293b; }
    .msg { color: #0a0; font-size: 13px; margin-top: 8px; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    select.from-order, input.from-order { background: #e9ecef !important; color: #495057; cursor: not-allowed; }
    #content { min-height: 200px; }
    #opWhReceiptItemsTable td { padding: 8px; }
    #opWhReceiptItemsTable td input, #opWhReceiptItemsTable td select { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
    #opWhReceiptItemsTable td input[readonly] { background: #f0f0f0; cursor: not-allowed; }
    #opWhReceiptItemsTable tfoot tr { border-top: 2px solid #ccc; }
    #opWhReceiptItemsTable .op-wh-receipt-price, #opWhReceiptItemsTable .op-wh-receipt-sum { font-family: monospace; }
    .badge { display: inline-block; }
    .card h2 { margin: 0 0 20px 0; font-size: 20px; font-weight: 600; color: #1e293b; }
    .content-inner > .card:first-child { margin-top: 0; }
    #customersMap { width: 100%; height: calc(100vh - 260px); min-height: 400px; border-radius: 8px; background: #e8ecf0; }
    .map-toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
    .map-toolbar label { font-weight: 600; font-size: 13px; }
    .map-toolbar select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    .multiselect-status { position: relative; min-width: 180px; max-width: 280px; }
    .multiselect-trigger { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; min-height: 38px; padding: 6px 32px 6px 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; }
    .multiselect-trigger:hover { border-color: #999; }
    .multiselect-trigger.open { border-color: #0d9488; outline: 2px solid rgba(13,148,136,0.3); outline-offset: 2px; }
    .multiselect-tags { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; flex: 1; min-height: 24px; }
    .multiselect-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #e5e7eb; color: #374151; border-radius: 4px; font-size: 13px; }
    .multiselect-tag .multiselect-tag-remove { cursor: pointer; color: #6b7280; font-size: 14px; line-height: 1; padding: 0 2px; }
    .multiselect-tag .multiselect-tag-remove:hover { color: #1f2937; }
    .multiselect-plus { display: inline-flex; align-items: center; padding: 2px 8px; background: #f3f4f6; color: #6b7280; border-radius: 4px; font-size: 13px; }
    .multiselect-clear { position: absolute; right: 28px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280; font-size: 16px; padding: 2px 4px; line-height: 1; }
    .multiselect-clear:hover { color: #1f2937; }
    .multiselect-arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 12px; pointer-events: none; }
    .multiselect-placeholder { color: #9ca3af; font-size: 14px; }
    .multiselect-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 50; max-height: 220px; overflow-y: auto; padding: 8px; }
    .multiselect-status.open .multiselect-dropdown { display: block; }
    .multiselect-dropdown label { display: flex; align-items: center; gap: 8px; padding: 8px 10px; cursor: pointer; font-size: 14px; border-radius: 4px; }
    .multiselect-dropdown label:hover { background: #f3f4f6; }
    .multiselect-dropdown input[type="checkbox"] { margin: 0; accent-color: #0d9488; }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="/favicon.ico" alt="" class="sidebar-favicon">
        <span class="sidebar-title">Меню</span>
      </div>
      <div id="sidebarMenu"></div>
    </nav>
    <div class="main">
      <div class="header">
        <div class="header-left">
          <h1>Система управления продажами и дистрибуцией</h1>
        </div>
        <div class="header-right">
          <p class="user">Вы вошли: <strong id="userName">—</strong></p>
          <button type="button" class="btn btn-header" id="btnAbout" style="margin-right:8px">О системе</button>
          <button type="button" class="btn btn-header" id="btnLogout">Выйти</button>
        </div>
      </div>
      <div class="content-inner">
        <div id="content"></div>
      </div>
    </div>
  </div>
  <div id="modalContainer"></div>
  <script>
    (function () {
      var token = localStorage.getItem('sds_token');
      if (!token) { window.location.href = '/login'; return; }

      var api = function (path, opts) {
        opts = opts || {};
        var url = path.indexOf('http') === 0 ? path : (window.location.origin + path);
        var headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
        if (opts.headers) for (var k in opts.headers) headers[k] = opts.headers[k];
        return fetch(url, { method: opts.method || 'GET', headers: headers, body: opts.body }).then(function (r) {
          return r.text().then(function (text) {
            var data = null;
            try { data = text ? JSON.parse(text) : null; } catch (_) {}
            if (!r.ok) throw { status: r.status, data: data };
            return data;
          });
        });
      };

      var currentUser = { login: '', fio: '', role: '' };
      var isAdmin = function () { return (currentUser.role || '').toLowerCase() === 'admin'; };
      var menuByCode = {};
      var menuItems = [];
      var currentSectionAccess = 'full';

      var SECTION_TO_CODE = {
        users: 'users',
        ref_parent: 'references', ref_payment: 'ref_payment', ref_products: 'ref_products', ref_operations: 'ref_operations', ref_currency: 'ref_currency', ref_cities: 'ref_cities', ref_territories: 'ref_territories', warehouses: 'warehouses', products: 'products',
        customers_parent: 'customers', customers: 'customers', customers_create: 'customers', customers_map: 'customers',
        visits_parent: 'visits', visits_search: 'visits', visits_create: 'visits', visits_calendar: 'visits',
        orders_parent: 'orders', orders: 'orders', orders_create: 'orders', order_items: 'orders',
        ops_parent: 'operations', operations: 'operations', operations_create: 'operations',
        stock: 'balances',
        cash_parent: 'cashier', cash_pending: 'cashier', cash_received: 'cashier', cashier_orders: 'cashier',
        reports_parent: 'reports', report_customers: 'reports', report_agents: 'reports', report_expeditors: 'reports', report_visits: 'reports', report_dashboard: 'reports', report_photos: 'reports',
        role_menu_access: 'users'
      };
      function sectionToCode(name) { return SECTION_TO_CODE[name] || name; }

      var SIDEBAR_ICONS = {
        users: '<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>',
        folder: '<path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>',
        building: '<path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2z"/>',
        calendar: '<path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>',
        'shopping-cart': '<path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v12z"/>',
        truck: '<path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>',
        box: '<path d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4h16v3z"/>',
        dollar: '<path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>',
        chart: '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>'
      };
      var SIDEBAR_CHILDREN = {
        references: [{ s: 'ref_payment', l: 'Типы оплат' }, { s: 'ref_products', l: 'Типы продуктов' }, { s: 'ref_operations', l: 'Типы операций' }, { s: 'ref_currency', l: 'Валюта' }, { s: 'ref_cities', l: 'Города' }, { s: 'ref_territories', l: 'Территории' }, { s: 'warehouses', l: 'Склады' }, { s: 'products', l: 'Товары' }],
        customers: [{ s: 'customers', l: 'Поиск клиента' }, { s: 'customers_create', l: 'Создать клиента' }, { s: 'customers_map', l: 'Клиенты на карте' }],
        visits: [{ s: 'visits_search', l: 'Поиск визита' }, { s: 'visits_create', l: 'Создать визит' }, { s: 'visits_calendar', l: 'Календарь визитов' }],
        orders: [{ s: 'orders', l: 'Поиск заказов' }, { s: 'orders_create', l: 'Создать заказ' }, { s: 'order_items', l: 'Поиск позиций заказов' }],
        operations: [{ s: 'operations', l: 'Поиск операций' }, { s: 'operations_create', l: 'Создать операцию' }],
        cashier: [{ s: 'cash_pending', l: 'Ожидающие передачи от экспедиторов' }, { s: 'cash_received', l: 'Принятые деньги за период' }, { s: 'cashier_orders', l: 'Заказы для подтверждения оплаты' }],
        reports: [{ s: 'report_customers', l: 'По клиентам' }, { s: 'report_agents', l: 'По агентам' }, { s: 'report_expeditors', l: 'По экспедиторам' }, { s: 'report_visits', l: 'По визитам' }, { s: 'report_dashboard', l: 'Сводная аналитика' }, { s: 'report_photos', l: 'Фотографии клиентов' }]
      };
      var SIDEBAR_SECTIONS = { users: 'users', references: 'ref_parent', customers: 'customers_parent', visits: 'visits_parent', orders: 'orders_parent', operations: 'ops_parent', balances: 'stock', cashier: 'cash_parent', reports: 'reports_parent' };
      var PARENT_IDS = { references: ['refParent', 'refSubmenu'], customers: ['customersParent', 'customersSubmenu'], visits: ['visitsParent', 'visitsSubmenu'], orders: ['ordersParent', 'ordersSubmenu'], operations: ['opsParent', 'opsSubmenu'], cashier: ['cashParent', 'cashSubmenu'], reports: ['reportsParent', 'reportsSubmenu'] };

      function renderSidebar(items) {
        var el = document.getElementById('sidebarMenu');
        if (!el) return;
        menuByCode = {};
        (items || []).forEach(function (m) { menuByCode[m.code] = m.access_level || 'view'; });
        menuItems = items || [];

        // Пропускаем только подпункты справочников (ref_payment, ref_products и т.д.)
        // которые возвращены API как отдельные записи
        var skipCodes = {};
        if (SIDEBAR_CHILDREN['references']) {
          SIDEBAR_CHILDREN['references'].forEach(function (child) {
            // Пропускаем только если этот подпункт справочника есть в API
            if (menuByCode[child.s] && child.s !== 'references') {
              skipCodes[child.s] = true;
            }
          });
        }

        var html = '';
        (items || []).forEach(function (m) {
          var code = m.code;

          // Пропускаем ТОЛЬКО подпункты справочников
          if (skipCodes[code]) return;

          var section = SIDEBAR_SECTIONS[code];
          var label = m.label || code;
          var icon = SIDEBAR_ICONS[m.icon] || SIDEBAR_ICONS[code] || '';
          var ids = PARENT_IDS[code];
          var children = SIDEBAR_CHILDREN[code];
          if (children && children.length) {
            html += '<a href="#" class="parent" id="' + (ids ? ids[0] : '') + '" data-section="' + section + '"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">' + icon + '</svg></span>' + label + '</a>';
            html += '<div class="submenu" id="' + (ids ? ids[1] : '') + '">';
            children.forEach(function (c) { html += '<a href="#" data-section="' + c.s + '">' + (c.l || c.s) + '</a>'; });
            html += '</div>';
          } else {
            html += '<a href="#" data-section="' + section + '"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">' + icon + '</svg></span>' + label + '</a>';
          }
        });
        el.innerHTML = html;
      }

      function applyViewOnlyAccess() {
        if (currentSectionAccess !== 'view') return;
        var sel = '#content .sectionAdd, #content #sectionAdd, #content .btn-edit, #content .btn-delete, #content button[id*="Add"]:not(.btn-secondary), #content [data-action="edit"], #content [data-action="delete"], #content a[data-edit]';
        document.querySelectorAll(sel).forEach(function (e) { e.style.display = 'none'; });
      }

      var loadMe = function () {
        return api('/api/v1/auth/me').then(function (u) {
          currentUser = u || {};
          window.currentUser = currentUser;
          var el = document.getElementById('userName');
          if (el) el.textContent = (currentUser.fio || currentUser.login || '—') + ' (' + (currentUser.role || '—') + ')';
        }).catch(function () {
          localStorage.removeItem('sds_token');
          window.location.href = '/login';
        });
      };

      var loadMenu = function () {
        return api('/api/v1/menu').then(function (data) {
          var list = (data && data.menu) ? data.menu : [];
          console.log('API /menu returned:', list);
          renderSidebar(list);
          console.log('menuByCode after renderSidebar:', menuByCode);
          return list;
        }).catch(function () {
          menuByCode = {};
          menuItems = [];
          renderSidebar([]);
          return [];
        });
      };

      var showModal = function (title, bodyHtml, onSave, opts) {
        var wrap = document.getElementById('modalContainer');
        if (!wrap) return;
        var id = 'modal' + Date.now();
        var closeOnly = opts && opts.closeOnly;
        var actionsHtml = closeOnly
          ? '<div class="modal-actions" style="justify-content:center"><button type="button" class="btn btn-primary" id="' + id + '_back">Назад</button></div>'
          : '<div class="modal-actions"><button type="button" class="btn btn-primary" id="' + id + '_save">Сохранить</button><button type="button" class="btn btn-secondary" id="' + id + '_cancel">Отмена</button></div>';
        wrap.innerHTML = '<div class="modal show" id="' + id + '"><div class="modal-inner"><h3>' + title + '</h3><div id="' + id + '_body">' + bodyHtml + '</div>' + actionsHtml + '<div id="' + id + '_err" class="err"></div></div></div>';
        var errEl = document.getElementById(id + '_err');
        var closeModal = function () { document.getElementById(id).classList.remove('show'); };
        if (closeOnly) {
          document.getElementById(id + '_back').onclick = closeModal;
        } else {
          document.getElementById(id + '_cancel').onclick = closeModal;
          document.getElementById(id + '_save').onclick = function () {
            if (errEl) errEl.textContent = '';
            var p = onSave(errEl);
            if (p && p.then) p.then(closeModal).catch(function (e) {
              if (!errEl) return;
              var detail = e && e.data && e.data.detail;
              if (!detail) {
                var statusMsg = e && e.status ? ' [' + e.status + ']' : '';
                errEl.textContent = 'Ошибка соединения или сервера.' + statusMsg;
                return;
              }
              if (typeof detail === 'string') { errEl.textContent = detail; return; }
              if (Array.isArray(detail)) {
                var parts = detail.map(function (x) {
                  var loc = x.loc && x.loc.slice ? x.loc.slice(-1).join(' ') : '';
                  var msg = x.msg || x.message || '';
                  if (msg && msg.indexOf('Value error, ') === 0) msg = msg.replace('Value error, ', '');
                  return (loc ? loc + ': ' : '') + msg;
                });
                errEl.textContent = parts.join(' ');
              } else { errEl.textContent = typeof detail === 'object' ? JSON.stringify(detail) : String(detail); }
            }); else closeModal();
          };
        }
      };
      function formatDateOnly(isoStr) {
        if (!isoStr) return '';
        try {
          var d = new Date(isoStr);
          return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch (e) { return isoStr; }
      }
      function dateToApiFormat(val) {
        if (val == null || val === '') return null;
        var s = String(val).trim();
        if (!s) return null;
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        var m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
        if (m) return m[3] + '-' + m[2].padStart(2,'0') + '-' + m[1].padStart(2,'0');
        return s;
      }
      function visitStatusRu(code) {
        var map = { planned: 'Запланирован', completed: 'Завершён', cancelled: 'Отменён', postponed: 'На рассмотрении' };
        return (map[code] || code || '');
      }

      var showSection = function (name) {
        var code = sectionToCode(name);
        console.log('showSection: name=' + name + ', code=' + code + ', menuByCode[code]=' + menuByCode[code]);
        if (!menuByCode[code] || menuByCode[code] === 'none') {
          console.error('Access denied for section: ' + name + ', code: ' + code);
          var content = document.getElementById('content');
          if (content) content.innerHTML = '<div class="card"><h2>Доступ запрещён</h2><p>Access Denied. У вас нет прав на этот раздел.</p><p><button type="button" class="btn btn-primary" id="accessDeniedBack">На главную</button></p></div>';
          document.getElementById('accessDeniedBack').onclick = function () {
            var first = (menuItems && menuItems[0]) ? (SIDEBAR_SECTIONS[menuItems[0].code] || 'users') : 'users';
            showSection(first);
          };
          return;
        }
        currentSectionAccess = menuByCode[code] || 'full';
        document.querySelectorAll('.sidebar a').forEach(function (a) {
          var s = a.getAttribute('data-section');
          a.classList.toggle('active', s === name);
          if (a.id === 'refParent') a.classList.toggle('open', (name === 'ref_parent' || name === 'ref_payment' || name === 'ref_products' || name === 'ref_operations' || name === 'ref_currency' || name === 'ref_cities' || name === 'ref_territories' || name === 'warehouses' || name === 'products'));
          if (a.id === 'customersParent') a.classList.toggle('open', (name === 'customers_parent' || name === 'customers' || name === 'customers_create' || name === 'customers_map'));
          if (a.id === 'visitsParent') a.classList.toggle('open', (name === 'visits_parent' || name === 'visits_search' || name === 'visits_create' || name === 'visits_calendar'));
          if (a.id === 'ordersParent') a.classList.toggle('open', (name === 'orders_parent' || name === 'orders' || name === 'orders_create' || name === 'order_items'));
          if (a.id === 'opsParent') a.classList.toggle('open', (name === 'ops_parent' || name === 'operations' || name === 'operations_create'));
          if (a.id === 'cashParent') a.classList.toggle('open', (name === 'cash_parent' || name === 'cash_pending' || name === 'cash_received' || name === 'cashier_orders'));
          if (a.id === 'reportsParent') a.classList.toggle('open', (name === 'reports_parent' || name === 'report_customers' || name === 'report_agents' || name === 'report_expeditors' || name === 'report_visits' || name === 'report_dashboard' || name === 'report_photos'));
        });
        var sub = document.getElementById('refSubmenu');
        if (sub) sub.classList.toggle('open', name === 'ref_parent' || name === 'ref_payment' || name === 'ref_products' || name === 'ref_operations' || name === 'ref_currency' || name === 'ref_cities' || name === 'ref_territories' || name === 'warehouses' || name === 'products');
        var customersSub = document.getElementById('customersSubmenu');
        if (customersSub) customersSub.classList.toggle('open', name === 'customers_parent' || name === 'customers' || name === 'customers_create' || name === 'customers_map');
        var visitsSub = document.getElementById('visitsSubmenu');
        if (visitsSub) visitsSub.classList.toggle('open', name === 'visits_parent' || name === 'visits_search' || name === 'visits_create' || name === 'visits_calendar');
        var ordersSub = document.getElementById('ordersSubmenu');
        if (ordersSub) ordersSub.classList.toggle('open', name === 'orders_parent' || name === 'orders' || name === 'orders_create' || name === 'order_items');
        var opsSub = document.getElementById('opsSubmenu');
        if (opsSub) opsSub.classList.toggle('open', name === 'ops_parent' || name === 'operations' || name === 'operations_create');
        var cashSub = document.getElementById('cashSubmenu');
        if (cashSub) cashSub.classList.toggle('open', name === 'cash_parent' || name === 'cash_pending' || name === 'cash_received' || name === 'cashier_orders');
        var reportsSub = document.getElementById('reportsSubmenu');
        if (reportsSub) reportsSub.classList.toggle('open', name === 'reports_parent' || name === 'report_customers' || name === 'report_agents' || name === 'report_expeditors' || name === 'report_visits' || name === 'report_dashboard' || name === 'report_photos');
        var content = document.getElementById('content');
        if (!content) return;
        if (name === 'ref_parent' || name === 'ops_parent' || name === 'orders_parent' || name === 'customers_parent' || name === 'visits_parent' || name === 'cash_parent' || name === 'reports_parent') return;
        // Для пункта меню "Создать клиента" — форма сразу на странице (без модалки)
        if (name === 'customers_create') {
          loadCitiesAndTerritories().then(function () {
            return api('/api/v1/dictionary/user-logins').catch(function () { return []; });
          }).then(function (userList) {
            userList = userList || [];
            var content = document.getElementById('content');
            if (!content) return;
            var formHtml = custEditFormHtml({ status: 'Активный' }, userList);
            content.innerHTML = '<div class="card"><h2>Создать клиента</h2><div id="custCreateErr" class="err" style="margin-bottom:12px"></div><div id="custCreateForm">' + formHtml + '</div><div class="modal-actions" style="margin-top:20px"><button type="button" class="btn btn-primary" id="custCreateSave">Сохранить</button><button type="button" class="btn btn-secondary" id="custCreateCancel">Отмена</button></div></div>';
            document.getElementById('custCreateCancel').onclick = function () { showSection('customers'); };
            document.getElementById('custCreateSave').onclick = function () {
              var errEl = document.getElementById('custCreateErr');
              if (errEl) errEl.textContent = '';
              api('/api/v1/customers', { method: 'POST', body: JSON.stringify(custFormBody()) }).then(function () { showSection('customers'); }).catch(function (e) {
                if (!errEl) return;
                var d = e && e.data && e.data.detail;
                errEl.textContent = (typeof d === 'string' ? d : (d ? JSON.stringify(d) : 'Ошибка сохранения'));
              });
            };
          });
          return;
        }
        if (name === 'customers_map') {
          loadSectionCustomersMap();
          return;
        }
        // Для пункта меню "Создать операцию" — загружаем раздел и сразу открываем форму создания
        if (name === 'operations_create') {
          loadSectionOperations(false, true);
          return;
        }
        // Для пункта меню "Создать заказ" открываем форму создания заказа
        if (name === 'orders_create') {
          // Используем существующую кнопку "Создать заказ" из раздела заказов
          loadSectionOrders();
          setTimeout(function () {
            var btn = document.getElementById('orderAdd');
            if (btn) btn.click();
          }, 0);
          return;
        }
        content.innerHTML = '<div class="card"><p>Загрузка раздела...</p></div>';
        if (name === 'users') loadSectionUsers();
        else if (name === 'products') loadSectionProducts();
        else if (name === 'ref_payment') loadSectionRefPayment();
        else if (name === 'ref_products') loadSectionRefProducts();
        else if (name === 'ref_operations') loadSectionRefOperations();
        else if (name === 'ref_currency') loadSectionRefCurrency();
        else if (name === 'warehouses') loadSectionWarehouses();
        else if (name === 'ref_cities') loadSectionCities();
        else if (name === 'ref_territories') loadSectionTerritories();
        else if (name === 'customers') loadSectionCustomers();
        else if (name === 'orders') loadSectionOrders();
        else if (name === 'order_items') loadSectionOrderItems();
        else if (name === 'operations') loadSectionOperations(false);
        else if (name === 'stock') loadSectionStock();
        else if (name === 'cash_pending') loadSectionCashPending();
        else if (name === 'cash_received') loadSectionCashReceived();
        else if (name === 'cashier_orders') loadSectionCashierOrders();
        else if (name === 'visits_search') loadSectionVisitsSearch();
        else if (name === 'visits_create') loadSectionVisitsCreate();
        else if (name === 'visits_calendar') loadSectionVisitsCalendar();
        else if (name === 'report_customers') loadSectionReportCustomers();
        else if (name === 'report_agents') loadSectionReportAgents();
        else if (name === 'report_expeditors') loadSectionReportExpeditors();
        else if (name === 'report_visits') loadSectionReportVisits();
        else if (name === 'report_dashboard') loadSectionReportDashboard();
        else if (name === 'report_photos') loadSectionReportPhotos();
        setTimeout(applyViewOnlyAccess, 300);
      };

      function loadSectionUsers() {
        api('/api/v1/users').catch(function (e) { if (e && e.status === 403) return null; throw e; }).then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="sectionAdd">Добавить пользователя</button>' : '';
          var roleMenuBtn = isAdmin() ? ' <button type="button" class="btn btn-secondary" id="btnRoleMenuAccess">Права доступа к меню</button>' : '';
          var html = '<div class="card"><h2>Пользователи</h2><p style="margin:0 0 12px 0">' + addBtn + roleMenuBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          var errDiv = document.getElementById('sectionErr');
          if (list === null || !Array.isArray(list)) { tableDiv.innerHTML = '<p>Доступ только для администратора.</p>'; return; }
          if (!list.length) { tableDiv.innerHTML = '<p>Нет пользователей.</p>'; return; }
          var sortCol = 'login';
          var sortDir = 1;
          function renderTable(data) {
            var sorted = data.slice().sort(function (a, b) { return tableSortCompare(a, b, sortCol, sortDir, function (r, c) { if (c === 'has_password') return (r.has_password ? '1' : '0'); return (r[c] || '').toString().toLowerCase(); }); });
            var t = '<table><thead><tr>' + sortableTh('login', 'Логин', sortCol, sortDir) + sortableTh('fio', 'ФИО', sortCol, sortDir) + sortableTh('role', 'Роль', sortCol, sortDir) + sortableTh('status', 'Статус', sortCol, sortDir) + sortableTh('has_password', 'Пароль', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (u) {
            var login = (u.login || '').replace(/"/g, '&quot;');
            var fio = (u.fio || '').replace(/"/g, '&quot;');
            var status = (u.status || '').replace(/"/g, '&quot;');
            var phone = (u.phone || '').replace(/"/g, '&quot;');
            var email = (u.email || '').replace(/"/g, '&quot;');
            t += '<tr><td>' + (u.login || '') + '</td><td>' + (u.fio || '') + '</td><td>' + (u.role || '') + '</td><td>' + (u.status || '') + '</td><td>' + (u.has_password ? 'Да' : 'Нет') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit="' + login + '" data-fio="' + fio + '" data-role="' + (u.role || '') + '" data-status="' + status + '" data-phone="' + phone + '" data-email="' + email + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-pwd="' + (u.login || '') + '">Сменить пароль</button>';
            t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderTable(list); };
            });
          }
          renderTable(list);
          if (isAdmin()) {
            var btnRoleMenu = document.getElementById('btnRoleMenuAccess');
            if (btnRoleMenu) btnRoleMenu.onclick = function () { loadSectionRoleMenuAccess(); };
            document.getElementById('sectionAdd').onclick = function () {
              showModal('Добавить пользователя', '<div class="form-group"><label>Логин</label><input type="text" id="mu_login" required placeholder="Латиница или цифры"></div><div class="form-group"><label>ФИО</label><input type="text" id="mu_fio" required placeholder="Фамилия Имя"></div><div class="form-group"><label>Пароль</label><input type="password" id="mu_password" required></div><div class="form-group"><label>Роль</label><select id="mu_role"><option value="agent">agent</option><option value="admin">admin</option><option value="expeditor">expeditor</option><option value="stockman">stockman</option><option value="paymaster">paymaster</option></select></div><div class="form-group"><label>Телефон</label><input type="text" id="mu_phone" placeholder="+998901234567 или 901234567"></div><div class="form-group"><label>Email</label><input type="email" id="mu_email" placeholder="user@example.com"></div><p style="font-size:12px;color:#666;margin-top:4px;">Телефон: цифры, +, пробелы, скобки, дефис. Email: например user@mail.ru</p>', function (errEl) {
                return api('/api/v1/users', { method: 'POST', body: JSON.stringify({ login: document.getElementById('mu_login').value.trim(), fio: document.getElementById('mu_fio').value.trim(), password: document.getElementById('mu_password').value, role: document.getElementById('mu_role').value, phone: document.getElementById('mu_phone').value.trim() || null, email: document.getElementById('mu_email').value.trim() || null }) }).then(function () { loadSectionUsers(); });
              });
            };
          }
          tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              var login = el.getAttribute('data-edit').replace(/&quot;/g, '"');
              var fio = (el.getAttribute('data-fio') || '').replace(/&quot;/g, '"');
              var role = el.getAttribute('data-role') || 'agent';
              var status = (el.getAttribute('data-status') || '').replace(/&quot;/g, '"');
              var phone = (el.getAttribute('data-phone') || '').replace(/&quot;/g, '"');
              var email = (el.getAttribute('data-email') || '').replace(/&quot;/g, '"');
              var roles = ['agent', 'admin', 'expeditor', 'stockman', 'paymaster'];
              var roleOpts = roles.map(function (r) { return '<option value="' + r + '"' + (r === role ? ' selected' : '') + '>' + r + '</option>'; }).join('');
              var esc = function (s) { return (s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); };
              showModal('Изменить пользователя: ' + login, '<div class="form-group"><label>ФИО</label><input type="text" id="eu_fio" value="' + esc(fio) + '"></div><div class="form-group"><label>Роль</label><select id="eu_role">' + roleOpts + '</select></div><div class="form-group"><label>Статус</label><input type="text" id="eu_status" value="' + esc(status) + '" placeholder="активен"></div><div class="form-group"><label>Телефон</label><input type="text" id="eu_phone" value="' + esc(phone) + '"></div><div class="form-group"><label>Email</label><input type="email" id="eu_email" value="' + esc(email) + '"></div>', function (errEl) {
                return api('/api/v1/users/' + encodeURIComponent(login), { method: 'PATCH', body: JSON.stringify({ fio: document.getElementById('eu_fio').value.trim(), role: document.getElementById('eu_role').value, status: document.getElementById('eu_status').value.trim() || undefined, phone: document.getElementById('eu_phone').value.trim() || undefined, email: document.getElementById('eu_email').value.trim() || undefined }) }).then(function () { loadSectionUsers(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-pwd]').forEach(function (el) {
            el.onclick = function () {
              var login = el.getAttribute('data-pwd');
              showModal('Сменить пароль: ' + login, '<div class="form-group"><label>Новый пароль</label><input type="password" id="sp_password" required></div>', function (errEl) {
                return api('/api/v1/users/' + encodeURIComponent(login) + '/set-password', { method: 'POST', body: JSON.stringify({ password: document.getElementById('sp_password').value }) }).then(function () { loadSectionUsers(); });
              });
            };
          });
        }).catch(function (e) {
          if (document.getElementById('sectionErr')) document.getElementById('sectionErr').textContent = (e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : 'Ошибка') : 'Ошибка загрузки';
        });
      }

      function loadSectionRoleMenuAccess() {
        var content = document.getElementById('content');
        if (!content) return;
        var roles = [{ v: 'admin', l: 'admin' }, { v: 'agent', l: 'agent' }, { v: 'expeditor', l: 'expeditor' }, { v: 'stockman', l: 'stockman' }, { v: 'paymaster', l: 'paymaster' }];
        var roleOpts = roles.map(function (r) { return '<option value="' + r.v + '">' + r.l + '</option>'; }).join('');
        content.innerHTML = '<div class="card"><h2>Права доступа к меню</h2><p style="margin:0 0 12px 0"><label>Роль: </label><select id="rma_role" style="margin-right:12px">' + roleOpts + '</select><button type="button" class="btn btn-primary" id="rma_save">Сохранить</button> <button type="button" class="btn btn-secondary" id="rma_back">Назад к пользователям</button></p><div id="rma_err" class="err" style="margin-top:8px"></div><div id="rma_table_wrap" style="margin-top:16px"><p>Загрузка...</p></div></div>';
        document.getElementById('rma_back').onclick = function () { loadSectionUsers(); };
        var roleSel = document.getElementById('rma_role');
        var errEl = document.getElementById('rma_err');
        function loadMatrix() {
          var role = roleSel.value;
          errEl.textContent = '';
          document.getElementById('rma_table_wrap').innerHTML = '<p>Загрузка...</p>';
          api('/api/v1/admin/roles/' + encodeURIComponent(role) + '/menu-access').then(function (data) {
            var rows = (data && data.menu_access) ? data.menu_access : [];
            var tb = '<div style="overflow-x:auto"><table><thead><tr><th>Пункт меню</th><th>Доступ</th></tr></thead><tbody>';
            rows.forEach(function (row) {
              var name = 'rma_' + row.menu_item_id;
              var none = row.access_level === 'none' ? ' checked' : '';
              var view = row.access_level === 'view' ? ' checked' : '';
              var full = row.access_level === 'full' ? ' checked' : '';
              tb += '<tr><td>' + escAttr(row.menu_label || row.menu_code || '') + '</td><td><label style="margin-right:12px"><input type="radio" name="' + name + '" value="none" data-mid="' + row.menu_item_id + '"' + none + '> Скрыто</label><label style="margin-right:12px"><input type="radio" name="' + name + '" value="view" data-mid="' + row.menu_item_id + '"' + view + '> Просмотр</label><label><input type="radio" name="' + name + '" value="full" data-mid="' + row.menu_item_id + '"' + full + '> Полный</label></td></tr>';
            });
            tb += '</tbody></table></div>';
            document.getElementById('rma_table_wrap').innerHTML = rows.length ? tb : '<p>Нет пунктов меню.</p>';
          }).catch(function (e) {
            errEl.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : 'Ошибка') : 'Ошибка загрузки';
            document.getElementById('rma_table_wrap').innerHTML = '';
          });
        }
        roleSel.onchange = loadMatrix;
        document.getElementById('rma_save').onclick = function () {
          var role = roleSel.value;
          var wrap = document.getElementById('rma_table_wrap');
          var radios = wrap.querySelectorAll('input[type="radio"]:checked');
          var byMid = {};
          radios.forEach(function (r) { byMid[r.getAttribute('data-mid')] = r.value; });
          var menu_access = [];
          for (var mid in byMid) menu_access.push({ menu_item_id: parseInt(mid, 10), access_level: byMid[mid] });
          if (!menu_access.length) { errEl.textContent = 'Нет данных для сохранения.'; return; }
          errEl.textContent = '';
          api('/api/v1/admin/roles/' + encodeURIComponent(role) + '/menu-access', { method: 'POST', body: JSON.stringify({ menu_access: menu_access }) }).then(function () {
            errEl.textContent = '';
            errEl.style.color = '#0a0';
            errEl.textContent = 'Права обновлены. Пользователи увидят изменения после перезагрузки страницы.';
            setTimeout(function () { errEl.textContent = ''; errEl.style.color = ''; }, 3000);
          }).catch(function (e) {
            errEl.style.color = '';
            errEl.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : 'Ошибка') : 'Ошибка сохранения';
          });
        };
        loadMatrix();
      }

      function productTypeSelectHtml(typeList, selected) {
        selected = selected || '';
        var opts = '<option value="">—</option>';
        (typeList || []).forEach(function (ty) {
          var name = escAttr(ty.name);
          opts += '<option value="' + name + '"' + (ty.name === selected ? ' selected' : '') + '>' + (ty.name || '') + '</option>';
        });
        return opts;
      }
      function loadSectionProducts() {
        Promise.all([
          api('/api/v1/dictionary/products').catch(function () { return []; }),
          api('/api/v1/dictionary/products/types').catch(function () { return []; }),
          api('/api/v1/dictionary/currencies').catch(function () { return []; })
        ]).then(function (results) {
          var list = results[0] || [];
          var typeList = results[1] || [];
          var currencyList = results[2] || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="prodAdd">Добавить товар</button>' : '';
          content.innerHTML = '<div class="card"><h2>Товары</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет товаров.</p>'; bindProdAdd(typeList); return; }
          var sortCol = 'code';
          var sortDir = 1;
          function renderProdTable(data) {
            var sorted = data.slice().sort(function (a, b) {
              return tableSortCompare(a, b, sortCol, sortDir, function (r, c) {
                if (c === 'weight_g' || c === 'price' || c === 'expiry_days') return (r[c] != null && r[c] !== '' ? String(Number(r[c])).padStart(15, '0') : '');
                return (r[c] || '').toString().toLowerCase();
              });
            });
            var t = '<table><thead><tr>' + sortableTh('code', 'Код', sortCol, sortDir) + sortableTh('name', 'Название', sortCol, sortDir) + sortableTh('type_id', 'Тип', sortCol, sortDir) + sortableTh('weight_g', 'Вес', sortCol, sortDir) + sortableTh('unit', 'Ед.', sortCol, sortDir) + sortableTh('price', 'Цена', sortCol, sortDir) + sortableTh('currency_code', 'Валюта', sortCol, sortDir) + sortableTh('expiry_days', 'Срок', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (p) {
            var code = escAttr(p.code), name = escAttr(p.name), typeId = escAttr(p.type_id), unit = escAttr(p.unit);
            var curr = (p.currency_code || 'sum');
            t += '<tr><td>' + (p.code || '') + '</td><td>' + (p.name || '') + '</td><td>' + (p.type_id || '') + '</td><td>' + (p.weight_g != null ? p.weight_g : '') + '</td><td>' + (p.unit || '') + '</td><td>' + (p.price != null ? p.price : '') + '</td><td>' + escAttr(curr) + '</td><td>' + (p.expiry_days != null ? p.expiry_days : '') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-prod-edit data-code="' + code + '" data-name="' + name + '" data-type="' + typeId + '" data-weight="' + (p.weight_g != null ? p.weight_g : '') + '" data-unit="' + unit + '" data-price="' + (p.price != null ? p.price : '') + '" data-expiry="' + (p.expiry_days != null ? p.expiry_days : '') + '" data-currency="' + escAttr(curr) + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-prod-del data-code="' + code + '">Удалить</button>';
            t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderProdTable(list); };
            });
            bindProdAdd(typeList, currencyList);
            tableDiv.querySelectorAll('[data-prod-edit]').forEach(function (el) {
            el.onclick = function () {
              var unesc = function (x) { return (x || '').replace(/&quot;/g, '"'); };
              var code = unesc(el.getAttribute('data-code'));
              var typeOpts = productTypeSelectHtml(typeList, unesc(el.getAttribute('data-type')));
              var currSelected = unesc(el.getAttribute('data-currency') || 'sum');
              var currOpts = '<option value>—</option>';
              (currencyList || []).forEach(function (c) {
                var codeCur = escAttr(c.code);
                var label = c.code + (c.symbol ? ' (' + c.symbol + ')' : '') + (c.name ? ' — ' + c.name : '');
                currOpts += '<option value="' + codeCur + '"' + (c.code === currSelected ? ' selected' : '') + '>' + escAttr(label) + '</option>';
              });
              if (!currencyList.length) {
                currOpts += '<option value="sum"' + (currSelected === 'sum' ? ' selected' : '') + '>sum — сум</option>';
              }
              var bodyHtml = '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="prod_code" value="' + escAttr(code) + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="prod_name" value="' + (unesc(el.getAttribute('data-name')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div><div class="form-group"><label>Тип</label><select id="prod_type">' + typeOpts + '</select></div><div class="form-group"><label>Вес (г)</label><input type="number" id="prod_weight" value="' + (el.getAttribute('data-weight') || '') + '"></div><div class="form-group"><label>Ед.</label><input type="text" id="prod_unit" value="' + (unesc(el.getAttribute('data-unit')) || '').replace(/"/g, '&quot;') + '" placeholder="ШТ"></div><div class="form-group"><label>Цена</label><input type="number" step="0.01" id="prod_price" value="' + (el.getAttribute('data-price') || '') + '"></div><div class="form-group"><label>Валюта</label><select id="prod_currency">' + currOpts + '</select></div><div class="form-group"><label>Срок годности (дней)</label><input type="number" id="prod_expiry" value="' + (el.getAttribute('data-expiry') || '') + '"></div>';
              showModal('Изменить товар', bodyHtml, function (errEl) {
                return api('/api/v1/dictionary/products/' + encodeURIComponent(code), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('prod_name').value.trim(), type_id: document.getElementById('prod_type').value || null, weight_g: document.getElementById('prod_weight').value ? parseInt(document.getElementById('prod_weight').value, 10) : null, unit: document.getElementById('prod_unit').value.trim() || null, price: document.getElementById('prod_price').value ? parseFloat(document.getElementById('prod_price').value) : null, expiry_days: document.getElementById('prod_expiry').value ? parseInt(document.getElementById('prod_expiry').value, 10) : null, currency_code: document.getElementById('prod_currency').value || null }) }).then(function () { loadSectionProducts(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-prod-del]').forEach(function (el) {
            el.onclick = function () {
              var code = (el.getAttribute('data-code') || '').replace(/&quot;/g, '"');
              if (!confirm('Удалить (деактивировать) товар «' + code + '»?')) return;
              api('/api/v1/dictionary/products/' + encodeURIComponent(code), { method: 'DELETE' }).then(function () { loadSectionProducts(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); });
            };
          });
          }
          renderProdTable(list);
        }).catch(function (e) {
          document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки товаров.</p></div>';
        });
        function bindProdAdd(typeList, currencyList) {
          var btn = document.getElementById('prodAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            var typeOpts = productTypeSelectHtml(typeList, '');
            var currOpts = '<option value="sum">sum — сум (по умолчанию)</option>';
            (currencyList || []).forEach(function (c) {
              if (c.code === 'sum') return;
              var label = c.code + (c.symbol ? ' (' + c.symbol + ')' : '') + (c.name ? ' — ' + c.name : '');
              currOpts += '<option value="' + escAttr(c.code) + '">' + escAttr(label) + '</option>';
            });
            var bodyHtml = '<div class="form-group"><label>Название</label><input type="text" id="prod_name" placeholder="Название"></div><div class="form-group"><label>Тип</label><select id="prod_type">' + typeOpts + '</select></div><div class="form-group"><label>Вес (г)</label><input type="number" id="prod_weight" placeholder="0"></div><div class="form-group"><label>Ед.</label><input type="text" id="prod_unit" value="ШТ" placeholder="ШТ"></div><div class="form-group"><label>Цена</label><input type="number" step="0.01" id="prod_price" placeholder="0"></div><div class="form-group"><label>Валюта</label><select id="prod_currency">' + currOpts + '</select></div><div class="form-group"><label>Срок годности (дней)</label><input type="number" id="prod_expiry" placeholder="0"></div>';
            showModal('Добавить товар', bodyHtml, function (errEl) {
              var name = document.getElementById('prod_name').value.trim();
              if (!name) return Promise.reject({ data: { detail: 'Укажите название.' } });
              var currency = document.getElementById('prod_currency').value || 'sum';
              return api('/api/v1/dictionary/products', { method: 'POST', body: JSON.stringify({ name: name, type_id: document.getElementById('prod_type').value || null, weight_g: document.getElementById('prod_weight').value ? parseInt(document.getElementById('prod_weight').value, 10) : null, unit: document.getElementById('prod_unit').value.trim() || 'ШТ', price: document.getElementById('prod_price').value ? parseFloat(document.getElementById('prod_price').value) : null, expiry_days: document.getElementById('prod_expiry').value ? parseInt(document.getElementById('prod_expiry').value, 10) : null, currency_code: currency }) }).then(function () { loadSectionProducts(); });
            });
          };
        }
      }

      function escAttr(s) { var str = (s == null || s === undefined) ? '' : String(s); return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
      function tableSortCompare(a, b, sortCol, sortDir, getVal) {
        getVal = getVal || function (r, c) { return (r[c] || '').toString().toLowerCase(); };
        var va = getVal(a, sortCol);
        var vb = getVal(b, sortCol);
        var cmp = va < vb ? -1 : (va > vb ? 1 : 0);
        return sortDir * cmp;
      }
      function sortableTh(col, label, sortCol, sortDir) {
        var arrow = sortCol === col ? (sortDir > 0 ? ' ▲' : ' ▼') : '';
        return '<th class="sortable" data-col="' + escAttr(col) + '" style="cursor:pointer">' + escAttr(label) + arrow + '</th>';
      }
      function formatStatusBadge(statusCode, statusName) {
        var text = statusName || statusCode || '';
        var code = (statusCode || '').toLowerCase().trim();
        var cls = 'status-badge--default';
        if (code === 'completed' || code === 'delivered' || code === 'доставлен') cls = 'status-badge--completed';
        else if (code === 'delivery' || code === 'доставка') cls = 'status-badge--delivery';
        else if (code === 'open' || code === 'создан' || code === 'новый') cls = 'status-badge--open';
        else if (code === 'cancelled' || code === 'canceled' || code === 'отменен') cls = 'status-badge--cancelled';
        else if (code === 'pending') cls = 'status-badge--pending';
        return '<span class="status-badge ' + cls + '">' + escAttr(text) + '</span>';
      }
      function loadSectionRefPayment() {
        api('/api/v1/dictionary/payment-types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы оплат</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefPaymentAdd(); return; }
          var sortCol = 'code';
          var sortDir = 1;
          function renderTable(data) {
            var sorted = data.slice().sort(function (a, b) {
              return tableSortCompare(a, b, sortCol, sortDir, function (r, c) {
                if (c === 'active') return (r.active === true ? '1' : '0');
                return (r[c] || '').toString().toLowerCase();
              });
            });
            var t = '<table><thead><tr>' + sortableTh('code', 'Код', sortCol, sortDir) + sortableTh('name', 'Название', sortCol, sortDir) + sortableTh('description', 'Описание', sortCol, sortDir) + sortableTh('active', 'Активна', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (r) {
              var c = escAttr(r.code), n = escAttr(r.name), d = escAttr(r.description);
              var act = (r.active === false ? 'Нет' : 'Да');
              t += '<tr><td>' + (r.code || '') + '</td><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>' + act + '</td><td>';
              if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-code="' + c + '" data-name="' + n + '" data-desc="' + d + '" data-active="' + (r.active === false ? 'false' : 'true') + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-code="' + c + '">Удалить</button>';
              t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderTable(list); };
            });
            bindRefPaymentAdd();
            tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
            el.onclick = function () {
              showModal('Изменить тип оплаты', '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="re_code" value="' + el.getAttribute('data-code') + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="re_name" value="' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '"></div><div class="form-group"><label>Описание</label><input type="text" id="re_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>', function (errEl) {
                return api('/api/v1/dictionary/payment-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('re_name').value.trim(), description: document.getElementById('re_desc').value.trim() || null }) }).then(function () { loadSectionRefPayment(); });
              });
            };
          });
            tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
              el.onclick = function () { if (!confirm('Удалить тип оплаты «' + el.getAttribute('data-code') + '»?')) return; api('/api/v1/dictionary/payment-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'DELETE' }).then(function () { loadSectionRefPayment(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
            });
          }
          renderTable(list);
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов оплат.</p></div>'; });
        function bindRefPaymentAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип оплаты', '<div class="form-group"><label>Код</label><input type="text" id="re_code" placeholder="например card_sum"></div><div class="form-group"><label>Название</label><input type="text" id="re_name" placeholder="Название"></div><div class="form-group"><label>Описание</label><input type="text" id="re_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/dictionary/payment-types', { method: 'POST', body: JSON.stringify({ code: document.getElementById('re_code').value.trim(), name: document.getElementById('re_name').value.trim(), description: document.getElementById('re_desc').value.trim() || null }) }).then(function () { loadSectionRefPayment(); });
            });
          };
        }
      }

      function loadSectionRefCurrency() {
        api('/api/v1/dictionary/currencies').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="curAdd">Добавить валюту</button>' : '';
          var html = '<div class="card"><h2>Валюта</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет валют.</p>'; }
          else {
            var sortCol = 'code';
            var sortDir = 1;
            function renderTable(data) {
              var sorted = data.slice().sort(function (a, b) {
                return tableSortCompare(a, b, sortCol, sortDir, function (r, c) {
                  if (c === 'is_default') return (r.is_default ? '1' : '0');
                  return (r[c] || '').toString().toLowerCase();
                });
              });
              var t = '<table><thead><tr>' + sortableTh('code', 'Код', sortCol, sortDir) + sortableTh('name', 'Название', sortCol, sortDir) + sortableTh('country', 'Страна', sortCol, sortDir) + sortableTh('symbol', 'Символ', sortCol, sortDir) + sortableTh('is_default', 'По умолчанию', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
              sorted.forEach(function (c) {
                t += '<tr><td>' + escAttr(c.code || '') + '</td><td>' + escAttr(c.name || '') + '</td><td>' + escAttr(c.country || '') + '</td><td>' + escAttr(c.symbol || '') + '</td><td>' + (c.is_default ? 'Да' : '') + '</td><td>';
                if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-cur-edit data-code="' + escAttr(c.code || '') + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-cur-del data-code="' + escAttr(c.code || '') + '">Удалить</button>';
                t += '</td></tr>';
              });
              t += '</tbody></table>';
              tableDiv.innerHTML = t;
              tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
                th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderTable(list); };
              });
            }
            renderTable(list);
          }
          if (isAdmin()) {
            var addBtnEl = document.getElementById('curAdd');
            if (addBtnEl) addBtnEl.onclick = function () {
              var bodyHtml = '<div class="form-group"><label>Код</label><input type="text" id="cur_code" placeholder="sum"></div><div class="form-group"><label>Название</label><input type="text" id="cur_name" placeholder="сум"></div><div class="form-group"><label>Страна</label><input type="text" id="cur_country" placeholder="Узбекистан"></div><div class="form-group"><label>Символ</label><input type="text" id="cur_symbol" placeholder="сум"></div><div class="form-group"><label><input type="checkbox" id="cur_default"> Валюта по умолчанию</label></div>';
              showModal('Добавить валюту', bodyHtml, function (errEl) {
                var code = document.getElementById('cur_code').value.trim();
                var name = document.getElementById('cur_name').value.trim();
                if (!code || !name) { if (errEl) errEl.textContent = 'Код и название обязательны.'; return; }
                var payload = {
                  code: code,
                  name: name,
                  country: document.getElementById('cur_country').value.trim() || null,
                  symbol: document.getElementById('cur_symbol').value.trim() || null,
                  is_default: document.getElementById('cur_default').checked,
                };
                return api('/api/v1/dictionary/currencies', { method: 'POST', body: JSON.stringify(payload) }).then(function () { loadSectionRefCurrency(); });
              });
            };
            var tableDiv = document.getElementById('sectionTable');
            if (tableDiv) {
              tableDiv.querySelectorAll('[data-cur-edit]').forEach(function (el) {
                el.onclick = function () {
                  var code = el.getAttribute('data-code');
                  var row = el.closest('tr');
                  var name = row ? row.children[1].textContent : '';
                  var country = row ? row.children[2].textContent : '';
                  var symbol = row ? row.children[3].textContent : '';
                  var isDefault = row ? (row.children[4].textContent.trim() === 'Да') : false;
                  var bodyHtml = '<div class="form-group"><label>Код (нельзя изменить)</label><input type="text" id="cur_code" value="' + escAttr(code) + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="cur_name" value="' + escAttr(name) + '"></div><div class="form-group"><label>Страна</label><input type="text" id="cur_country" value="' + escAttr(country) + '"></div><div class="form-group"><label>Символ</label><input type="text" id="cur_symbol" value="' + escAttr(symbol) + '"></div><div class="form-group"><label><input type="checkbox" id="cur_default"' + (isDefault ? ' checked' : '') + '> Валюта по умолчанию</label></div>';
                  showModal('Изменить валюту', bodyHtml, function (errEl) {
                    var nameNew = document.getElementById('cur_name').value.trim();
                    if (!nameNew) { if (errEl) errEl.textContent = 'Укажите название.'; return; }
                    var payload = {
                      name: nameNew,
                      country: document.getElementById('cur_country').value.trim() || null,
                      symbol: document.getElementById('cur_symbol').value.trim() || null,
                      is_default: document.getElementById('cur_default').checked,
                    };
                    return api('/api/v1/dictionary/currencies/' + encodeURIComponent(code), { method: 'PUT', body: JSON.stringify(payload) }).then(function () { loadSectionRefCurrency(); });
                  });
                };
              });
              tableDiv.querySelectorAll('[data-cur-del]').forEach(function (el) {
                el.onclick = function () {
                  var code = el.getAttribute('data-code');
                  if (!confirm('Удалить валюту «' + code + '»?')) return;
                  api('/api/v1/dictionary/currencies/' + encodeURIComponent(code), { method: 'DELETE' }).then(function () { loadSectionRefCurrency(); }).catch(function (e) {
                    alert((e && e.data && e.data.detail) ? e.data.detail : 'Ошибка удаления валюты');
                  });
                };
              });
            }
          }
        }).catch(function (e) {
          var content = document.getElementById('content');
          if (content) content.innerHTML = '<div class="card"><p class="err">Ошибка загрузки валют.</p></div>';
        });
      }
      function loadSectionRefProducts() {
        api('/api/v1/dictionary/products/types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы продуктов</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefProductsAdd(); return; }
          var sortCol = 'name';
          var sortDir = 1;
          function renderTable(data) {
            var sorted = data.slice().sort(function (a, b) { return tableSortCompare(a, b, sortCol, sortDir); });
            var t = '<table><thead><tr>' + sortableTh('name', 'Название', sortCol, sortDir) + sortableTh('description', 'Описание', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (r) {
              var n = escAttr(r.name), d = escAttr(r.description);
              t += '<tr><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>';
              if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-name="' + n + '" data-desc="' + d + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-name="' + n + '">Удалить</button>';
              t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderTable(list); };
            });
            bindRefProductsAdd();
            tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
              el.onclick = function () {
                var nameVal = (el.getAttribute('data-name') || '').replace(/&quot;/g, '"');
                showModal('Изменить тип продукта', '<div class="form-group"><label>Название (не изменяется)</label><input type="text" id="rp_name" value="' + el.getAttribute('data-name') + '" readonly></div><div class="form-group"><label>Описание</label><input type="text" id="rp_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>', function (errEl) {
                  return api('/api/v1/dictionary/products/types/' + encodeURIComponent(nameVal), { method: 'PUT', body: JSON.stringify({ description: document.getElementById('rp_desc').value.trim() || null }) }).then(function () { loadSectionRefProducts(); });
                });
              };
            });
            tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
              el.onclick = function () { if (!confirm('Удалить тип продукта «' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '»?')) return; api('/api/v1/dictionary/products/types/' + encodeURIComponent((el.getAttribute('data-name') || '').replace(/&quot;/g, '"')), { method: 'DELETE' }).then(function () { loadSectionRefProducts(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
            });
          }
          renderTable(list);
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов продуктов.</p></div>'; });
        function bindRefProductsAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип продукта', '<div class="form-group"><label>Название</label><input type="text" id="rp_name" placeholder="например Yogurt"></div><div class="form-group"><label>Описание</label><input type="text" id="rp_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/dictionary/products/types', { method: 'POST', body: JSON.stringify({ name: document.getElementById('rp_name').value.trim(), description: document.getElementById('rp_desc').value.trim() || null }) }).then(function () { loadSectionRefProducts(); });
            });
          };
        }
      }
      function loadSectionRefOperations() {
        api('/api/v1/operation-types').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="refAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Типы операций</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindRefOpsAdd(); return; }
          var sortCol = 'code';
          var sortDir = 1;
          function renderTable(data) {
            var sorted = data.slice().sort(function (a, b) {
              var va = (a[sortCol] || '').toString().toLowerCase();
              var vb = (b[sortCol] || '').toString().toLowerCase();
              if (sortCol === 'active') {
                va = (a.active === true ? '1' : '0');
                vb = (b.active === true ? '1' : '0');
              }
              var cmp = va < vb ? -1 : (va > vb ? 1 : 0);
              return sortDir * cmp;
            });
            var arrow = sortDir > 0 ? ' ▲' : ' ▼';
            var t = '<table><thead><tr><th class="sortable" data-col="code">Код' + (sortCol === 'code' ? arrow : '') + '</th><th class="sortable" data-col="name">Название' + (sortCol === 'name' ? arrow : '') + '</th><th class="sortable" data-col="description">Описание' + (sortCol === 'description' ? arrow : '') + '</th><th class="sortable" data-col="active">Активна' + (sortCol === 'active' ? arrow : '') + '</th><th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (r) {
              var c = escAttr(r.code), n = escAttr(r.name), d = escAttr(r.description);
              var actText = (r.active === true ? 'Да' : 'Нет');
              var actAttr = (r.active === true ? 'true' : 'false');
              t += '<tr><td>' + (r.code || '') + '</td><td>' + (r.name || '') + '</td><td>' + (r.description || '') + '</td><td>' + actText + '</td><td>';
              if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-code="' + c + '" data-name="' + n + '" data-desc="' + d + '" data-active="' + actAttr + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-del data-code="' + c + '">Удалить</button>';
              t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.style.cursor = 'pointer';
              th.onclick = function () {
                var col = th.getAttribute('data-col');
                if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; }
                renderTable(list);
              };
            });
            bindRefOpsAdd();
            tableDiv.querySelectorAll('[data-edit]').forEach(function (el) {
              el.onclick = function () {
                var act = el.getAttribute('data-active') || 'true';
                var bodyHtml = ''
                  + '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="ro_code" value="' + el.getAttribute('data-code') + '" readonly></div>'
                  + '<div class="form-group"><label>Название</label><input type="text" id="ro_name" value="' + (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') + '"></div>'
                  + '<div class="form-group"><label>Описание</label><input type="text" id="ro_desc" value="' + (el.getAttribute('data-desc') || '').replace(/&quot;/g, '"') + '"></div>'
                  + '<div class="form-group"><label>Активна</label><select id="ro_active"><option value="true">Да</option><option value="false">Нет</option></select></div>';
                showModal('Изменить тип операции', bodyHtml, function (errEl) {
                  var name = document.getElementById('ro_name').value.trim();
                  var desc = document.getElementById('ro_desc').value.trim() || null;
                  var activeVal = document.getElementById('ro_active').value === 'true';
                  return api('/api/v1/operation-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'PUT', body: JSON.stringify({ name: name, description: desc, active: activeVal }) }).then(function () { loadSectionRefOperations(); });
                });
                var sel = document.getElementById('ro_active');
                if (sel) sel.value = (act === 'false' ? 'false' : 'true');
              };
            });
            tableDiv.querySelectorAll('[data-del]').forEach(function (el) {
              el.onclick = function () { if (!confirm('Удалить тип операции «' + el.getAttribute('data-code') + '»?')) return; api('/api/v1/operation-types/' + encodeURIComponent(el.getAttribute('data-code')), { method: 'DELETE' }).then(function () { loadSectionRefOperations(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
            });
          }
          renderTable(list);
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки типов операций.</p></div>'; });
        function bindRefOpsAdd() {
          var btn = document.getElementById('refAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить тип операции', '<div class="form-group"><label>Код</label><input type="text" id="ro_code" placeholder="например transfer"></div><div class="form-group"><label>Название</label><input type="text" id="ro_name" placeholder="Название"></div><div class="form-group"><label>Описание</label><input type="text" id="ro_desc" placeholder="Описание"></div>', function (errEl) {
              return api('/api/v1/operation-types', { method: 'POST', body: JSON.stringify({ code: document.getElementById('ro_code').value.trim(), name: document.getElementById('ro_name').value.trim(), description: document.getElementById('ro_desc').value.trim() || null }) }).then(function () { loadSectionRefOperations(); });
            });
          };
        }
      }

      function whUserSelectHtml(userList, selectedSk, selectedAg, selectedExp) {
        selectedSk = selectedSk || ''; selectedAg = selectedAg || ''; selectedExp = selectedExp || '';
        var optsAll = '<option value="">— Не назначен</option>';
        var optsExp = '<option value="">— Не назначен</option>';
        (userList || []).forEach(function (u) {
          var login = escAttr(u.login);
          var label = (u.login || '') + (u.fio ? ' — ' + (u.fio || '').replace(/</g, '&lt;') : '');
          optsAll += '<option value="' + login + '">' + label + '</option>';
          var role = (u.role || '').toLowerCase();
          if (role === 'expeditor') {
            optsExp += '<option value="' + login + '">' + label + '</option>';
          }
        });
        var escSk = escAttr(selectedSk), escAg = escAttr(selectedAg), escEx = escAttr(selectedExp);
        var skOpts = optsAll.replace('value="' + escSk + '"', 'value="' + escSk + '" selected');
        var agOpts = optsAll.replace('value="' + escAg + '"', 'value="' + escAg + '" selected');
        var exOpts = optsExp.replace('value="' + escEx + '"', 'value="' + escEx + '" selected');
        return '<div class="form-group"><label>Кладовщик</label><select id="wh_sk">' + skOpts + '</select></div><div class="form-group"><label>Агент</label><select id="wh_agent">' + agOpts + '</select></div><div class="form-group"><label>Экспедитор (login)</label><select id="wh_exp">' + exOpts + '</select></div>';
      }
      function loadSectionWarehouses() {
        Promise.all([
          api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; })
        ]).then(function (results) {
          var list = results[0] || [];
          var userList = results[1] || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="whAdd">Добавить</button>' : '';
          var html = '<div class="card"><h2>Склады</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('sectionTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет складов.</p>'; bindWhAdd(userList); return; }
          var sortCol = 'code';
          var sortDir = 1;
          function renderWhTable(data) {
            var sorted = data.slice().sort(function (a, b) { return tableSortCompare(a, b, sortCol, sortDir); });
            var t = '<table><thead><tr>' + sortableTh('code', 'Код', sortCol, sortDir) + sortableTh('name', 'Название', sortCol, sortDir) + sortableTh('type', 'Тип', sortCol, sortDir) + sortableTh('storekeeper', 'Кладовщик', sortCol, sortDir) + sortableTh('agent', 'Агент', sortCol, sortDir) + sortableTh('expeditor_login', 'Экспедитор (login)', sortCol, sortDir) + '<th>Действия</th></tr></thead><tbody>';
            sorted.forEach(function (w) {
            var c = escAttr(w.code), n = escAttr(w.name), ty = escAttr(w.type), sk = escAttr(w.storekeeper), ag = escAttr(w.agent), ex = escAttr(w.expeditor_login);
            t += '<tr><td>' + (w.code || '') + '</td><td>' + (w.name || '') + '</td><td>' + (w.type || '') + '</td><td>' + (w.storekeeper || '') + '</td><td>' + (w.agent || '') + '</td><td>' + (w.expeditor_login || '') + '</td><td>';
            if (isAdmin()) t += '<button type="button" class="btn btn-secondary btn-small" data-wh-edit data-code="' + c + '" data-name="' + n + '" data-type="' + ty + '" data-storekeeper="' + sk + '" data-agent="' + ag + '" data-expeditor="' + ex + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-wh-del data-code="' + c + '">Удалить</button>';
            t += '</td></tr>';
            });
            t += '</tbody></table>';
            tableDiv.innerHTML = t;
            tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
              th.onclick = function () { var col = th.getAttribute('data-col'); if (sortCol === col) sortDir = -sortDir; else { sortCol = col; sortDir = 1; } renderWhTable(list); };
            });
            bindWhAdd(userList);
            tableDiv.querySelectorAll('[data-wh-edit]').forEach(function (el) {
            el.onclick = function () {
              var unesc = function (x) { return (x || '').replace(/&quot;/g, '"'); };
              var sk = unesc(el.getAttribute('data-storekeeper'));
              var ag = unesc(el.getAttribute('data-agent'));
              var ex = unesc(el.getAttribute('data-expeditor'));
              var bodyHtml = '<div class="form-group"><label>Код (не изменяется)</label><input type="text" id="wh_code" value="' + el.getAttribute('data-code') + '" readonly></div><div class="form-group"><label>Название</label><input type="text" id="wh_name" value="' + (unesc(el.getAttribute('data-name')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div><div class="form-group"><label>Тип</label><input type="text" id="wh_type" value="' + (unesc(el.getAttribute('data-type')) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"></div>' + whUserSelectHtml(userList, sk, ag, ex);
              showModal('Изменить склад', bodyHtml, function (errEl) {
                var skVal = document.getElementById('wh_sk').value || null;
                var agVal = document.getElementById('wh_agent').value || null;
                var exVal = document.getElementById('wh_exp').value || null;
                return api('/api/v1/dictionary/warehouses/' + encodeURIComponent(unesc(el.getAttribute('data-code'))), { method: 'PUT', body: JSON.stringify({ name: document.getElementById('wh_name').value.trim(), type: document.getElementById('wh_type').value.trim() || null, storekeeper: skVal, agent: agVal, expeditor_login: exVal }) }).then(function () { loadSectionWarehouses(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-wh-del]').forEach(function (el) {
            el.onclick = function () { if (!confirm('Удалить склад «' + (el.getAttribute('data-code') || '').replace(/&quot;/g, '"') + '»?')) return; api('/api/v1/dictionary/warehouses/' + encodeURIComponent((el.getAttribute('data-code') || '').replace(/&quot;/g, '"')), { method: 'DELETE' }).then(function () { loadSectionWarehouses(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); }); };
          });
          }
          renderWhTable(list);
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки складов.</p></div>'; });
        function bindWhAdd(userList) {
          var btn = document.getElementById('whAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            var bodyHtml = '<div class="form-group"><label>Код</label><input type="text" id="wh_code" placeholder="например WH01"></div><div class="form-group"><label>Название</label><input type="text" id="wh_name" placeholder="Название"></div><div class="form-group"><label>Тип</label><input type="text" id="wh_type" placeholder="основной"></div>' + whUserSelectHtml(userList, '', '', '');
            showModal('Добавить склад', bodyHtml, function (errEl) {
              var skVal = document.getElementById('wh_sk').value || null;
              var agVal = document.getElementById('wh_agent').value || null;
              var exVal = document.getElementById('wh_exp').value || null;
              return api('/api/v1/dictionary/warehouses', { method: 'POST', body: JSON.stringify({ code: document.getElementById('wh_code').value.trim(), name: document.getElementById('wh_name').value.trim(), type: document.getElementById('wh_type').value.trim() || null, storekeeper: skVal, agent: agVal, expeditor_login: exVal }) }).then(function () { loadSectionWarehouses(); });
            });
          };
        }
      }

      function custUserSelectHtml(userList, selected) {
        selected = selected || '';
        var opts = '<option value="">— Не назначен</option>';
        (userList || []).forEach(function (u) {
          var login = escAttr(u.login);
          var label = (u.login || '') + (u.fio ? ' — ' + (u.fio || '').replace(/</g, '&lt;') : '');
          opts += '<option value="' + login + '"' + (u.login === selected ? ' selected' : '') + '>' + label + '</option>';
        });
        return opts;
      }
      var citiesCache = [];
      var territoriesCache = [];
      function loadCitiesAndTerritories() {
        console.log('=== loadCitiesAndTerritories CALLED ===');
        return Promise.all([
          api('/api/v1/dictionary/cities').then(function (data) {
            console.log('Cities API returned:', data);
            citiesCache = data || [];
            console.log('citiesCache after assignment:', citiesCache);
            return citiesCache;
          }).catch(function (err) {
            console.error('Error loading cities:', err);
            citiesCache = [];
            return citiesCache;
          }),
          api('/api/v1/dictionary/territories').then(function (data) {
            console.log('Territories API returned:', data);
            territoriesCache = data || [];
            console.log('territoriesCache after assignment:', territoriesCache);
            return territoriesCache;
          }).catch(function (err) {
            console.error('Error loading territories:', err);
            territoriesCache = [];
            return territoriesCache;
          })
        ]).then(function() {
          console.log('=== loadCitiesAndTerritories COMPLETED ===');
          console.log('Final citiesCache:', citiesCache);
          console.log('Final territoriesCache:', territoriesCache);
        });
      }
      function custInputVal(v) { return (v != null && v !== '' ? String(v) : '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
      function custEditFormHtml(c, userList) {
        console.log('custEditFormHtml called - citiesCache:', citiesCache, 'territoriesCache:', territoriesCache);
        var agOpts = custUserSelectHtml(userList, c.login_agent || '');
        var expUsers = (userList || []).filter(function (u) { return (u.role || '').toLowerCase() === 'expeditor'; });
        var exOpts = custUserSelectHtml(expUsers, c.login_expeditor || '');
        var f = function (label, id, val) { return '<div class="form-group"><label>' + label + '</label><input type="text" id="' + id + '" value="' + custInputVal(val) + '"></div>'; };
        var num = function (label, id, val) { return '<div class="form-group"><label>' + label + '</label><input type="number" step="any" id="' + id + '" value="' + custInputVal(val) + '"></div>'; };
        var cityOpts = '<option value="">— Не выбрано —</option>';
        citiesCache.forEach(function (ct) { cityOpts += '<option value="' + ct.id + '"' + (ct.id === c.city_id ? ' selected' : '') + '>' + escAttr(ct.name) + '</option>'; });
        var territoryOpts = '<option value="">— Не выбрано —</option>';
        territoriesCache.forEach(function (t) { territoryOpts += '<option value="' + t.id + '"' + (t.id === c.territory_id ? ' selected' : '') + '>' + escAttr(t.name) + '</option>'; });
        console.log('Built cityOpts:', cityOpts);
        console.log('Built territoryOpts:', territoryOpts);
        return f('Название клиента', 'cust_name', c.name_client) + f('Название фирмы', 'cust_firm', c.firm_name) + f('Категория клиента', 'cust_category', c.category_client) + f('Адрес', 'cust_address', c.address) + '<div class="form-group"><label>Город</label><select id="cust_city">' + cityOpts + '</select></div><div class="form-group"><label>Территория</label><select id="cust_territory">' + territoryOpts + '</select></div>' + f('Ориентир', 'cust_landmark', c.landmark) + f('Телефон', 'cust_phone', c.phone) + f('Контактное лицо', 'cust_contact', c.contact_person) + f('ИНН', 'cust_tax_id', c.tax_id) + f('Статус', 'cust_status', c.status) + '<div class="form-group"><label>login агента</label><select id="cust_agent">' + agOpts + '</select></div><div class="form-group"><label>login экспедитора</label><select id="cust_expeditor">' + exOpts + '</select></div>' + num('Широта', 'cust_lat', c.latitude) + num('Долгота', 'cust_lon', c.longitude) + f('ПИНФЛ', 'cust_pinfl', c.PINFL) + f('Договор №', 'cust_contract_no', c.contract_no) + f('Р/С', 'cust_account_no', c.account_no) + f('Банк', 'cust_bank', c.bank) + f('МФО', 'cust_mfo', c.MFO) + f('ОКЭД', 'cust_oked', c.OKED) + f('Регистрационный код плательщика НДС', 'cust_vat_code', c.VAT_code);
      }
      function custFormBody() {
        var g = function (id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; };
        var gn = function (id) { var v = g(id); return v === '' ? null : (Number(v)); };
        var citySelect = document.getElementById('cust_city');
        var territorySelect = document.getElementById('cust_territory');
        var cityId = citySelect && citySelect.value ? parseInt(citySelect.value, 10) : null;
        var territoryId = territorySelect && territorySelect.value ? parseInt(territorySelect.value, 10) : null;
        return { name_client: g('cust_name') || null, firm_name: g('cust_firm') || null, category_client: g('cust_category') || null, address: g('cust_address') || null, city_id: cityId, territory_id: territoryId, landmark: g('cust_landmark') || null, phone: g('cust_phone') || null, contact_person: g('cust_contact') || null, tax_id: g('cust_tax_id') || null, status: g('cust_status') || null, login_agent: document.getElementById('cust_agent') ? document.getElementById('cust_agent').value || null : null, login_expeditor: document.getElementById('cust_expeditor') ? document.getElementById('cust_expeditor').value || null : null, latitude: gn('cust_lat'), longitude: gn('cust_lon'), PINFL: g('cust_pinfl') || null, contract_no: g('cust_contract_no') || null, account_no: g('cust_account_no') || null, bank: g('cust_bank') || null, MFO: g('cust_mfo') || null, OKED: g('cust_oked') || null, VAT_code: g('cust_vat_code') || null };
      }
      function loadSectionCustomers() {
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          userList = userList || [];
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="custAdd">Добавить клиента</button>' : '';
          var exportBtn = isAdmin() ? '<button type="button" class="btn btn-secondary" id="custExport">Скачать в Excel всех клиентов</button>' : '';
          var agentOpts = '<option value="">— Все —</option>';
          var expeditorOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            agentOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorOpts += optHtml;
          });
          content.innerHTML = '<div class="card"><h2>Клиенты</h2><p style="margin:0 0 12px 0">' + addBtn + ' ' + exportBtn + '</p><div class="form-group" style="margin-bottom:12px"><label>Поиск</label></div><div style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"><input type="number" id="custSearchId" placeholder="ИД клиента" min="1" style="max-width:110px"><input id="custSearchName" placeholder="Название клиента" style="max-width:180px"><input id="custSearchFirm" placeholder="Название фирмы" style="max-width:180px"><input id="custSearchCity" placeholder="Город" style="max-width:140px"><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">login агента</label><select id="custSearchAgent" style="max-width:160px">' + agentOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">login экспедитора</label><select id="custSearchExpeditor" style="max-width:160px">' + expeditorOpts + '</select></div><input id="custSearchPhone" placeholder="Телефон" style="max-width:140px"><input id="custSearchTaxId" placeholder="ИНН" style="max-width:120px"><button type="button" class="btn btn-primary" id="btnCustSearch">Найти</button></div><div id="sectionTable"></div><div id="sectionErr" class="err"></div></div>';
          bindCustAdd(userList);
          var exportEl = document.getElementById('custExport');
          if (exportEl) exportEl.onclick = function () {
            var url = window.location.origin + '/api/v1/customers/export';
            fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clients.xlsx'; a.click(); URL.revokeObjectURL(a.href);
            }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
          };
          function runCustomerSearch() {
            var cust_id = document.getElementById('custSearchId') ? document.getElementById('custSearchId').value.trim() : '';
            var name_client = document.getElementById('custSearchName') ? document.getElementById('custSearchName').value.trim() : '';
            var firm_name = document.getElementById('custSearchFirm') ? document.getElementById('custSearchFirm').value.trim() : '';
            var city = document.getElementById('custSearchCity') ? document.getElementById('custSearchCity').value.trim() : '';
            var login_agent = document.getElementById('custSearchAgent') ? document.getElementById('custSearchAgent').value : '';
            var login_expeditor = document.getElementById('custSearchExpeditor') ? document.getElementById('custSearchExpeditor').value : '';
            var phone = document.getElementById('custSearchPhone') ? document.getElementById('custSearchPhone').value.trim() : '';
            var tax_id = document.getElementById('custSearchTaxId') ? document.getElementById('custSearchTaxId').value.trim() : '';
            var params = ['limit=500'];
            if (cust_id) params.push('customer_id=' + encodeURIComponent(cust_id));
            if (name_client) params.push('name_client=' + encodeURIComponent(name_client));
            if (firm_name) params.push('firm_name=' + encodeURIComponent(firm_name));
            if (city) params.push('city=' + encodeURIComponent(city));
            if (login_agent) params.push('login_agent=' + encodeURIComponent(login_agent));
            if (login_expeditor) params.push('login_expeditor=' + encodeURIComponent(login_expeditor));
            if (phone) params.push('phone=' + encodeURIComponent(phone));
            if (tax_id) params.push('tax_id=' + encodeURIComponent(tax_id));
            api('/api/v1/customers?' + params.join('&')).catch(function () { return []; }).then(function (list) {
              list = list || [];
              var tableDiv = document.getElementById('sectionTable');
              if (!tableDiv) return;
              if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет клиентов.</p>'; return; }
              var custSortCol = 'name_client';
              var custSortDir = 1;
              var canEditCust = isAdmin() || (menuByCode['customers'] && menuByCode['customers'] !== 'none') || (menuByCode['customers_create'] && menuByCode['customers_create'] !== 'none');
              function renderCustTable(data) {
                var sorted = data.slice().sort(function (a, b) {
                  return tableSortCompare(a, b, custSortCol, custSortDir, function (r, c) {
                    if (c === 'has_photo') return (r.has_photo ? '1' : '0');
                    if (c === 'id') return String(r[c] != null ? r[c] : 0).padStart(12, '0');
                    if (c === 'latitude' || c === 'longitude') return (r[c] != null ? r[c] : '').toString();
                    return (r[c] || '').toString().toLowerCase();
                  });
                });
                var cols = [{ col: 'id', lbl: 'ИД клиента' }, { col: 'name_client', lbl: 'Название клиента' }, { col: 'firm_name', lbl: 'Название фирмы' }, { col: 'category_client', lbl: 'Категория клиента' }, { col: 'address', lbl: 'Адрес' }, { col: 'city', lbl: 'Город' }, { col: 'territory', lbl: 'Территория' }, { col: 'landmark', lbl: 'Ориентир' }, { col: 'phone', lbl: 'Телефон' }, { col: 'contact_person', lbl: 'Контактное лицо' }, { col: 'tax_id', lbl: 'ИНН' }, { col: 'status', lbl: 'Статус' }, { col: 'login_agent', lbl: 'login агента' }, { col: 'login_expeditor', lbl: 'login экспедитора' }, { col: 'has_photo', lbl: 'Есть фото' }, { col: 'latitude', lbl: 'Широта' }, { col: 'longitude', lbl: 'Долгота' }, { col: 'PINFL', lbl: 'ПИНФЛ' }, { col: 'contract_no', lbl: 'Договор №' }, { col: 'account_no', lbl: 'Р/С' }, { col: 'bank', lbl: 'Банк' }, { col: 'MFO', lbl: 'МФО' }, { col: 'OKED', lbl: 'ОКЭД' }, { col: 'VAT_code', lbl: 'Рег. код НДС' }];
                var t = '<div style="overflow-x:auto"><table><thead><tr><th>Действия</th>';
                cols.forEach(function (x) { t += sortableTh(x.col, x.lbl, custSortCol, custSortDir); });
                t += '</tr></thead><tbody>';
                sorted.forEach(function (c) {
                  var id = c.id;
                  var custJson = escAttr(JSON.stringify(c));
                  t += '<tr><td>';
                  t += ' <button type="button" class="btn btn-secondary btn-small" data-cust-visits data-id="' + id + '" data-name="' + escAttr((c.name_client || c.firm_name || '').toString()) + '">Визиты</button> <button type="button" class="btn btn-secondary btn-small" data-cust-photos data-id="' + id + '" data-name="' + escAttr((c.name_client || c.firm_name || '').toString()) + '">Фото</button> <button type="button" class="btn btn-secondary btn-small" data-cust-edit data-id="' + id + '" data-cust-json="' + custJson + '">Изменить</button>';
                  if (isAdmin()) t += ' <button type="button" class="btn btn-secondary btn-small" data-cust-del data-id="' + id + '">Удалить</button>';
                  t += '</td><td>' + (c.id != null ? c.id : '') + '</td><td>' + escAttr(c.name_client || '') + '</td><td>' + escAttr(c.firm_name || '') + '</td><td>' + escAttr(c.category_client || '') + '</td><td>' + escAttr(c.address || '') + '</td><td>' + escAttr(c.city || '') + '</td><td>' + escAttr(c.territory || '') + '</td><td>' + escAttr(c.landmark || '') + '</td><td>' + escAttr(c.phone || '') + '</td><td>' + escAttr(c.contact_person || '') + '</td><td>' + escAttr(c.tax_id || '') + '</td><td>' + escAttr(c.status || '') + '</td><td>' + escAttr(c.login_agent || '') + '</td><td>' + escAttr(c.login_expeditor || '') + '</td><td>' + (c.has_photo ? 'Да' : 'Нет') + '</td><td>' + (c.latitude != null ? c.latitude : '') + '</td><td>' + (c.longitude != null ? c.longitude : '') + '</td><td>' + escAttr(c.PINFL || '') + '</td><td>' + escAttr(c.contract_no || '') + '</td><td>' + escAttr(c.account_no || '') + '</td><td>' + escAttr(c.bank || '') + '</td><td>' + escAttr(c.MFO || '') + '</td><td>' + escAttr(c.OKED || '') + '</td><td>' + escAttr(c.VAT_code || '') + '</td></tr>';
                });
                t += '</tbody></table></div>';
                tableDiv.innerHTML = t;
                tableDiv.querySelectorAll('th.sortable').forEach(function (th) {
                  th.onclick = function () { var col = th.getAttribute('data-col'); if (custSortCol === col) custSortDir = -custSortDir; else { custSortCol = col; custSortDir = 1; } renderCustTable(list); };
                });
                tableDiv.querySelectorAll('[data-cust-edit]').forEach(function (el) {
                el.onclick = function () {
                  var id = el.getAttribute('data-id');
                  var jsonStr = (el.getAttribute('data-cust-json') || '').replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&amp;/g, '&');
                  var c = {}; try { c = JSON.parse(jsonStr); } catch (e) {}
                  loadCitiesAndTerritories().then(function () {
                    showModal('Изменить клиента', custEditFormHtml(c, userList), function (errEl) {
                      return api('/api/v1/customers/' + id, { method: 'PATCH', body: JSON.stringify(custFormBody()) }).then(function () { loadSectionCustomers(); });
                    });
                  });
                };
              });
              tableDiv.querySelectorAll('[data-cust-del]').forEach(function (el) {
                el.onclick = function () {
                  var id = el.getAttribute('data-id');
                  if (!confirm('Удалить клиента ID ' + id + '?')) return;
                  api('/api/v1/customers/' + id, { method: 'DELETE' }).then(function () { loadSectionCustomers(); }).catch(function (e) { alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка'); });
                };
              });
              tableDiv.querySelectorAll('[data-cust-visits]').forEach(function (el) {
                el.onclick = function () {
                  var cid = el.getAttribute('data-id');
                  var cname = (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') || ('Клиент #' + cid);
                  var html = '<div id="visitsModalBody"><p>Загрузка...</p></div><p style="margin-top:12px"><button type="button" class="btn btn-primary" id="btnAddVisitModal">Добавить визит</button></p>';
                  showModal('Визиты: ' + cname, html, function () { return Promise.resolve(); });
                  var container = document.getElementById('visitsModalBody');
                  var refreshVisits = function () {
                    if (!container) return;
                    api('/api/v1/customers/' + cid + '/visits?limit=100').then(function (r) {
                      var data = Array.isArray(r) ? r : (r && r.data) || [];
                      if (!container) return;
                      if (!data.length) { container.innerHTML = '<p>Нет визитов.</p>'; return; }
                      var tbl = '<table style="width:100%"><thead><tr><th>Дата</th><th>Время</th><th>Статус</th><th>Ответственный</th><th>Комментарий</th><th></th></tr></thead><tbody>';
                      data.forEach(function (v) {
                        var statusRu = (v.status === 'planned' ? 'Запланирован' : v.status === 'completed' ? 'Завершён' : 'Отменён');
                        var canEdit = v.status !== 'cancelled';
                        tbl += '<tr><td>' + (v.visit_date || '') + '</td><td>' + (v.visit_time || '—') + '</td><td>' + statusRu + '</td><td>' + (v.responsible_name || v.responsible_login || '—') + '</td><td>' + (v.comment || '').substring(0, 50) + (v.comment && v.comment.length > 50 ? '…' : '') + '</td><td><button type="button" class="btn btn-secondary btn-small" data-visit-open data-vid="' + v.id + '">Открыть</button> ' + (canEdit ? '<button type="button" class="btn btn-secondary btn-small" data-visit-edit data-vid="' + v.id + '">Изменить</button> ' : '') + '<button type="button" class="btn btn-secondary btn-small" data-visit-del data-vid="' + v.id + '">Удалить</button></td></tr>';
                      });
                      tbl += '</tbody></table>';
                      container.innerHTML = tbl;
                      container.querySelectorAll('[data-visit-del]').forEach(function (b) {
                        b.onclick = function () {
                          if (!confirm('Удалить визит?')) return;
                          api('/api/v1/visits/' + b.getAttribute('data-vid'), { method: 'DELETE' }).then(refreshVisits).catch(function (e) { alert(e.data && e.data.detail ? e.data.detail : 'Ошибка'); });
                        };
                      });
                      container.querySelectorAll('[data-visit-open]').forEach(function (b) {
                        b.onclick = function () {
                          var vid = b.getAttribute('data-vid');
                          api('/api/v1/visits/' + vid).then(function (visit) {
                            var dateStr = visit.visit_date ? formatDateOnly(visit.visit_date) : '—';
                            var timeStr = (visit.visit_time || '').toString().substring(0, 5) || '—';
                            var statusRu = (visit.status === 'planned' ? 'Запланирован' : visit.status === 'completed' ? 'Завершён' : visit.status === 'cancelled' ? 'Отменён' : 'На рассмотрении');
                            var body = '<div class="form-group"><label>Клиент</label><div>' + escAttr(visit.customer_name || '') + '</div></div><div class="form-group"><label>Дата</label><div>' + escAttr(dateStr) + '</div></div><div class="form-group"><label>Время</label><div>' + escAttr(timeStr) + '</div></div><div class="form-group"><label>Статус</label><div>' + escAttr(statusRu) + '</div></div><div class="form-group"><label>Ответственный</label><div>' + escAttr(visit.responsible_name || visit.responsible_login || '') + '</div></div>' + (visit.comment ? '<div class="form-group"><label>Комментарий</label><div>' + escAttr(visit.comment) + '</div></div>' : '') + '<p><button type="button" class="btn btn-secondary" id="vcard_edit_inner">Изменить</button></p>';
                            showModal('Карточка визита', body, function () { return Promise.resolve(); });
                            var editBtn = document.getElementById('vcard_edit_inner');
                            if (editBtn) editBtn.onclick = function () {
                              document.querySelector('#modalContainer .modal.show') && document.querySelector('#modalContainer .modal.show').classList.remove('show');
                              openVisitEditModal(cid, visit, userList, refreshVisits);
                            };
                          });
                        };
                      });
                      container.querySelectorAll('[data-visit-edit]').forEach(function (b) {
                        b.onclick = function () {
                          var vid = b.getAttribute('data-vid');
                          api('/api/v1/visits/' + vid).then(function (visit) {
                            openVisitEditModal(cid, visit, userList, refreshVisits);
                          }).catch(function (e) { alert(e.data && e.data.detail ? e.data.detail : 'Ошибка загрузки'); });
                        };
                      });
                    }).catch(function () { if (container) container.innerHTML = '<p class="err">Ошибка загрузки визитов.</p>'; });
                  };
                  refreshVisits();
                  setTimeout(function () {
                    var addBtn = document.getElementById('btnAddVisitModal');
                    if (addBtn) addBtn.onclick = function () {
                      openVisitAddModal(cid, userList, refreshVisits);
                    };
                  }, 100);
                };
              });
              tableDiv.querySelectorAll('[data-cust-photos]').forEach(function (el) {
                el.onclick = function () {
                  var cid = el.getAttribute('data-id');
                  var cname = (el.getAttribute('data-name') || '').replace(/&quot;/g, '"') || ('Клиент #' + cid);
                  var html = '<div id="photosModalBody"><p>Загрузка...</p></div><p style="margin-top:12px"><strong>Загрузка фото</strong> (клиент: ' + escAttr(cname) + ')</p><p style="display:flex;flex-wrap:wrap;align-items:center;gap:12px"><span style="position:relative"><input type="file" id="photoFile" accept="image/*" style="position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer;font-size:0"><button type="button" class="btn btn-secondary" style="pointer-events:none">ВЫБРАТЬ ФАЙЛ!</button></span><span id="photoFileName" style="font-size:13px;color:#64748b;min-width:120px"></span><button type="button" class="btn btn-primary" id="btnUploadPhoto">Загрузить</button></p><div id="photosUploadErr" class="err" style="margin-top:8px;display:none"></div>';
                  showModal('Фото: ' + cname, html, function () { return Promise.resolve(); }, { closeOnly: true });
                  var container = document.getElementById('photosModalBody');
                  var refreshPhotos = function () {
                    if (!container) return;
                    api('/api/v1/customers/' + cid + '/photos').then(function (r) {
                      var data = (r && r.data) || [];
                      if (!container) return;
                        if (!data.length) { container.innerHTML = '<p>Нет фотографий.</p>'; return; }
                      var div = '<div style="display:flex;flex-wrap:wrap;gap:8px">';
                      data.forEach(function (p) {
                        var fname = (p.photo_path || '').split('/').pop() || '';
                        var url = p.photo_url || (fname ? (window.location.origin + '/photo/' + fname) : null) || (window.location.origin + '/api/v1/photos/download/' + (p.download_token || ''));
                        var desc = p.description || (p.photo_datetime ? ('Съёмка: ' + p.photo_datetime.slice(0, 16).replace('T', ' ')) : '—');
                        div += '<div style="flex:0 0 auto"><a href="' + url + '" target="_blank"><img src="' + url + '" alt="" style="max-width:120px;max-height:120px;object-fit:cover;border-radius:6px"></a><p style="font-size:11px;margin:4px 0 0 0">' + (desc || '—') + '</p></div>';
                      });
                      div += '</div>';
                      container.innerHTML = div;
                    }).catch(function (e) {
                      if (!container) return;
                      var msg = 'Не удалось загрузить список фотографий.';
                      if (e && e.data) {
                        var d = e.data;
                        if (typeof d === 'string') msg += ' ' + d;
                        else if (d && d.detail) msg += ' ' + (typeof d.detail === 'string' ? d.detail : JSON.stringify(d.detail));
                        else if (e.status) msg += ' (HTTP ' + e.status + ')';
                      } else if (e && e.status) msg += ' (HTTP ' + e.status + ')';
                      container.innerHTML = '<p class="err">' + msg + '</p><p style="margin-top:8px"><button type="button" class="btn btn-secondary" id="btnRetryPhotos">Повторить</button></p>';
                      var retryBtn = document.getElementById('btnRetryPhotos');
                      if (retryBtn) retryBtn.onclick = refreshPhotos;
                    });
                  };
                  refreshPhotos();
                  setTimeout(function () {
                    var fileInput = document.getElementById('photoFile');
                    var photoFileNameEl = document.getElementById('photoFileName');
                    var uploadErrEl = document.getElementById('photosUploadErr');
                    if (fileInput && photoFileNameEl) fileInput.addEventListener('change', function () {
                      photoFileNameEl.textContent = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
                      if (uploadErrEl) uploadErrEl.textContent = '';
                    });
                    var uploadBtn = document.getElementById('btnUploadPhoto');
                    if (uploadBtn) uploadBtn.onclick = function () {
                      var fileInput = document.getElementById('photoFile');
                      if (!fileInput || !fileInput.files || !fileInput.files[0]) { if (uploadErrEl) { uploadErrEl.textContent = 'Выберите файл'; uploadErrEl.className = 'err'; uploadErrEl.style.display = 'block'; } else alert('Выберите файл'); return; }
                      var token = localStorage.getItem('sds_token');
                      if (!token) { var m = 'Нет токена авторизации. Войдите заново.'; if (uploadErrEl) { uploadErrEl.textContent = m; uploadErrEl.style.display = 'block'; } else alert(m); return; }
                      uploadBtn.disabled = true;
                      if (uploadErrEl) { uploadErrEl.textContent = 'Загрузка...'; uploadErrEl.className = ''; uploadErrEl.style.display = 'block'; }
                      var fd = new FormData();
                      fd.append('file', fileInput.files[0]);
                      fd.append('is_main', 'false');
                      var url = window.location.origin + '/api/v1/customers/' + cid + '/photos';
                      console.log('[Photo upload] POST', url, 'file:', fileInput.files[0].name);
                      fetch(url, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd }).then(function (res) {
                        console.log('[Photo upload] status', res.status, res.statusText);
                        if (!res.ok) return res.text().then(function (text) {
                          var d;
                          try { d = JSON.parse(text); } catch (_) { d = { detail: res.status + ' ' + res.statusText + (text ? ': ' + text.slice(0, 200) : '') }; }
                          throw d;
                        });
                        return res.json();
                      }).then(function (data) {
                        console.log('[Photo upload] success', data);
                        fileInput.value = '';
                        if (photoFileNameEl) photoFileNameEl.textContent = '';
                        if (uploadErrEl) { uploadErrEl.textContent = 'Загружено.'; uploadErrEl.className = 'msg'; uploadErrEl.style.display = 'block'; }
                        refreshPhotos();
                      }).catch(function (e) {
                        console.error('[Photo upload] error', e);
                        var msg = (e && e.detail) ? (typeof e.detail === 'string' ? e.detail : JSON.stringify(e.detail)) : (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) ? e.message : 'Ошибка загрузки фото';
                        if (uploadErrEl) { uploadErrEl.textContent = msg; uploadErrEl.className = 'err'; uploadErrEl.style.display = 'block'; } else alert(msg);
                      }).finally(function () { uploadBtn.disabled = false; });
                    };
                  }, 150);
                };
              });
            }
              renderCustTable(list);
            });
          }
          document.getElementById('btnCustSearch').onclick = runCustomerSearch;
          runCustomerSearch();
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки.</p></div>'; });
        function bindCustAdd(userList) {
          var btn = document.getElementById('custAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            loadCitiesAndTerritories().then(function () {
              var bodyHtml = custEditFormHtml({ status: 'Активный' }, userList);
              showModal('Добавить клиента', bodyHtml, function (errEl) {
                return api('/api/v1/customers', { method: 'POST', body: JSON.stringify(custFormBody()) }).then(function () { loadSectionCustomers(); });
              });
            });
          };
        }
      }

      function loadSectionCustomersMap() {
        var content = document.getElementById('content');
        if (!content) return;
        content.innerHTML = '<div class="card"><h2>Клиенты на карте</h2><div class="map-toolbar"><label>Карта:</label><select id="mapProvider"><option value="yandex">Яндекс.Карты</option><option value="osm">OpenStreetMap</option></select></div><p id="customersMapInfo" style="margin:0 0 12px 0;font-size:14px;color:#555">Загрузка...</p><div id="customersMap"></div></div>';
        api('/api/v1/config').catch(function () { return {}; }).then(function (config) {
          var yandexKey = (config && config.yandexMapsApiKey) ? config.yandexMapsApiKey : '';
          api('/api/v1/customers?limit=2000').catch(function () { return []; }).then(function (list) {
            list = list || [];
            var withCoords = list.filter(function (c) { return c.latitude != null && c.longitude != null && !isNaN(Number(c.latitude)) && !isNaN(Number(c.longitude)); });
            var infoEl = document.getElementById('customersMapInfo');
            var noCoordsMsg = withCoords.length === 0 ? ' Нет клиентов с координатами — укажите широту и долготу в карточке клиента (Поиск клиента → Изменить).' : '';
            if (infoEl) infoEl.innerHTML = 'Отображено клиентов на карте: ' + withCoords.length + (list.length ? ' (из ' + list.length + ')' : '') + (noCoordsMsg ? '<br><span style="color:#856404">' + noCoordsMsg + '</span>' : '');
            var defaultCenter = [41.2995, 69.2401];
            var zoom = 10;
            if (withCoords.length === 1) { defaultCenter = [Number(withCoords[0].latitude), Number(withCoords[0].longitude)]; }
            if (withCoords.length > 1) {
              var minLat = Math.min.apply(null, withCoords.map(function (c) { return Number(c.latitude); }));
              var maxLat = Math.max.apply(null, withCoords.map(function (c) { return Number(c.latitude); }));
              var minLon = Math.min.apply(null, withCoords.map(function (c) { return Number(c.longitude); }));
              var maxLon = Math.max.apply(null, withCoords.map(function (c) { return Number(c.longitude); }));
              defaultCenter = [(minLat + maxLat) / 2, (minLon + maxLon) / 2];
            }
            var center = defaultCenter;
            var leafletMap = null;
            function destroyCurrentMap() {
              if (window._customersLeafletMap) {
                try { window._customersLeafletMap.remove(); } catch (e) {}
                window._customersLeafletMap = null;
              }
              var container = document.getElementById('customersMap');
              if (container) container.innerHTML = '';
            }
            function initOsmMap() {
              destroyCurrentMap();
              var container = document.getElementById('customersMap');
              if (!container) return;
              function doInit() {
                if (window._customersLeafletMap) return;
                var map = L.map('customersMap').setView(center, zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
                withCoords.forEach(function (c) {
                  var lat = Number(c.latitude);
                  var lon = Number(c.longitude);
                  var name = (c.name_client || c.firm_name || 'Клиент #' + (c.id || '')).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                  var addr = (c.address || '') + (c.city ? ', ' + c.city : '') + (c.territory ? ', ' + c.territory : '');
                  var popup = '<div style="padding:4px 0"><strong>' + name + '</strong></div>' + (addr ? '<div style="font-size:12px;color:#666">' + addr.replace(/</g, '&lt;') + '</div>' : '') + (c.phone ? '<div style="font-size:12px">' + (c.phone + '').replace(/</g, '&lt;') + '</div>' : '');
                  L.marker([lat, lon]).addTo(map).bindPopup(popup);
                });
                if (withCoords.length > 1) map.fitBounds(withCoords.map(function (c) { return [Number(c.latitude), Number(c.longitude)]; }), { padding: [50, 50] });
                window._customersLeafletMap = map;
              }
              if (typeof L !== 'undefined') { doInit(); return; }
              var link = document.createElement('link');
              link.rel = 'stylesheet'; link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY='; link.crossOrigin = '';
              document.head.appendChild(link);
              var script = document.createElement('script');
              script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
              script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo='; script.crossOrigin = '';
              script.onload = doInit;
              document.head.appendChild(script);
            }
            function initYandexMap() {
              destroyCurrentMap();
              var container = document.getElementById('customersMap');
              if (container) container.innerHTML = '<div id="customersMapInner" style="width:100%;height:100%;min-height:400px"></div>';
              if (typeof ymaps === 'undefined' && !yandexKey) {
                if (infoEl) infoEl.innerHTML = 'Отображено клиентов на карте: ' + withCoords.length + '. <span style="color:#c00">Для Яндекс.Карт задайте YANDEX_MAPS_API_KEY на сервере или выберите OpenStreetMap.</span>';
                return;
              }
              function doYandex() {
                if (typeof ymaps === 'undefined') {
                  var script = document.createElement('script');
                  script.src = 'https://api-maps.yandex.ru/2.1/?apikey=' + encodeURIComponent(yandexKey) + '&lang=ru_RU';
                  script.onload = doYandex; script.onerror = function () { if (infoEl) infoEl.innerHTML = 'Ошибка загрузки Яндекс.Карт.'; };
                  document.head.appendChild(script);
                  return;
                }
                ymaps.ready(function () {
                  var mapDiv = document.getElementById('customersMapInner') || document.getElementById('customersMap');
                  if (!mapDiv) return;
                  var map = new ymaps.Map(mapDiv, { center: center, zoom: zoom, controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl'] });
                  withCoords.forEach(function (c) {
                    var lat = Number(c.latitude);
                    var lon = Number(c.longitude);
                    var name = (c.name_client || c.firm_name || 'Клиент #' + (c.id || '')).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    var addr = (c.address || '') + (c.city ? ', ' + c.city : '') + (c.territory ? ', ' + c.territory : '');
                    var balloon = '<div style="padding:4px 0"><strong>' + name + '</strong></div>' + (addr ? '<div style="font-size:12px;color:#666">' + addr.replace(/</g, '&lt;') + '</div>' : '') + (c.phone ? '<div style="font-size:12px">' + (c.phone + '').replace(/</g, '&lt;') + '</div>' : '');
                    var placemark = new ymaps.Placemark([lat, lon], { balloonContent: balloon }, { preset: 'islands#redCircleIcon' });
                    map.geoObjects.add(placemark);
                  });
                  if (withCoords.length > 1) map.setBounds(map.geoObjects.getBounds(), { checkZoomRange: true, zoomMargin: 50 });
                });
              }
              doYandex();
            }
            function renderMap() {
              var sel = document.getElementById('mapProvider');
              var provider = (sel && sel.value) ? sel.value : 'osm';
              if (provider === 'osm') initOsmMap(); else initYandexMap();
            }
            document.getElementById('mapProvider').onchange = renderMap;
            renderMap();
          });
        });
      }

      function loadSectionOrders() {
        var content = document.getElementById('content');
        if (!content) return;
        content.innerHTML = '<div class="card"><h2>Заказы</h2><p style="margin:0 0 12px 0"><button type="button" class="btn btn-primary" id="orderAdd">Создать заказ</button>' + (isAdmin() ? ' <button type="button" class="btn btn-secondary" id="orderExport">Скачать заказы в Excel</button>' : '') + '</p><div class="form-group" style="margin:12px 0"><label>Поиск заказов</label></div><div id="orderSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="sectionOrderErr" class="err"></div><div id="orderInfo" style="margin:12px 0;padding:8px;background:#f8f9fa;border-radius:4px;font-size:13px"></div><div id="sectionTable"></div></div>';
        var tableDiv = document.getElementById('sectionTable');
        var errDiv = document.getElementById('sectionOrderErr');
        var searchRow = document.getElementById('orderSearchRow');
        bindOrderAdd();
        var orderExportBtn = document.getElementById('orderExport');
        if (orderExportBtn) orderExportBtn.onclick = function () {
          var url = window.location.origin + '/api/v1/orders/export';
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'orders.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
        };
        function formatDateTashkent(isoStr) {
          if (!isoStr) return '';
          try {
            var d = new Date(isoStr);
            return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
          } catch (e) { return isoStr; }
        }
        function formatScheduledDelivery(isoStr, statusCode) {
          var text = formatDateTashkent(isoStr);
          if (!text) return '';
          var sc = (statusCode || '').toString().toLowerCase().replace(/\s/g, '');
          if (sc === 'completed' || sc === 'cancelled' || sc === 'canceled' || sc === 'отменен' || sc === 'завершен' || sc === 'closed' || sc === '4' || (sc.length && sc.charAt(0) === '4') || sc.indexOf('отменен') !== -1) return text;
          try {
            var d = new Date(isoStr);
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            d.setHours(0, 0, 0, 0);
            if (d < today) return '<span style="color:#c00;font-weight:bold" title="Просрочена">' + text + '</span>';
          } catch (e) {}
          return text;
        }
        var orderSortCol = 'order_no';
        var orderSortDir = 1;
        function renderOrderTable(data) {
          if (errDiv) errDiv.textContent = '';
          var list = Array.isArray(data) ? data : (data && data.orders ? data.orders : []);
          var totalAmount = 0;
          var totalCount = 0;
          var infoDiv = document.getElementById('orderInfo');
          
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            totalCount = data.total_count || list.length;
            totalAmount = data.total_amount || 0;
          } else {
            totalCount = list.length;
            list.forEach(function(o) {
              totalAmount += (o.total_amount || 0);
            });
          }
          
          if (infoDiv) {
            infoDiv.innerHTML = '<strong>Найдено заказов:</strong> ' + totalCount + ' | <strong>Итого сумма:</strong> ' + totalAmount.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' сум';
          }
          
          if (!list || !list.length) { 
            tableDiv.innerHTML = '<p>Заказов не найдено. Измените критерии поиска или создайте заказ.</p>'; 
            if (infoDiv && totalCount === 0) {
              infoDiv.innerHTML = '<strong>Найдено заказов:</strong> 0 | <strong>Итого сумма:</strong> 0,00 сум';
            }
            return; 
          }
          var sorted = list.slice().sort(function (a, b) {
            return tableSortCompare(a, b, orderSortCol, orderSortDir, function (r, c) {
              if (c === 'order_no') return String(r.order_no != null ? r.order_no : (r.id || 0)).padStart(12, '0');
              if (c === 'total_amount') return (r.total_amount != null ? String(Number(r.total_amount)).padStart(20, '0') : '');
              if (c === 'order_date' || c === 'scheduled_delivery_at' || c === 'last_updated_at') return (r[c] || '').toString();
              return (r[c] || (r.customer_name || (r.customer_id != null ? 'ID ' + r.customer_id : '')) || '').toString().toLowerCase();
            });
          });
          var arrow = orderSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (orderSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Действия</th>' + th('order_no', '№') + th('customer_name', 'Клиент') + th('order_date', 'Дата создания') + th('status_code', 'Статус') + th('payment_type_name', 'Тип оплаты') + th('total_amount', 'Сумма') + th('login_agent', 'Агент') + th('login_expeditor', 'Экспедитор') + th('scheduled_delivery_at', 'Дата поставки') + '<th>Перевод в статус «Доставка»</th><th>Дата закрытия</th>' + th('last_updated_at', 'Последнее изменение') + th('last_updated_by', 'Кто изменил') + '</tr></thead><tbody>';
          sorted.forEach(function (o) {
            t += '<tr><td><button type="button" class="btn btn-secondary btn-small" data-order-edit data-id="' + (o.order_no != null ? o.order_no : o.id) + '">Изменить</button> <button type="button" class="btn btn-secondary btn-small" data-order-copy data-id="' + (o.order_no != null ? o.order_no : o.id) + '" style="background:#17a2b8;color:#fff;border-color:#17a2b8">Копировать</button></td><td>' + (o.order_no != null ? o.order_no : o.id) + '</td><td>' + escAttr(o.customer_name || (o.customer_id != null ? 'ID ' + o.customer_id : '')) + '</td><td>' + formatDateTashkent(o.order_date) + '</td><td>' + formatStatusBadge(o.status_code, o.status_name) + '</td><td>' + escAttr(o.payment_type_name || o.payment_type_code || '') + '</td><td>' + (o.total_amount != null ? o.total_amount : '') + '</td><td>' + escAttr(o.login_agent || '') + '</td><td>' + escAttr(o.login_expeditor || '') + '</td><td>' + formatScheduledDelivery(o.scheduled_delivery_at, o.status_code) + '</td><td>' + formatDateTashkent(o.status_delivery_at) + '</td><td>' + formatDateTashkent(o.closed_at) + '</td><td>' + formatDateTashkent(o.last_updated_at) + '</td><td>' + escAttr(o.last_updated_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (orderSortCol === col) orderSortDir = -orderSortDir; else { orderSortCol = col; orderSortDir = 1; } renderOrderTable(data); };
          });
          tableDiv.querySelectorAll('[data-order-edit]').forEach(function (el) {
            el.onclick = function () {
              var orderId = el.getAttribute('data-id') || '';
              api('/api/v1/orders/' + orderId).then(function (orderData) {
                Promise.all([
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/orders/statuses').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  var customers = results[0] || [];
                  var statuses = results[1] || [];
                  var products = results[2] || [];
                  var paymentTypes = results[3] || [];
                  var userList = results[4] || [];
                  openOrderForm(true, orderId, orderData, customers, statuses, products, paymentTypes, userList);
                });
              }).catch(function (e) {
                if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Не удалось загрузить заказ.';
              });
            };
          });
          tableDiv.querySelectorAll('[data-order-copy]').forEach(function (el) {
            el.onclick = function () {
              var orderId = el.getAttribute('data-id') || '';
              api('/api/v1/orders/' + orderId).then(function (orderData) {
                Promise.all([
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/orders/statuses').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  var customers = results[0] || [];
                  var statuses = results[1] || [];
                  var products = results[2] || [];
                  var paymentTypes = results[3] || [];
                  var userList = results[4] || [];
                  var copyData = {
                    customer_id: orderData.customer_id,
                    customer_name: orderData.customer_name,
                    status_code: 'open',
                    payment_type_code: orderData.payment_type_code,
                    login_agent: orderData.login_agent,
                    login_expeditor: orderData.login_expeditor,
                    scheduled_delivery_at: null,
                    items: (orderData.items || []).map(function (it) {
                      return { product_code: it.product_code, quantity: it.quantity, price: it.price };
                    })
                  };
                  openOrderForm(false, null, copyData, customers, statuses, products, paymentTypes, userList);
                  var titleEl = document.getElementById('orderFormTitle');
                  if (titleEl) titleEl.textContent = 'Копия заказа № ' + orderId;
                });
              }).catch(function (e) {
                if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Не удалось загрузить заказ.';
              });
            };
          });
        }
        var ORDER_SEARCH_STORAGE = 'orderSearchFilters';
        var ORDER_PRESETS_STORAGE = 'orderSearchPresets';
        function getOrderSearchFilters() {
          var order_no = document.getElementById('orderSearchOrderNo') ? document.getElementById('orderSearchOrderNo').value : '';
          var customer_id = document.getElementById('orderSearchCustomerId') ? document.getElementById('orderSearchCustomerId').value : '';
          var status_code = document.getElementById('orderSearchStatus') ? document.getElementById('orderSearchStatus').value : '';
          var date_from = document.getElementById('orderSearchDateFrom') ? document.getElementById('orderSearchDateFrom').value : '';
          var date_to = document.getElementById('orderSearchDateTo') ? document.getElementById('orderSearchDateTo').value : '';
          var login_agent = document.getElementById('orderSearchAgent') ? document.getElementById('orderSearchAgent').value : '';
          var login_expeditor = document.getElementById('orderSearchExpeditor') ? document.getElementById('orderSearchExpeditor').value : '';
          var last_updated_by = document.getElementById('orderSearchLastUpdatedBy') ? document.getElementById('orderSearchLastUpdatedBy').value : '';
          return { order_no: order_no, customer_id: customer_id, status_code: status_code, date_from: date_from, date_to: date_to, login_agent: login_agent, login_expeditor: login_expeditor, last_updated_by: last_updated_by };
        }
        function setOrderSearchFilters(f) {
          if (!f) return;
          var el;
          if (el = document.getElementById('orderSearchOrderNo')) el.value = f.order_no || '';
          if (el = document.getElementById('orderSearchCustomerId')) el.value = f.customer_id || '';
          if (el = document.getElementById('orderSearchStatus')) el.value = f.status_code || '';
          if (el = document.getElementById('orderSearchDateFrom')) el.value = f.date_from || '';
          if (el = document.getElementById('orderSearchDateTo')) el.value = f.date_to || '';
          if (el = document.getElementById('orderSearchAgent')) el.value = f.login_agent || '';
          if (el = document.getElementById('orderSearchExpeditor')) el.value = f.login_expeditor || '';
          if (el = document.getElementById('orderSearchLastUpdatedBy')) el.value = f.last_updated_by || '';
        }
        function runOrderSearch() {
          var f = getOrderSearchFilters();
          try { localStorage.setItem(ORDER_SEARCH_STORAGE, JSON.stringify(f)); } catch (e) {}
          var params = [];
          if (f.order_no) params.push('order_no=' + encodeURIComponent(f.order_no));
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.status_code) params.push('status_code=' + encodeURIComponent(f.status_code));
          if (f.date_from) params.push('scheduled_delivery_from=' + encodeURIComponent(f.date_from + 'T00:00:00'));
          if (f.date_to) params.push('scheduled_delivery_to=' + encodeURIComponent(f.date_to + 'T23:59:59'));
          if (f.login_agent) params.push('login_agent=' + encodeURIComponent(f.login_agent));
          if (f.login_expeditor) params.push('login_expeditor=' + encodeURIComponent(f.login_expeditor));
          if (f.last_updated_by) params.push('last_updated_by=' + encodeURIComponent(f.last_updated_by));
          api('/api/v1/orders' + (params.length ? '?' + params.join('&') : '')).then(renderOrderTable).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки заказов.';
            tableDiv.innerHTML = '<p>Список заказов не загружен.</p>';
          });
        }
        Promise.all([
          api('/api/v1/orders/statuses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; })
        ]).then(function (results) {
          var statuses = results[0] || [];
          var userList = results[1] || [];
          var customers = results[2] || [];
          if (!statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = '<option value="">— Все —</option>'; statuses.forEach(function (s) { statusOpts += '<option value="' + escAttr(s.code) + '">' + escAttr(s.name || s.code) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>';
          var expeditorUserOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            userOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorUserOpts += optHtml;
          });
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var presets = [];
          try { var p = localStorage.getItem(ORDER_PRESETS_STORAGE); if (p) presets = JSON.parse(p); } catch (e) {}
          var presetOpts = '<option value="">— Текущий поиск —</option>';
          presets.forEach(function (pr, i) { presetOpts += '<option value="' + i + '">' + escAttr(pr.name || 'Вариант ' + (i + 1)) + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Сохранённый поиск</label><select id="orderSearchPreset" style="max-width:180px">' + presetOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Номер заказа</label><input type="number" id="orderSearchOrderNo" min="1" style="max-width:110px" placeholder="№ заказа"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="orderSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="orderSearchStatus" style="max-width:140px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки с</label><input type="text" id="orderSearchDateFrom" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="orderSearchDateTo" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Агент</label><select id="orderSearchAgent" style="max-width:160px">' + userOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Экспедитор</label><select id="orderSearchExpeditor" style="max-width:160px">' + expeditorUserOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто изменил</label><select id="orderSearchLastUpdatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="orderSearchBtn">Найти</button> <button type="button" class="btn btn-secondary" id="orderSearchSavePreset">Сохранить вариант</button>';
          document.getElementById('orderSearchBtn').onclick = runOrderSearch;
          document.getElementById('orderSearchPreset').onchange = function () {
            var idx = this.value;
            if (idx === '') return;
            var pr = presets[parseInt(idx, 10)];
            if (pr && pr.filters) { setOrderSearchFilters(pr.filters); runOrderSearch(); }
          };
          document.getElementById('orderSearchSavePreset').onclick = function () {
            var name = prompt('Название варианта поиска (например: Мои заказы)');
            if (!name || !name.trim()) return;
            var f = getOrderSearchFilters();
            presets.push({ name: name.trim(), filters: f });
            try { localStorage.setItem(ORDER_PRESETS_STORAGE, JSON.stringify(presets)); } catch (e) {}
            var sel = document.getElementById('orderSearchPreset');
            var opt = document.createElement('option'); opt.value = presets.length - 1; opt.textContent = name.trim(); sel.appendChild(opt);
          };
          var savedFilters = null;
          try { var s = localStorage.getItem(ORDER_SEARCH_STORAGE); if (s) savedFilters = JSON.parse(s); } catch (e) {}
          if (window.flatpickr) {
            var df = document.getElementById('orderSearchDateFrom');
            var dt = document.getElementById('orderSearchDateTo');
            if (df) window.flatpickr(df, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
            if (dt) window.flatpickr(dt, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
          }
          if (savedFilters) { setOrderSearchFilters(savedFilters); runOrderSearch(); } else { tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти» или выберите сохранённый вариант.</p>'; }
          function tryOpenOrderCard() {
            if (!window._openOrderNo) return;
            var orderNo = window._openOrderNo;
            window._openOrderNo = null;
            api('/api/v1/orders/' + orderNo).then(function (orderData) {
              Promise.all([
                api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                api('/api/v1/orders/statuses').catch(function () { return []; }),
                api('/api/v1/dictionary/products').catch(function () { return []; }),
                api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                api('/api/v1/dictionary/user-logins').catch(function () { return []; })
              ]).then(function (results) {
                openOrderForm(true, orderNo, orderData, results[0], results[1], results[2], results[3], results[4]);
              });
            }).catch(function () {});
          }
          tryOpenOrderCard();
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="orderSearchBtn">Загрузить заказы</button>';
          document.getElementById('orderSearchBtn').onclick = runOrderSearch;
          setTimeout(function () {
            if (window._openOrderNo) {
              var orderNo = window._openOrderNo;
              window._openOrderNo = null;
              api('/api/v1/orders/' + orderNo).then(function (orderData) {
                Promise.all([
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/orders/statuses').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  openOrderForm(true, orderNo, orderData, results[0], results[1], results[2], results[3], results[4]);
                });
              }).catch(function () {});
            }
          }, 100);
        });
        function openOrderForm(isEdit, orderId, orderData, customers, statuses, products, paymentTypes, userList) {
          var sel = orderData ? { cust: orderData.customer_id, status: orderData.status_code || 'open', payment: orderData.payment_type_code || '', agent: orderData.login_agent || '', exp: orderData.login_expeditor || '' } : { cust: '', status: 'open', payment: '', agent: '', exp: '' };
          var custOpts = '<option value="">— Выберите клиента —</option>';
          customers.forEach(function (c) { var s = (sel.cust != null && String(sel.cust) === String(c.id)) ? ' selected' : ''; custOpts += '<option value="' + (c.id != null ? c.id : '') + '"' + s + '>' + escAttr((c.name_client || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          if (!statuses || !statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = ''; statuses.forEach(function (s) { var o = (s.code === sel.status) ? ' selected' : ''; statusOpts += '<option value="' + escAttr(s.code) + '"' + o + '>' + escAttr(s.name || s.code) + '</option>'; });
          var payOpts = '<option value="">— Выберите тип оплаты —</option>'; paymentTypes.forEach(function (pt) { var o = (pt.code === sel.payment) ? ' selected' : ''; payOpts += '<option value="' + escAttr(pt.code) + '"' + o + '>' + escAttr(pt.name || pt.code) + '</option>'; });
          var productOpts = '<option value="">— Выберите товар —</option>';
          products.forEach(function (p) { productOpts += '<option value="' + escAttr(p.code) + '" data-price="' + (p.price != null ? p.price : '') + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var agentOpts = '<option value="">— Не назначен —</option>';
          var expeditorOpts = '<option value="">— Не назначен —</option>';
          userList.forEach(function (u) {
            var oAgent = (u.login === sel.agent) ? ' selected' : '';
            agentOpts += '<option value="' + escAttr(u.login) + '"' + oAgent + '>' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            if ((u.role || '').toLowerCase() === 'expeditor') {
              var oExp = (u.login === sel.exp) ? ' selected' : '';
              expeditorOpts += '<option value="' + escAttr(u.login) + '"' + oExp + '>' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            }
          });
          var content = document.getElementById('content');
          if (!content) return;
          content.innerHTML = '<div class="card"><h2 id="orderFormTitle">Создание заказа</h2><div id="orderCreateErr" class="err" style="margin-bottom:12px"></div><div id="orderFormMsg" class="msg" style="margin-bottom:12px;display:none"></div><div class="form-group"><label>Клиент</label><select id="orderCreateCustomer">' + custOpts + '</select></div><div class="form-group"><label>Агент</label><select id="orderCreateAgent">' + agentOpts + '</select></div><div class="form-group"><label>Экспедитор</label><select id="orderCreateExpeditor">' + expeditorOpts + '</select></div><div class="form-group"><label>Статус</label><select id="orderCreateStatus">' + statusOpts + '</select></div><div class="form-group"><label>Тип оплаты</label><select id="orderCreatePaymentType">' + payOpts + '</select></div><div class="form-group"><label>Назначенная дата поставки</label><input type="text" id="orderScheduledDelivery" placeholder="дд.мм.гггг чч:мм" autocomplete="off"></div><div class="form-group"><label>Позиции заказа</label></div><div style="overflow-x:auto"><table><thead><tr><th>Товар</th><th>Количество</th><th>Цена</th><th>Действия</th></tr></thead><tbody id="orderCreateItemsBody"></tbody></table></div><p style="margin:12px 0"><button type="button" class="btn btn-secondary" id="orderAddRow">Добавить позицию</button></p><div class="form-group"><label>Сумма</label><div id="orderCreateSum" style="padding:6px 0;font-weight:600">0</div></div><p><button type="button" class="btn btn-primary" id="orderCreateSave">Сохранить заказ</button> <button type="button" class="btn btn-secondary" id="orderCreateCancel">Отмена</button></p><div style="margin-top:24px;padding:12px;background:#f8f9fa;border-radius:6px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата создания заказа</label><div id="orderOrderDate" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Перевод в статус «Доставка»</label><div id="orderStatusDeliveryAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата и время закрытия заказа</label><div id="orderClosedAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px;color:#666">Дата последнего изменения</label><div id="orderLastUpdatedAt" class="form-readonly">—</div></div><div class="form-group" style="margin-bottom:0"><label style="font-size:12px;color:#666">Кто изменил</label><div id="orderLastUpdatedBy" class="form-readonly">—</div></div></div></div>';
          document.getElementById('orderFormTitle').textContent = isEdit ? ('Редактирование заказа № ' + orderId) : 'Создание заказа';
          function formatDateTashkent(isoStr) {
            if (!isoStr) return '—';
            try {
              var d = new Date(isoStr);
              return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            } catch (e) { return isoStr; }
          }
          function isoToDatetimeLocal(isoStr) {
            if (!isoStr) return '';
            try {
              var d = new Date(isoStr);
              var y = d.getFullYear(); var m = String(d.getMonth() + 1).padStart(2, '0'); var day = String(d.getDate()).padStart(2, '0');
              var h = String(d.getHours()).padStart(2, '0'); var min = String(d.getMinutes()).padStart(2, '0');
              return y + '-' + m + '-' + day + 'T' + h + ':' + min;
            } catch (e) { return ''; }
          }
          if (isEdit && orderData) {
            document.getElementById('orderOrderDate').textContent = formatDateTashkent(orderData.order_date);
            document.getElementById('orderStatusDeliveryAt').textContent = formatDateTashkent(orderData.status_delivery_at);
            document.getElementById('orderClosedAt').textContent = formatDateTashkent(orderData.closed_at);
            document.getElementById('orderLastUpdatedAt').textContent = formatDateTashkent(orderData.last_updated_at);
            document.getElementById('orderLastUpdatedBy').textContent = orderData.last_updated_by || '—';
          } else {
            document.getElementById('orderOrderDate').textContent = '—';
          }
          var schedEl = document.getElementById('orderScheduledDelivery');
          if (window.flatpickr && schedEl) {
            var defaultDate = (isEdit && orderData && orderData.scheduled_delivery_at) ? orderData.scheduled_delivery_at : null;
            window.flatpickr(schedEl, {
              enableTime: true,
              time_24hr: true,
              locale: 'ru',
              dateFormat: 'Y-m-d H:i',
              defaultDate: defaultDate,
              allowInput: false,
              firstDayOfWeek: 1
            });
          }
          var tbody = document.getElementById('orderCreateItemsBody');
          function updateAgentExpeditor() {
            var cid = document.getElementById('orderCreateCustomer').value;
            var cust = customers.filter(function (c) { return String(c.id) === String(cid); })[0];
            var agSel = document.getElementById('orderCreateAgent'); var exSel = document.getElementById('orderCreateExpeditor');
            if (agSel) { agSel.value = cust && cust.login_agent ? cust.login_agent : ''; }
            if (exSel) { exSel.value = cust && cust.login_expeditor ? cust.login_expeditor : ''; }
          }
          function updateSum() {
            var rows = tbody.querySelectorAll('tr'); var sum = 0;
            for (var i = 0; i < rows.length; i++) {
              var qty = parseInt(rows[i].querySelector('.order-item-qty').value, 10) || 0;
              var priceVal = rows[i].querySelector('.order-item-price').value.trim();
              var price = priceVal !== '' ? parseFloat(priceVal) : 0;
              sum += qty * price;
            }
            var el = document.getElementById('orderCreateSum'); if (el) el.textContent = sum;
          }
          document.getElementById('orderCreateCustomer').onchange = updateAgentExpeditor;
          function addRow(existingItem) {
            var tr = document.createElement('tr');
            if (existingItem) tr.setAttribute('data-item-id', existingItem.id || '');
            var qty = (existingItem && existingItem.quantity != null) ? existingItem.quantity : 1;
            var priceStr = (existingItem && existingItem.price != null) ? existingItem.price : '';
            tr.innerHTML = '<td><select class="order-item-product" style="min-width:220px">' + productOpts + '</select></td><td><input type="number" min="1" class="order-item-qty" value="' + qty + '" style="width:80px"></td><td><input type="number" step="0.01" min="0" class="order-item-price" placeholder="по прайсу" value="' + priceStr + '" style="width:100px"></td><td><button type="button" class="btn btn-secondary btn-small order-item-del">Удалить</button></td>';
            tbody.appendChild(tr);
            if (existingItem && existingItem.product_code) { var selProd = tr.querySelector('.order-item-product'); selProd.value = existingItem.product_code; }
            tr.querySelector('.order-item-product').onchange = function () {
              var opt = this.options[this.selectedIndex];
              var price = opt && opt.getAttribute('data-price');
              var priceInput = tr.querySelector('.order-item-price');
              if (priceInput && price) priceInput.value = price;
              updateSum();
            };
            tr.querySelector('.order-item-qty').oninput = tr.querySelector('.order-item-price').oninput = updateSum;
            tr.querySelector('.order-item-del').onclick = function () { tr.remove(); updateSum(); };
          }
          if (orderData && orderData.items && orderData.items.length) {
            orderData.items.forEach(function (it) { addRow(it); });
          } else {
            addRow(null);
          }
          updateSum();
          document.getElementById('orderAddRow').onclick = function () { addRow(null); };
          document.getElementById('orderCreateCancel').onclick = function () { loadSectionOrders(); };
          document.getElementById('orderCreateSave').onclick = function () {
            var errEl = document.getElementById('orderCreateErr');
            var msgEl = document.getElementById('orderFormMsg');
            var saveBtn = document.getElementById('orderCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var customer_id = document.getElementById('orderCreateCustomer').value;
            var statusEl = document.getElementById('orderCreateStatus');
            var status_code = statusEl.value || 'open';
            var statusLabel = '';
            if (statusEl && statusEl.selectedIndex >= 0) statusLabel = String(statusEl.options[statusEl.selectedIndex].textContent || '').toLowerCase();
            var statusCodeLower = String(status_code || '').toLowerCase();
            var isDeliveryStatus = ['2', 'delivery', 'доставка'].indexOf(statusCodeLower) >= 0 || /достав|deliver|shipping/.test((statusLabel + ' ' + statusCodeLower).toLowerCase());
            var payment_type_code = document.getElementById('orderCreatePaymentType').value || null;
            if (!customer_id) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
            var rows = tbody.querySelectorAll('tr');
            var items = []; var total = 0;
            for (var i = 0; i < rows.length; i++) {
              var product = rows[i].querySelector('.order-item-product').value;
              var qty = parseInt(rows[i].querySelector('.order-item-qty').value, 10) || 0;
              var priceVal = rows[i].querySelector('.order-item-price').value.trim();
              var price = priceVal !== '' ? parseFloat(priceVal) : null;
              if (product && qty > 0) { items.push({ product_code: product, quantity: qty, price: price, itemId: rows[i].getAttribute('data-item-id') || null }); total += qty * (price || 0); }
            }
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы одну позицию с товаром и количеством.'; return; }
            function errText(e) {
              if (!e) return 'Неизвестная ошибка';
              var d = e.data;
              if (d && d.detail !== undefined) {
                if (typeof d.detail === 'string') return d.detail;
                if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || JSON.stringify(x); }).join(' ');
                return JSON.stringify(d.detail);
              }
              if (d) return JSON.stringify(d);
              return (e.message || e.status || 'Ошибка соединения или сервера') + '';
            }
            var login_agent = document.getElementById('orderCreateAgent').value || null;
            var login_expeditor = document.getElementById('orderCreateExpeditor').value || null;
            var schedInput = document.getElementById('orderScheduledDelivery');
            var schedRaw = schedInput && schedInput.value ? schedInput.value.trim() : '';
            if (isDeliveryStatus && !schedRaw) {
              if (errEl) errEl.textContent = 'Для статуса «Доставка» укажите «Назначенная дата поставки».';
              return;
            }
            var scheduled_delivery_at = null;
            if (schedRaw) {
              try {
                var v = schedRaw.replace(' ', 'T');
                if (v && v.length >= 16) scheduled_delivery_at = new Date(v + (v.length === 16 ? ':00' : '')).toISOString();
              } catch (e) {}
            }
            if (isDeliveryStatus && !scheduled_delivery_at) {
              if (errEl) errEl.textContent = 'Некорректная дата поставки. Выберите дату из календаря.';
              return;
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess() {
              if (msgEl) { msgEl.textContent = 'Заказ сохранён.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOrders(); }, 1500);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить заказ';
              if (errEl) errEl.textContent = errText(e);
            }
            if (isEdit) {
              api('/api/v1/orders/' + orderId, { method: 'PATCH', body: JSON.stringify({ customer_id: parseInt(customer_id, 10), status_code: status_code, payment_type_code: payment_type_code || null, total_amount: total, scheduled_delivery_at: scheduled_delivery_at }) }).then(function () {
                var keptIds = [];
                var chain = Promise.resolve();
                items.forEach(function (it) {
                  if (it.itemId) {
                    keptIds.push(it.itemId);
                    chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items/' + it.itemId, { method: 'PATCH', body: JSON.stringify({ quantity: it.quantity, price: it.price }) }); });
                  } else {
                    chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items', { method: 'POST', body: JSON.stringify({ product_code: it.product_code, quantity: it.quantity, price: it.price }) }); });
                  }
                });
                var toDelete = (orderData.items || []).filter(function (it) { return it.id && keptIds.indexOf(it.id) === -1; });
                toDelete.forEach(function (it) {
                  chain = chain.then(function () { return api('/api/v1/orders/' + orderId + '/items/' + it.id, { method: 'DELETE' }); });
                });
                chain.then(function () {
                  return api('/api/v1/customers/' + customer_id, { method: 'PATCH', body: JSON.stringify({ login_agent: login_agent, login_expeditor: login_expeditor }) });
                }).then(doneSuccess).catch(doneError);
              }).catch(doneError);
            } else {
              api('/api/v1/orders', { method: 'POST', body: JSON.stringify({ customer_id: parseInt(customer_id, 10), status_code: status_code, payment_type_code: payment_type_code, scheduled_delivery_at: scheduled_delivery_at }) }).then(function (res) {
                var newOrderId = res && res.id;
                if (!newOrderId) { doneError({ data: { detail: 'Заказ не создан.' } }); return; }
                var chain = Promise.resolve();
                items.forEach(function (it) {
                  chain = chain.then(function () { return api('/api/v1/orders/' + newOrderId + '/items', { method: 'POST', body: JSON.stringify({ product_code: it.product_code, quantity: it.quantity, price: it.price }) }); });
                });
                chain.then(function () {
                  return api('/api/v1/orders/' + newOrderId, { method: 'PATCH', body: JSON.stringify({ total_amount: total }) });
                }).then(function () {
                  return api('/api/v1/customers/' + customer_id, { method: 'PATCH', body: JSON.stringify({ login_agent: login_agent, login_expeditor: login_expeditor }) });
                }).then(doneSuccess).catch(doneError);
              }).catch(doneError);
            }
          };
        }
        function bindOrderAdd() {
          var btn = document.getElementById('orderAdd');
          if (!btn) return;
          btn.onclick = function () {
            Promise.all([
              api('/api/v1/customers?limit=1000').catch(function () { return []; }),
              api('/api/v1/orders/statuses').catch(function () { return []; }),
              api('/api/v1/dictionary/products').catch(function () { return []; }),
              api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
              api('/api/v1/dictionary/user-logins').catch(function () { return []; })
            ]).then(function (results) {
              openOrderForm(false, null, null, results[0] || [], results[1] || [], results[2] || [], results[3] || [], results[4] || []);
            }).catch(function (e) {
              var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка';
              var content = document.getElementById('content');
              if (content) content.innerHTML = '<div class="card"><h2>Заказы</h2><p class="err">Ошибка загрузки данных для создания заказа: ' + msg + '</p><p><button type="button" class="btn btn-secondary" id="orderBackToList">Вернуться к списку</button> <button type="button" class="btn btn-primary" id="orderAdd">Создать заказ</button></p><div id="sectionTable"></div></div>';
              bindOrderAdd();
              var backBtn = document.getElementById('orderBackToList');
              if (backBtn) backBtn.onclick = function () { loadSectionOrders(); };
            });
          };
        }
      }
      function loadSectionOrderItems() {
        var content = document.getElementById('content');
        if (!content) return;
        content.innerHTML = '<div class="card"><h2>Позиции заказов</h2><p style="margin:0 0 12px 0">' + (isAdmin() ? '<button type="button" class="btn btn-secondary" id="orderItemsExport">Скачать позиции в Excel</button>' : '') + '</p><div class="form-group" style="margin:12px 0"><label>Поиск позиций заказов</label></div><div id="orderItemsSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="sectionOrderItemsErr" class="err"></div><div id="orderItemsInfo" style="margin:12px 0;padding:8px;background:#f8f9fa;border-radius:4px;font-size:13px"></div><div id="orderItemsTable"></div><div id="orderItemsPagination" style="margin-top:16px;display:flex;justify-content:center;align-items:center;gap:8px"></div></div>';
        var tableDiv = document.getElementById('orderItemsTable');
        var errDiv = document.getElementById('sectionOrderItemsErr');
        var searchRow = document.getElementById('orderItemsSearchRow');
        var exportBtn = document.getElementById('orderItemsExport');
        function formatDateTashkent(isoStr) {
          if (!isoStr) return '';
          try {
            var d = new Date(isoStr);
            return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
          } catch (e) { return isoStr; }
        }
        function formatScheduledDeliveryOi(isoStr, statusCode) {
          var text = formatDateTashkent(isoStr);
          if (!text) return '';
          var sc = (statusCode || '').toString().toLowerCase().replace(/\s/g, '');
          if (sc === 'completed' || sc === 'cancelled' || sc === 'canceled' || sc === 'отменен' || sc === 'завершен' || sc === 'closed' || sc === '4' || (sc.length && sc.charAt(0) === '4') || sc.indexOf('отменен') !== -1) return text;
          try {
            var d = new Date(isoStr);
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            d.setHours(0, 0, 0, 0);
            if (d < today) return '<span style="color:#c00;font-weight:bold" title="Просрочена">' + text + '</span>';
          } catch (e) {}
          return text;
        }
        function getFilters() {
          var customer_id = document.getElementById('orderItemsSearchCustomerId') ? document.getElementById('orderItemsSearchCustomerId').value : '';
          var status_code = document.getElementById('orderItemsSearchStatus') ? document.getElementById('orderItemsSearchStatus').value : '';
          var date_from = document.getElementById('orderItemsSearchDateFrom') ? document.getElementById('orderItemsSearchDateFrom').value : '';
          var date_to = document.getElementById('orderItemsSearchDateTo') ? document.getElementById('orderItemsSearchDateTo').value : '';
          var login_agent = document.getElementById('orderItemsSearchAgent') ? document.getElementById('orderItemsSearchAgent').value : '';
          var login_expeditor = document.getElementById('orderItemsSearchExpeditor') ? document.getElementById('orderItemsSearchExpeditor').value : '';
          var last_updated_by = document.getElementById('orderItemsSearchLastUpdatedBy') ? document.getElementById('orderItemsSearchLastUpdatedBy').value : '';
          return { customer_id: customer_id, status_code: status_code, date_from: date_from, date_to: date_to, login_agent: login_agent, login_expeditor: login_expeditor, last_updated_by: last_updated_by };
        }
        function buildQuery(f) {
          var params = [];
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.status_code) params.push('status_code=' + encodeURIComponent(f.status_code));
          if (f.date_from) params.push('scheduled_delivery_from=' + encodeURIComponent(f.date_from + 'T00:00:00'));
          if (f.date_to) params.push('scheduled_delivery_to=' + encodeURIComponent(f.date_to + 'T23:59:59'));
          if (f.login_agent) params.push('login_agent=' + encodeURIComponent(f.login_agent));
          if (f.login_expeditor) params.push('login_expeditor=' + encodeURIComponent(f.login_expeditor));
          if (f.last_updated_by) params.push('last_updated_by=' + encodeURIComponent(f.last_updated_by));
          return params.length ? '?' + params.join('&') : '';
        }
        var currentPage = 1;
        var pageSize = 100;
        var totalCount = 0;
        var totalAmount = 0;
        var oiSortCol = 'order_no';
        var oiSortDir = 1;
        var lastOiData = null;
        function renderTable(data) {
          if (errDiv) errDiv.textContent = '';
          lastOiData = data;
          var list = Array.isArray(data) ? data : (data && data.items ? data.items : []);
          var infoDiv = document.getElementById('orderItemsInfo');
          var paginationDiv = document.getElementById('orderItemsPagination');
          
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            totalCount = data.total_count || 0;
            totalAmount = data.total_amount || 0;
            currentPage = Math.floor((data.offset || 0) / pageSize) + 1;
          } else {
            totalCount = list.length;
            totalAmount = 0;
            list.forEach(function(r) {
              var amt = (r.amount != null ? r.amount : ((r.quantity || 0) * (r.price != null ? r.price : 0)));
              totalAmount += amt;
            });
          }
          
          if (infoDiv) {
            var start = totalCount > 0 ? ((currentPage - 1) * pageSize + 1) : 0;
            var end = totalCount > 0 ? Math.min(currentPage * pageSize, totalCount) : 0;
            infoDiv.innerHTML = '<strong>Найдено позиций:</strong> ' + totalCount + ' | <strong>Показано:</strong> ' + (totalCount > 0 ? start + '-' + end : '0') + ' | <strong>Общая сумма:</strong> ' + totalAmount.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' сум';
          }
          
          if (!list || !list.length) { 
            tableDiv.innerHTML = '<p>Позиции заказов не найдены. Измените критерии поиска.</p>'; 
            if (paginationDiv) paginationDiv.innerHTML = '';
            if (infoDiv && totalCount === 0) {
              infoDiv.innerHTML = '<strong>Найдено позиций:</strong> 0 | <strong>Показано:</strong> 0 | <strong>Общая сумма:</strong> 0,00 сум';
            }
            return; 
          }
          
          var sorted = list.slice().sort(function (a, b) {
            return tableSortCompare(a, b, oiSortCol, oiSortDir, function (r, c) {
              if (c === 'quantity' || c === 'price' || c === 'amount') { var v = r[c] != null ? r[c] : (c === 'amount' ? ((r.quantity || 0) * (r.price != null ? r.price : 0)) : ''); return (v !== '' && v != null ? String(Number(v)).padStart(20, '0') : ''); }
              return (r[c] || '').toString().toLowerCase();
            });
          });
          var arrow = oiSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (oiSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Заказ</th>' + th('order_no', '№ заказа') + th('customer_name', 'Клиент') + th('order_date', 'Дата заказа') + th('status_code', 'Статус') + th('payment_type_name', 'Тип оплаты') + th('product_code', 'Код товара') + th('product_name', 'Товар') + th('quantity', 'Количество') + th('price', 'Цена') + th('amount', 'Сумма') + th('login_agent', 'Агент') + th('login_expeditor', 'Экспедитор') + th('scheduled_delivery_at', 'Дата поставки') + '<th>Перевод в статус «Доставка»</th><th>Дата закрытия</th>' + th('order_last_updated_at', 'Последнее изменение заказа') + th('order_last_updated_by', 'Кто изменил') + '</tr></thead><tbody>';
          sorted.forEach(function (r) {
            var amt = (r.amount != null ? r.amount : ((r.quantity || 0) * (r.price != null ? r.price : 0)));
            var orderNo = (r.order_no != null ? r.order_no : '');
            t += '<tr><td><button type="button" class="btn btn-secondary btn-small" data-order-open data-order-no="' + escAttr(orderNo) + '" title="Открыть заказ">📋</button></td><td>' + orderNo + '</td><td>' + escAttr(r.customer_name || (r.customer_id != null ? 'ID ' + r.customer_id : '')) + '</td><td>' + formatDateTashkent(r.order_date) + '</td><td>' + formatStatusBadge(r.status_code, r.status_name) + '</td><td>' + escAttr(r.payment_type_name || r.payment_type_code || '') + '</td><td>' + escAttr(r.product_code || '') + '</td><td>' + escAttr(r.product_name || '') + '</td><td>' + (r.quantity != null ? r.quantity : '') + '</td><td>' + (r.price != null ? r.price : '') + '</td><td>' + (amt != null ? amt : '') + '</td><td>' + escAttr(r.login_agent || '') + '</td><td>' + escAttr(r.login_expeditor || '') + '</td><td>' + formatScheduledDeliveryOi(r.scheduled_delivery_at, r.status_code) + '</td><td>' + formatDateTashkent(r.status_delivery_at) + '</td><td>' + formatDateTashkent(r.closed_at) + '</td><td>' + formatDateTashkent(r.order_last_updated_at) + '</td><td>' + escAttr(r.order_last_updated_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (oiSortCol === col) oiSortDir = -oiSortDir; else { oiSortCol = col; oiSortDir = 1; } renderTable(lastOiData); };
          });
          tableDiv.querySelectorAll('[data-order-open]').forEach(function (btn) {
            btn.onclick = function () {
              var orderNo = btn.getAttribute('data-order-no');
              if (orderNo) { window._openOrderNo = orderNo; showSection('orders'); }
            };
          });
          // Пагинация
          if (paginationDiv && totalCount > pageSize) {
            var totalPages = Math.ceil(totalCount / pageSize);
            var pagHtml = '';
            if (currentPage > 1) {
              pagHtml += '<button type="button" class="btn btn-secondary btn-small" id="orderItemsPagePrev">‹ Предыдущая</button>';
            }
            pagHtml += '<span style="padding:0 12px">Страница ' + currentPage + ' из ' + totalPages + '</span>';
            if (currentPage < totalPages) {
              pagHtml += '<button type="button" class="btn btn-secondary btn-small" id="orderItemsPageNext">Следующая ›</button>';
            }
            paginationDiv.innerHTML = pagHtml;
            var prevBtn = document.getElementById('orderItemsPagePrev');
            var nextBtn = document.getElementById('orderItemsPageNext');
            if (prevBtn) prevBtn.onclick = function() { currentPage--; runSearch(false); };
            if (nextBtn) nextBtn.onclick = function() { currentPage++; runSearch(false); };
          } else if (paginationDiv) {
            paginationDiv.innerHTML = '';
          }
        }
        var searchButtonClicked = false;
        function runSearch(resetPage) {
          if (resetPage !== false) {
            currentPage = 1;
          }
          var f = getFilters();
          var qs = buildQuery(f);
          var offset = (currentPage - 1) * pageSize;
          if (qs) {
            qs += '&limit=' + pageSize + '&offset=' + offset;
          } else {
            qs = '?limit=' + pageSize + '&offset=' + offset;
          }
          api('/api/v1/orders/items' + qs).then(function(data) {
            renderTable(data);
          }).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки позиций заказов.';
            tableDiv.innerHTML = '<p>Список позиций не загружен.</p>';
            var infoDiv = document.getElementById('orderItemsInfo');
            var paginationDiv = document.getElementById('orderItemsPagination');
            if (infoDiv) infoDiv.innerHTML = '';
            if (paginationDiv) paginationDiv.innerHTML = '';
          });
        }
        if (exportBtn) {
          exportBtn.onclick = function () {
            var f = getFilters();
            var qs = buildQuery(f);
            var url = window.location.origin + '/api/v1/orders/items/export' + qs;
            fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'order_items.xlsx'; a.click(); URL.revokeObjectURL(a.href);
            }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
          };
        }
        Promise.all([
          api('/api/v1/orders/statuses').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; })
        ]).then(function (results) {
          var statuses = results[0] || [];
          var userList = results[1] || [];
          var customers = results[2] || [];
          if (!statuses.length) statuses = [{ code: 'open', name: 'Открыт' }, { code: 'cancelled', name: 'Отменён' }];
          statuses = statuses.slice().sort(function (a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });
          var statusOpts = '<option value="">— Все —</option>'; statuses.forEach(function (s) { statusOpts += '<option value="' + escAttr(s.code) + '">' + escAttr(s.name || s.code) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>';
          var expeditorUserOpts = '<option value="">— Все —</option>';
          userList.forEach(function (u) {
            var optHtml = '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
            userOpts += optHtml;
            if ((u.role || '').toLowerCase() === 'expeditor') expeditorUserOpts += optHtml;
          });
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="orderItemsSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="orderItemsSearchStatus" style="max-width:140px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки с</label><input type="text" id="orderItemsSearchDateFrom" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="orderItemsSearchDateTo" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Агент</label><select id="orderItemsSearchAgent" style="max-width:160px">' + userOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Экспедитор</label><select id="orderItemsSearchExpeditor" style="max-width:160px">' + expeditorUserOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто изменил</label><select id="orderItemsSearchLastUpdatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="orderItemsSearchBtn">Найти</button>';
          document.getElementById('orderItemsSearchBtn').onclick = runSearch;
          if (window.flatpickr) {
            var df = document.getElementById('orderItemsSearchDateFrom');
            var dt = document.getElementById('orderItemsSearchDateTo');
            if (df) window.flatpickr(df, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
            if (dt) window.flatpickr(dt, { locale: 'ru', dateFormat: 'Y-m-d', allowInput: true });
          }
          currentPage = 1;
          totalCount = 0;
          totalAmount = 0;
          tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти».</p>';
          var infoDiv = document.getElementById('orderItemsInfo');
          var paginationDiv = document.getElementById('orderItemsPagination');
          if (infoDiv) infoDiv.innerHTML = '';
          if (paginationDiv) paginationDiv.innerHTML = '';
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="orderItemsSearchBtn">Загрузить позиции</button>';
          document.getElementById('orderItemsSearchBtn').onclick = runSearch;
        });
      }

      function loadSectionOperations(showCreate, openCreateForm) {
        var content = document.getElementById('content');
        if (!content) return;
        var canCreate = (typeof showCreate === 'boolean') ? showCreate : true;
        var addBtn = (isAdmin() && canCreate) ? '<button type="button" class="btn btn-primary" id="opAdd">Создать операцию</button>' : '';
        var exportBtn = isAdmin() ? ' <button type="button" class="btn btn-secondary" id="opExport">Скачать в Excel</button>' : '';
        content.innerHTML = '<div class="card"><h2>Операции</h2><p style="margin:0 0 12px 0">' + addBtn + exportBtn + '</p><div class="form-group" style="margin:12px 0"><label>Поиск операций</label></div><div id="opSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><div id="opSectionErr" class="err"></div><div id="opSectionTable"></div></div>';
        var tableDiv = document.getElementById('opSectionTable');
        var errDiv = document.getElementById('opSectionErr');
        var searchRow = document.getElementById('opSearchRow');
        bindOperationAdd();
        var opExportBtn = document.getElementById('opExport');
        if (opExportBtn) opExportBtn.onclick = function () {
          var url = window.location.origin + '/api/v1/operations/export';
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'operations.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) { alert('Ошибка выгрузки: ' + (e && e.data && e.data.detail ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : e.message || 'Ошибка')); });
        };
        function formatDateOp(isoStr) {
          if (!isoStr) return '';
          try { var d = new Date(isoStr); return d.toLocaleDateString('ru-RU'); } catch (e) { return isoStr; }
        }
        function operationStatusRu(code) {
          var m = { pending: 'В ожидании', completed: 'Выполнено', cancelled: 'Отменено', canceled: 'Отменено' };
          return m[(code || '').toString().toLowerCase()] || (code || '');
        }
        var opSortCol = 'operation_number';
        var opSortDir = 1;
        var lastOpList = null;
        function renderOpTable(list) {
          if (errDiv) errDiv.textContent = '';
          lastOpList = list;
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Операций не найдено. Измените критерии поиска или создайте операцию.</p>'; return; }
          var sorted = list.slice().sort(function (a, b) {
            return tableSortCompare(a, b, opSortCol, opSortDir, function (r, c) {
              if (c === 'quantity' || c === 'amount') return (r[c] != null && r[c] !== '' ? String(Number(r[c])).padStart(20, '0') : '');
              return (r[c] || (r.type_name || r.type_code) || (r.customer_name || (r.customer_id != null ? 'ID ' + r.customer_id : '')) || '').toString().toLowerCase();
            });
          });
          var arrow = opSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (opSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>Действия</th>' + th('operation_number', '№ операции') + th('operation_date', 'Дата') + th('type_code', 'Тип') + th('status', 'Статус') + th('customer_name', 'Клиент') + th('product_code', 'Товар') + th('quantity', 'Кол-во') + th('amount', 'Сумма') + th('order_id', 'Заказ №') + th('created_by', 'Кто создал') + '</tr></thead><tbody>';
          sorted.forEach(function (o) {
            t += '<tr><td><button type="button" class="btn btn-secondary btn-small" data-op-edit data-id="' + escAttr(o.id) + '">Изменить</button></td><td>' + escAttr(o.operation_number || '') + '</td><td>' + formatDateOp(o.operation_date) + '</td><td>' + escAttr(o.type_name || o.type_code || '') + '</td><td>' + formatStatusBadge(o.status, (o.status_name_ru != null && o.status_name_ru !== '') ? o.status_name_ru : operationStatusRu(o.status)) + '</td><td>' + escAttr(o.customer_name || (o.customer_id != null ? 'ID ' + o.customer_id : '')) + '</td><td>' + escAttr(o.product_code || '') + '</td><td>' + (o.quantity != null ? o.quantity : '') + '</td><td>' + (o.amount != null ? o.amount : '') + '</td><td>' + (o.order_id != null ? o.order_id : '') + '</td><td>' + escAttr(o.created_by || '') + '</td></tr>';
          });
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (opSortCol === col) opSortDir = -opSortDir; else { opSortCol = col; opSortDir = 1; } renderOpTable(lastOpList); };
          });
          tableDiv.querySelectorAll('[data-op-edit]').forEach(function (el) {
            el.onclick = function () {
              var opId = el.getAttribute('data-id') || '';
              api('/api/v1/operations/' + opId).then(function (opData) {
                Promise.all([
                  api('/api/v1/operation-types').catch(function () { return []; }),
                  api('/api/v1/customers?limit=1000').catch(function () { return []; }),
                  api('/api/v1/dictionary/products').catch(function () { return []; }),
                  api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
                  api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
                  api('/api/v1/dictionary/user-logins').catch(function () { return []; })
                ]).then(function (results) {
                  var types = results[0] || [];
                  // При редактировании показываем все типы (включая неактивные), чтобы можно было редактировать существующие операции
                  // Но если операция использует неактивный тип, он всё равно будет доступен
                  openOperationForm(true, opId, opData, types, results[1] || [], results[2] || [], results[3] || [], results[4] || [], results[5] || []);
                });
              }).catch(function (e) {
                if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Не удалось загрузить операцию.';
              });
            };
          });
        }
        var OP_SEARCH_STORAGE = 'opSearchFilters';
        function getOpSearchFilters() {
          return {
            type_code: document.getElementById('opSearchType') ? document.getElementById('opSearchType').value : '',
            status: document.getElementById('opSearchStatus') ? document.getElementById('opSearchStatus').value : '',
            customer_id: document.getElementById('opSearchCustomerId') ? document.getElementById('opSearchCustomerId').value : '',
            product_code: document.getElementById('opSearchProduct') ? document.getElementById('opSearchProduct').value : '',
            from_date: document.getElementById('opSearchDateFrom') ? document.getElementById('opSearchDateFrom').value : '',
            to_date: document.getElementById('opSearchDateTo') ? document.getElementById('opSearchDateTo').value : '',
            created_by: document.getElementById('opSearchCreatedBy') ? document.getElementById('opSearchCreatedBy').value : ''
          };
        }
        function setOpSearchFilters(f) {
          if (!f) return;
          var el;
          if (el = document.getElementById('opSearchType')) el.value = f.type_code || '';
          if (el = document.getElementById('opSearchStatus')) el.value = f.status || '';
          if (el = document.getElementById('opSearchCustomerId')) el.value = f.customer_id || '';
          if (el = document.getElementById('opSearchProduct')) el.value = f.product_code || '';
          if (el = document.getElementById('opSearchDateFrom')) el.value = f.from_date || '';
          if (el = document.getElementById('opSearchDateTo')) el.value = f.to_date || '';
          if (el = document.getElementById('opSearchCreatedBy')) el.value = f.created_by || '';
        }
        function runOpSearch() {
          var f = getOpSearchFilters();
          try { localStorage.setItem(OP_SEARCH_STORAGE, JSON.stringify(f)); } catch (e) {}
          var params = [];
          if (f.type_code) params.push('type_code=' + encodeURIComponent(f.type_code));
          if (f.status) params.push('status=' + encodeURIComponent(f.status));
          if (f.customer_id) params.push('customer_id=' + encodeURIComponent(f.customer_id));
          if (f.product_code) params.push('product_code=' + encodeURIComponent(f.product_code));
          if (f.from_date) params.push('from_date=' + encodeURIComponent(f.from_date));
          if (f.to_date) params.push('to_date=' + encodeURIComponent(f.to_date));
          if (f.created_by) params.push('created_by=' + encodeURIComponent(f.created_by));
          api('/api/v1/operations' + (params.length ? '?' + params.join('&') : '')).then(renderOpTable).catch(function (e) {
            if (errDiv) errDiv.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка загрузки операций.';
            tableDiv.innerHTML = '<p>Список не загружен.</p>';
          });
        }
        Promise.all([
          api('/api/v1/operation-types').catch(function () { return []; }),
          api('/api/v1/customers?limit=2000').catch(function () { return []; }),
          api('/api/v1/dictionary/products').catch(function () { return []; }),
          api('/api/v1/dictionary/user-logins').catch(function () { return []; })
        ]).then(function (results) {
          var types = results[0] || [];
          var customers = results[1] || [];
          var products = results[2] || [];
          var userList = results[3] || [];
          // Фильтруем только активные типы операций для фильтров
          var activeTypes = types.filter(function(ty) { return ty.active !== false; });
          var typeOpts = '<option value="">— Все —</option>'; activeTypes.forEach(function (ty) { typeOpts += '<option value="' + escAttr(ty.code) + '">' + escAttr(ty.name || ty.code) + '</option>'; });
          var statusOpts = '<option value="">— Все —</option><option value="pending">В ожидании</option><option value="completed">Выполнено</option><option value="cancelled">Отменено</option>';
          var custOpts = '<option value="">— Любой —</option>'; customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var prodOpts = '<option value="">— Любой —</option>'; products.forEach(function (p) { prodOpts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var userOpts = '<option value="">— Все —</option>'; userList.forEach(function (u) { userOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>'; });
          searchRow.innerHTML = '<div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Тип</label><select id="opSearchType" style="max-width:160px">' + typeOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="opSearchStatus" style="max-width:100px">' + statusOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Клиент</label><select id="opSearchCustomerId" style="max-width:220px">' + custOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Товар</label><select id="opSearchProduct" style="max-width:200px">' + prodOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата с</label><input type="text" id="opSearchDateFrom" placeholder="дд.мм.гггг" style="max-width:130px"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="opSearchDateTo" placeholder="дд.мм.гггг" style="max-width:130px"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Кто создал</label><select id="opSearchCreatedBy" style="max-width:160px">' + userOpts + '</select></div><button type="button" class="btn btn-primary" id="opSearchBtn">Найти</button>';
          if (window.flatpickr) {
            var opDf = document.getElementById('opSearchDateFrom');
            var opDt = document.getElementById('opSearchDateTo');
            if (opDf) window.flatpickr(opDf, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
            if (opDt) window.flatpickr(opDt, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          }
          document.getElementById('opSearchBtn').onclick = runOpSearch;
          var savedFilters = null;
          try { var s = localStorage.getItem(OP_SEARCH_STORAGE); if (s) savedFilters = JSON.parse(s); } catch (e) {}
          if (savedFilters) {
            setOpSearchFilters(savedFilters);
          }
          tableDiv.innerHTML = '<p style="color:#666">Укажите критерии поиска и нажмите «Найти» или оставьте поля пустыми и нажмите «Найти» для полного списка. По умолчанию запрос не выполняется автоматически.</p>';
          if (openCreateForm && window.openOperationCreate) {
            window.openOperationCreate();
          }
        }).catch(function () {
          searchRow.innerHTML = '<button type="button" class="btn btn-primary" id="opSearchBtn">Загрузить операции</button>';
          document.getElementById('opSearchBtn').onclick = runOpSearch;
        });
        function openOperationForm(isEdit, operationId, opData, types, customers, products, warehouses, paymentTypes, userList) {
          warehouses = warehouses || []; paymentTypes = paymentTypes || []; userList = userList || [];
          var sel = isEdit && opData ? { type_code: opData.type_code || '', customer_id: opData.customer_id != null ? String(opData.customer_id) : '', product_code: opData.product_code || '', quantity: opData.quantity != null ? opData.quantity : '', amount: opData.amount != null ? opData.amount : '', comment: opData.comment || '', order_id: opData.order_id != null ? opData.order_id : '', operation_date: opData.operation_date ? opData.operation_date.slice(0, 10) : '', warehouse_from: opData.warehouse_from || '', warehouse_to: opData.warehouse_to || '', payment_type_code: opData.payment_type_code || '', status: opData.status || 'pending', expeditor_login: opData.expeditor_login || '', cashier_login: opData.cashier_login || '', storekeeper_login: opData.storekeeper_login || '' } : { type_code: '', customer_id: '', product_code: '', quantity: '1', amount: '', comment: '', order_id: '', operation_date: new Date().toISOString().slice(0, 10), warehouse_from: '', warehouse_to: '', payment_type_code: '', status: 'pending', expeditor_login: '', cashier_login: '', storekeeper_login: '' };
          // Фильтруем только активные типы операций, но при редактировании добавляем текущий тип операции (даже если неактивен)
          var activeTypes = types.filter(function(ty) { return ty.active !== false; });
          if (isEdit && opData && opData.type_code) {
            var currentType = types.find(function(ty) { return ty.code === opData.type_code; });
            if (currentType && currentType.active === false) {
              // Добавляем текущий тип операции, даже если он неактивен (чтобы можно было редактировать существующую операцию)
              activeTypes.push(currentType);
            }
          }
          var typeOpts = '<option value="">— Выберите тип —</option>'; activeTypes.forEach(function (ty) { var o = (ty.code === sel.type_code) ? ' selected' : ''; typeOpts += '<option value="' + escAttr(ty.code) + '"' + o + '>' + escAttr(ty.name || ty.code) + '</option>'; });
          var custOpts = '<option value="">— Не указан —</option>'; customers.forEach(function (c) { var o = (String(c.id) === sel.customer_id) ? ' selected' : ''; custOpts += '<option value="' + (c.id != null ? c.id : '') + '"' + o + '>' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var prodOpts = '<option value="">— Не указан —</option>'; products.forEach(function (p) { var o = (p.code === sel.product_code) ? ' selected' : ''; prodOpts += '<option value="' + escAttr(p.code) + '"' + o + '>' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var whOpts = '<option value="">— Не указан —</option>'; warehouses.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var payOpts = '<option value="">— Не указан —</option>'; paymentTypes.forEach(function (pt) { var o = (pt.code === sel.payment_type_code) ? ' selected' : ''; payOpts += '<option value="' + escAttr(pt.code) + '"' + o + '>' + escAttr(pt.name || pt.code) + '</option>'; });
          var statusOpts = '<option value="pending"' + (sel.status === 'pending' ? ' selected' : '') + '>В ожидании</option><option value="completed"' + (sel.status === 'completed' ? ' selected' : '') + '>Выполнено</option><option value="cancelled"' + (sel.status === 'cancelled' ? ' selected' : '') + '>Отменено</option>';
          var userOpts = '<option value="">— Не указан —</option>'; userList.forEach(function (u) { userOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>'; });
          var content = document.getElementById('content');
          if (!content) return;
          var statusBlock = isEdit ? ('<div class="form-group" id="opFormStatusBlock"><label>Статус</label><select id="opCreateStatus">' + statusOpts + '</select></div>') : '';
          content.innerHTML = '<div class="card"><h2 id="opFormTitle">Создание операции</h2><div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div><div class="form-group"><label>Дата операции</label><input type="text" id="opCreateDate" placeholder="дд.мм.гггг" autocomplete="off"></div><div class="form-group"><label>Тип операции</label><select id="opCreateType" required>' + typeOpts + '</select></div>' + statusBlock + '<div class="form-group"><label>Склад от</label><select id="opCreateWarehouseFrom">' + whOpts + '</select></div><div class="form-group"><label>Склад в</label><select id="opCreateWarehouseTo">' + whOpts + '</select></div><div class="form-group"><label>Клиент</label><select id="opCreateCustomer">' + custOpts + '</select></div><div class="form-group"><label>Товар</label><select id="opCreateProduct">' + prodOpts + '</select></div><div class="form-group"><label>Количество</label><input type="number" id="opCreateQuantity" min="0" placeholder="необяз."></div><div class="form-group"><label>Сумма</label><input type="number" id="opCreateAmount" step="0.01" placeholder="необяз."></div><div class="form-group"><label>Тип оплаты</label><select id="opCreatePaymentType">' + payOpts + '</select></div><div class="form-group"><label>Заказ №</label><input type="number" id="opCreateOrderId" placeholder="необяз." min="0"></div><div class="form-group"><label>Экспедитор</label><select id="opCreateExpeditor">' + userOpts + '</select></div><div class="form-group"><label>Кассир</label><select id="opCreateCashier">' + userOpts + '</select></div><div class="form-group"><label>Кладовщик</label><select id="opCreateStorekeeper">' + userOpts + '</select></div><div class="form-group"><label>Комментарий</label><input type="text" id="opCreateComment" placeholder="необяз."></div><div style="margin-top:24px;padding:12px;background:#f8f9fa;border-radius:6px"><div class="form-group" style="margin-bottom:0"><label style="font-size:12px;color:#666">Кто создал</label><div id="opCreatedBy" class="form-readonly">—</div></div></div><p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opCreateSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opCreateCancel">Отмена</button></p></div>';
          document.getElementById('opFormTitle').textContent = isEdit ? ('Редактирование ' + (opData.operation_number || operationId)) : 'Создание операции';
          var opDateEl = document.getElementById('opCreateDate');
          if (opDateEl) {
            opDateEl.value = sel.operation_date ? sel.operation_date.replace(/^(\d{4})-(\d{2})-(\d{2}).*/, '$3.$2.$1') : '';
            if (window.flatpickr) {
              window.flatpickr(opDateEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
            }
          }
          document.getElementById('opCreateQuantity').value = sel.quantity;
          document.getElementById('opCreateAmount').value = sel.amount;
          document.getElementById('opCreateComment').value = sel.comment;
          document.getElementById('opCreateOrderId').value = sel.order_id;
          var wFrom = document.getElementById('opCreateWarehouseFrom'); if (wFrom) wFrom.value = sel.warehouse_from || '';
          var wTo = document.getElementById('opCreateWarehouseTo'); if (wTo) wTo.value = sel.warehouse_to || '';
          document.getElementById('opCreatePaymentType').value = sel.payment_type_code || '';
          var statusSel = document.getElementById('opCreateStatus'); if (statusSel) statusSel.value = sel.status || 'pending';
          var exSel = document.getElementById('opCreateExpeditor'); if (exSel) exSel.value = sel.expeditor_login || '';
          var cashSel = document.getElementById('opCreateCashier'); if (cashSel) cashSel.value = sel.cashier_login || '';
          var stSel = document.getElementById('opCreateStorekeeper'); if (stSel) stSel.value = sel.storekeeper_login || '';
          if (isEdit && opData && opData.created_by) document.getElementById('opCreatedBy').textContent = opData.created_by; else document.getElementById('opCreatedBy').textContent = '—';
          document.getElementById('opCreateCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opCreateSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var operation_dateRaw = document.getElementById('opCreateDate').value || '';
            var operation_date = null;
            if (operation_dateRaw) {
              var m = operation_dateRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
              if (m) operation_date = m[3] + '-' + m[2].padStart(2, '0') + '-' + m[1].padStart(2, '0') + 'T12:00:00';
              else if (/^\d{4}-\d{2}-\d{2}/.test(operation_dateRaw)) operation_date = operation_dateRaw.slice(0, 10) + (operation_dateRaw.indexOf('T') >= 0 ? '' : 'T12:00:00');
            }
            var type_code = document.getElementById('opCreateType').value;
            var statusEl = document.getElementById('opCreateStatus');
            var status = (statusEl ? statusEl.value : null) || 'pending';
            var warehouse_from = document.getElementById('opCreateWarehouseFrom').value || null;
            var warehouse_to = document.getElementById('opCreateWarehouseTo').value || null;
            var customer_id = document.getElementById('opCreateCustomer').value;
            var product_code = document.getElementById('opCreateProduct').value || null;
            var qVal = document.getElementById('opCreateQuantity').value.trim();
            var quantity = qVal !== '' ? parseInt(qVal, 10) : null;
            var amountVal = document.getElementById('opCreateAmount').value.trim();
            var amount = amountVal !== '' ? parseFloat(amountVal) : null;
            var payment_type_code = document.getElementById('opCreatePaymentType').value || null;
            var orderIdVal = document.getElementById('opCreateOrderId').value.trim();
            var orderIdNum = orderIdVal !== '' ? parseInt(orderIdVal, 10) : NaN;
            var order_id = (orderIdNum > 0) ? orderIdNum : null;
            var comment = document.getElementById('opCreateComment').value.trim() || null;
            var expeditor_login = document.getElementById('opCreateExpeditor').value || null;
            var cashier_login = document.getElementById('opCreateCashier').value || null;
            var storekeeper_login = document.getElementById('opCreateStorekeeper').value || null;
            if (!type_code) { if (errEl) errEl.textContent = 'Выберите тип операции.'; return; }
            function errText(e) {
              if (!e) return 'Неизвестная ошибка';
              var d = e.data;
              if (d && d.detail !== undefined) { if (typeof d.detail === 'string') return d.detail; if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || JSON.stringify(x); }).join(' '); return JSON.stringify(d.detail); }
              if (d) return JSON.stringify(d);
              return (e.message || e.status || 'Ошибка') + '';
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess() {
              if (msgEl) { msgEl.textContent = 'Операция сохранена.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 1500);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              if (errEl) errEl.textContent = errText(e);
            }
            var payload = { type_code: type_code, operation_date: operation_date, status: status, warehouse_from: warehouse_from, warehouse_to: warehouse_to, customer_id: customer_id ? parseInt(customer_id, 10) : null, product_code: product_code, quantity: quantity, amount: amount, payment_type_code: payment_type_code, order_id: order_id, comment: comment, expeditor_login: expeditor_login, cashier_login: cashier_login, storekeeper_login: storekeeper_login };
            if (isEdit) {
              api('/api/v1/operations/' + operationId, { method: 'PATCH', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
            } else {
              api('/api/v1/operations', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
            }
          };
        }
        function buildWarehouseReceiptForm(config, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehouses.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var prodOpts = '<option value="">— Выберите товар —</option>';
          products.forEach(function (p) { prodOpts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Приход на склад') + '</h2>';
          if (config.description) formHtml += '<p style="color:#666;margin-bottom:16px">' + escAttr(config.description) + '</p>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          var productsMap = {};
          products.forEach(function (p) { productsMap[p.code] = p; });
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="opWhReceiptWarehouseTo" required>' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары</h3><div style="overflow-x:auto"><table id="opWhReceiptItemsTable" style="width:100%"><thead><tr><th>Товар <span style="color:#c00">*</span></th><th>Срок годности <span style="color:#c00">*</span></th><th>Количество <span style="color:#c00">*</span></th><th>Цена (из справочника)</th><th>Сумма</th><th>Код партии (авто)</th><th></th></tr></thead><tbody id="opWhReceiptItemsBody"><tr class="op-wh-receipt-row"><td><select class="op-wh-receipt-product" required>' + prodOpts + '</select></td><td><input type="text" class="op-wh-receipt-expiry" placeholder="дд.мм.гггг" required autocomplete="off"></td><td><input type="number" class="op-wh-receipt-quantity" min="1" required></td><td class="op-wh-receipt-price" style="text-align:right;padding:8px;font-weight:600">—</td><td class="op-wh-receipt-sum" style="text-align:right;padding:8px;font-weight:600">—</td><td><input type="text" class="op-wh-receipt-batch" readonly style="background:#f0f0f0"></td><td><button type="button" class="btn btn-secondary btn-small op-wh-receipt-remove" style="display:none">Удалить</button></td></tr></tbody><tfoot id="opWhReceiptItemsFooter"><tr style="background:#f8f9fa;font-weight:600"><td colspan="3" style="text-align:right;padding:10px">Итого:</td><td></td><td id="opWhReceiptTotalSum" style="text-align:right;padding:10px">0</td><td colspan="2"></td></tr></tfoot></table></div><button type="button" class="btn btn-secondary" id="opWhReceiptAddRow" style="margin-top:8px">+ Добавить товар</button></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="opWhReceiptComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opWhReceiptSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opWhReceiptCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var expiryInputs = content.querySelectorAll('.op-wh-receipt-expiry');
          expiryInputs.forEach(function (el) {
            if (window.flatpickr) window.flatpickr(el, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
          });
          function updateRowCalculations(row) {
            var productSel = row.querySelector('.op-wh-receipt-product');
            var expiryInp = row.querySelector('.op-wh-receipt-expiry');
            var quantityInp = row.querySelector('.op-wh-receipt-quantity');
            var batchInp = row.querySelector('.op-wh-receipt-batch');
            var priceCell = row.querySelector('.op-wh-receipt-price');
            var sumCell = row.querySelector('.op-wh-receipt-sum');
            if (!productSel || !expiryInp || !batchInp || !priceCell || !sumCell) return;
            var productCode = (productSel.value || '').trim();
            var expiryRaw = (expiryInp.value || '').trim();
            var quantity = parseInt(quantityInp ? quantityInp.value : 0, 10) || 0;
            var product = productsMap[productCode];
            var price = product && product.price ? parseFloat(product.price) : 0;
            if (productCode && expiryRaw) {
              var m = expiryRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
              if (!m) {
                var iso = expiryRaw.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (iso) m = [null, iso[3], iso[2], iso[1]];
              }
              if (m) {
                var ddmmyyyy = m[1].padStart(2, '0') + m[2].padStart(2, '0') + m[3];
                batchInp.value = productCode + '_' + ddmmyyyy;
              }
            } else {
              batchInp.value = '';
            }
            priceCell.textContent = price > 0 ? price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум' : '—';
            var sum = price * quantity;
            sumCell.textContent = sum > 0 ? sum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум' : '—';
            updateTotalSum();
          }
          function updateTotalSum() {
            var rows = document.querySelectorAll('.op-wh-receipt-row');
            var totalSum = 0;
            var totalQty = 0;
            rows.forEach(function (row) {
              var quantityInp = row.querySelector('.op-wh-receipt-quantity');
              var productSel = row.querySelector('.op-wh-receipt-product');
              if (!quantityInp || !productSel) return;
              var productCode = (productSel.value || '').trim();
              var quantity = parseInt(quantityInp.value, 10) || 0;
              var product = productsMap[productCode];
              var price = product && product.price ? parseFloat(product.price) : 0;
              totalQty += quantity;
              totalSum += price * quantity;
            });
            var totalSumEl = document.getElementById('opWhReceiptTotalSum');
            if (totalSumEl) {
              totalSumEl.innerHTML = totalSum > 0 ? totalSum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум<br><small style="font-weight:normal;color:#666">(' + totalQty + ' шт.)</small>' : '0';
            }
          }
          function attachRowHandlers(row) {
            var productSel = row.querySelector('.op-wh-receipt-product');
            var expiryInp = row.querySelector('.op-wh-receipt-expiry');
            var quantityInp = row.querySelector('.op-wh-receipt-quantity');
            var removeBtn = row.querySelector('.op-wh-receipt-remove');
            if (productSel) productSel.onchange = function () { updateRowCalculations(row); };
            if (expiryInp) {
              expiryInp.onchange = function () { updateRowCalculations(row); };
              expiryInp.oninput = function () { updateRowCalculations(row); };
            }
            if (quantityInp) {
              quantityInp.onchange = function () { updateRowCalculations(row); };
              quantityInp.oninput = function () { updateRowCalculations(row); };
            }
            if (removeBtn) removeBtn.onclick = function () { row.remove(); updateTotalSum(); };
          }
          var rows = content.querySelectorAll('.op-wh-receipt-row');
          rows.forEach(function (row) {
            attachRowHandlers(row);
            updateRowCalculations(row);
          });
          document.getElementById('opWhReceiptAddRow').onclick = function () {
            var tbody = document.getElementById('opWhReceiptItemsBody');
            var newRow = document.createElement('tr');
            newRow.className = 'op-wh-receipt-row';
            newRow.innerHTML = '<td><select class="op-wh-receipt-product" required>' + prodOpts + '</select></td><td><input type="text" class="op-wh-receipt-expiry" placeholder="дд.мм.гггг" required autocomplete="off"></td><td><input type="number" class="op-wh-receipt-quantity" min="1" required></td><td class="op-wh-receipt-price" style="text-align:right;padding:8px;font-weight:600">—</td><td class="op-wh-receipt-sum" style="text-align:right;padding:8px;font-weight:600">—</td><td><input type="text" class="op-wh-receipt-batch" readonly style="background:#f0f0f0"></td><td><button type="button" class="btn btn-secondary btn-small op-wh-receipt-remove">Удалить</button></td>';
            tbody.appendChild(newRow);
            var expiryEl = newRow.querySelector('.op-wh-receipt-expiry');
            if (expiryEl && window.flatpickr) window.flatpickr(expiryEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
            attachRowHandlers(newRow);
            var allRows = tbody.querySelectorAll('.op-wh-receipt-row');
            if (allRows.length > 1) allRows.forEach(function (r) { var btn = r.querySelector('.op-wh-receipt-remove'); if (btn) btn.style.display = 'inline-block'; });
          };
          document.getElementById('opWhReceiptCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opWhReceiptSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opWhReceiptSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var warehouseTo = document.getElementById('opWhReceiptWarehouseTo').value;
            if (!warehouseTo) { if (errEl) errEl.textContent = 'Выберите склад'; return; }
            var rows = document.querySelectorAll('.op-wh-receipt-row');
            if (!rows.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар'; return; }
            var items = [];
            var hasErrors = false;
            rows.forEach(function (row, idx) {
              var productSel = row.querySelector('.op-wh-receipt-product');
              var expiryInp = row.querySelector('.op-wh-receipt-expiry');
              var quantityInp = row.querySelector('.op-wh-receipt-quantity');
              var batchInp = row.querySelector('.op-wh-receipt-batch');
              if (!productSel || !expiryInp || !quantityInp || !batchInp) return;
              var productCode = (productSel.value || '').trim();
              var expiryDate = (expiryInp.value || '').trim();
              var quantity = parseInt(quantityInp.value, 10);
              var batchCode = (batchInp.value || '').trim();
              if (!productCode || !expiryDate || isNaN(quantity) || quantity <= 0) {
                hasErrors = true;
                return;
              }
              items.push({ product_code: productCode, expiry_date: expiryDate, quantity: quantity, batch_code: batchCode });
            });
            if (hasErrors) { if (errEl) errEl.textContent = 'Заполните все поля для всех товаров'; return; }
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар'; return; }
            var payload = { warehouse_to: warehouseTo, items: items, comment: (document.getElementById('opWhReceiptComment').value || '').trim() || null };
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess(result) {
              if (msgEl) { msgEl.textContent = 'Операции созданы: ' + (result.operations_count || items.length) + ' шт.'; msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 2000);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              var detail = e && e.data && e.data.detail;
              if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
              if (detail && detail.errors) {
                var errs = [];
                for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                if (errEl) errEl.textContent = errs.join('; ');
              } else if (errEl) errEl.textContent = 'Ошибка сохранения';
            }
            api('/api/v1/operations/warehouse_receipt/create-batch', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
          };
        }
        function buildAllocationForm(config, customers, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var expOpts = '<option value="">— Не указан —</option>';
          (userList || []).forEach(function (u) {
            if ((u.role || '').toLowerCase() !== 'expeditor') return;
            expOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
          });
          // Список товаров будем ограничивать только теми, у которых есть остатки на выбранном складе
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Выдача экспедитору') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          // порядок: Склад от → Экспедитор → Склад в (серое, автозаполняется по экспедитору)
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="allocWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Экспедитор <span style="color:#c00">*</span></label><select id="allocExpeditor" required>' + expOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="allocWhTo" required disabled style="background-color:#eee; color:#555;">' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары</h3><div style="overflow-x:auto"><table id="allocItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество</th><th>Вес</th><th>Цена</th><th>Сумма</th><th></th></tr></thead><tbody id="allocItemsBody"><tr class="alloc-row"><td><select class="alloc-product" required><option value=\"\">— Выберите товар —</option></select></td><td><select class="alloc-batch" required><option value=\"\">— нет данных —</option></select></td><td class="alloc-expiry">—</td><td class="alloc-days" style="text-align:center">—</td><td class="alloc-available" style="text-align:right">0</td><td><input type="number" class="alloc-qty" min="1" required></td><td class="alloc-weight" style="text-align:right">—</td><td class="alloc-price" style="text-align:right">—</td><td class="alloc-sum" style="text-align:right">—</td><td><button type="button" class="btn btn-secondary btn-small alloc-remove" style="display:none">Удалить</button></td></tr></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="6" style="text-align:right;padding:8px">Итого:</td><td id="allocTotalWeight" style="text-align:right;padding:8px">0</td><td></td><td id="allocTotalQty" style="text-align:right;padding:8px">0</td><td></td><td id="allocTotalSum" style="text-align:right;padding:8px">0</td><td></td></tr></tfoot></table></div><button type="button" class="btn btn-secondary" id="allocAddRow" style="margin-top:8px">+ Добавить товар</button></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="allocComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="allocSave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="allocCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var stockCache = null;
          function loadStock(whCode) {
            if (!whCode) { stockCache = null; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
            }).catch(function () { stockCache = []; });
          }
          function buildProductOptionsFromStock() {
            var opts = '<option value="">— Выберите товар —</option>';
            if (!stockCache || !stockCache.length) return opts;
            var withStock = {};
            stockCache.forEach(function (s) {
              if (s.product_code) withStock[s.product_code] = true;
            });
            productsList.forEach(function (p) {
              if (withStock[p.code]) {
                opts += '<option value="' + escAttr(p.code) + '">' + escAttr((p.code || '') + ' — ' + (p.name || '')) + '</option>';
              }
            });
            return opts;
          }
          function updateRowFromStock(row) {
            var productSel = row.querySelector('.alloc-product');
            var batchSel = row.querySelector('.alloc-batch');
            var expiryCell = row.querySelector('.alloc-expiry');
            var daysCell = row.querySelector('.alloc-days');
            var availCell = row.querySelector('.alloc-available');
            var weightCell = row.querySelector('.alloc-weight');
            var priceCell = row.querySelector('.alloc-price');
            var sumCell = row.querySelector('.alloc-sum');
            var qtyInp = row.querySelector('.alloc-qty');
            if (!productSel || !batchSel) return;
            var whFrom = document.getElementById('allocWhFrom').value;
            var productCode = productSel.value || '';
            var rows = (stockCache || []).filter(function (s) { return s.product_code === productCode && (!whFrom || s.warehouse_code === whFrom); });
            rows.sort(function (a, b) {
              var ea = a.expiry_date || ''; var eb = b.expiry_date || '';
              return ea.localeCompare(eb);
            });
            var opts = '<option value="">— Выберите партию —</option>';
            rows.forEach(function (r) {
              var days = (r.days_until_expiry != null ? r.days_until_expiry : '');
              var status = r.expiry_status || {};
              var color = status.color || '';
              var icon = status.icon || '';
              opts += '<option value="' + escAttr(r.batch_code || '') + '" data-batch-id="' + escAttr(r.batch_id || '') + '" data-expiry="' + escAttr(r.expiry_date || '') + '" data-available="' + (r.total_qty != null ? r.total_qty : 0) + '" data-days="' + days + '" data-color="' + escAttr(color) + '" data-icon="' + escAttr(icon) + '">' + escAttr((r.batch_code || '') + (r.expiry_date ? ' — ' + formatDateOnly(r.expiry_date) : '')) + '</option>';
            });
            batchSel.innerHTML = opts;
            if (rows.length) batchSel.selectedIndex = 1;
            updateBatchInfo();
            function updateBatchInfo() {
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var expiry = opt ? opt.getAttribute('data-expiry') || '' : '';
              var avail = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              var daysAttr = opt ? opt.getAttribute('data-days') : null;
              var color = opt ? opt.getAttribute('data-color') || '' : '';
              var icon = opt ? opt.getAttribute('data-icon') || '' : '';
              expiryCell.textContent = expiry ? formatDateOnly(expiry) : '—';
              availCell.textContent = avail;
              if (daysCell) {
                if (daysAttr === null || daysAttr === '' || isNaN(parseInt(daysAttr, 10))) {
                  daysCell.textContent = '—';
                } else {
                  var days = parseInt(daysAttr, 10);
                  var badgeColor = '#28a745';
                  if (color === 'YELLOW') badgeColor = '#ffc107';
                  else if (color === 'RED') badgeColor = '#dc3545';
                  else if (color === 'BLACK') badgeColor = '#343a40';
                  var iconChar = icon || (color === 'YELLOW' ? '🟡' : (color === 'RED' ? '🔴' : (color === 'BLACK' ? '⚫' : '🟢')));
                  var daysText = days + ' дн.';
                  daysCell.innerHTML = '<span class="badge" style="background-color:' + badgeColor + ';color:#fff;border-radius:4px;padding:2px 6px;font-size:11px;">' + iconChar + ' ' + daysText + '</span>';
                }
              }
              var prod = productsMap[productCode];
              var price = prod && prod.price ? parseFloat(prod.price) : 0;
              var weightG = prod && prod.weight_g ? parseFloat(prod.weight_g) : 0;
              priceCell.textContent = price ? price.toFixed(2) : '—';
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (qty > avail) qty = avail;
              if (qtyInp.value && parseInt(qtyInp.value, 10) !== qty) qtyInp.value = qty || '';
              var sum = price * qty;
              sumCell.textContent = sum ? sum.toFixed(2) : '—';
              if (weightCell) {
                var totalWeightG = weightG * qty;
                if (totalWeightG > 0) {
                  var totalWeightKg = (totalWeightG / 1000).toFixed(2);
                  weightCell.textContent = totalWeightKg + ' кг';
                } else {
                  weightCell.textContent = '—';
                }
              }
              updateTotals();
            }
            batchSel.onchange = updateBatchInfo;
            qtyInp.oninput = updateBatchInfo;
            qtyInp.onchange = updateBatchInfo;
          }
          function updateTotals() {
            var rows = document.querySelectorAll('.alloc-row');
            var totalQty = 0;
            var totalSum = 0;
            var totalWeightG = 0;
            rows.forEach(function (row) {
              var qty = parseInt((row.querySelector('.alloc-qty') || {}).value || '0', 10) || 0;
              var productSel = row.querySelector('.alloc-product');
              if (!productSel) return;
              var prod = productsMap[productSel.value || ''];
              var price = prod && prod.price ? parseFloat(prod.price) : 0;
              var weightG = prod && prod.weight_g ? parseFloat(prod.weight_g) : 0;
              totalQty += qty;
              totalSum += price * qty;
              totalWeightG += weightG * qty;
            });
            var qEl = document.getElementById('allocTotalQty');
            var sEl = document.getElementById('allocTotalSum');
            var wEl = document.getElementById('allocTotalWeight');
            if (qEl) qEl.textContent = totalQty;
            if (sEl) sEl.textContent = totalSum ? totalSum.toFixed(2) : '0';
            if (wEl) {
              if (totalWeightG > 0) {
                var totalWeightKg = (totalWeightG / 1000).toFixed(2);
                wEl.textContent = totalWeightKg + ' кг';
              } else {
                wEl.textContent = '0';
              }
            }
          }
          function attachAllocRowHandlers(row) {
            var prodSel = row.querySelector('.alloc-product');
            var qtyInp = row.querySelector('.alloc-qty');
            var batchSel = row.querySelector('.alloc-batch');
            var removeBtn = row.querySelector('.alloc-remove');
            if (prodSel) prodSel.onchange = function () { updateRowFromStock(row); updateTotals(); };
            if (qtyInp) qtyInp.oninput = function () { updateRowFromStock(row); updateTotals(); };
            if (batchSel) batchSel.onchange = function () { updateRowFromStock(row); updateTotals(); };
            if (removeBtn) removeBtn.onclick = function () { row.remove(); updateTotals(); };
          }
          document.getElementById('allocWhFrom').onchange = function () {
            loadStock(this.value).then(function () {
              var rows = document.querySelectorAll('.alloc-row');
              var prodOptsHtml = buildProductOptionsFromStock();
              rows.forEach(function (row) {
                var prodSel = row.querySelector('.alloc-product');
                if (prodSel) {
                  var prev = prodSel.value || '';
                  prodSel.innerHTML = prodOptsHtml;
                  if (prev) {
                    var opt = prodSel.querySelector('option[value="' + prev.replace(/"/g, '&quot;') + '"]');
                    if (opt) prodSel.value = prev;
                  }
                }
                updateRowFromStock(row);
              });
              updateTotals();
            });
          };
          var expSel = document.getElementById('allocExpeditor');
          if (expSel) {
            expSel.onchange = function () {
              var login = this.value || '';
              var whToSel = document.getElementById('allocWhTo');
              if (!whToSel) return;
              var match = null;
              if (login) {
                (warehousesList || []).forEach(function (w) {
                  if (!match && w.expeditor_login && w.expeditor_login === login) match = w;
                });
              }
              if (match && match.code) {
                // Автоподстановка склада по экспедитору, поле только для просмотра (серое)
                whToSel.value = match.code;
              } else {
                // Если связки нет — очищаем поле
                whToSel.value = '';
              }
            };
          }
          var firstRow = document.querySelector('.alloc-row');
          if (firstRow) attachAllocRowHandlers(firstRow);
          document.getElementById('allocAddRow').onclick = function () {
            var tbody = document.getElementById('allocItemsBody');
            var row = document.createElement('tr');
            row.className = 'alloc-row';
            var prodOptsNow = buildProductOptionsFromStock();
            row.innerHTML = '<td><select class="alloc-product" required>' + prodOptsNow + '</select></td><td><select class="alloc-batch" required><option value="">— нет данных —</option></select></td><td class="alloc-expiry">—</td><td class="alloc-days" style="text-align:center">—</td><td class="alloc-available" style="text-align:right">0</td><td><input type="number" class="alloc-qty" min="1" required></td><td class="alloc-weight" style="text-align:right">—</td><td class="alloc-price" style="text-align:right">—</td><td class="alloc-sum" style="text-align:right">—</td><td><button type="button" class="btn btn-secondary btn-small alloc-remove">Удалить</button></td>';
            tbody.appendChild(row);
            attachAllocRowHandlers(row);
          };
          document.getElementById('allocCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('allocSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('allocWhFrom').value;
            var whTo = document.getElementById('allocWhTo').value;
            var expeditor = document.getElementById('allocExpeditor').value;
            if (errEl) errEl.textContent = '';
            if (!whFrom || !whTo) { if (errEl) errEl.textContent = 'Выберите склады от и в.'; return; }
            if (!expeditor) { if (errEl) errEl.textContent = 'Выберите экспедитора.'; return; }
            var rows = document.querySelectorAll('.alloc-row');
            var items = [];
            rows.forEach(function (row) {
              var prodSel = row.querySelector('.alloc-product');
              var batchSel = row.querySelector('.alloc-batch');
              var qtyInp = row.querySelector('.alloc-qty');
              if (!prodSel || !batchSel || !qtyInp) return;
              var productCode = (prodSel.value || '').trim();
              var batchCode = (batchSel.value || '').trim();
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (!productCode || !batchCode || !qty) return;
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var available = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              if (qty > available) qty = available;
              items.push({ product_code: productCode, batch_code: batchCode, quantity: qty });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Добавьте хотя бы один товар.'; return; }
            var comment = (document.getElementById('allocComment').value || '').trim() || null;
            var createdBy = (window.currentUser && window.currentUser.login) ? window.currentUser.login : null;
            var saveBtn = document.getElementById('allocSave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0;
            var idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Операции созданы: ' + createdCount + ' шт.'; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              api('/api/v1/operations/allocation', {
                method: 'POST',
                body: JSON.stringify({
                  warehouse_from: whFrom,
                  warehouse_to: whTo,
                  product_code: it.product_code,
                  batch_code: it.batch_code,
                  quantity: it.quantity,
                  expeditor_login: expeditor,
                  created_by: createdBy,
                  comment: comment
                })
              }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) {
                  var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                  if (errEl) errEl.textContent = errs.join('; ');
                } else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildWriteOffForm(config, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Списание товара') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Склад <span style="color:#c00">*</span></label><select id="writeOffWh" required>' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары для списания</h3><p style="color:#666;font-size:13px;margin-bottom:8px">Выберите склад — подтянутся остатки по партиям.</p><div style="overflow-x:auto"><table id="writeOffItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество к списанию</th><th>Вес</th><th>Цена</th><th>Сумма</th></tr></thead><tbody id="writeOffItemsBody"></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="5" style="text-align:right;padding:8px">Итого:</td><td id="writeOffTotalQty" style="text-align:right;padding:8px">0</td><td id="writeOffTotalWeight" style="text-align:right;padding:8px">—</td><td></td><td id="writeOffTotalSum" style="text-align:right;padding:8px">0</td></tr></tfoot></table></div></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="writeOffComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="writeOffSave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="writeOffCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var stockCache = [];
          function loadStock(whCode) {
            if (!whCode) { stockCache = []; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
              stockCache.sort(function (a, b) {
                var da = a.days_until_expiry != null ? a.days_until_expiry : 1e9;
                var db = b.days_until_expiry != null ? b.days_until_expiry : 1e9;
                return da - db;
              });
            }).catch(function () { stockCache = []; });
          }
          function renderWriteOffTable() {
            var tbody = document.getElementById('writeOffItemsBody');
            var wh = document.getElementById('writeOffWh').value;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!wh || !stockCache.length) {
              if (!wh) tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Выберите склад</td></tr>';
              else tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Нет остатков на складе</td></tr>';
              document.getElementById('writeOffTotalQty').textContent = '0';
              document.getElementById('writeOffTotalSum').textContent = '0';
              document.getElementById('writeOffTotalWeight').textContent = '—';
              return;
            }
            var totalQty = 0, totalSum = 0, totalWeightG = 0;
            stockCache.forEach(function (s) {
              var productName = (s.product_name || s.product_code || '');
              var expiry = s.expiry_date ? formatDateOnly(s.expiry_date) : '—';
              var days = s.days_until_expiry != null ? s.days_until_expiry : '—';
              var avail = s.total_qty != null ? s.total_qty : 0;
              var price = s.unit_price != null ? parseFloat(s.unit_price) : 0;
              var weightG = s.weight_g != null ? parseInt(s.weight_g, 10) : 0;
              var status = s.expiry_status || {};
              var color = status.color || '';
              var icon = status.icon || '';
              var daysHtml = (days === '—' || days === '') ? '—' : '<span class="badge" style="background-color:' + (color === 'YELLOW' ? '#ffc107' : color === 'RED' ? '#dc3545' : color === 'BLACK' ? '#343a40' : '#28a745') + ';color:#fff;border-radius:4px;padding:2px 6px;font-size:11px;">' + (icon || '') + ' ' + days + ' дн.</span>';
              var row = document.createElement('tr');
              row.className = 'writeoff-row';
              row.setAttribute('data-product-code', s.product_code || '');
              row.setAttribute('data-batch-code', s.batch_code || '');
              row.setAttribute('data-available', String(avail));
              row.setAttribute('data-price', String(price));
              row.setAttribute('data-weight-g', String(weightG));
              row.innerHTML = '<td>' + escAttr(productName) + '</td><td>' + escAttr(s.batch_code || '') + '</td><td>' + expiry + '</td><td style="text-align:center">' + daysHtml + '</td><td style="text-align:right">' + avail + '</td><td><input type="number" class="writeoff-qty" min="0" max="' + avail + '" value="0" data-available="' + avail + '"></td><td class="writeoff-weight" style="text-align:right">—</td><td class="writeoff-price" style="text-align:right">' + (price ? price.toFixed(2) : '—') + '</td><td class="writeoff-sum" style="text-align:right">0</td>';
              var qtyInp = row.querySelector('.writeoff-qty');
              var weightCell = row.querySelector('.writeoff-weight');
              var sumCell = row.querySelector('.writeoff-sum');
              function upd() {
                var q = parseInt(qtyInp.value || '0', 10) || 0;
                var maxA = parseInt(qtyInp.getAttribute('data-available') || '0', 10) || 0;
                if (q > maxA) { q = maxA; qtyInp.value = q || ''; }
                var sum = price * q;
                sumCell.textContent = sum ? sum.toFixed(2) : '0';
                if (weightG > 0 && q > 0) weightCell.textContent = ((weightG * q) / 1000).toFixed(2) + ' кг'; else weightCell.textContent = '—';
                updateWriteOffTotals();
              }
              qtyInp.oninput = upd;
              qtyInp.onchange = upd;
              tbody.appendChild(row);
            });
            updateWriteOffTotals();
          }
          function updateWriteOffTotals() {
            var totalQty = 0, totalSum = 0, totalWeightG = 0;
            document.querySelectorAll('.writeoff-row').forEach(function (row) {
              var qtyInp = row.querySelector('.writeoff-qty');
              var code = row.getAttribute('data-product-code');
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var wg = parseInt(row.getAttribute('data-weight-g') || '0', 10) || 0;
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              totalQty += q;
              totalSum += price * q;
              totalWeightG += wg * q;
            });
            document.getElementById('writeOffTotalQty').textContent = totalQty;
            document.getElementById('writeOffTotalSum').textContent = totalSum ? totalSum.toFixed(2) : '0';
            var wEl = document.getElementById('writeOffTotalWeight');
            if (totalWeightG > 0) wEl.textContent = (totalWeightG / 1000).toFixed(2) + ' кг'; else wEl.textContent = '—';
          }
          document.getElementById('writeOffWh').onchange = function () {
            loadStock(this.value).then(renderWriteOffTable);
          };
          document.getElementById('writeOffCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('writeOffSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var wh = document.getElementById('writeOffWh').value;
            var comment = (document.getElementById('writeOffComment').value || '').trim() || null;
            var createdBy = (window.currentUser && window.currentUser.login) ? window.currentUser.login : ((currentUser && currentUser.login) ? currentUser.login : null);
            if (errEl) errEl.textContent = '';
            if (!wh) { if (errEl) errEl.textContent = 'Выберите склад.'; return; }
            if (!createdBy) { if (errEl) errEl.textContent = 'Не определен текущий пользователь.'; return; }
            var items = [];
            document.querySelectorAll('.writeoff-row').forEach(function (row) {
              var qtyInp = row.querySelector('.writeoff-qty');
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              if (q <= 0) return;
              items.push({
                product_code: row.getAttribute('data-product-code') || '',
                batch_code: row.getAttribute('data-batch-code') || '',
                quantity: q
              });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Укажите количество к списанию хотя бы по одной позиции.'; return; }
            var saveBtn = document.getElementById('writeOffSave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0, idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Создано операций списания: ' + createdCount; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              api('/api/v1/operations/write_off', { method: 'POST', body: JSON.stringify({ warehouse_from: wh, product_code: it.product_code, batch_code: it.batch_code, quantity: it.quantity, created_by: createdBy, comment: comment }) }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) { var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]); if (errEl) errEl.textContent = errs.join('; '); }
                else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildTransferForm(config, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Перемещение между складами') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="transferWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="transferWhTo" required>' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары для перемещения</h3><p style="color:#666;font-size:13px;margin-bottom:8px">Выберите склады — подтянутся остатки по партиям со склада «от».</p><div style="overflow-x:auto"><table id="transferItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество к перемещению</th><th>Вес</th><th>Цена</th><th>Сумма</th></tr></thead><tbody id="transferItemsBody"></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="5" style="text-align:right;padding:8px">Итого:</td><td id="transferTotalQty" style="text-align:right;padding:8px">0</td><td id="transferTotalWeight" style="text-align:right;padding:8px">—</td><td></td><td id="transferTotalSum" style="text-align:right;padding:8px">0</td></tr></tfoot></table></div></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="transferComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="transferSave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="transferCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var stockCache = [];
          function loadStock(whCode) {
            if (!whCode) { stockCache = []; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
            }).catch(function () { stockCache = []; });
          }
          function renderTransferTable() {
            var tbody = document.getElementById('transferItemsBody');
            var whFrom = document.getElementById('transferWhFrom').value;
            var whTo = document.getElementById('transferWhTo').value;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!whFrom || !whTo || whFrom === whTo || !stockCache.length) {
              if (!whFrom || !whTo) tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Выберите склад от и склад в</td></tr>';
              else if (whFrom === whTo) tbody.innerHTML = '<tr><td colspan="9" style="color:#c00;padding:12px">Склад от и склад в не должны совпадать</td></tr>';
              else tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Нет остатков на складе «от»</td></tr>';
              document.getElementById('transferTotalQty').textContent = '0';
              document.getElementById('transferTotalSum').textContent = '0';
              document.getElementById('transferTotalWeight').textContent = '—';
              return;
            }
            stockCache.forEach(function (s) {
              var productName = (s.product_name || s.product_code || '');
              var expiry = s.expiry_date ? formatDateOnly(s.expiry_date) : '—';
              var days = s.days_until_expiry != null ? s.days_until_expiry : '—';
              var avail = s.total_qty != null ? s.total_qty : 0;
              var price = s.unit_price != null ? parseFloat(s.unit_price) : 0;
              var weightG = s.weight_g != null ? parseInt(s.weight_g, 10) : 0;
              var status = s.expiry_status || {};
              var color = status.color || '';
              var icon = status.icon || '';
              var daysHtml = (days === '—' || days === '') ? '—' : '<span class="badge" style="background-color:' + (color === 'YELLOW' ? '#ffc107' : color === 'RED' ? '#dc3545' : color === 'BLACK' ? '#343a40' : '#28a745') + ';color:#fff;border-radius:4px;padding:2px 6px;font-size:11px;">' + (icon || '') + ' ' + days + ' дн.</span>';
              var row = document.createElement('tr');
              row.className = 'transfer-row';
              row.setAttribute('data-product-code', s.product_code || '');
              row.setAttribute('data-batch-code', s.batch_code || '');
              row.setAttribute('data-available', String(avail));
              row.setAttribute('data-price', String(price));
              row.setAttribute('data-weight-g', String(weightG));
              row.innerHTML = '<td>' + escAttr(productName) + '</td><td>' + escAttr(s.batch_code || '') + '</td><td>' + expiry + '</td><td style="text-align:center">' + daysHtml + '</td><td style="text-align:right">' + avail + '</td><td><input type="number" class="transfer-qty" min="0" max="' + avail + '" value="0" data-available="' + avail + '"></td><td class="transfer-weight" style="text-align:right">—</td><td class="transfer-price" style="text-align:right">' + (price ? price.toFixed(2) : '—') + '</td><td class="transfer-sum" style="text-align:right">0</td>';
              var qtyInp = row.querySelector('.transfer-qty');
              var weightCell = row.querySelector('.transfer-weight');
              var sumCell = row.querySelector('.transfer-sum');
              function upd() {
                var q = parseInt(qtyInp.value || '0', 10) || 0;
                var maxA = parseInt(qtyInp.getAttribute('data-available') || '0', 10) || 0;
                if (q > maxA) { q = maxA; qtyInp.value = q || ''; }
                sumCell.textContent = price * q ? (price * q).toFixed(2) : '0';
                if (weightG > 0 && q > 0) weightCell.textContent = ((weightG * q) / 1000).toFixed(2) + ' кг'; else weightCell.textContent = '—';
                updateTransferTotals();
              }
              qtyInp.oninput = upd;
              qtyInp.onchange = upd;
              tbody.appendChild(row);
            });
            updateTransferTotals();
          }
          function updateTransferTotals() {
            var totalQty = 0, totalSum = 0, totalWeightG = 0;
            document.querySelectorAll('.transfer-row').forEach(function (row) {
              var qtyInp = row.querySelector('.transfer-qty');
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var wg = parseInt(row.getAttribute('data-weight-g') || '0', 10) || 0;
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              totalQty += q;
              totalSum += price * q;
              totalWeightG += wg * q;
            });
            document.getElementById('transferTotalQty').textContent = totalQty;
            document.getElementById('transferTotalSum').textContent = totalSum ? totalSum.toFixed(2) : '0';
            var wEl = document.getElementById('transferTotalWeight');
            if (totalWeightG > 0) wEl.textContent = (totalWeightG / 1000).toFixed(2) + ' кг'; else wEl.textContent = '—';
          }
          document.getElementById('transferWhFrom').onchange = function () {
            var whFrom = this.value;
            if (whFrom) loadStock(whFrom).then(renderTransferTable); else renderTransferTable();
          };
          document.getElementById('transferWhTo').onchange = renderTransferTable;
          document.getElementById('transferCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('transferSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('transferWhFrom').value;
            var whTo = document.getElementById('transferWhTo').value;
            var comment = (document.getElementById('transferComment').value || '').trim() || null;
            var createdBy = (currentUser && currentUser.login) ? currentUser.login : null;
            if (errEl) errEl.textContent = '';
            if (!whFrom || !whTo) { if (errEl) errEl.textContent = 'Выберите склад от и склад в.'; return; }
            if (whFrom === whTo) { if (errEl) errEl.textContent = 'Склад от и склад в не должны совпадать.'; return; }
            if (!createdBy) { if (errEl) errEl.textContent = 'Не определен текущий пользователь.'; return; }
            var items = [];
            document.querySelectorAll('.transfer-row').forEach(function (row) {
              var qtyInp = row.querySelector('.transfer-qty');
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              if (q <= 0) return;
              items.push({ product_code: row.getAttribute('data-product-code') || '', batch_code: row.getAttribute('data-batch-code') || '', quantity: q });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Укажите количество к перемещению хотя бы по одной позиции.'; return; }
            var saveBtn = document.getElementById('transferSave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0, idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Создано операций перемещения: ' + createdCount; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              api('/api/v1/operations/transfer', { method: 'POST', body: JSON.stringify({ warehouse_from: whFrom, warehouse_to: whTo, product_code: it.product_code, batch_code: it.batch_code, quantity: it.quantity, created_by: createdBy, comment: comment }) }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) { var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]); if (errEl) errEl.textContent = errs.join('; '); }
                else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildPromotionalSampleForm(config, products, warehouses, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var expOpts = '<option value="">— Выберите экспедитора —</option>';
          (userList || []).forEach(function (u) {
            if ((u.role || '').toLowerCase() !== 'expeditor') return;
            expOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
          });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Раздача образцов') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Экспедитор <span style="color:#c00">*</span></label><select id="sampleExpeditor" required>' + expOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Склад в <span style="color:#c00">*</span></label><select id="sampleWhTo" required disabled style="background:#eee;color:#555">' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="sampleWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Образцы</h3><p style="color:#666;font-size:13px;margin-bottom:8px">Остатки отсортированы от просроченных к нормальным. Укажите количество образцов.</p><div style="overflow-x:auto"><table id="sampleItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество образцов</th><th>Вес</th><th>Цена</th><th>Сумма</th></tr></thead><tbody id="sampleItemsBody"></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="5" style="text-align:right;padding:8px">Итого:</td><td id="sampleTotalQty" style="text-align:right;padding:8px">0</td><td id="sampleTotalWeight" style="text-align:right;padding:8px">—</td><td></td><td id="sampleTotalSum" style="text-align:right;padding:8px">0</td></tr></tfoot></table></div></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="sampleComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="sampleSave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="sampleCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var stockCache = [];
          function loadStock(whCode) {
            if (!whCode) { stockCache = []; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
              stockCache.sort(function (a, b) {
                var da = a.days_until_expiry != null ? a.days_until_expiry : 1e9;
                var db = b.days_until_expiry != null ? b.days_until_expiry : 1e9;
                return da - db;
              });
            }).catch(function () { stockCache = []; });
          }
          function renderSampleTable() {
            var tbody = document.getElementById('sampleItemsBody');
            var whFrom = document.getElementById('sampleWhFrom').value;
            var whTo = document.getElementById('sampleWhTo').value;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!whFrom || !whTo || !stockCache.length) {
              if (!whTo) tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Сначала выберите экспедитора (склад в заполнится автоматически)</td></tr>';
              else if (!whFrom) tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Выберите склад от</td></tr>';
              else tbody.innerHTML = '<tr><td colspan="9" style="color:#666;padding:12px">Нет остатков на складе</td></tr>';
              document.getElementById('sampleTotalQty').textContent = '0';
              document.getElementById('sampleTotalSum').textContent = '0';
              document.getElementById('sampleTotalWeight').textContent = '—';
              return;
            }
            stockCache.forEach(function (s) {
              var productName = (s.product_name || s.product_code || '');
              var expiry = s.expiry_date ? formatDateOnly(s.expiry_date) : '—';
              var days = s.days_until_expiry != null ? s.days_until_expiry : '—';
              var avail = s.total_qty != null ? s.total_qty : 0;
              var price = s.unit_price != null ? parseFloat(s.unit_price) : 0;
              var weightG = s.weight_g != null ? parseInt(s.weight_g, 10) : 0;
              var status = s.expiry_status || {};
              var color = status.color || '';
              var icon = status.icon || '';
              var daysHtml = (days === '—' || days === '') ? '—' : '<span class="badge" style="background-color:' + (color === 'YELLOW' ? '#ffc107' : color === 'RED' ? '#dc3545' : color === 'BLACK' ? '#343a40' : '#28a745') + ';color:#fff;border-radius:4px;padding:2px 6px;font-size:11px;">' + (icon || '') + ' ' + days + ' дн.</span>';
              var row = document.createElement('tr');
              row.className = 'sample-row';
              row.setAttribute('data-product-code', s.product_code || '');
              row.setAttribute('data-batch-code', s.batch_code || '');
              row.setAttribute('data-available', String(avail));
              row.setAttribute('data-price', String(price));
              row.setAttribute('data-weight-g', String(weightG));
              row.innerHTML = '<td>' + escAttr(productName) + '</td><td>' + escAttr(s.batch_code || '') + '</td><td>' + expiry + '</td><td style="text-align:center">' + daysHtml + '</td><td style="text-align:right">' + avail + '</td><td><input type="number" class="sample-qty" min="0" max="' + avail + '" value="0" data-available="' + avail + '"></td><td class="sample-weight" style="text-align:right">—</td><td class="sample-price" style="text-align:right">' + (price ? price.toFixed(2) : '—') + '</td><td class="sample-sum" style="text-align:right">0</td>';
              var qtyInp = row.querySelector('.sample-qty');
              var weightCell = row.querySelector('.sample-weight');
              var sumCell = row.querySelector('.sample-sum');
              function upd() {
                var q = parseInt(qtyInp.value || '0', 10) || 0;
                var maxA = parseInt(qtyInp.getAttribute('data-available') || '0', 10) || 0;
                if (q > maxA) { q = maxA; qtyInp.value = q || ''; }
                sumCell.textContent = price * q ? (price * q).toFixed(2) : '0';
                if (weightG > 0 && q > 0) weightCell.textContent = ((weightG * q) / 1000).toFixed(2) + ' кг'; else weightCell.textContent = '—';
                updateSampleTotals();
              }
              qtyInp.oninput = upd;
              qtyInp.onchange = upd;
              tbody.appendChild(row);
            });
            updateSampleTotals();
          }
          function updateSampleTotals() {
            var totalQty = 0, totalSum = 0, totalWeightG = 0;
            document.querySelectorAll('.sample-row').forEach(function (row) {
              var qtyInp = row.querySelector('.sample-qty');
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var wg = parseInt(row.getAttribute('data-weight-g') || '0', 10) || 0;
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              totalQty += q;
              totalSum += price * q;
              totalWeightG += wg * q;
            });
            document.getElementById('sampleTotalQty').textContent = totalQty;
            document.getElementById('sampleTotalSum').textContent = totalSum ? totalSum.toFixed(2) : '0';
            var wEl = document.getElementById('sampleTotalWeight');
            if (totalWeightG > 0) wEl.textContent = (totalWeightG / 1000).toFixed(2) + ' кг'; else wEl.textContent = '—';
          }
          document.getElementById('sampleExpeditor').onchange = function () {
            var login = this.value || '';
            var whToSel = document.getElementById('sampleWhTo');
            var match = null;
            if (login) warehousesList.forEach(function (w) { if (!match && w.expeditor_login === login) match = w; });
            if (match && match.code) whToSel.value = match.code; else whToSel.value = '';
            renderSampleTable();
          };
          document.getElementById('sampleWhFrom').onchange = function () {
            loadStock(this.value).then(renderSampleTable);
          };
          document.getElementById('sampleCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('sampleSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('sampleWhFrom').value;
            var whTo = document.getElementById('sampleWhTo').value;
            var expeditor = document.getElementById('sampleExpeditor').value;
            var comment = (document.getElementById('sampleComment').value || '').trim() || null;
            var createdBy = (currentUser && currentUser.login) ? currentUser.login : null;
            if (errEl) errEl.textContent = '';
            if (!expeditor) { if (errEl) errEl.textContent = 'Выберите экспедитора.'; return; }
            if (!whTo) { if (errEl) errEl.textContent = 'Склад в не определён — выберите экспедитора, привязанного к складу.'; return; }
            if (!whFrom) { if (errEl) errEl.textContent = 'Выберите склад от.'; return; }
            if (!createdBy) { if (errEl) errEl.textContent = 'Не определен текущий пользователь.'; return; }
            var items = [];
            document.querySelectorAll('.sample-row').forEach(function (row) {
              var qtyInp = row.querySelector('.sample-qty');
              var q = parseInt((qtyInp && qtyInp.value) || '0', 10) || 0;
              if (q <= 0) return;
              items.push({ product_code: row.getAttribute('data-product-code') || '', batch_code: row.getAttribute('data-batch-code') || '', quantity: q });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Укажите количество образцов хотя бы по одной позиции.'; return; }
            var saveBtn = document.getElementById('sampleSave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0, idx = 0;
            function createNext() {
              if (idx >= items.length) {
                if (msgEl) { msgEl.textContent = 'Создано операций раздачи образцов: ' + createdCount; msgEl.style.display = 'block'; }
                setTimeout(function () { loadSectionOperations(false); }, 1500);
                return;
              }
              var it = items[idx++];
              api('/api/v1/operations/allocation', { method: 'POST', body: JSON.stringify({ warehouse_from: whFrom, warehouse_to: whTo, product_code: it.product_code, batch_code: it.batch_code, quantity: it.quantity, expeditor_login: expeditor, created_by: createdBy, comment: comment }) }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) { var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]); if (errEl) errEl.textContent = errs.join('; '); }
                else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildDeliveryForm(config, customers, products, warehouses, paymentTypes, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var warehousesList = warehouses || [];
          var productsList = products || [];
          var productsMap = {}; productsList.forEach(function (p) { productsMap[p.code] = p; });
          var whOpts = '<option value="">— Выберите склад —</option>';
          warehousesList.forEach(function (w) { whOpts += '<option value="' + escAttr(w.code) + '">' + escAttr(w.name || w.code) + '</option>'; });
          var expOpts = '<option value="">— Не указан —</option>';
          (userList || []).forEach(function (u) {
            if ((u.role || '').toLowerCase() !== 'expeditor') return;
            expOpts += '<option value="' + escAttr(u.login) + '">' + escAttr(u.login + (u.fio ? ' — ' + u.fio : '')) + '</option>';
          });
          var custOpts = '<option value="">— Выберите клиента —</option>';
          customers.forEach(function (c) { custOpts += '<option value="' + (c.id != null ? c.id : '') + '">' + escAttr((c.name_client || c.firm_name || '') + ' (ID ' + (c.id != null ? c.id : '') + ')') + '</option>'; });
          var payOpts = '<option value="">— Выберите тип оплаты —</option>';
          paymentTypes.forEach(function (pt) { payOpts += '<option value="' + escAttr(pt.code) + '">' + escAttr(pt.name || pt.code) + '</option>'; });
          var formHtml = '<div class="card"><h2>Создание операции: ' + escAttr(config.operation_name || 'Доставка клиенту') + '</h2>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Заказ № <span style="color:#c00">*</span></label><div style="display:flex;gap:8px;align-items:center"><input type="number" id="deliveryOrderId" min="1" required placeholder="Введите номер заказа или найдите" autocomplete="off" style="flex:1"><button type="button" class="btn btn-secondary" id="deliveryOrderSearchBtn">Найти заказ</button></div></div>';
          formHtml += '<div id="deliveryOrderInfo" style="margin-bottom:16px;display:none"></div>';
          formHtml += '<div class="form-group"><label>Склад от <span style="color:#c00">*</span></label><select id="deliveryWhFrom" required>' + whOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Экспедитор <span style="color:#c00">*</span></label><select id="deliveryExpeditor" required>' + expOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Клиент <span style="color:#c00">*</span></label><select id="deliveryCustomer" required>' + custOpts + '</select></div>';
          formHtml += '<div class="form-group"><label>Тип оплаты <span style="color:#c00">*</span></label><select id="deliveryPaymentType" required>' + payOpts + '</select></div>';
          formHtml += '<div style="margin-top:20px"><h3 style="margin-bottom:12px">Товары заказа</h3><div style="overflow-x:auto"><table id="deliveryItemsTable" style="width:100%"><thead><tr><th>Товар</th><th>Партия</th><th>Срок годности</th><th>Дней осталось</th><th>Доступно</th><th>Количество (заказ)</th><th>Количество (доставка)</th><th>Цена</th><th>Сумма</th></tr></thead><tbody id="deliveryItemsBody"></tbody><tfoot><tr style="background:#f8f9fa;font-weight:600"><td colspan="6" style="text-align:right;padding:8px">Итого:</td><td id="deliveryTotalQty" style="text-align:right;padding:8px">0</td><td></td><td id="deliveryTotalSum" style="text-align:right;padding:8px">0</td><td></td></tr></tfoot></table></div></div>';
          formHtml += '<div class="form-group" style="margin-top:20px"><label>Комментарий</label><input type="text" id="deliveryComment" placeholder="необяз."></div>';
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="deliverySave">Сохранить операции</button> <button type="button" class="btn btn-secondary" id="deliveryCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var orderData = null;
          var stockCache = null;
          function loadStock(whCode) {
            if (!whCode) { stockCache = null; return Promise.resolve(); }
            return api('/api/v1/warehouse/stock?warehouse=' + encodeURIComponent(whCode)).then(function (resp) {
              stockCache = (resp && resp.success && Array.isArray(resp.data)) ? resp.data : [];
            }).catch(function () { stockCache = []; });
          }
          document.getElementById('deliveryOrderId').onchange = function () {
            var orderId = parseInt(this.value || '0', 10) || 0;
            var infoDiv = document.getElementById('deliveryOrderInfo');
            var tbody = document.getElementById('deliveryItemsBody');
            if (!orderId) {
              infoDiv.style.display = 'none';
              tbody.innerHTML = '';
              orderData = null;
              var custSel = document.getElementById('deliveryCustomer');
              var paySel = document.getElementById('deliveryPaymentType');
              var expSel = document.getElementById('deliveryExpeditor');
              var whSel = document.getElementById('deliveryWhFrom');
              if (custSel) { custSel.disabled = false; custSel.classList.remove('from-order'); }
              if (paySel) { paySel.disabled = false; paySel.classList.remove('from-order'); }
              if (expSel) { expSel.disabled = false; expSel.classList.remove('from-order'); }
              if (whSel) { whSel.disabled = false; whSel.classList.remove('from-order'); }
              return;
            }
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = '<p style="color:#666">Загрузка заказа...</p>';
            api('/api/v1/orders/' + orderId).then(function (order) {
              orderData = order;
              var custSel = document.getElementById('deliveryCustomer');
              var paySel = document.getElementById('deliveryPaymentType');
              var expSel = document.getElementById('deliveryExpeditor');
              var whSel = document.getElementById('deliveryWhFrom');
              if (custSel && order.customer_id) custSel.value = String(order.customer_id);
              if (paySel && order.payment_type_code) paySel.value = order.payment_type_code;
              if (expSel && order.login_expeditor) expSel.value = order.login_expeditor;
              if (whSel && order.warehouse_from_expeditor) {
                whSel.value = order.warehouse_from_expeditor;
                whSel.disabled = true; whSel.classList.add('from-order');
              }
              var whFrom = whSel ? whSel.value : '';
              custSel.disabled = true; custSel.classList.add('from-order');
              paySel.disabled = true; paySel.classList.add('from-order');
              if (expSel) { expSel.disabled = true; expSel.classList.add('from-order'); }
              infoDiv.innerHTML = '<p style="color:#28a745;font-weight:600">Заказ №' + order.order_no + ' — ' + escAttr(order.customer_name || '') + '</p><p style="color:#666;font-size:12px;margin-top:4px">Склад, экспедитор, клиент и тип оплаты взяты из заказа (только для чтения).</p>';
              tbody.innerHTML = '';
              if (!order.items || !order.items.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:16px;color:#666">В заказе нет товаров</td></tr>';
                return;
              }
              if (whFrom) loadStock(whFrom).then(function () { renderOrderItems(order.items); });
              else renderOrderItems(order.items);
            }).catch(function (e) {
              var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка загрузки заказа';
              infoDiv.innerHTML = '<p class="err">Ошибка: ' + escAttr(msg) + '</p>';
              tbody.innerHTML = '';
              orderData = null;
            });
          };
          document.getElementById('deliveryWhFrom').onchange = function () {
            var whCode = this.value || '';
            loadStock(whCode).then(function () {
              if (orderData && orderData.items) renderOrderItems(orderData.items);
            });
          };
          function renderOrderItems(items) {
            var tbody = document.getElementById('deliveryItemsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!items || !items.length) {
              tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:16px;color:#666">Нет товаров</td></tr>';
              return;
            }
            var whFrom = document.getElementById('deliveryWhFrom').value;
            items.forEach(function (item) {
              var product = productsMap[item.product_code] || {};
              var productName = (product.code || '') + ' — ' + (product.name || '');
              var stockRows = (stockCache || []).filter(function (s) { return s.product_code === item.product_code && (!whFrom || s.warehouse_code === whFrom); });
              stockRows.sort(function (a, b) {
                var ea = a.expiry_date || ''; var eb = b.expiry_date || '';
                return ea.localeCompare(eb);
              });
              var batchOpts = '<option value="">— Выберите партию —</option>';
              stockRows.forEach(function (r) {
                var days = (r.days_until_expiry != null ? r.days_until_expiry : '');
                var status = r.expiry_status || {};
                var color = status.color || '';
                var icon = status.icon || '';
                batchOpts += '<option value="' + escAttr(r.batch_code || '') + '" data-batch-id="' + escAttr(r.batch_id || '') + '" data-expiry="' + escAttr(r.expiry_date || '') + '" data-available="' + (r.total_qty != null ? r.total_qty : 0) + '" data-days="' + days + '" data-color="' + escAttr(color) + '" data-icon="' + escAttr(icon) + '">' + escAttr((r.batch_code || '') + (r.expiry_date ? ' — ' + formatDateOnly(r.expiry_date) : '')) + '</option>';
              });
              var price = (item.price != null ? parseFloat(item.price) : (product.price != null ? parseFloat(product.price) : 0)) || 0;
              var row = document.createElement('tr');
              row.className = 'delivery-row';
              row.setAttribute('data-product-code', item.product_code);
              row.setAttribute('data-order-qty', item.quantity || 0);
              row.setAttribute('data-price', price);
              row.innerHTML = '<td>' + escAttr(productName) + '</td><td><select class="delivery-batch" required>' + batchOpts + '</select></td><td class="delivery-expiry">—</td><td class="delivery-days" style="text-align:center">—</td><td class="delivery-available" style="text-align:right">0</td><td style="text-align:right;font-weight:600">' + (item.quantity || 0) + '</td><td><input type="number" class="delivery-qty" min="1" max="' + (item.quantity || 0) + '" value="' + (item.quantity || 0) + '" required></td><td class="delivery-price" style="text-align:right">' + (price ? price.toFixed(2) : '—') + '</td><td class="delivery-sum" style="text-align:right">—</td>';
              tbody.appendChild(row);
              var batchSel = row.querySelector('.delivery-batch');
              if (batchSel && stockRows.length > 0) {
                batchSel.selectedIndex = 1;
              }
              attachDeliveryRowHandlers(row);
            });
            updateDeliveryTotals();
          }
          function attachDeliveryRowHandlers(row) {
            var batchSel = row.querySelector('.delivery-batch');
            var qtyInp = row.querySelector('.delivery-qty');
            var expiryCell = row.querySelector('.delivery-expiry');
            var daysCell = row.querySelector('.delivery-days');
            var availCell = row.querySelector('.delivery-available');
            var sumCell = row.querySelector('.delivery-sum');
            if (!batchSel || !qtyInp) return;
            function updateBatchInfo() {
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var expiry = opt ? opt.getAttribute('data-expiry') || '' : '';
              var avail = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              var daysAttr = opt ? opt.getAttribute('data-days') : null;
              var color = opt ? opt.getAttribute('data-color') || '' : '';
              var icon = opt ? opt.getAttribute('data-icon') || '' : '';
              expiryCell.textContent = expiry ? formatDateOnly(expiry) : '—';
              availCell.textContent = avail;
              var orderQty = parseInt(row.getAttribute('data-order-qty') || '0', 10) || 0;
              var maxQty = Math.min(orderQty, avail);
              qtyInp.max = maxQty;
              if (parseInt(qtyInp.value || '0', 10) > maxQty) qtyInp.value = maxQty;
              if (daysCell) {
                if (daysAttr === null || daysAttr === '' || isNaN(parseInt(daysAttr, 10))) {
                  daysCell.textContent = '—';
                } else {
                  var days = parseInt(daysAttr, 10);
                  var badgeColor = '#28a745';
                  if (color === 'YELLOW') badgeColor = '#ffc107';
                  else if (color === 'RED') badgeColor = '#dc3545';
                  else if (color === 'BLACK') badgeColor = '#343a40';
                  var iconChar = icon || (color === 'YELLOW' ? '🟡' : (color === 'RED' ? '🔴' : (color === 'BLACK' ? '⚫' : '🟢')));
                  var daysText = days + ' дн.';
                  daysCell.innerHTML = '<span style="display:inline-block;padding:2px 6px;border-radius:4px;background:' + badgeColor + ';color:#fff;font-size:11px;font-weight:600">' + iconChar + ' ' + daysText + '</span>';
                }
              }
              updateRowSum();
            }
            function updateRowSum() {
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var sum = qty * price;
              sumCell.textContent = sum ? sum.toFixed(2) : '—';
              updateDeliveryTotals();
            }
            batchSel.onchange = updateBatchInfo;
            qtyInp.onchange = updateRowSum;
            qtyInp.oninput = updateRowSum;
            updateBatchInfo();
          }
          function updateDeliveryTotals() {
            var rows = document.querySelectorAll('.delivery-row');
            var totalQty = 0;
            var totalSum = 0;
            rows.forEach(function (row) {
              var qtyInp = row.querySelector('.delivery-qty');
              var sumCell = row.querySelector('.delivery-sum');
              if (qtyInp && sumCell) {
                var qty = parseInt(qtyInp.value || '0', 10) || 0;
                var sum = parseFloat(sumCell.textContent || '0') || 0;
                totalQty += qty;
                totalSum += sum;
              }
            });
            var totalQtyEl = document.getElementById('deliveryTotalQty');
            var totalSumEl = document.getElementById('deliveryTotalSum');
            if (totalQtyEl) totalQtyEl.textContent = totalQty;
            if (totalSumEl) totalSumEl.textContent = totalSum ? totalSum.toFixed(2) : '0';
          }
          function showOrderSearchModal() {
            api('/api/v1/orders/statuses').catch(function() { return []; }).then(function(statuses) {
              function formatDateTashkent(isoStr) {
                if (!isoStr) return '';
                try {
                  var d = new Date(isoStr);
                  return d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                } catch (e) { return isoStr; }
              }
              var modalId = 'orderSearchModal_' + Date.now();
              var statusOptsHtml = '<option value="">— Все —</option>';
              if (statuses && statuses.length) {
                statuses.forEach(function(s) {
                  statusOptsHtml += '<option value="' + escAttr(s.code) + '">' + escAttr(s.name || s.code) + '</option>';
                });
              } else {
                statusOptsHtml += '<option value="open">Открыт</option><option value="delivery">Доставка</option>';
              }
              var modalHtml = '<div class="modal show" id="' + modalId + '"><div class="modal-inner" style="max-width:900px;max-height:90vh;overflow:auto"><h3>Поиск заказа</h3>';
              modalHtml += '<div style="margin-bottom:16px"><div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:12px">';
              modalHtml += '<div><label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Экспедитор</label><select id="orderSearchModalExpeditor" style="min-width:200px">' + expOpts + '</select></div>';
              modalHtml += '<div><label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Статус</label><select id="orderSearchModalStatus" style="min-width:180px">' + statusOptsHtml + '</select></div>';
              modalHtml += '<div><label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Клиент</label><select id="orderSearchModalCustomer" style="min-width:220px">' + custOpts + '</select></div>';
              modalHtml += '<div><button type="button" class="btn btn-primary" id="orderSearchModalBtn">Найти</button></div>';
              modalHtml += '</div><div style="margin-top:8px"><label><input type="checkbox" id="orderSearchModalNotClosed" checked> Только не закрытые заказы</label></div></div>';
              modalHtml += '<div id="orderSearchModalResults" style="margin-top:16px;max-height:400px;overflow-y:auto"></div>';
              modalHtml += '<div id="orderSearchModalErr" class="err" style="margin-top:8px"></div>';
              modalHtml += '<div class="modal-actions" style="margin-top:16px"><button type="button" class="btn btn-secondary" id="orderSearchModalCancel">Отмена</button></div></div></div>';
              var modalContainer = document.getElementById('modalContainer');
              if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'modalContainer';
                document.body.appendChild(modalContainer);
              }
              modalContainer.innerHTML = modalHtml;
              var resultsDiv = document.getElementById('orderSearchModalResults');
              var errDiv = document.getElementById('orderSearchModalErr');
              
              function searchOrders() {
                if (errDiv) errDiv.textContent = '';
                if (resultsDiv) resultsDiv.innerHTML = '<p style="color:#666;text-align:center;padding:20px">Поиск...</p>';
                var expeditor = document.getElementById('orderSearchModalExpeditor') ? document.getElementById('orderSearchModalExpeditor').value : '';
                var status = document.getElementById('orderSearchModalStatus') ? document.getElementById('orderSearchModalStatus').value : '';
                var customer = document.getElementById('orderSearchModalCustomer') ? document.getElementById('orderSearchModalCustomer').value : '';
                var notClosed = document.getElementById('orderSearchModalNotClosed') ? document.getElementById('orderSearchModalNotClosed').checked : true;
                var params = [];
                if (expeditor && expeditor.trim()) params.push('login_expeditor=' + encodeURIComponent(expeditor.trim()));
                if (status && status.trim()) params.push('status_code=' + encodeURIComponent(status.trim()));
                if (customer && customer.trim() && !isNaN(parseInt(customer, 10))) params.push('customer_id=' + encodeURIComponent(customer.trim()));
                performSearch(params, notClosed);
              }
              
              function performSearch(params, filterNotClosed) {
                var url = '/api/v1/orders' + (params.length ? '?' + params.join('&') : '');
                api(url).then(function(data) {
                  var orders = Array.isArray(data) ? data : (data && data.orders ? data.orders : []);
                  if (!resultsDiv) return;
                  
                  // Только не закрытые: по умолчанию показываем только open и delivery (закрытые — completed и canceled)
                  if (filterNotClosed && orders && orders.length) {
                    var openStatusCodes = ['open', 'delivery'];
                    orders = orders.filter(function(o) {
                      var code = (o.status_code || '').toLowerCase().trim();
                      return openStatusCodes.indexOf(code) !== -1;
                    });
                  }
                  
                  if (!orders || !orders.length) {
                    resultsDiv.innerHTML = '<p style="color:#666;text-align:center;padding:20px">Заказы не найдены. Измените критерии поиска.</p>';
                    return;
                  }
                  var tableHtml = '<div style="overflow-x:auto"><table style="width:100%"><thead><tr><th>№</th><th>Клиент</th><th>Дата создания</th><th>Статус</th><th>Сумма</th><th>Экспедитор</th><th>Действие</th></tr></thead><tbody>';
                  orders.forEach(function(o) {
                    tableHtml += '<tr><td>' + (o.order_no || o.id) + '</td><td>' + escAttr(o.customer_name || '') + '</td><td>' + formatDateTashkent(o.order_date) + '</td><td>' + formatStatusBadge(o.status_code, o.status_name) + '</td><td>' + (o.total_amount || '0') + '</td><td>' + escAttr(o.login_expeditor || '') + '</td><td><button type="button" class="btn btn-primary btn-small" data-select-order="' + (o.order_no || o.id) + '">Выбрать</button></td></tr>';
                  });
                  tableHtml += '</tbody></table></div>';
                  resultsDiv.innerHTML = tableHtml;
                  resultsDiv.querySelectorAll('[data-select-order]').forEach(function(btn) {
                    btn.onclick = function() {
                      var orderId = this.getAttribute('data-select-order');
                      document.getElementById('deliveryOrderId').value = orderId;
                      document.getElementById(modalId).classList.remove('show');
                      document.getElementById('deliveryOrderId').dispatchEvent(new Event('change'));
                    };
                  });
                }).catch(function(e) {
                  console.error('Order search error:', e);
                  var msg = 'Ошибка поиска заказов.';
                  if (e && e.data) {
                    var d = e.data.detail;
                    if (typeof d === 'string') msg = d;
                    else if (Array.isArray(d) && d.length) msg = d.map(function(x) { return x.msg || x.message || JSON.stringify(x); }).join(' ');
                    else if (d && typeof d === 'object') msg = JSON.stringify(d);
                  }
                  if (e && e.status) msg = 'Код ' + e.status + ': ' + msg;
                  else if (e && e.message) msg = msg + ' ' + String(e.message);
                  if (errDiv) errDiv.textContent = msg;
                  if (resultsDiv) resultsDiv.innerHTML = '';
                });
              }
              
              document.getElementById('orderSearchModalBtn').onclick = searchOrders;
              document.getElementById('orderSearchModalCancel').onclick = function() {
                document.getElementById(modalId).classList.remove('show');
              };
              // Закрытие по клику вне модального окна
              document.getElementById(modalId).onclick = function(e) {
                if (e.target.id === modalId) {
                  document.getElementById(modalId).classList.remove('show');
                }
              };
              // Первый поиск без фильтров — проверка, что API отвечает
              performSearch([], document.getElementById('orderSearchModalNotClosed').checked);
            });
          }
          document.getElementById('deliveryOrderSearchBtn').onclick = showOrderSearchModal;
          document.getElementById('deliveryCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('deliverySave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var whFrom = document.getElementById('deliveryWhFrom').value;
            var expeditor = document.getElementById('deliveryExpeditor').value;
            var customerId = document.getElementById('deliveryCustomer').value;
            var paymentType = document.getElementById('deliveryPaymentType').value;
            var orderId = parseInt(document.getElementById('deliveryOrderId').value || '0', 10) || 0;
            if (errEl) errEl.textContent = '';
            if (!whFrom) { if (errEl) errEl.textContent = 'Выберите склад от.'; return; }
            if (!expeditor) { if (errEl) errEl.textContent = 'Выберите экспедитора.'; return; }
            if (!customerId) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
            if (!paymentType) { if (errEl) errEl.textContent = 'Выберите тип оплаты.'; return; }
            if (!orderId) { if (errEl) errEl.textContent = 'Введите номер заказа.'; return; }
            var rows = document.querySelectorAll('.delivery-row');
            var items = [];
            rows.forEach(function (row) {
              var batchSel = row.querySelector('.delivery-batch');
              var qtyInp = row.querySelector('.delivery-qty');
              var productCode = row.getAttribute('data-product-code') || '';
              if (!batchSel || !qtyInp || !productCode) return;
              var batchCode = (batchSel.value || '').trim();
              var qty = parseInt(qtyInp.value || '0', 10) || 0;
              if (!batchCode || !qty) return;
              var opt = batchSel.options[batchSel.selectedIndex] || null;
              var available = opt ? parseInt(opt.getAttribute('data-available') || '0', 10) || 0 : 0;
              if (qty > available) qty = available;
              var price = parseFloat(row.getAttribute('data-price') || '0') || 0;
              var amount = qty * price;
              items.push({ product_code: productCode, batch_code: batchCode, quantity: qty, amount: amount });
            });
            if (!items.length) { if (errEl) errEl.textContent = 'Выберите партии для всех товаров.'; return; }
            var comment = (document.getElementById('deliveryComment').value || '').trim() || null;
            var createdBy = (window.currentUser && window.currentUser.login) ? window.currentUser.login : null;
            var saveBtn = document.getElementById('deliverySave');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            var createdCount = 0;
            var idx = 0;
            function createNext() {
              if (idx >= items.length) {
                var done = function () {
                  if (msgEl) { msgEl.textContent = 'Операции доставки созданы: ' + createdCount + ' шт. Заказ переведён в статус «Доставлен».'; msgEl.style.display = 'block'; }
                  setTimeout(function () { loadSectionOperations(false); }, 1500);
                };
                if (createdCount > 0 && orderId) {
                  api('/api/v1/orders/' + orderId, { method: 'PATCH', body: JSON.stringify({ status_code: 'completed' }) }).then(done).catch(function () { done(); });
                } else {
                  done();
                }
                return;
              }
              var it = items[idx++];
              var payload = {
                warehouse_from: whFrom,
                product_code: it.product_code,
                batch_code: it.batch_code,
                quantity: it.quantity,
                customer_id: parseInt(customerId, 10),
                amount: it.amount,
                payment_type_code: paymentType,
                expeditor_login: expeditor,
                order_id: orderId,
                comment: comment
              };
              api('/api/v1/operations/' + encodeURIComponent(config.operation_type) + '/create', { method: 'POST', body: JSON.stringify(payload) }).then(function () {
                createdCount += 1;
                createNext();
              }).catch(function (e) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить операции';
                var detail = e && e.data && e.data.detail;
                if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
                if (detail && detail.errors) {
                  var errs = []; for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                  if (errEl) errEl.textContent = errs.join('; ');
                } else if (errEl) errEl.textContent = 'Ошибка сохранения';
              });
            }
            createNext();
          };
        }
        function buildFormFromConfig(config, customers, products, warehouses, paymentTypes, userList) {
          var content = document.getElementById('content');
          if (!content) return;
          var fieldsToShow = (config.required_fields || []).concat(config.optional_fields || []);
          var hiddenFields = config.hidden_fields || [];
          var readonlyFields = config.readonly_fields || [];
          if (config.operation_type === 'payment_receipt_from_customer') {
            var prio = ['customer_id', 'order_id'];
            var rest = fieldsToShow.filter(function (f) { return prio.indexOf(f) === -1; });
            fieldsToShow = prio.filter(function (f) { return fieldsToShow.indexOf(f) >= 0; }).concat(rest);
          }
          if (config.operation_type === 'warehouse_receipt') {
            buildWarehouseReceiptForm(config, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'allocation') {
            buildAllocationForm(config, customers, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'delivery') {
            buildDeliveryForm(config, customers, products, warehouses, paymentTypes, userList);
            return;
          }
          if (config.operation_type === 'write_off') {
            buildWriteOffForm(config, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'transfer') {
            buildTransferForm(config, products, warehouses, userList);
            return;
          }
          if (config.operation_type === 'promotional_sample') {
            buildPromotionalSampleForm(config, products, warehouses, userList);
            return;
          }
          var formHtml = '<div class="card"><h2 id="opFormTitle">Создание операции: ' + escAttr(config.operation_name || config.operation_type) + '</h2>';
          if (config.description) formHtml += '<p style="color:#666;margin-bottom:16px">' + escAttr(config.description) + '</p>';
          formHtml += '<div id="opFormErr" class="err" style="margin-bottom:12px"></div><div id="opFormMsg" class="msg" style="margin-bottom:12px;display:none"></div>';
          var fieldMap = {
            warehouse_from: { label: 'Склад от', type: 'select', options: warehouses, id: 'opCreateWarehouseFrom' },
            warehouse_to: { label: 'Склад в', type: 'select', options: warehouses, id: 'opCreateWarehouseTo' },
            product_code: { label: 'Товар', type: 'select', options: products, id: 'opCreateProduct' },
            batch_code: { label: 'Код партии', type: 'text', id: 'opCreateBatchCode', autoFromProductAndExpiry: true },
            expiry_date: { label: 'Срок годности', type: 'date', id: 'opCreateExpiryDate' },
            quantity: { label: 'Количество', type: 'number', id: 'opCreateQuantity', min: 0 },
            amount: { label: 'Сумма', type: 'number', id: 'opCreateAmount', step: '0.01' },
            payment_type_code: { label: 'Тип оплаты', type: 'select', options: paymentTypes, id: 'opCreatePaymentType' },
            customer_id: { label: 'Клиент', type: 'select', options: customers, id: 'opCreateCustomer' },
            order_id: { label: 'Заказ №', type: 'number', id: 'opCreateOrderId', min: 0 },
            expeditor_login: { label: 'Экспедитор', type: 'select', options: (userList || []).filter(function (u) { return (u.role || '').toLowerCase() === 'expeditor'; }), id: 'opCreateExpeditor' },
            cashier_login: { label: 'Кассир', type: 'select', options: userList, id: 'opCreateCashier' },
            storekeeper_login: { label: 'Кладовщик', type: 'select', options: userList, id: 'opCreateStorekeeper' },
            comment: { label: 'Комментарий', type: 'text', id: 'opCreateComment' },
            related_operation_id: { label: 'Связанная операция', type: 'text', id: 'opCreateRelatedOp' }
          };
          fieldsToShow.forEach(function (fieldName) {
            if (hiddenFields.indexOf(fieldName) >= 0) return;
            var field = fieldMap[fieldName];
            if (!field) return;
            var isRequired = (config.required_fields || []).indexOf(fieldName) >= 0;
            var isReadonly = readonlyFields.indexOf(fieldName) >= 0;
            formHtml += '<div class="form-group"><label>' + escAttr(field.label || fieldName) + (isRequired ? ' <span style="color:#c00">*</span>' : '') + '</label>';
            if (fieldName === 'order_id' && config.operation_type === 'payment_receipt_from_customer') {
              formHtml += '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><input type="hidden" id="' + field.id + '"><input type="text" id="opCreateOrderDisplay" readonly placeholder="Сначала выберите клиента" style="flex:1;min-width:200px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px"><button type="button" class="btn btn-secondary" id="opOrderPickBtn" disabled>Выбрать заказ</button></div></div>';
            } else if (fieldName === 'customer_id' && config.operation_type === 'payment_receipt_from_customer') {
              formHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center"><input type="hidden" id="' + field.id + '"><input type="text" id="opCreateCustomerSearch" placeholder="ИНН или р/с" style="max-width:220px" autocomplete="off"><button type="button" class="btn btn-secondary" id="opCreateCustomerFind">Найти</button><span id="opCreateCustomerDisplay" style="color:#0f766e;font-weight:600"></span></div><div id="opCreateCustomerErr" class="err" style="margin-top:4px;font-size:12px"></div></div>';
            } else if (field.type === 'select') {
              var opts = '<option value="">— Не указан —</option>';
              if (field.options) {
                field.options.forEach(function (opt) {
                  if (fieldName === 'expeditor_login' && (opt.role || '').toLowerCase() !== 'expeditor') return;
                  var val = opt.code || opt.id || opt.login || '';
                  var text = (fieldName === 'customer_id')
                    ? ((opt.name_client || opt.firm_name || '') + ' (ID ' + (opt.id || '') + ')')
                    : ((fieldName === 'product_code')
                      ? ((opt.code || '') + ' — ' + (opt.name || ''))
                      : (opt.name || opt.code || opt.login || val));
                  opts += '<option value="' + escAttr(val) + '">' + escAttr(text) + '</option>';
                });
              }
              formHtml += '<select id="' + field.id + '"' + (isRequired ? ' required' : '') + (isReadonly ? ' disabled' : '') + '>' + opts + '</select></div>';
            } else {
              var inputType = field.type || 'text';
              var placeholder = (isRequired ? 'обязательно' : 'необяз.');
              if (fieldName === 'expiry_date') { inputType = 'text'; placeholder = 'дд.мм.гггг'; }
              formHtml += '<input type="' + inputType + '" id="' + field.id + '"' + (isRequired ? ' required' : '') + (isReadonly ? ' readonly' : '') + (field.min !== undefined ? ' min="' + field.min + '"' : '') + (field.step !== undefined ? ' step="' + field.step + '"' : '') + ' placeholder="' + placeholder + '" autocomplete="off"></div>';
            }
          });
          formHtml += '<p style="margin-top:16px"><button type="button" class="btn btn-primary" id="opCreateSave">Сохранить операцию</button> <button type="button" class="btn btn-secondary" id="opCreateCancel">Отмена</button></p></div>';
          content.innerHTML = formHtml;
          var expiryEl = document.getElementById('opCreateExpiryDate');
          if (expiryEl && window.flatpickr) {
            window.flatpickr(expiryEl, { locale: 'ru', dateFormat: 'd.m.Y', allowInput: true });
          }
          function updateBatchCodeFromProductAndExpiry() {
            var productEl = document.getElementById('opCreateProduct');
            var expiryEl = document.getElementById('opCreateExpiryDate');
            var batchEl = document.getElementById('opCreateBatchCode');
            if (!productEl || !expiryEl || !batchEl) return;
            var productCode = (productEl.value || '').trim();
            var expiryRaw = (expiryEl.value || '').trim();
            if (!productCode || !expiryRaw) return;
            var m = expiryRaw.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
            if (!m) {
              var iso = expiryRaw.match(/^(\d{4})-(\d{2})-(\d{2})/);
              if (iso) m = [null, iso[3], iso[2], iso[1]];
            }
            if (m) {
              var ddmmyyyy = m[1].padStart(2, '0') + m[2].padStart(2, '0') + m[3];
              batchEl.value = productCode + '_' + ddmmyyyy;
            }
          }
          var productEl = document.getElementById('opCreateProduct');
          var expiryEl = document.getElementById('opCreateExpiryDate');
          var batchEl = document.getElementById('opCreateBatchCode');
          if (productEl && expiryEl && batchEl && fieldMap.batch_code && fieldMap.batch_code.autoFromProductAndExpiry) {
            productEl.onchange = updateBatchCodeFromProductAndExpiry;
            if (expiryEl) { expiryEl.onchange = updateBatchCodeFromProductAndExpiry; expiryEl.oninput = updateBatchCodeFromProductAndExpiry; }
          }
          if (config.operation_type === 'payment_receipt_from_customer') {
            var customerIdInput = document.getElementById('opCreateCustomer');
            var customerSearchInput = document.getElementById('opCreateCustomerSearch');
            var customerDisplay = document.getElementById('opCreateCustomerDisplay');
            var customerErr = document.getElementById('opCreateCustomerErr');
            var orderIdInput = document.getElementById('opCreateOrderId');
            var orderDisplay = document.getElementById('opCreateOrderDisplay');
            var orderPickBtn = document.getElementById('opOrderPickBtn');
            var amountEl = document.getElementById('opCreateAmount');
            var paymentTypeEl = document.getElementById('opCreatePaymentType');
            function updateOrderPickState() {
              var cust = customerIdInput ? customerIdInput.value : '';
              if (orderPickBtn) orderPickBtn.disabled = !cust || cust.trim() === '';
              if (!cust || cust.trim() === '') {
                if (orderIdInput) orderIdInput.value = '';
                if (orderDisplay) { orderDisplay.value = ''; orderDisplay.placeholder = 'Сначала выберите клиента'; }
                if (amountEl) { amountEl.value = ''; amountEl.readOnly = false; }
                if (paymentTypeEl) { paymentTypeEl.value = ''; paymentTypeEl.disabled = false; }
              } else if (orderDisplay) orderDisplay.placeholder = 'Нажмите «Выбрать заказ»';
            }
            if (document.getElementById('opCreateCustomerFind')) {
              document.getElementById('opCreateCustomerFind').onclick = function () {
                var val = (customerSearchInput && customerSearchInput.value) ? customerSearchInput.value.trim() : '';
                if (customerErr) customerErr.textContent = '';
                if (!val) { if (customerErr) customerErr.textContent = 'Введите ИНН или расчётный счёт'; return; }
                api('/api/v1/customers?search=' + encodeURIComponent(val)).then(function (data) {
                  var list = Array.isArray(data) ? data : (data && data.data ? data.data : []);
                  if (!list.length) { if (customerErr) customerErr.textContent = 'Клиент не найден'; return; }
                  var c = list[0];
                  var id = c.id != null ? c.id : c.customer_id;
                  if (customerIdInput) customerIdInput.value = id;
                  if (customerDisplay) customerDisplay.textContent = (c.name_client || c.firm_name || '') + ' (ID ' + id + ')';
                  if (customerErr) customerErr.textContent = '';
                  updateOrderPickState();
                }).catch(function () { if (customerErr) customerErr.textContent = 'Ошибка поиска'; });
              };
            }
            updateOrderPickState();
            if (orderPickBtn) {
              orderPickBtn.onclick = function () {
                var customerId = customerIdInput ? customerIdInput.value : '';
                if (!customerId || customerId.trim() === '') return;
                var modalId = 'opOrderPickModal_' + Date.now();
                var modalHtml = '<div class="modal show" id="' + modalId + '"><div class="modal-inner" style="max-width:700px;max-height:85vh;overflow:auto"><h3>Выбор заказа (неоплаченные)</h3><div id="opOrderPickLoading" style="padding:20px;text-align:center;color:#666">Загрузка заказов...</div><div id="opOrderPickResults" style="margin-top:12px;max-height:400px;overflow-y:auto;display:none"></div><div id="opOrderPickErr" class="err" style="margin-top:8px"></div><div class="modal-actions" style="margin-top:16px"><button type="button" class="btn btn-secondary" id="opOrderPickCancel">Отмена</button></div></div></div>';
                var modalContainer = document.getElementById('modalContainer');
                if (!modalContainer) { modalContainer = document.createElement('div'); modalContainer.id = 'modalContainer'; document.body.appendChild(modalContainer); }
                modalContainer.innerHTML = modalHtml;
                var loadingEl = document.getElementById('opOrderPickLoading');
                var resultsEl = document.getElementById('opOrderPickResults');
                var errEl = document.getElementById('opOrderPickErr');
                api('/api/v1/orders?customer_id=' + encodeURIComponent(customerId)).then(function (data) {
                  var orders = Array.isArray(data) ? data : (data && data.orders ? data.orders : data && data.data ? data.data : []);
                  orders = (orders || []).filter(function (o) { var s = (o.status_code || '').toLowerCase(); return s !== 'completed' && s !== 'canceled' && s !== 'cancelled'; });
                  if (loadingEl) loadingEl.style.display = 'none';
                  if (resultsEl) {
                    resultsEl.style.display = 'block';
                    if (!orders.length) {
                      resultsEl.innerHTML = '<p style="color:#666;text-align:center;padding:20px">Нет неоплаченных заказов у клиента.</p>';
                      return;
                    }
                    var tableHtml = '<div style="overflow-x:auto"><table style="width:100%"><thead><tr><th>№ заказа</th><th>Дата поставки</th><th>Статус</th><th>Сумма</th><th></th></tr></thead><tbody>';
                    orders.forEach(function (o) {
                      var orderNo = o.order_no != null ? o.order_no : o.id;
                      var deliveryDate = o.scheduled_delivery_at ? formatDateOnly(o.scheduled_delivery_at) : '—';
                      var status = o.status_name || o.status_code || '—';
                      var amount = o.total_amount != null ? (typeof o.total_amount === 'number' ? o.total_amount.toFixed(2) : o.total_amount) : '—';
                      tableHtml += '<tr><td>' + escAttr(orderNo) + '</td><td>' + escAttr(deliveryDate) + '</td><td>' + formatStatusBadge(o.status_code, status) + '</td><td>' + escAttr(amount) + '</td><td><button type="button" class="btn btn-primary btn-small" data-op-select-order="' + escAttr(orderNo) + '" data-op-order-amount="' + escAttr(o.total_amount != null ? o.total_amount : '') + '" data-op-order-payment="' + escAttr(o.payment_type_code || '') + '" data-op-order-display="' + escAttr('№ ' + orderNo + ' — ' + deliveryDate) + '">Выбрать</button></td></tr>';
                    });
                    tableHtml += '</tbody></table></div>';
                    resultsEl.innerHTML = tableHtml;
                    resultsEl.querySelectorAll('[data-op-select-order]').forEach(function (btn) {
                      btn.onclick = function () {
                        var ordId = this.getAttribute('data-op-select-order');
                        var disp = this.getAttribute('data-op-order-display') || ('№ ' + ordId);
                        if (orderIdInput) orderIdInput.value = ordId;
                        if (orderDisplay) orderDisplay.value = disp;
                        var amt = this.getAttribute('data-op-order-amount');
                        var pay = this.getAttribute('data-op-order-payment') || '';
                        if (amountEl) { amountEl.value = amt != null && amt !== '' ? amt : ''; amountEl.readOnly = true; }
                        if (paymentTypeEl) { try { paymentTypeEl.value = pay; paymentTypeEl.disabled = true; } catch (e) {} }
                        document.getElementById(modalId).classList.remove('show');
                      };
                    });
                  }
                }).catch(function (e) {
                  if (loadingEl) loadingEl.style.display = 'none';
                  if (resultsEl) { resultsEl.style.display = 'block'; resultsEl.innerHTML = ''; }
                  var msg = 'Ошибка загрузки заказов.';
                  if (e && e.data && e.data.detail) msg = typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail);
                  if (errEl) errEl.textContent = msg;
                });
                document.getElementById('opOrderPickCancel').onclick = function () { document.getElementById(modalId).classList.remove('show'); };
                document.getElementById(modalId).onclick = function (e) { if (e.target.id === modalId) document.getElementById(modalId).classList.remove('show'); };
              };
            }
          }
          document.getElementById('opCreateCancel').onclick = function () { loadSectionOperations(false); };
          document.getElementById('opCreateSave').onclick = function () {
            var errEl = document.getElementById('opFormErr');
            var msgEl = document.getElementById('opFormMsg');
            var saveBtn = document.getElementById('opCreateSave');
            if (errEl) errEl.textContent = '';
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            var payload = {};
            fieldsToShow.forEach(function (fieldName) {
              if (hiddenFields.indexOf(fieldName) >= 0) return;
              var field = fieldMap[fieldName];
              if (!field) return;
              var el = document.getElementById(field.id);
              if (!el) return;
              var val = el.value;
              if (val && val.trim() !== '') {
                if (fieldName === 'customer_id' || fieldName === 'order_id' || fieldName === 'quantity') {
                  var num = parseInt(val, 10);
                  if (!isNaN(num)) payload[fieldName] = num;
                } else if (fieldName === 'amount') {
                  var num = parseFloat(val);
                  if (!isNaN(num)) payload[fieldName] = num;
                } else {
                  payload[fieldName] = val.trim();
                }
              }
            });
            if (config.operation_type === 'payment_receipt_from_customer' && (config.required_fields || []).indexOf('order_id') >= 0) {
              var ordIdVal = document.getElementById('opCreateOrderId') ? document.getElementById('opCreateOrderId').value : '';
              if (!ordIdVal || ordIdVal.trim() === '') {
                if (errEl) errEl.textContent = 'Выберите заказ клиента.';
                return;
              }
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';
            function doneSuccess(result) {
              if (msgEl) { msgEl.textContent = 'Операция создана: ' + (result.operation_number || 'OK'); msgEl.style.display = 'block'; }
              setTimeout(function () { loadSectionOperations(false); }, 2000);
            }
            function doneError(e) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Сохранить операцию';
              var detail = e && e.data && e.data.detail;
              if (typeof detail === 'string') { if (errEl) errEl.textContent = detail; return; }
              if (detail && detail.errors) {
                var errs = [];
                for (var k in detail.errors) errs.push(k + ': ' + detail.errors[k]);
                if (errEl) errEl.textContent = errs.join('; ');
              } else if (errEl) errEl.textContent = 'Ошибка сохранения';
            }
            api('/api/v1/operations/' + encodeURIComponent(config.operation_type) + '/create', { method: 'POST', body: JSON.stringify(payload) }).then(doneSuccess).catch(doneError);
          };
        }
        function openOperationCreate() {
          var content = document.getElementById('content');
          if (!content) return;
          // Показываем UI сразу — только тип операции
          content.innerHTML = '<div class="card"><h2>Создание операции</h2><div id="opFormErr" class="err" style="margin-bottom:12px"></div><div class="form-group"><label>Тип операции <span style="color:#c00">*</span></label><select id="opSelectType" required><option value="">— Загрузка...</option></select></div><div id="opFormContainer"></div></div>';
          // Загружаем типы операций сразу (быстро, мало данных)
          api('/api/v1/operation-types').catch(function () { return []; }).then(function (types) {
            var typeOpts = '<option value="">— Выберите тип операции —</option>';
            (types || []).forEach(function (ty) {
              if (ty.active !== true || ty.has_config !== true) return;
              typeOpts += '<option value="' + escAttr(ty.code) + '">' + escAttr(ty.name || ty.code) + '</option>';
            });
            var sel = document.getElementById('opSelectType');
            if (sel) sel.innerHTML = typeOpts;
          });
          // Фоновая загрузка остальных данных (клиенты, товары, склады и т.д.)
          var formDataPromise = Promise.all([
            api('/api/v1/customers?limit=500').catch(function () { return []; }),
            api('/api/v1/dictionary/products').catch(function () { return []; }),
            api('/api/v1/dictionary/warehouses').catch(function () { return []; }),
            api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
            api('/api/v1/dictionary/user-logins').catch(function () { return []; })
          ]).then(function (results) {
            return { customers: results[0] || [], products: results[1] || [], warehouses: results[2] || [], paymentTypes: results[3] || [], userList: results[4] || [] };
          });
          document.getElementById('opSelectType').onchange = function () {
            var typeCode = this.value;
            if (!typeCode) { document.getElementById('opFormContainer').innerHTML = ''; return; }
            document.getElementById('opFormContainer').innerHTML = '<p>Загрузка формы...</p>';
            Promise.all([
              api('/api/v1/operations/' + encodeURIComponent(typeCode) + '/form-config'),
              formDataPromise
            ]).then(function (results) {
              var config = results[0];
              var fd = results[1];
              buildFormFromConfig(config, fd.customers, fd.products, fd.warehouses, fd.paymentTypes, fd.userList);
            }).catch(function (e) {
              var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка';
              document.getElementById('opFormContainer').innerHTML = '<p class="err">Ошибка загрузки: ' + escAttr(msg) + '</p>';
            });
          };
        }
        // Делаем функцию доступной из глобальной области для showSection
        window.openOperationCreate = openOperationCreate;

        function bindOperationAdd() {
          var btn = document.getElementById('opAdd');
          if (!btn) return;
          btn.onclick = openOperationCreate;
        }
      }

      function loadSectionStock() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Остатки по складу</h2><p><label>Склад </label><select id="stock_wh"><option value="">—</option></select> <button type="button" class="btn btn-primary" id="stockLoad">Показать</button> <button type="button" class="btn btn-secondary" id="stockExport">Выгрузить в Excel</button></p><div id="sectionTable" style="margin-top:12px"></div></div>';
        api('/api/v1/dictionary/warehouses').then(function (list) {
          var sel = document.getElementById('stock_wh');
          if (sel && list) list.forEach(function (w) { var o = document.createElement('option'); o.value = w.code; o.textContent = w.name + ' (' + w.code + ')'; sel.appendChild(o); });
        });
        var stockSortCol = 'product_code';
        var stockSortDir = 1;
        var lastStockData = null;
        function renderStockTable(data) {
          lastStockData = data;
          var tableDiv = document.getElementById('sectionTable');
          if (!data.length) { tableDiv.innerHTML = '<p>Нет остатков.</p>'; return; }
          var sorted = data.slice().sort(function (a, b) {
            return tableSortCompare(a, b, stockSortCol, stockSortDir, function (r, c) {
              if (c === 'total_qty' || c === 'unit_price' || c === 'total_cost' || c === 'days_until_expiry') return (r[c] != null && r[c] !== '' ? String(Number(r[c])).padStart(20, '0') : '');
              if (c === 'expiry_date') return (r.expiry_date || '').toString();
              return (r[c] || r.warehouse_name || r.warehouse_code || r.product_name || '').toString().toLowerCase();
            });
          });
          var arrow = stockSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (stockSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr>' + th('warehouse_code', 'Склад') + th('product_code', 'Товар (код)') + th('product_name', 'Название товара') + th('batch_code', 'Партия (код)') + th('total_qty', 'Остаток') + th('unit_price', 'Цена за 1 шт') + th('total_cost', 'Сумма') + th('expiry_date', 'Срок годности') + th('days_until_expiry', 'Дней осталось') + '</tr></thead><tbody>';
          var totalQty = 0;
          var totalCost = 0;
          sorted.forEach(function (r) {
            var expiryDate = r.expiry_date ? formatDateOnly(r.expiry_date) : '—';
            var days = r.days_until_expiry;
            var status = r.expiry_status || {};
            var color = status.color || null;
            var icon = status.icon || '';
            var badgeColor = '#28a745';
            if (color === 'YELLOW') badgeColor = '#ffc107';
            else if (color === 'RED') badgeColor = '#dc3545';
            else if (color === 'BLACK') badgeColor = '#343a40';
            var daysText = '';
            if (days == null) {
              daysText = '—';
            } else if (days <= 0) {
              daysText = (icon || '⚫') + ' Просрочен (дней: ' + days + ')';
            } else {
              daysText = (icon || '🟢') + ' ' + days + ' дн.';
            }
            var badgeHtml = daysText === '—'
              ? '—'
              : '<span class="badge" style="background-color:' + badgeColor + ';color:#fff;border-radius:4px;padding:4px 8px;font-size:12px;">' + escAttr(daysText) + '</span>';
            var price = (r.unit_price != null ? Number(r.unit_price) : 0);
            var cost = (r.total_cost != null ? Number(r.total_cost) : 0);
            var priceText = price ? price.toFixed(2) : '—';
            var costText = cost ? cost.toFixed(2) : '—';
            var qty = (r.total_qty != null ? r.total_qty : 0);
            totalQty += qty;
            totalCost += cost;
            t += '<tr><td>' + escAttr(r.warehouse_name || r.warehouse_code || '') + '</td><td>' + escAttr(r.product_code || '') + '</td><td>' + escAttr(r.product_name || '') + '</td><td>' + escAttr(r.batch_code || '—') + '</td><td style="text-align:right;font-weight:600">' + qty + '</td><td style="text-align:right;">' + priceText + '</td><td style="text-align:right;font-weight:600">' + costText + '</td><td>' + expiryDate + '</td><td style="text-align:center;">' + badgeHtml + '</td></tr>';
          });
          // строка ИТОГО
          t += '<tr style="background:#f8f9fa;font-weight:600"><td colspan="4" style="text-align:right;padding:8px">Итого:</td><td style="text-align:right;padding:8px">' + totalQty + '</td><td></td><td style="text-align:right;padding:8px">' + (totalCost ? totalCost.toFixed(2) : '0') + '</td><td></td><td></td></tr>';
          t += '</tbody></table></div>';
          tableDiv.innerHTML = t;
          tableDiv.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (stockSortCol === col) stockSortDir = -stockSortDir; else { stockSortCol = col; stockSortDir = 1; } renderStockTable(lastStockData); };
          });
        }
        document.getElementById('stockLoad').onclick = function () {
          var code = document.getElementById('stock_wh').value;
          var tableDiv = document.getElementById('sectionTable');
          tableDiv.innerHTML = '<p>Загрузка...</p>';
          var url = '/api/v1/warehouse/stock';
          if (code) url += '?warehouse=' + encodeURIComponent(code);
          api(url).then(function (response) {
            var data = (response && response.success && Array.isArray(response.data)) ? response.data : (Array.isArray(response) ? response : []);
            if (!data.length) { tableDiv.innerHTML = '<p>Нет остатков' + (code ? ' на выбранном складе' : '') + '.</p>'; return; }
            renderStockTable(data);
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.data && e.data.error) ? e.data.error : (e && e.message) || 'Ошибка загрузки';
            tableDiv.innerHTML = '<p class="err">Ошибка загрузки: ' + escAttr(msg) + '</p>';
          });
        };
        document.getElementById('stockExport').onclick = function () {
          var code = document.getElementById('stock_wh').value;
          var url = '/api/v1/warehouse/stock/export';
          if (code) url += '?warehouse=' + encodeURIComponent(code);
          fetch(url, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
          }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'warehouse_stock.xlsx'; a.click(); URL.revokeObjectURL(a.href);
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : (e && e.message) || 'Ошибка выгрузки';
            alert(msg);
          });
        };
      }

      function loadSectionCashPending() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Ожидающие передачи от экспедиторов</h2><p style="color:#666;font-size:13px;margin-bottom:16px">Передачи наличных (cash_handover_from_expeditor) со статусом pending. Выберите передачу и нажмите «Принять» для создания операции cash_receipt.</p><div id="cashPendingList"><p>Загрузка...</p></div></div>';
        var div = document.getElementById('cashPendingList');
        var cpSortCol = 'operation_number';
        var cpSortDir = 1;
        var lastCpData = null;
        function renderCashPendingTable(data) {
          lastCpData = data;
          if (!div) return;
          if (!data.length) {
            div.innerHTML = '<p style="color:#666">Нет ожидающих передач.</p>';
            return;
          }
          var sorted = data.slice().sort(function (a, b) {
            return tableSortCompare(a, b, cpSortCol, cpSortDir, function (r, c) {
              if (c === 'amount') return (r.amount != null ? String(Number(r.amount)).padStart(20, '0') : '');
              return (r[c] || (r.expeditor_login || r.expeditor_fio) || (r.customer_name || (r.customer_id != null ? 'ID ' + r.customer_id : '')) || '').toString().toLowerCase();
            });
          });
          var arrow = cpSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (cpSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr>' + th('operation_number', '№ операции') + th('expeditor_login', 'Экспедитор') + th('order_id', 'Заказ №') + th('customer_name', 'Клиент') + th('amount', 'Сумма') + th('operation_date', 'Дата') + '<th>Действие</th></tr></thead><tbody>';
          sorted.forEach(function (h) {
            var amt = (h.amount != null) ? Number(h.amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '—';
            var dt = h.operation_date ? formatDateOnly(h.operation_date) : '—';
            var exp = (h.expeditor_fio || h.expeditor_login || '') ? ((h.expeditor_login || '') + (h.expeditor_fio ? ' — ' + h.expeditor_fio : '')) : '—';
            var orderNo = h.order_id != null ? h.order_id : '—';
            var custName = h.customer_name || (h.customer_id != null ? 'ID ' + h.customer_id : '—');
            t += '<tr><td>' + escAttr(h.operation_number || '') + '</td><td>' + escAttr(exp) + '</td><td>' + escAttr(orderNo) + '</td><td>' + escAttr(custName) + '</td><td style="text-align:right;font-weight:600">' + amt + '</td><td>' + dt + '</td><td><button type="button" class="btn btn-primary btn-small" data-accept-handover data-id="' + escAttr(h.id || '') + '" data-amount="' + escAttr(h.amount || '') + '" data-expeditor="' + escAttr(h.expeditor_login || '') + '">Принять</button></td></tr>';
          });
          t += '</tbody></table></div>';
          div.innerHTML = t;
          div.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (cpSortCol === col) cpSortDir = -cpSortDir; else { cpSortCol = col; cpSortDir = 1; } renderCashPendingTable(lastCpData); };
          });
          div.querySelectorAll('[data-accept-handover]').forEach(function (btn) {
            btn.onclick = function () {
                var id = btn.getAttribute('data-id');
                var amount = btn.getAttribute('data-amount');
                var expeditor = btn.getAttribute('data-expeditor');
                if (!id) return;
                var formHtml = '<div class="form-group"><label>Сумма (от передачи) <span style="color:#c00">*</span></label><input type="number" id="cr_amount" step="0.01" value="' + escAttr(amount || '') + '" required></div>';
                formHtml += '<div class="form-group"><label>Тип оплаты <span style="color:#c00">*</span></label><select id="cr_payment_type"><option value="cash_sum">Наличные</option></select></div>';
                formHtml += '<div class="form-group"><label>Кассир <span style="color:#c00">*</span></label><select id="cr_cashier"></select></div>';
                formHtml += '<div class="form-group"><label>Комментарий</label><input type="text" id="cr_comment" placeholder="необяз."></div>';
                showModal('Приём наличных в кассу', formHtml, function (errEl) { return Promise.resolve(); });
                api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
                  var sel = document.getElementById('cr_cashier');
                  if (sel) {
                    userList = userList || [];
                    var me = (currentUser && currentUser.login) ? currentUser.login : '';
                    userList.forEach(function (u) {
                      var o = document.createElement('option'); o.value = u.login; o.textContent = (u.login || '') + (u.fio ? ' — ' + u.fio : ''); sel.appendChild(o);
                      if (u.login === me) sel.value = me;
                    });
                  }
                });
                api('/api/v1/dictionary/payment-types').catch(function () { return []; }).then(function (pts) {
                  var sel = document.getElementById('cr_payment_type');
                  if (sel && pts && pts.length) {
                    sel.innerHTML = '';
                    pts.forEach(function (pt) {
                      var o = document.createElement('option'); o.value = pt.code; o.textContent = pt.name || pt.code;
                      sel.appendChild(o);
                      if (pt.code === 'cash_sum') sel.value = 'cash_sum';
                    });
                  }
                });
                var submitBtn = document.createElement('button');
                submitBtn.type = 'button';
                submitBtn.className = 'btn btn-primary';
                submitBtn.textContent = 'Принять наличные';
                document.getElementById('modalContainer').querySelector('.modal-actions').appendChild(submitBtn);
                submitBtn.onclick = function () {
                  var errEl = document.querySelector('#modalContainer .modal.show .err');
                  var amountVal = document.getElementById('cr_amount').value;
                  var payType = document.getElementById('cr_payment_type').value;
                  var cashier = document.getElementById('cr_cashier').value;
                  var comment = document.getElementById('cr_comment').value.trim() || null;
                  if (!amountVal || parseFloat(amountVal) <= 0) { if (errEl) errEl.textContent = 'Укажите сумму.'; return; }
                  if (!cashier) { if (errEl) errEl.textContent = 'Укажите кассира.'; return; }
                  api('/api/v1/finances/accept-handover', { method: 'POST', body: JSON.stringify({ handover_operation_id: id, cashier_login: cashier, amount: parseFloat(amountVal), comment: comment || null }) }).then(function () {
                    var m = document.querySelector('#modalContainer .modal.show'); if (m) m.classList.remove('show');
                    loadPending();
                  }).catch(function (e) {
                    var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка сохранения';
                    var modalErr = document.querySelector('#modalContainer .modal.show .err');
                    if (modalErr) modalErr.textContent = msg;
                  });
                };
              };
            });
          }
        function loadPending() {
          api('/api/v1/finances/pending-handovers').then(function (res) {
            var data = (res && res.success && res.data) ? res.data : [];
            renderCashPendingTable(data);
          }).catch(function (e) {
            if (div) div.innerHTML = '<p class="err">Ошибка загрузки</p>';
          });
        }
        loadPending();
      }

      function loadSectionCashReceived() {
        var content = document.getElementById('content');
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
        content.innerHTML = '<div class="card"><h2>Принятые деньги за период</h2><p><label>Дата с </label><input type="text" id="cashDateFrom" placeholder="дд.мм.гггг" style="max-width:130px"> <label>по </label><input type="text" id="cashDateTo" placeholder="дд.мм.гггг" style="max-width:130px"> <button type="button" class="btn btn-primary" id="cashLoadReceived">Показать</button> <button type="button" class="btn btn-secondary" id="cashExportExcel">Выгрузить в Excel</button> <button type="button" class="btn btn-secondary" id="cashCreateManual">Создать операцию приёма платежа (от клиента)</button></p><div id="cashReceivedList" style="margin-top:12px"><p>Загрузка...</p></div></div>';
        var dateFromEl = document.getElementById('cashDateFrom');
        var dateToEl = document.getElementById('cashDateTo');
        if (dateFromEl) {
          dateFromEl.value = todayStr;
          if (window.flatpickr) window.flatpickr(dateFromEl, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        if (dateToEl) {
          dateToEl.value = todayStr;
          if (window.flatpickr) window.flatpickr(dateToEl, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        var crSortCol = 'operation_number';
        var crSortDir = 1;
        var lastCrData = null;
        var lastCrTotal = 0;
        function renderCashReceivedTable(data, total) {
          lastCrData = data;
          lastCrTotal = total || 0;
          var div = document.getElementById('cashReceivedList');
          if (!div || !data.length) {
            if (div) div.innerHTML = '<p style="color:#666">Нет принятых денег за выбранный период.</p>';
            return;
          }
          var sorted = data.slice().sort(function (a, b) {
            return tableSortCompare(a, b, crSortCol, crSortDir, function (r, c) {
              if (c === 'amount') return (r.amount != null ? String(Number(r.amount)).padStart(20, '0') : '');
              return (r[c] || '').toString().toLowerCase();
            });
          });
          var arrow = crSortDir > 0 ? ' ▲' : ' ▼';
          var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (crSortCol === col ? arrow : '') + '</th>'; };
          var t = '<div style="overflow-x:auto"><table><thead><tr>' + th('operation_number', '№ операции') + th('amount', 'Сумма') + th('payment_type_code', 'Тип оплаты') + th('cashier_login', 'Кассир') + '<th>Источник</th>' + th('operation_date', 'Дата') + '</tr></thead><tbody>';
          sorted.forEach(function (r) {
              var amt = (r.amount != null) ? Number(r.amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '—';
              var dt = r.operation_date ? formatDateOnly(r.operation_date) : '—';
              var source = r.expeditor_login ? ('от экспедитора ' + r.expeditor_login) : (r.customer_id != null ? 'от клиента (ID ' + r.customer_id + ')' : 'от клиента');
              t += '<tr><td>' + escAttr(r.operation_number || '') + '</td><td style="text-align:right;font-weight:600">' + amt + '</td><td>' + escAttr(r.payment_type_code || '') + '</td><td>' + escAttr(r.cashier_login || '') + '</td><td>' + escAttr(source) + '</td><td>' + dt + '</td></tr>';
            });
          t += '</tbody></table></div><p style="margin-top:12px;font-weight:600">Итого за период: ' + lastCrTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' сум</p>';
          div.innerHTML = t;
          div.querySelectorAll('th.sortable').forEach(function (thEl) {
            thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (crSortCol === col) crSortDir = -crSortDir; else { crSortCol = col; crSortDir = 1; } renderCashReceivedTable(lastCrData, lastCrTotal); };
          });
        }
        function dateToApiFormat(val) {
          if (!val || !(val = (val + '').trim())) return '';
          if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
          var m = val.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
          if (m) return m[3] + '-' + m[2].padStart(2, '0') + '-' + m[1].padStart(2, '0');
          return val;
        }
        function loadReceived() {
          var div = document.getElementById('cashReceivedList');
          var dateFromVal = dateToApiFormat(document.getElementById('cashDateFrom') ? document.getElementById('cashDateFrom').value : '');
          var dateToVal = dateToApiFormat(document.getElementById('cashDateTo') ? document.getElementById('cashDateTo').value : '');
          if (!div) return;
          var params = [];
          if (dateFromVal) params.push('date_from=' + encodeURIComponent(dateFromVal));
          if (dateToVal) params.push('date_to=' + encodeURIComponent(dateToVal));
          var url = '/api/v1/finances/cash-received' + (params.length ? '?' + params.join('&') : '');
          api(url).then(function (res) {
            var data = (res && res.data) ? res.data : [];
            var total = (res && res.total_amount != null) ? Number(res.total_amount) : 0;
            renderCashReceivedTable(data, total);
          }).catch(function (e) {
            div.innerHTML = '<p class="err">Ошибка загрузки</p>';
          });
        }
        document.getElementById('cashLoadReceived').onclick = loadReceived;
        loadReceived();
        document.getElementById('cashExportExcel').onclick = function () {
          var params = [];
          var df = document.getElementById('cashDateFrom'); var dt = document.getElementById('cashDateTo');
          var dfVal = dateToApiFormat(df ? df.value : ''); var dtVal = dateToApiFormat(dt ? dt.value : '');
          if (dfVal) params.push('date_from=' + encodeURIComponent(dfVal));
          if (dtVal) params.push('date_to=' + encodeURIComponent(dtVal));
          var url = window.location.origin + '/api/v1/finances/cash-received/export' + (params.length ? '?' + params.join('&') : '');
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) { var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cash_received.xlsx'; a.click(); URL.revokeObjectURL(a.href); }).catch(function (e) { alert('Ошибка: ' + (e && e.data && e.data.detail ? e.data.detail : 'Ошибка выгрузки')); });
        };
        document.getElementById('cashCreateManual').onclick = function () {
          var formHtml = '<div class="form-group"><label>Сумма <span style="color:#c00">*</span></label><input type="number" id="crm_amount" step="0.01" required></div>';
          formHtml += '<div class="form-group"><label>Тип оплаты <span style="color:#c00">*</span></label><select id="crm_payment_type"><option value="bank_sum">Банковский перевод</option></select></div>';
          formHtml += '<div class="form-group"><label>Кассир <span style="color:#c00">*</span></label><select id="crm_cashier"></select></div>';
          formHtml += '<div class="form-group"><label>Клиент (ID)</label><input type="number" id="crm_customer_id" placeholder="необяз."></div>';
          formHtml += '<div class="form-group"><label>Заказ №</label><input type="number" id="crm_order_id" placeholder="необяз."></div>';
          formHtml += '<div class="form-group"><label>Комментарий</label><input type="text" id="crm_comment" placeholder="необяз."></div>';
          showModal('Создать операцию приёма платежа (от клиента)', formHtml, function (errEl) {
            var amountVal = document.getElementById('crm_amount').value;
            var payType = document.getElementById('crm_payment_type').value;
            var cashier = document.getElementById('crm_cashier').value;
            var custId = document.getElementById('crm_customer_id').value;
            var orderId = document.getElementById('crm_order_id').value;
            var comment = document.getElementById('crm_comment').value.trim() || null;
            if (!amountVal || parseFloat(amountVal) <= 0) { if (errEl) errEl.textContent = 'Укажите сумму.'; return Promise.reject(); }
            if (!payType) { if (errEl) errEl.textContent = 'Укажите тип оплаты.'; return Promise.reject(); }
            if (!cashier) { if (errEl) errEl.textContent = 'Укажите кассира.'; return Promise.reject(); }
            var payload = { amount: parseFloat(amountVal), payment_type_code: payType, cashier_login: cashier, comment: comment };
            if (custId && !isNaN(parseInt(custId, 10))) payload.customer_id = parseInt(custId, 10);
            if (orderId && !isNaN(parseInt(orderId, 10))) payload.order_id = parseInt(orderId, 10);
            return api('/api/v1/finances/cash-receipt-manual', { method: 'POST', body: JSON.stringify(payload) }).then(function () { loadReceived(); });
          });
          api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
            var sel = document.getElementById('crm_cashier');
            if (sel) {
              userList = userList || [];
              var me = (currentUser && currentUser.login) ? currentUser.login : '';
              userList.forEach(function (u) {
                var o = document.createElement('option'); o.value = u.login; o.textContent = (u.login || '') + (u.fio ? ' — ' + u.fio : ''); sel.appendChild(o);
                if (u.login === me) sel.value = me;
              });
            }
          });
          api('/api/v1/dictionary/payment-types').catch(function () { return []; }).then(function (pts) {
            var sel = document.getElementById('crm_payment_type');
            if (sel && pts && pts.length) {
              sel.innerHTML = '';
              pts.forEach(function (pt) {
                var o = document.createElement('option'); o.value = pt.code; o.textContent = pt.name || pt.code;
                sel.appendChild(o);
                if (pt.code === 'bank_sum') sel.value = 'bank_sum';
              });
            }
          });
        };
        loadReceived();
      }

      function loadSectionCashierOrders() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Заказы для подтверждения оплаты</h2><p style="color:#666;margin-bottom:12px">Заказы с указанным типом оплаты. Подтвердите приём денег по каждому заказу.</p><div style="margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:flex-end;gap:8px 16px"><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Тип оплаты</label><select id="cof_payment_type" style="max-width:180px"><option value="">— Все —</option></select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label><select id="cof_status" style="max-width:160px"><option value="">— Все —</option></select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Оплата подтверждена</label><select id="cof_payment_confirmed" style="max-width:160px"><option value="">Все</option><option value="true">Подтверждено</option><option value="false">Не подтверждено</option></select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки с</label><input type="text" id="cof_date_from" placeholder="дд.мм.гггг" style="max-width:130px"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата поставки по</label><input type="text" id="cof_date_to" placeholder="дд.мм.гггг" style="max-width:130px"></div><button type="button" class="btn btn-primary" id="cof_apply">Показать</button> <button type="button" class="btn btn-secondary" id="cashierOrdersExport">Выгрузить в Excel</button></div><div id="cashierOrdersList" style="margin-top:12px"><p>Загрузка...</p></div></div>';
        var div = document.getElementById('cashierOrdersList');
        if (window.flatpickr) {
          var cofDf = document.getElementById('cof_date_from');
          var cofDt = document.getElementById('cof_date_to');
          if (cofDf) window.flatpickr(cofDf, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          if (cofDt) window.flatpickr(cofDt, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        function renderCashierOrdersTable(data) {
          if (!div) return;
          if (!data || !data.length) {
            div.innerHTML = '<p style="color:#666">Нет заказов с типом оплаты.</p>';
            return;
          }
          var t = '<div style="overflow-x:auto"><table><thead><tr><th>№ заказа</th><th>Клиент</th><th>ИНН</th><th>Р/С</th><th>Агент</th><th>Экспедитор</th><th>Сумма</th><th>Тип оплаты</th><th>Статус</th><th>Дата поставки заказа</th><th>Оплата подтверждена</th><th>Действия</th></tr></thead><tbody>';
          data.forEach(function (r) {
            var amt = (r.total_amount != null) ? Number(r.total_amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '—';
            var payConfirmed = r.payment_confirmed ? '<span class="status-badge status-badge--completed">Подтверждено</span>' : '<span class="status-badge status-badge--pending">Не подтверждено</span>';
            var confirmBtn = r.payment_confirmed ? '' : '<button type="button" class="btn btn-primary btn-small" data-order-no="' + escAttr(r.order_no) + '" data-customer-id="' + (r.customer_id || '') + '" data-amount="' + (r.total_amount != null ? r.total_amount : '') + '" data-payment-type="' + escAttr(r.payment_type_code || '') + '">Подтвердить оплату</button>';
            var deliveryDate = '—';
            if (r.scheduled_delivery_at) {
              try {
                var d = new Date(r.scheduled_delivery_at);
                deliveryDate = d.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
              } catch (e) { deliveryDate = r.scheduled_delivery_at; }
            }
            t += '<tr><td>' + escAttr(r.order_no || '') + '</td><td>' + escAttr(r.customer_name || '—') + '</td><td>' + escAttr(r.tax_id || '—') + '</td><td>' + escAttr(r.account_no || '—') + '</td><td>' + escAttr(r.agent_name || r.login_agent || '—') + '</td><td>' + escAttr(r.expeditor_name || r.login_expeditor || '—') + '</td><td style="text-align:right;font-weight:600">' + amt + '</td><td>' + escAttr(r.payment_type_name || r.payment_type_code || '') + '</td><td>' + escAttr(r.status_name || r.status_code || '') + '</td><td>' + deliveryDate + '</td><td>' + payConfirmed + '</td><td>' + confirmBtn + '</td></tr>';
          });
          t += '</tbody></table></div>';
          div.innerHTML = t;
          div.querySelectorAll('button[data-order-no]').forEach(function (btn) {
            btn.onclick = function () {
              var orderNo = parseInt(btn.getAttribute('data-order-no'), 10);
              var customerId = btn.getAttribute('data-customer-id');
              var amount = btn.getAttribute('data-amount');
              var paymentType = btn.getAttribute('data-payment-type');
              openCashierConfirmModal(orderNo, customerId ? parseInt(customerId, 10) : null, amount ? parseFloat(amount) : null, paymentType, function () { loadCashierOrders(); });
            };
          });
        }
        document.getElementById('cashierOrdersExport').onclick = function () {
          var pt = document.getElementById('cof_payment_type') && document.getElementById('cof_payment_type').value;
          var st = document.getElementById('cof_status') && document.getElementById('cof_status').value;
          var pc = document.getElementById('cof_payment_confirmed') && document.getElementById('cof_payment_confirmed').value;
          var df = document.getElementById('cof_date_from') && document.getElementById('cof_date_from').value;
          var dt = document.getElementById('cof_date_to') && document.getElementById('cof_date_to').value;
          var params = [];
          if (pt) params.push('payment_type_code=' + encodeURIComponent(pt));
          if (st) params.push('status_code=' + encodeURIComponent(st));
          if (pc) params.push('payment_confirmed=' + encodeURIComponent(pc));
          if (df) params.push('scheduled_delivery_from=' + encodeURIComponent(dateToApiFormatCof(df)));
          if (dt) params.push('scheduled_delivery_to=' + encodeURIComponent(dateToApiFormatCof(dt)));
          var url = window.location.origin + '/api/v1/finances/orders-for-confirmation/export' + (params.length ? '?' + params.join('&') : '');
          fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
            return r.blob();
          }).then(function (blob) { var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'orders_for_confirmation.xlsx'; a.click(); URL.revokeObjectURL(a.href); }).catch(function (e) { alert('Ошибка: ' + (e && e.data && e.data.detail ? e.data.detail : 'Ошибка выгрузки')); });
        };
        function dateToApiFormatCof(val) {
          if (!val || !(val + '').trim()) return '';
          var v = (val + '').trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
          var m = v.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
          if (m) return m[3] + '-' + m[2].padStart(2, '0') + '-' + m[1].padStart(2, '0');
          return v;
        }
        function loadCashierOrders() {
          var pt = document.getElementById('cof_payment_type') && document.getElementById('cof_payment_type').value;
          var st = document.getElementById('cof_status') && document.getElementById('cof_status').value;
          var pc = document.getElementById('cof_payment_confirmed') && document.getElementById('cof_payment_confirmed').value;
          var df = document.getElementById('cof_date_from') && document.getElementById('cof_date_from').value;
          var dt = document.getElementById('cof_date_to') && document.getElementById('cof_date_to').value;
          var params = [];
          if (pt) params.push('payment_type_code=' + encodeURIComponent(pt));
          if (st) params.push('status_code=' + encodeURIComponent(st));
          if (pc) params.push('payment_confirmed=' + encodeURIComponent(pc));
          if (df) params.push('scheduled_delivery_from=' + encodeURIComponent(dateToApiFormatCof(df)));
          if (dt) params.push('scheduled_delivery_to=' + encodeURIComponent(dateToApiFormatCof(dt)));
          var url = '/api/v1/finances/orders-for-confirmation' + (params.length ? '?' + params.join('&') : '');
          api(url).then(function (res) {
            if (res && res.success === false && res.error) {
              if (div) div.innerHTML = '<p class="err">Ошибка: ' + escAttr(res.error) + '</p>';
              return;
            }
            var data = (res && res.data) ? res.data : [];
            renderCashierOrdersTable(data);
          }).catch(function (e) {
            var msg = 'Ошибка загрузки';
            if (e && e.data) {
              if (typeof e.data.detail === 'string') msg = e.data.detail;
              else if (e.data.detail) msg = JSON.stringify(e.data.detail);
            }
            if (e && e.status === 404) msg = 'API не найден (404). Перезапустите сервер и обновите страницу.';
            if (div) div.innerHTML = '<p class="err">' + escAttr(msg) + '</p>';
          });
        }
        document.getElementById('cof_apply').onclick = loadCashierOrders;
        Promise.all([
          api('/api/v1/dictionary/payment-types').catch(function () { return []; }),
          api('/api/v1/orders/statuses').catch(function () { return []; })
        ]).then(function (results) {
          var pts = results[0] || [];
          var sts = results[1] || [];
          var ptSel = document.getElementById('cof_payment_type');
          var stSel = document.getElementById('cof_status');
          if (ptSel) {
            ptSel.innerHTML = '<option value="">— Все —</option>';
            pts.forEach(function (p) { var o = document.createElement('option'); o.value = p.code; o.textContent = p.name || p.code; ptSel.appendChild(o); });
          }
          if (stSel) {
            stSel.innerHTML = '<option value="">— Все —</option>';
            sts.forEach(function (s) { var o = document.createElement('option'); o.value = s.code; o.textContent = s.name || s.code; stSel.appendChild(o); });
          }
          loadCashierOrders();
        });
      }

      function openCashierConfirmModal(orderNo, customerId, amount, paymentType, onSuccess) {
        var formHtml = '<div class="form-group"><label>Заказ №</label><div class="form-readonly">' + escAttr(orderNo) + '</div></div>';
        formHtml += '<div class="form-group"><label>Сумма <span style="color:#c00">*</span></label><input type="number" id="ccm_amount" step="0.01" value="' + (amount != null && !isNaN(amount) ? amount : '') + '" required></div>';
        formHtml += '<div class="form-group"><label>Тип оплаты <span style="color:#c00">*</span></label><select id="ccm_payment_type"></select></div>';
        formHtml += '<div class="form-group"><label>Кассир <span style="color:#c00">*</span></label><select id="ccm_cashier"></select></div>';
        formHtml += '<div class="form-group"><label>Клиент (ID)</label><input type="number" id="ccm_customer_id" value="' + (customerId != null && !isNaN(customerId) ? customerId : '') + '" readonly class="from-order"></div>';
        formHtml += '<div class="form-group"><label>Комментарий</label><input type="text" id="ccm_comment" placeholder="необяз."></div>';
        showModal('Подтвердить приём денег по заказу №' + orderNo, formHtml, function (errEl) {
          var amountVal = document.getElementById('ccm_amount').value;
          var payType = document.getElementById('ccm_payment_type').value;
          var cashier = document.getElementById('ccm_cashier').value;
          var comment = document.getElementById('ccm_comment').value.trim() || null;
          if (!amountVal || parseFloat(amountVal) <= 0) { if (errEl) errEl.textContent = 'Укажите сумму.'; return Promise.reject(); }
          if (!payType) { if (errEl) errEl.textContent = 'Укажите тип оплаты.'; return Promise.reject(); }
          if (!cashier) { if (errEl) errEl.textContent = 'Укажите кассира.'; return Promise.reject(); }
          var payload = { amount: parseFloat(amountVal), payment_type_code: payType, cashier_login: cashier, order_id: orderNo, comment: comment };
          if (customerId != null && !isNaN(customerId)) payload.customer_id = customerId;
          return api('/api/v1/finances/cash-receipt-manual', { method: 'POST', body: JSON.stringify(payload) }).then(function () { if (onSuccess) onSuccess(); });
        });
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          var sel = document.getElementById('ccm_cashier');
          if (sel && userList && userList.length) {
            sel.innerHTML = '';
            var me = (currentUser && currentUser.login) ? currentUser.login : '';
            userList.forEach(function (u) {
              var o = document.createElement('option'); o.value = u.login; o.textContent = (u.login || '') + (u.fio ? ' — ' + u.fio : ''); sel.appendChild(o);
              if (u.login === me) sel.value = me;
            });
          }
        });
        api('/api/v1/dictionary/payment-types').catch(function () { return []; }).then(function (pts) {
          var sel = document.getElementById('ccm_payment_type');
          if (sel && pts && pts.length) {
            sel.innerHTML = '';
            pts.forEach(function (pt) {
              var o = document.createElement('option'); o.value = pt.code; o.textContent = pt.name || pt.code;
              sel.appendChild(o);
            });
            sel.value = pts.some(function (p) { return p.code === 'bank_sum'; }) ? 'bank_sum' : (pts[0] ? pts[0].code : '');
          }
        });
      }

      function loadSectionVisitsSearch() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Поиск визита</h2><div class="form-group" style="margin:12px 0"><label>Поиск</label></div><div id="vsSearchRow" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-bottom:12px"></div><p><strong>Результаты</strong> (<span id="vs_total">0</span>):</p><div id="vs_table"></div></div>';
        var searchRow = document.getElementById('vsSearchRow');
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          userList = userList || [];
          var respOpts = '<option value="">Все сотрудники</option>';
          userList.forEach(function (u) { respOpts += '<option value="' + escAttr(u.login) + '">' + escAttr((u.login || '') + (u.fio ? ' — ' + u.fio : '')) + '</option>'; });
          var statusOptions = [
            { code: 'planned', label: 'Запланирован' },
            { code: 'postponed', label: 'На рассмотрении' },
            { code: 'completed', label: 'Завершён' },
            { code: 'cancelled', label: 'Отменён' }
          ];
          var statusHtml = '<div class="multiselect-status" id="vs_status_container"><div class="multiselect-trigger" id="vs_status_trigger"><div class="multiselect-tags" id="vs_status_tags"></div><button type="button" class="multiselect-clear" id="vs_status_clear" title="Очистить">×</button><span class="multiselect-arrow">▼</span></div><div class="multiselect-dropdown" id="vs_status_dropdown">';
          statusOptions.forEach(function (o) {
            statusHtml += '<label><input type="checkbox" value="' + escAttr(o.code) + '" id="vs_status_' + o.code + '"> ' + escAttr(o.label) + '</label>';
          });
          statusHtml += '</div></div>';
          searchRow.innerHTML = '<div style="display:flex;flex-wrap:wrap;align-items:flex-end;gap:6px"><label style="font-size:11px;color:#666;display:block;margin-bottom:2px;width:100%">Клиент</label><input type="text" id="vs_customer_search" placeholder="Название или ИНН" style="max-width:120px" title="Введите мин. 2 символа"><select id="vs_customer_pick" style="max-width:200px"><option value="">— Все клиенты —</option></select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Статус</label>' + statusHtml + '</div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Ответственный</label><select id="vs_responsible" style="max-width:160px">' + respOpts + '</select></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">Дата от</label><input type="text" id="vs_from" style="max-width:130px" placeholder="дд.мм.гггг"></div><div><label style="font-size:11px;color:#666;display:block;margin-bottom:2px">по</label><input type="text" id="vs_to" style="max-width:130px" placeholder="дд.мм.гггг"></div><button type="button" class="btn btn-primary" id="vs_find">Найти</button> <button type="button" class="btn btn-secondary" id="vs_reset">Сбросить</button> <button type="button" class="btn btn-secondary" id="vs_export">Выгрузить в Excel</button>';
          ['planned', 'postponed'].forEach(function (c) { var cb = document.getElementById('vs_status_' + c); if (cb) cb.checked = true; });
          ['completed', 'cancelled'].forEach(function (c) { var cb = document.getElementById('vs_status_' + c); if (cb) cb.checked = false; });
          function renderVsStatusTags() {
            var tagsEl = document.getElementById('vs_status_tags');
            if (!tagsEl) return;
            var selected = [];
            statusOptions.forEach(function (o) {
              var cb = document.getElementById('vs_status_' + o.code);
              if (cb && cb.checked) selected.push(o);
            });
            if (selected.length === 0) {
              tagsEl.innerHTML = '<span class="multiselect-placeholder">Выберите статусы</span>';
              return;
            }
            var html = '';
            var showCount = 1;
            selected.slice(0, showCount).forEach(function (o) {
              html += '<span class="multiselect-tag" data-code="' + escAttr(o.code) + '">' + escAttr(o.label) + ' <span class="multiselect-tag-remove">×</span></span>';
            });
            if (selected.length > showCount) {
              html += '<span class="multiselect-plus">+' + (selected.length - showCount) + '</span>';
            }
            tagsEl.innerHTML = html;
            tagsEl.querySelectorAll('.multiselect-tag-remove').forEach(function (btn) {
              btn.onclick = function (e) {
                e.stopPropagation();
                var code = btn.closest('.multiselect-tag').getAttribute('data-code');
                var cb = document.getElementById('vs_status_' + code);
                if (cb) cb.checked = false;
                renderVsStatusTags();
              };
            });
          }
          renderVsStatusTags();
          var vsContainer = document.getElementById('vs_status_container');
          var vsTrigger = document.getElementById('vs_status_trigger');
          var vsDropdown = document.getElementById('vs_status_dropdown');
          var vsClear = document.getElementById('vs_status_clear');
          if (vsTrigger) vsTrigger.onclick = function (e) {
            if (e.target.closest('.multiselect-clear') || e.target.closest('.multiselect-tag-remove')) return;
            vsContainer.classList.toggle('open');
          };
          vsContainer.querySelectorAll('.multiselect-dropdown input[type="checkbox"]').forEach(function (cb) {
            cb.onclick = function (e) { e.stopPropagation(); renderVsStatusTags(); };
          });
          vsDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
          if (vsClear) vsClear.onclick = function (e) {
            e.stopPropagation();
            statusOptions.forEach(function (o) {
              var cb = document.getElementById('vs_status_' + o.code);
              if (cb) cb.checked = false;
            });
            renderVsStatusTags();
          };
          document.addEventListener('click', function closeVsStatus(e) {
            if (vsContainer && !vsContainer.contains(e.target)) vsContainer.classList.remove('open');
          });
          if (window.flatpickr) {
            var df = document.getElementById('vs_from');
            var dt = document.getElementById('vs_to');
            if (df) window.flatpickr(df, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
            if (dt) window.flatpickr(dt, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          }
          var vsFindBtn = document.getElementById('vs_find');
          var vsResetBtn = document.getElementById('vs_reset');
          if (vsFindBtn) vsFindBtn.onclick = runSearch;
          if (vsResetBtn) vsResetBtn.onclick = function () {
            document.getElementById('vs_customer_search').value = '';
            document.getElementById('vs_customer_pick').innerHTML = '<option value="">— Все клиенты —</option>';
            ['planned', 'postponed'].forEach(function (code) {
              var cb = document.getElementById('vs_status_' + code);
              if (cb) cb.checked = true;
            });
            ['completed', 'cancelled'].forEach(function (code) {
              var cb = document.getElementById('vs_status_' + code);
              if (cb) cb.checked = false;
            });
            renderVsStatusTags();
            document.getElementById('vs_responsible').value = '';
            document.getElementById('vs_from').value = '';
            document.getElementById('vs_to').value = '';
            document.getElementById('vs_table').innerHTML = '';
            document.getElementById('vs_total').textContent = '0';
          };
          var vsExportBtn = document.getElementById('vs_export');
          if (vsExportBtn) vsExportBtn.onclick = function () {
            var params = [];
            var customer_id = document.getElementById('vs_customer_pick') && document.getElementById('vs_customer_pick').value;
            var customer_name = document.getElementById('vs_customer_search') && document.getElementById('vs_customer_search').value.trim();
            var statuses = [];
            ['planned', 'postponed', 'completed', 'cancelled'].forEach(function (code) {
              var cb = document.getElementById('vs_status_' + code);
              if (cb && cb.checked) statuses.push(code);
            });
            var status = statuses.length ? statuses.join(',') : '';
            var responsible = document.getElementById('vs_responsible') && document.getElementById('vs_responsible').value;
            var from = document.getElementById('vs_from') && document.getElementById('vs_from').value;
            var to = document.getElementById('vs_to') && document.getElementById('vs_to').value;
            if (customer_id) params.push('customer_id=' + encodeURIComponent(customer_id));
            else if (customer_name) params.push('customer_name=' + encodeURIComponent(customer_name));
            if (status) params.push('status=' + encodeURIComponent(status));
            if (responsible) params.push('responsible_login=' + encodeURIComponent(responsible));
            if (from) params.push('from_date=' + encodeURIComponent(from));
            if (to) params.push('to_date=' + encodeURIComponent(to));
            var url = window.location.origin + '/api/v1/visits/export' + (params.length ? '?' + params.join('&') : '');
            fetch(url, { headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) return r.json().then(function (d) { throw { data: d }; }).catch(function (e) { if (e.data) throw e; throw { data: { detail: r.statusText } }; });
              return r.blob();
            }).then(function (blob) { var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'visits.xlsx'; a.click(); URL.revokeObjectURL(a.href); }).catch(function (e) { alert('Ошибка: ' + (e && e.data && e.data.detail ? e.data.detail : 'Ошибка выгрузки')); });
          };
          var vsSearch = document.getElementById('vs_customer_search');
          var vsPick = document.getElementById('vs_customer_pick');
          if (vsSearch && vsPick) {
            var lookupTimer = null;
            var runLookup = function (q) {
              q = (q || '').trim();
              if (q.length < 2) return;
              api('/api/v1/customers?search=' + encodeURIComponent(q) + '&limit=20').then(function (list) {
                list = list || [];
                vsPick.innerHTML = '<option value="">— Все клиенты —</option>';
                list.forEach(function (c) {
                  var name = (c.name_client || c.firm_name || '').trim() || ('Клиент #' + c.id);
                  var label = '○ ' + name + (c.tax_id ? ' (ИНН ' + c.tax_id + ')' : '');
                  var o = document.createElement('option');
                  o.value = c.id;
                  o.textContent = label;
                  vsPick.appendChild(o);
                });
                if (list.length === 1) vsPick.value = list[0].id;
              }).catch(function () { /* ignore */ });
            };
            vsSearch.oninput = function () {
              var q = vsSearch.value || '';
              if (lookupTimer) clearTimeout(lookupTimer);
              if (q.trim().length < 2) return;
              lookupTimer = setTimeout(function () { runLookup(q); }, 300);
            };
          }
          runSearch();
        });
        function openVisitCardModal(visitId, refreshCallback) {
          api('/api/v1/visits/' + visitId).then(function (visit) {
            api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
              userList = userList || [];
              var dateStr = visit.visit_date ? formatDateOnly(visit.visit_date) : '—';
              var timeStr = (visit.visit_time || '').toString().substring(0, 5) || '—';
              var dtCombined = (dateStr + (timeStr && timeStr !== '—' ? ' ' + timeStr : '')).trim() || '—';
              var body = '<div class="form-group"><label>Клиент</label><div>' + escAttr(visit.customer_name || '') + '</div></div><div class="form-group"><label>Дата и время</label><div>' + escAttr(dtCombined) + '</div></div><div class="form-group"><label>Статус</label><div>' + escAttr(visitStatusRu(visit.status)) + '</div></div><div class="form-group"><label>Ответственный</label><div>' + escAttr(visit.responsible_name || visit.responsible_login || '') + '</div></div>' + (visit.comment ? '<div class="form-group"><label>Комментарий</label><div>' + escAttr(visit.comment) + '</div></div>' : '') + '<p style="text-align:center"><button type="button" class="btn btn-secondary" id="vcard_edit">Изменить</button></p>';
              showModal('Карточка визита', body, function () { return Promise.resolve(); });
              var saveBtn = document.querySelector('#modalContainer .modal-actions .btn-primary');
              if (saveBtn) saveBtn.textContent = 'Закрыть';
              var editBtn = document.getElementById('vcard_edit');
              if (editBtn) editBtn.onclick = function () {
                document.querySelector('#modalContainer .modal.show') && document.querySelector('#modalContainer .modal.show').classList.remove('show');
                openVisitEditModal(visit.customer_id, visit, userList, refreshCallback || function () {});
              };
            });
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка';
            alert(msg);
          });
        }
        var vsSortCol = 'visit_date';
        var vsSortDir = 1;
        var lastVsData = null;
        function renderVisitsTable(data) {
          if (!data || !data.length) { document.getElementById('vs_table').innerHTML = '<p>Нет визитов.</p>'; return; }
          var sorted = data.slice().sort(function (a, b) { return tableSortCompare(a, b, vsSortCol, vsSortDir); });
          var arrow = vsSortDir > 0 ? ' ▲' : ' ▼';
          var thf = function (c, lbl) { return '<th class="sortable" data-col="' + c + '" style="cursor:pointer">' + lbl + (vsSortCol === c ? arrow : '') + '</th>'; };
          var tb = '<div style="overflow-x:auto"><table><thead><tr>' + thf('visit_date', 'Дата и время') + thf('customer_name', 'Клиент') + thf('status', 'Статус') + thf('responsible_login', 'Ответственный') + '<th>Действия</th></tr></thead><tbody>';
          sorted.forEach(function (v) {
            var sc = 'status-badge--default';
            if (v.status === 'completed') sc = 'status-badge--completed';
            else if (v.status === 'cancelled') sc = 'status-badge--cancelled';
            else if (v.status === 'planned') sc = 'status-badge--delivery';
            var ds = v.visit_date ? formatDateOnly(v.visit_date) : '—';
            var ts = (v.visit_time || '').toString().substring(0, 5) || '';
            var dtCombined = (ds + (ts && ts !== '—' ? ' ' + ts : '')).trim();
            var sru = visitStatusRu(v.status);
            tb += '<tr><td>' + escAttr(dtCombined) + '</td><td>' + escAttr(v.customer_name || '') + '</td><td><span class="status-badge ' + sc + '">' + escAttr(sru) + '</span></td><td>' + escAttr(v.responsible_name || v.responsible_login || '') + '</td><td><button type="button" class="btn btn-secondary btn-small" data-visit-id="' + (v.id || '') + '">Открыть</button></td></tr>';
          });
          tb += '</tbody></table></div>';
          document.getElementById('vs_table').innerHTML = tb;
          document.getElementById('vs_table').querySelectorAll('th.sortable').forEach(function (t) {
            t.onclick = function () { var col = t.getAttribute('data-col'); if (vsSortCol === col) vsSortDir = -vsSortDir; else { vsSortCol = col; vsSortDir = 1; } renderVisitsTable(lastVsData); };
          });
          document.getElementById('vs_table').querySelectorAll('[data-visit-id]').forEach(function (b) {
            b.onclick = function () { openVisitCardModal(b.getAttribute('data-visit-id'), runSearch); };
          });
        }
        function runSearch() {
          var params = ['limit=50', 'offset=0'];
          var customer_id = document.getElementById('vs_customer_pick') && document.getElementById('vs_customer_pick').value;
          var customer_name = document.getElementById('vs_customer_search') && document.getElementById('vs_customer_search').value.trim();
          var statuses = [];
          ['planned', 'postponed', 'completed', 'cancelled'].forEach(function (code) {
            var cb = document.getElementById('vs_status_' + code);
            if (cb && cb.checked) statuses.push(code);
          });
          var status = statuses.length ? statuses.join(',') : '';
          var responsible = document.getElementById('vs_responsible') && document.getElementById('vs_responsible').value;
          var from = document.getElementById('vs_from') && document.getElementById('vs_from').value;
          var to = document.getElementById('vs_to') && document.getElementById('vs_to').value;
          if (customer_id) params.push('customer_id=' + encodeURIComponent(customer_id));
          else if (customer_name) params.push('customer_name=' + encodeURIComponent(customer_name));
          if (status) params.push('status=' + encodeURIComponent(status));
          if (responsible) params.push('responsible_login=' + encodeURIComponent(responsible));
          if (from) params.push('from_date=' + encodeURIComponent(from));
          if (to) params.push('to_date=' + encodeURIComponent(to));
          document.getElementById('vs_table').innerHTML = '<p>Загрузка...</p>';
          api('/api/v1/visits/search?' + params.join('&')).then(function (res) {
            var total = (res && res.total != null) ? res.total : 0;
            var data = (res && res.data) ? res.data : [];
            lastVsData = data;
            document.getElementById('vs_total').textContent = total;
            if (!data.length) { document.getElementById('vs_table').innerHTML = '<p>Нет визитов.</p>'; return; }
            renderVisitsTable(data);
          }).catch(function (e) {
            var msg = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка';
            document.getElementById('vs_table').innerHTML = '<p class="err">' + escAttr(msg) + '</p>';
          });
        }
      }

      function openVisitAddModal(customerId, userList, refreshVisits) {
        var respOpts = '<option value="">— Не назначен —</option>';
        (userList || []).forEach(function (u) { respOpts += '<option value="' + escAttr(u.login) + '">' + escAttr((u.fio || u.login) + '') + '</option>'; });
        var formHtml = '<div class="form-group"><label>Дата визита *</label><input type="text" id="v_date" placeholder="Выберите дату" readonly style="cursor:pointer;background:#fff"></div><div class="form-group"><label>Время</label><input type="time" id="v_time"></div><div class="form-group"><label>Статус</label><select id="v_status"><option value="planned">Запланирован</option><option value="completed">Завершён</option><option value="cancelled">Отменён</option><option value="postponed">На рассмотрении</option></select></div><div class="form-group"><label>Ответственный</label><select id="v_resp">' + respOpts + '</select></div><div class="form-group"><label>Комментарий</label><textarea id="v_comment" rows="3" maxlength="5000" placeholder="При статусе «Завершён» укажите, что было сделано (мин. 10 символов)"></textarea><p id="v_comment_cnt" style="font-size:12px;color:#666">0 / 5000</p></div>';
        showModal('Добавить визит', formHtml, function (errEl) {
          var d = document.getElementById('v_date') && document.getElementById('v_date').value;
          var t = document.getElementById('v_time') && document.getElementById('v_time').value;
          var s = document.getElementById('v_status') && document.getElementById('v_status').value;
          var r = document.getElementById('v_resp') && document.getElementById('v_resp').value;
          var c = (document.getElementById('v_comment') && document.getElementById('v_comment').value.trim()) || null;
          if (!d) { if (errEl) errEl.textContent = 'Укажите дату визита.'; return; }
          if (s === 'completed' && (!c || c.length < 10)) { if (errEl) errEl.textContent = 'При статусе «Завершён» укажите, что было сделано на визите (минимум 10 символов).'; return; }
          if (s === 'completed' && c.length > 5000) { if (errEl) errEl.textContent = 'Комментарий не более 5000 символов.'; return; }
          var body = { visit_date: d, status: s, responsible_login: r || null, comment: c };
          if (t) body.visit_time = t + (t.length === 5 ? ':00' : '');
          return api('/api/v1/customers/' + customerId + '/visits', { method: 'POST', body: JSON.stringify(body) }).then(refreshVisits);
        });
        setTimeout(function () {
          var vDate = document.getElementById('v_date');
          if (vDate && window.flatpickr) window.flatpickr(vDate, { locale: 'ru', dateFormat: 'Y-m-d' });
          var vResp = document.getElementById('v_resp');
          if (vResp && currentUser && currentUser.login) vResp.value = currentUser.login;
          var vComment = document.getElementById('v_comment');
          var vCnt = document.getElementById('v_comment_cnt');
          if (vComment && vCnt) { vComment.oninput = function () { vCnt.textContent = vComment.value.length + ' / 5000'; }; vCnt.textContent = vComment.value.length + ' / 5000'; }
        }, 100);
      }

      function openVisitEditModal(customerId, visit, userList, refreshVisits) {
        if (visit.status === 'cancelled') {
          showModal('Визит отменён', '<p>Отменённый визит нельзя редактировать. Создайте новый визит при необходимости.</p>', function () { return Promise.resolve(); });
          return;
        }
        var respOpts = '';
        (userList || []).forEach(function (u) { respOpts += '<option value="' + escAttr(u.login) + '">' + escAttr((u.fio || u.login) + '') + '</option>'; });
        var locked = visit.status === 'completed';
        var dateReadonly = locked ? ' readonly style="cursor:not-allowed;background:#f0f0f0"' : ' readonly style="cursor:pointer;background:#fff"';
        var visitDT = (visit.visit_date || '').toString() + ((visit.visit_time && visit.visit_time !== '—') ? ' ' + (visit.visit_time + '').substring(0, 5) : '');
        var formHtml = '<div class="form-group"><label>Дата и время визита</label><input type="text" id="ve_datetime" value="' + escAttr(visitDT.trim()) + '"' + dateReadonly + ' placeholder="дд.мм.гггг чч:мм"></div><div class="form-group"><label>Статус</label><select id="ve_status"' + (locked ? '' : '') + '><option value="planned"' + (visit.status === 'planned' ? ' selected' : '') + '>Запланирован</option><option value="completed"' + (visit.status === 'completed' ? ' selected' : '') + '>Завершён</option><option value="cancelled"' + (visit.status === 'cancelled' ? ' selected' : '') + '>Отменён</option><option value="postponed"' + (visit.status === 'postponed' ? ' selected' : '') + '>На рассмотрении</option></select></div><div class="form-group"><label>Ответственный</label><select id="ve_resp"' + (locked ? ' disabled' : '') + '>' + respOpts + '</select></div><div class="form-group"><label>Комментарий</label><textarea id="ve_comment" rows="3" maxlength="5000" style="width:100%">' + escAttr(visit.comment || '') + '</textarea><p id="ve_comment_cnt" style="font-size:12px;color:#666">' + (visit.comment ? visit.comment.length : 0) + ' / 5000</p></div>';
        showModal('Изменить визит', formHtml, function (errEl) {
          var dtVal = (document.getElementById('ve_datetime') && document.getElementById('ve_datetime').value) || '';
          var s = document.getElementById('ve_status') && document.getElementById('ve_status').value;
          var r = document.getElementById('ve_resp');
          var rVal = r ? (r.disabled ? visit.responsible_login : r.value) : visit.responsible_login;
          var c = (document.getElementById('ve_comment') && document.getElementById('ve_comment').value.trim()) || null;
          if (!dtVal) { if (errEl) errEl.textContent = 'Укажите дату и время.'; return; }
          if (s === 'completed' && (!c || c.length < 10)) { if (errEl) errEl.textContent = 'При статусе «Завершён» укажите, что было сделано (минимум 10 символов).'; return; }
          if (s === 'completed' && c.length > 5000) { if (errEl) errEl.textContent = 'Комментарий не более 5000 символов.'; return; }
          var parts = dtVal.split(/[T ]/);
          var d = parts[0] || '';
          var t = parts[1] ? parts[1].substring(0, 5) : null;
          var body = { status: s, comment: c };
          if (!locked) { body.visit_date = d; body.responsible_login = rVal || null; if (t) body.visit_time = t + ':00'; else body.visit_time = null; }
          return api('/api/v1/visits/' + visit.id, { method: 'PUT', body: JSON.stringify(body) }).then(refreshVisits);
        });
        setTimeout(function () {
          var veDatetime = document.getElementById('ve_datetime');
          if (veDatetime && window.flatpickr && !locked) window.flatpickr(veDatetime, { locale: 'ru', dateFormat: 'Y-m-d H:i', altInput: true, altFormat: 'd.m.Y H:i', enableTime: true, time_24hr: true, allowInput: false });
          var veResp = document.getElementById('ve_resp');
          if (veResp && visit.responsible_login) veResp.value = visit.responsible_login;
          var veComment = document.getElementById('ve_comment');
          var veCnt = document.getElementById('ve_comment_cnt');
          if (veComment && veCnt) veComment.oninput = function () { veCnt.textContent = veComment.value.length + ' / 5000'; };
        }, 100);
      }

      function loadSectionVisitsCreate() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Создать визит</h2><div id="vc_err" class="err"></div><div class="form-group"><label>Клиент *</label><input type="hidden" id="vc_customer"><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><button type="button" class="btn btn-secondary btn-small" id="vc_customer_pick">Выбрать клиента</button><input type="text" id="vc_customer_display" readonly placeholder="Не выбран" style="flex:1;min-width:260px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px"></div></div><div class="form-group"><label>Дата и время визита *</label><input type="text" id="vc_datetime" readonly placeholder="дд.мм.гггг чч:мм" style="max-width:280px;cursor:pointer;background:#fff"></div><div class="form-group"><label>Агент (ответственный) *</label><div id="vc_agent_badge" style="font-size:13px;margin-bottom:4px;color:#065f46;"></div><select id="vc_responsible"><option value="">—</option></select></div><div class="form-group"><label>Статус *</label><select id="vc_status"><option value="planned" selected>Запланирован</option><option value="completed">Завершён</option><option value="cancelled">Отменён</option><option value="postponed">На рассмотрении</option></select></div><div class="form-group"><label>Комментарий</label><textarea id="vc_comment" rows="3" maxlength="5000" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px" placeholder="При статусе «Завершён» обязательно укажите, что было сделано (мин. 10 символов)"></textarea><p id="vc_comment_counter" style="font-size:12px;color:#666;margin:4px 0 0 0">0 / 5000</p><p id="vc_comment_hint" class="err" style="display:none;margin-top:4px">При статусе «Завершён» комментарий обязателен (минимум 10 символов). Укажите, что было сделано на визите.</p></div><p style="text-align:center"><button type="button" class="btn btn-primary" id="vc_save">Сохранить</button> <button type="button" class="btn btn-secondary" id="vc_cancel">Отмена</button></p></div>';
        Promise.all([api('/api/v1/dictionary/user-logins').catch(function () { return []; })]).then(function (arr) {
          var userList = arr[0] || [];
          var respSel = document.getElementById('vc_responsible');
          var vcAgentBadge = document.getElementById('vc_agent_badge');
          var agents = (userList || []).filter(function (u) {
            var r = (u.role || '').toLowerCase();
            return r === 'agent';
          });
          if (respSel) {
            agents.forEach(function (u) {
              var o = document.createElement('option');
              o.value = u.login;
              var label = (u.login || '') + (u.fio ? ' — ' + u.fio : '');
              if (currentUser && u.login === currentUser.login) label += ' (Текущий)';
              o.textContent = label;
              respSel.appendChild(o);
            });
            if (currentUser && currentUser.login) {
              respSel.value = currentUser.login;
            }
          }
          function updateAgentBadge() {
            if (!respSel || !vcAgentBadge) return;
            var login = respSel.value;
            if (!login) { vcAgentBadge.textContent = ''; return; }
            var u = agents.find(function (a) { return a.login === login; });
            var text = '✓ ' + (u ? (u.login + (u.fio ? ' — ' + u.fio : '')) : login);
            if (currentUser && login === currentUser.login) text += ' (Текущий пользователь)';
            vcAgentBadge.textContent = text;
          }
          if (respSel) respSel.onchange = updateAgentBadge;
          updateAgentBadge();
          var vcDatetimeEl = document.getElementById('vc_datetime');
          if (vcDatetimeEl && window.flatpickr) {
            window.flatpickr(vcDatetimeEl, {
              enableTime: true,
              time_24hr: true,
              locale: 'ru',
              dateFormat: 'Y-m-d H:i',
              altInput: true,
              altFormat: 'd.m.Y H:i',
              defaultDate: new Date(),
              allowInput: false,
              firstDayOfWeek: 1
            });
          }
          var vcCustomerId = document.getElementById('vc_customer');
          var vcCustomerDisplay = document.getElementById('vc_customer_display');
          var pickBtn = document.getElementById('vc_customer_pick');
          var openCustomerPicker = function () {
            var agentOptions = '<option value=\"\">— Все агенты —</option>';
            agents.forEach(function (u) {
              var label = (u.login || '') + (u.fio ? ' — ' + u.fio : '');
              var sel = (currentUser && u.login === currentUser.login) ? ' selected' : '';
              agentOptions += '<option value=\"' + escAttr(u.login || '') + '\"' + sel + '>' + escAttr(label) + '</option>';
            });
            var bodyHtml = '<div class=\"form-group\"><label>Поиск по клиенту / ИНН</label><input type=\"text\" id=\"vp_search\" placeholder=\"Название или ИНН (мин. 2 символа)\"></div><div class=\"form-group\"><label>Агент</label><select id=\"vp_agent\">' + agentOptions + '</select></div><p><button type=\"button\" class=\"btn btn-primary btn-small\" id=\"vp_find\">Найти</button></p><div id=\"vp_results\"><p>Введите не менее 2 символов для поиска.</p></div>';
            showModal('Выбрать клиента', bodyHtml, function (errEl) {
              var checked = document.querySelector('input[name=\"vp_cust_id\"]:checked');
              if (!checked) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
              var id = checked.value;
              var name = checked.getAttribute('data-name') || ('Клиент #' + id);
              if (vcCustomerId) vcCustomerId.value = id;
              if (vcCustomerDisplay) vcCustomerDisplay.value = name;
              return Promise.resolve();
            });
            setTimeout(function () {
              var searchEl = document.getElementById('vp_search');
              var agentEl = document.getElementById('vp_agent');
              var resultsEl = document.getElementById('vp_results');
              var findBtn = document.getElementById('vp_find');
              var runSearch = function () {
                if (!resultsEl) return;
                var q = (searchEl && searchEl.value || '').trim();
                var agent = agentEl && agentEl.value;
                if (!q && !agent) {
                  resultsEl.innerHTML = '<p>Укажите хотя бы 2 символа в поиске или выберите агента.</p>';
                  return;
                }
                if (q && q.length < 2) {
                  resultsEl.innerHTML = '<p>Введите не менее 2 символов.</p>';
                  return;
                }
                var params = ['limit=50'];
                if (q) params.push('search=' + encodeURIComponent(q));
                if (agent) params.push('login_agent=' + encodeURIComponent(agent));
                resultsEl.innerHTML = '<p>Загрузка...</p>';
                api('/api/v1/customers?' + params.join('&')).then(function (list) {
                  list = list || [];
                  if (!list.length) { resultsEl.innerHTML = '<p>Клиенты не найдены.</p>'; return; }
                  var t = '<div style=\"max-height:380px;overflow:auto\"><table><thead><tr><th></th><th>Клиент</th><th>ИНН</th><th>Агент</th></tr></thead><tbody>';
                  list.forEach(function (c) {
                    var id = c.id;
                    var name = (c.name_client || c.firm_name || '').trim() || ('Клиент #' + id);
                    var tax = c.tax_id || '';
                    t += '<tr><td><input type=\"radio\" name=\"vp_cust_id\" value=\"' + id + '\" data-name=\"' + escAttr(name + (tax ? ' (ИНН ' + tax + ')' : '')) + '\"></td><td>' + escAttr(name) + '</td><td>' + escAttr(tax) + '</td><td>' + escAttr(c.login_agent || '') + '</td></tr>';
                  });
                  t += '</tbody></table></div>';
                  resultsEl.innerHTML = t;
                }).catch(function () {
                  resultsEl.innerHTML = '<p class=\"err\">Ошибка поиска клиентов.</p>';
                });
              };
              if (findBtn) findBtn.onclick = runSearch;
              if (searchEl) searchEl.onkeydown = function (e) { if (e.key === 'Enter') { e.preventDefault(); runSearch(); } };
              runSearch();
            }, 50);
          };
          if (pickBtn) pickBtn.onclick = openCustomerPicker;
          var vcComment = document.getElementById('vc_comment');
          var vcCounter = document.getElementById('vc_comment_counter');
          var vcHint = document.getElementById('vc_comment_hint');
          function updateCommentUI() {
            var len = (vcComment && vcComment.value) ? vcComment.value.length : 0;
            if (vcCounter) vcCounter.textContent = len + ' / 5000';
            var statusEl = document.getElementById('vc_status');
            var needComment = statusEl && statusEl.value === 'completed';
            if (vcHint) vcHint.style.display = (needComment && len < 10) ? 'block' : 'none';
          }
          if (vcComment) { vcComment.oninput = updateCommentUI; vcComment.onchange = updateCommentUI; }
          var vcStatusEl = document.getElementById('vc_status');
          if (vcStatusEl) vcStatusEl.onchange = updateCommentUI;
          updateCommentUI();
          document.getElementById('vc_cancel').onclick = function () { showSection('visits_search'); };
          document.getElementById('vc_save').onclick = function () {
            var errEl = document.getElementById('vc_err');
            if (errEl) errEl.textContent = '';
            var customerId = document.getElementById('vc_customer').value;
            var datetimeVal = (document.getElementById('vc_datetime') && document.getElementById('vc_datetime').value) || '';
            var responsible = document.getElementById('vc_responsible').value;
            var status = (document.getElementById('vc_status') && document.getElementById('vc_status').value) || 'planned';
            var comment = document.getElementById('vc_comment').value.trim() || null;
            if (!customerId) { if (errEl) errEl.textContent = 'Выберите клиента.'; return; }
            if (!datetimeVal) { if (errEl) errEl.textContent = 'Укажите дату и время визита.'; return; }
            if (!responsible) { if (errEl) errEl.textContent = 'Выберите агента.'; return; }
            if (!status) { if (errEl) errEl.textContent = 'Выберите статус.'; return; }
            if (status === 'completed') {
              if (!comment || comment.length < 10) { if (errEl) errEl.textContent = 'Комментарий должен быть минимум 10 символов (сейчас: ' + (comment ? comment.length : 0) + ').'; if (vcHint) vcHint.style.display = 'block'; return; }
              if (comment.length > 5000) { if (errEl) errEl.textContent = 'Комментарий не должен превышать 5000 символов.'; return; }
            }
            var parts = datetimeVal.split(/[T ]/);
            var dateVal = parts[0] || '';
            var timeVal = parts[1] ? parts[1].substring(0, 5) : '';
            var body = { visit_date: dateVal, status: status, responsible_login: responsible || null, comment: comment };
            if (timeVal) body.visit_time = timeVal + ':00';
            api('/api/v1/customers/' + customerId + '/visits', { method: 'POST', body: JSON.stringify(body) }).then(function () { showSection('visits_search'); }).catch(function (e) {
              if (errEl) errEl.textContent = (e && e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка сохранения';
            });
          };
        });
      }

      function loadSectionVisitsCalendar() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Календарь визитов</h2><p><button type="button" class="btn btn-secondary" id="vcal_prev">◄ Пред.</button> <span id="vcal_title" style="margin:0 12px;font-weight:600"></span> <button type="button" class="btn btn-secondary" id="vcal_next">След. ►</button> <label style="margin-left:12px">Ответственный:</label> <select id="vcal_responsible" style="margin-left:6px"><option value="">Все визиты</option><option value="__me__">Мои визиты</option></select></p><div id="vcal_header" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:12px;font-weight:600;font-size:12px;text-align:center"><div>ПН</div><div>ВТ</div><div>СР</div><div>ЧТ</div><div>ПТ</div><div>СБ</div><div>ВС</div></div><div id="vcal_grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:4px"></div><p style="margin-top:16px"><strong>По дате: <span id="vcal_sel_date"></span></strong> (<span id="vcal_day_count">0</span> визитов)</p><div id="vcal_day_list"></div></div>';
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          var sel = document.getElementById('vcal_responsible');
          if (sel) {
            userList = userList || [];
            userList.forEach(function (u) { var o = document.createElement('option'); o.value = u.login; o.textContent = (u.login || '') + (u.fio ? ' — ' + u.fio : ''); sel.appendChild(o); });
          }
        });
        var cur = new Date();
        var viewYear = cur.getFullYear();
        var viewMonth = cur.getMonth() + 1;
        function monthName() { return new Date(viewYear, viewMonth - 1, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' }); }
        function load() {
          var respVal = document.getElementById('vcal_responsible') && document.getElementById('vcal_responsible').value;
          var responsible = (respVal === '__me__' && currentUser && currentUser.login) ? currentUser.login : (respVal && respVal !== '__me__' ? respVal : '');
          var url = '/api/v1/visits/calendar?year=' + viewYear + '&month=' + viewMonth;
          if (responsible) url += '&responsible_login=' + encodeURIComponent(responsible);
          document.getElementById('vcal_title').textContent = monthName();
          api(url).then(function (res) {
            var events = (res && res.events) ? res.events : [];
            var daysInMonth = new Date(viewYear, viewMonth, 0).getDate();
            var firstDow = new Date(viewYear, viewMonth - 1, 1).getDay();
            var dow = firstDow === 0 ? 7 : firstDow;
            var html = '';
            for (var i = 1; i < dow; i++) html += '<div style="padding:8px;background:#f0f0f0;border-radius:4px;min-height:40px"></div>';
            var byDate = {};
            events.forEach(function (ev) {
              var d = (ev.date || '').substring(0, 10);
              if (!byDate[d]) byDate[d] = []; byDate[d].push(ev);
            });
            for (var d = 1; d <= daysInMonth; d++) {
              var key = viewYear + '-' + (viewMonth < 10 ? '0' : '') + viewMonth + '-' + (d < 10 ? '0' : '') + d;
              var list = byDate[key] || [];
              var color = list.length ? '#0d9488' : '#f8f9fa';
              html += '<div class="vcal-day" data-date="' + key + '" style="padding:8px;background:' + color + ';color:' + (list.length ? '#fff' : '#333') + ';border-radius:4px;min-height:40px;cursor:pointer">' + d + (list.length ? ' (' + list.length + ')' : '') + '</div>';
            }
            document.getElementById('vcal_grid').innerHTML = html;
            document.querySelectorAll('.vcal-day').forEach(function (el) {
              el.onclick = function () {
                var key = el.getAttribute('data-date');
                document.getElementById('vcal_sel_date').textContent = key;
                var list = byDate[key] || [];
                document.getElementById('vcal_day_count').textContent = list.length;
                if (!list.length) { document.getElementById('vcal_day_list').innerHTML = '<p>Нет визитов.</p>'; return; }
                var t = '<ul style="list-style:none;padding:0;margin:0">';
                list.forEach(function (ev) {
                  var time = (ev.time || '').substring(0, 5) || '—';
                  t += '<li style="padding:8px;border-bottom:1px solid #eee">' + escAttr(time) + ' — ' + escAttr(ev.customer_name || '') + ' (' + escAttr(ev.responsible_login || '') + ')</li>';
                });
                t += '</ul>';
                document.getElementById('vcal_day_list').innerHTML = t;
              };
            });
          }).catch(function (e) {
            document.getElementById('vcal_grid').innerHTML = '<p class="err">Ошибка загрузки</p>';
          });
        }
        document.getElementById('vcal_prev').onclick = function () { viewMonth--; if (viewMonth < 1) { viewMonth = 12; viewYear--; } load(); };
        document.getElementById('vcal_next').onclick = function () { viewMonth++; if (viewMonth > 12) { viewMonth = 1; viewYear++; } load(); };
        document.getElementById('vcal_responsible').onchange = load;
        load();
      }

      function loadSectionReportCustomers() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Отчёт: По клиентам</h2><p><label>Статус </label><select id="rc_status"><option value="all">Все</option><option value="active">Активные</option><option value="inactive">Неактивные</option></select> <label>Агент </label><select id="rc_agent"><option value="">Все</option></select> <label>Дата с </label><input type="text" id="rc_date_from" placeholder="дд.мм.гггг" style="max-width:120px"> <label>по </label><input type="text" id="rc_date_to" placeholder="дд.мм.гггг" style="max-width:120px"> <button type="button" class="btn btn-primary" id="rc_load">Показать</button> <button type="button" class="btn btn-secondary" id="rc_export">Экспорт в Excel</button></p><div id="rc_table"><p style="color:#64748b">Укажите фильтры и нажмите «Показать».</p></div></div>';
        api('/api/v1/dictionary/user-logins').catch(function () { return []; }).then(function (userList) {
          var sel = document.getElementById('rc_agent');
          if (sel) userList.forEach(function (u) { var o = document.createElement('option'); o.value = u.login; o.textContent = (u.login || '') + (u.fio ? ' — ' + u.fio : ''); sel.appendChild(o); });
        });
        var rcDateFrom = document.getElementById('rc_date_from');
        var rcDateTo = document.getElementById('rc_date_to');
        if (window.flatpickr) {
          if (rcDateFrom) window.flatpickr(rcDateFrom, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          if (rcDateTo) window.flatpickr(rcDateTo, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        function run() {
          var params = [];
          var status = document.getElementById('rc_status') && document.getElementById('rc_status').value;
          var agent = document.getElementById('rc_agent') && document.getElementById('rc_agent').value;
          var df = dateToApiFormat((document.getElementById('rc_date_from') && document.getElementById('rc_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('rc_date_to') && document.getElementById('rc_date_to').value) || '');
          if (status && status !== 'all') params.push('status=' + encodeURIComponent(status));
          if (agent) params.push('agent_login=' + encodeURIComponent(agent));
          if (df) params.push('date_from=' + encodeURIComponent(df));
          if (dt) params.push('date_to=' + encodeURIComponent(dt));
          document.getElementById('rc_table').innerHTML = '<p>Загрузка...</p>';
          api('/api/v1/reports/customers?' + params.join('&')).then(function (res) {
            var total = (res && res.total != null) ? res.total : 0;
            var data = (res && res.data) ? res.data : [];
            if (!data.length) { document.getElementById('rc_table').innerHTML = '<p>Нет данных.</p>'; return; }
            var rcSortCol = 'name_client';
            var rcSortDir = 1;
            var lastRcData = data;
            function clientDisplay(r) {
              var n = (r.name_client || '').trim();
              var f = (r.firm_name || '').trim();
              if (f && f !== n) return n + (n ? ' (' + f + ')' : f);
              return n || f || '—';
            }
            function renderRc(data) {
              var sorted = data.slice().sort(function (a, b) {
                return tableSortCompare(a, b, rcSortCol, rcSortDir, function (r, c) {
                  if (c === 'orders_count') return (r[c] != null ? String(Number(r[c])).padStart(10, '0') : '');
                  if (c === 'orders_amount') return (r.orders_amount != null ? String(Number(r.orders_amount)).padStart(20, '0') : '');
                  if (c === 'total_visits' || c === 'completed_visits') return (r[c] != null ? String(Number(r[c])).padStart(10, '0') : '');
                  return (r[c] || '').toString().toLowerCase();
                });
              });
              var arrow = rcSortDir > 0 ? ' ▲' : ' ▼';
              var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (rcSortCol === col ? arrow : '') + '</th>'; };
              var tb = '<div style="overflow-x:auto"><table><thead><tr><th>#</th>' + th('name_client', 'Клиент') + th('agent_fio', 'ФИО Агента') + th('expeditor_fio', 'ФИО Экспедитора') + th('total_visits', 'Кол-во визитов агентом') + th('completed_visits', 'Кол-во завершённых визитов агентом') + th('orders_count', 'Кол-во заказов') + th('orders_amount', 'Сумма заказов') + '</tr></thead><tbody>';
              sorted.forEach(function (r, i) {
                var ordersCount = r.orders_count || 0;
                var ordersAmount = (r.orders_amount != null) ? Number(r.orders_amount) : 0;
                var totalVisits = r.total_visits != null ? r.total_visits : 0;
                var completedVisits = r.completed_visits != null ? r.completed_visits : 0;
                tb += '<tr><td>' + (i + 1) + '</td><td>' + escAttr(clientDisplay(r)) + '</td><td>' + escAttr(r.agent_fio || '') + '</td><td>' + escAttr(r.expeditor_fio || '') + '</td><td>' + totalVisits + '</td><td>' + completedVisits + '</td><td>' + ordersCount + '</td><td>' + (ordersAmount ? ordersAmount.toFixed(2) : '0.00') + '</td></tr>';
              });
              tb += '</tbody></table></div><p><strong>Итого клиентов: ' + total + '</strong></p>';
              document.getElementById('rc_table').innerHTML = tb;
              document.getElementById('rc_table').querySelectorAll('th.sortable').forEach(function (thEl) {
                thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (rcSortCol === col) rcSortDir = -rcSortDir; else { rcSortCol = col; rcSortDir = 1; } renderRc(lastRcData); };
              });
            }
            renderRc(data);
          }).catch(function (e) {
            document.getElementById('rc_table').innerHTML = '<p class="err">Ошибка загрузки</p>';
          });
        }
        document.getElementById('rc_load').onclick = run;
        var exportBtn = document.getElementById('rc_export');
        if (exportBtn) {
          exportBtn.onclick = function () {
            var params = [];
            var status = document.getElementById('rc_status') && document.getElementById('rc_status').value;
            var agent = document.getElementById('rc_agent') && document.getElementById('rc_agent').value;
            var df = dateToApiFormat((document.getElementById('rc_date_from') && document.getElementById('rc_date_from').value) || '');
            var dt = dateToApiFormat((document.getElementById('rc_date_to') && document.getElementById('rc_date_to').value) || '');
            if (status && status !== 'all') params.push('status=' + encodeURIComponent(status));
            if (agent) params.push('agent_login=' + encodeURIComponent(agent));
            if (df) params.push('date_from=' + encodeURIComponent(df));
            if (dt) params.push('date_to=' + encodeURIComponent(dt));
            var url = '/api/v1/reports/customers/export';
            if (params.length) url += '?' + params.join('&');
            fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) throw new Error('Ошибка выгрузки');
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'report_customers.xlsx';
              a.click();
              URL.revokeObjectURL(a.href);
            }).catch(function () { alert('Ошибка выгрузки отчёта.'); });
          };
        }
      }

      function loadSectionReportAgents() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Отчёт: Эффективность агентов</h2><p><label>Дата с </label><input type="text" id="ra_date_from" placeholder="дд.мм.гггг" style="max-width:120px"> <label>по </label><input type="text" id="ra_date_to" placeholder="дд.мм.гггг" style="max-width:120px"> <button type="button" class="btn btn-primary" id="ra_load">Показать</button> <button type="button" class="btn btn-secondary" id="ra_export">Экспорт в Excel</button></p><div id="ra_list"><p style="color:#64748b">Укажите фильтры и нажмите «Показать».</p></div></div>';
        var raDateFrom = document.getElementById('ra_date_from');
        var raDateTo = document.getElementById('ra_date_to');
        if (window.flatpickr) {
          if (raDateFrom) window.flatpickr(raDateFrom, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          if (raDateTo) window.flatpickr(raDateTo, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        function run() {
          var df = dateToApiFormat((document.getElementById('ra_date_from') && document.getElementById('ra_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('ra_date_to') && document.getElementById('ra_date_to').value) || '');
          var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt));
          var url = '/api/v1/reports/agents'; if (params.length) url += '?' + params.join('&');
          document.getElementById('ra_list').innerHTML = '<p>Загрузка...</p>';
          api(url).then(function (res) {
            var data = (res && res.data) ? res.data : [];
            var err = (res && res.error) ? res.error : null;
            if (err) { document.getElementById('ra_list').innerHTML = '<p class="err">Ошибка: ' + escAttr(err) + '</p>'; return; }
            if (!data.length) { document.getElementById('ra_list').innerHTML = '<p>Нет данных за выбранный период.</p>'; return; }
            var tb = '<div style="overflow-x:auto"><table><thead><tr><th>#</th><th>Логин</th><th>ФИО</th><th>Клиентов</th><th>Визитов</th><th>Завершено</th><th>% завершённости визитов</th><th>Сумма заказов</th><th>Кол-во заказов</th><th>% завершённости заказов</th></tr></thead><tbody>';
            data.forEach(function (r, i) {
              var visitRate = (r.visit_completion_rate != null) ? r.visit_completion_rate : 0;
              var orderRate = (r.orders_completion_rate != null) ? r.orders_completion_rate : 0;
              var amt = (r.orders_amount != null) ? Number(r.orders_amount) : 0;
              tb += '<tr><td>' + (i + 1) + '</td><td>' + escAttr(r.login || '') + '</td><td>' + escAttr(r.fio || '') + '</td><td>' + (r.client_count || 0) + '</td><td>' + (r.total_visits || 0) + '</td><td>' + (r.completed_visits || 0) + '</td><td>' + visitRate + '%</td><td>' + (amt ? amt.toFixed(2) : '0.00') + '</td><td>' + (r.orders_count || 0) + '</td><td>' + orderRate + '%</td></tr>';
            });
            tb += '</tbody></table></div><p><strong>Итого агентов: ' + data.length + '</strong></p>';
            document.getElementById('ra_list').innerHTML = tb;
          }).catch(function (e) { document.getElementById('ra_list').innerHTML = '<p class="err">Ошибка загрузки</p>'; });
        }
        document.getElementById('ra_load').onclick = run;
        var raExport = document.getElementById('ra_export');
        if (raExport) {
          raExport.onclick = function () {
            var df = dateToApiFormat((document.getElementById('ra_date_from') && document.getElementById('ra_date_from').value) || '');
            var dt = dateToApiFormat((document.getElementById('ra_date_to') && document.getElementById('ra_date_to').value) || '');
            var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt));
            var url = '/api/v1/reports/agents/export'; if (params.length) url += '?' + params.join('&');
            fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) throw new Error('Ошибка выгрузки');
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'report_agents.xlsx';
              a.click();
              URL.revokeObjectURL(a.href);
            }).catch(function () { alert('Ошибка выгрузки отчёта.'); });
          };
        }
      }

      function loadSectionReportExpeditors() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Отчёт: Эффективность экспедиторов (по заказам)</h2><p><label>Дата с </label><input type="text" id="re_date_from" placeholder="дд.мм.гггг" style="max-width:120px"> <label>по </label><input type="text" id="re_date_to" placeholder="дд.мм.гггг" style="max-width:120px"> <button type="button" class="btn btn-primary" id="re_load">Показать</button> <button type="button" class="btn btn-secondary" id="re_export">Экспорт в Excel</button></p><div id="re_list"><p style="color:#64748b">Укажите фильтры и нажмите «Показать».</p></div></div>';
        var reDateFrom = document.getElementById('re_date_from');
        var reDateTo = document.getElementById('re_date_to');
        if (window.flatpickr) {
          if (reDateFrom) window.flatpickr(reDateFrom, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          if (reDateTo) window.flatpickr(reDateTo, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        function run() {
          var df = dateToApiFormat((document.getElementById('re_date_from') && document.getElementById('re_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('re_date_to') && document.getElementById('re_date_to').value) || '');
          var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt));
          var url = '/api/v1/reports/expeditors'; if (params.length) url += '?' + params.join('&');
          document.getElementById('re_list').innerHTML = '<p>Загрузка...</p>';
          api(url).then(function (res) {
            var data = (res && res.data) ? res.data : [];
            var err = (res && res.error) ? res.error : null;
            if (err) { document.getElementById('re_list').innerHTML = '<p class="err">Ошибка: ' + escAttr(err) + '</p>'; return; }
            if (!data.length) { document.getElementById('re_list').innerHTML = '<p>Нет данных за выбранный период.</p>'; return; }
            var tb = '<div style="overflow-x:auto"><table><thead><tr><th>#</th><th>Логин</th><th>ФИО</th><th>Заказов</th><th>Сумма</th><th>Открыто</th><th>В доставке</th><th>Доставлено</th><th>Отменено</th></tr></thead><tbody>';
            data.forEach(function (r, i) {
              var amt = (r.orders_amount != null) ? Number(r.orders_amount) : 0;
              tb += '<tr><td>' + (i + 1) + '</td><td>' + escAttr(r.login || '') + '</td><td>' + escAttr(r.fio || '') + '</td><td>' + (r.orders_count || 0) + '</td><td>' + (amt ? amt.toFixed(2) : '0.00') + '</td><td>' + (r.orders_open || 0) + '</td><td>' + (r.orders_delivery || 0) + '</td><td>' + (r.orders_completed || 0) + '</td><td>' + (r.orders_cancelled || 0) + '</td></tr>';
            });
            tb += '</tbody></table></div><p><strong>Итого экспедиторов: ' + data.length + '</strong></p>';
            document.getElementById('re_list').innerHTML = tb;
          }).catch(function (e) { document.getElementById('re_list').innerHTML = '<p class="err">Ошибка загрузки</p>'; });
        }
        document.getElementById('re_load').onclick = run;
        var reExport = document.getElementById('re_export');
        if (reExport) {
          reExport.onclick = function () {
            var df = dateToApiFormat((document.getElementById('re_date_from') && document.getElementById('re_date_from').value) || '');
            var dt = dateToApiFormat((document.getElementById('re_date_to') && document.getElementById('re_date_to').value) || '');
            var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt));
            var url = '/api/v1/reports/expeditors/export'; if (params.length) url += '?' + params.join('&');
            fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) throw new Error('Ошибка выгрузки');
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'report_expeditors.xlsx';
              a.click();
              URL.revokeObjectURL(a.href);
            }).catch(function () { alert('Ошибка выгрузки отчёта.'); });
          };
        }
      }

      function loadSectionReportVisits() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Отчёт: Аналитика визитов</h2><p><label>Дата с </label><input type="text" id="rv_from" placeholder="дд.мм.гггг" style="max-width:120px"> <label>по </label><input type="text" id="rv_to" placeholder="дд.мм.гггг" style="max-width:120px"> <button type="button" class="btn btn-primary" id="rv_load">Показать</button> <button type="button" class="btn btn-secondary" id="rv_export">Экспорт в Excel</button></p><div id="rv_summary"><p style="color:#64748b">Укажите фильтры и нажмите «Показать».</p></div><div id="rv_table"></div></div>';
        var rvFrom = document.getElementById('rv_from');
        var rvTo = document.getElementById('rv_to');
        if (window.flatpickr) {
          if (rvFrom) window.flatpickr(rvFrom, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
          if (rvTo) window.flatpickr(rvTo, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true });
        }
        function run() {
          var from = dateToApiFormat((document.getElementById('rv_from') && document.getElementById('rv_from').value) || '');
          var to = dateToApiFormat((document.getElementById('rv_to') && document.getElementById('rv_to').value) || '');
          var params = []; if (from) params.push('from_date=' + encodeURIComponent(from)); if (to) params.push('to_date=' + encodeURIComponent(to));
          var url = '/api/v1/reports/visits'; if (params.length) url += '?' + params.join('&');
          document.getElementById('rv_summary').innerHTML = ''; document.getElementById('rv_table').innerHTML = '<p>Загрузка...</p>';
          api(url).then(function (res) {
            var sum = (res && res.summary) ? res.summary : {};
            document.getElementById('rv_summary').innerHTML = '<p><strong>Всего визитов:</strong> ' + (sum.total_visits || 0) + ', Завершено: ' + (sum.completed || 0) + ' (' + (sum.completion_rate != null ? sum.completion_rate : 0) + '%)</p>';
            var byDate = (res && res.by_date) ? res.by_date : [];
            if (!byDate.length) { document.getElementById('rv_table').innerHTML = '<p>Нет данных по датам.</p>'; return; }
            var rvSortCol = 'date';
            var rvSortDir = 1;
            var lastRvData = byDate;
            function renderRv(data) {
              var sorted = data.slice().sort(function (a, b) {
                return tableSortCompare(a, b, rvSortCol, rvSortDir, function (r, c) {
                  if (c === 'total_visits' || c === 'completed' || c === 'planned' || c === 'cancelled') return (r[c] != null ? String(Number(r[c])).padStart(10, '0') : '');
                  return (r[c] || '').toString();
                });
              });
              var arrow = rvSortDir > 0 ? ' ▲' : ' ▼';
              var th = function (col, lbl) { return '<th class="sortable" data-col="' + col + '" style="cursor:pointer">' + lbl + (rvSortCol === col ? arrow : '') + '</th>'; };
              var t = '<div style="overflow-x:auto"><table><thead><tr>' + th('date', 'Дата') + th('total_visits', 'Всего') + th('completed', 'Завершено') + th('planned', 'Запланировано') + th('cancelled', 'Отменено') + '</tr></thead><tbody>';
              sorted.forEach(function (r) { t += '<tr><td>' + escAttr(r.date || '') + '</td><td>' + (r.total_visits || 0) + '</td><td>' + (r.completed || 0) + '</td><td>' + (r.planned || 0) + '</td><td>' + (r.cancelled || 0) + '</td></tr>'; });
              t += '</tbody></table></div>';
              document.getElementById('rv_table').innerHTML = t;
              document.getElementById('rv_table').querySelectorAll('th.sortable').forEach(function (thEl) {
                thEl.onclick = function () { var col = thEl.getAttribute('data-col'); if (rvSortCol === col) rvSortDir = -rvSortDir; else { rvSortCol = col; rvSortDir = 1; } renderRv(lastRvData); };
              });
            }
            renderRv(byDate);
          }).catch(function (e) { document.getElementById('rv_table').innerHTML = '<p class="err">Ошибка загрузки</p>'; });
        }
        document.getElementById('rv_load').onclick = run;
        var rvExport = document.getElementById('rv_export');
        if (rvExport) {
          rvExport.onclick = function () {
            var from = dateToApiFormat((document.getElementById('rv_from') && document.getElementById('rv_from').value) || '');
            var to = dateToApiFormat((document.getElementById('rv_to') && document.getElementById('rv_to').value) || '');
            var params = []; if (from) params.push('from_date=' + encodeURIComponent(from)); if (to) params.push('to_date=' + encodeURIComponent(to));
            var url = '/api/v1/reports/visits/export'; if (params.length) url += '?' + params.join('&');
            fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) throw new Error('Ошибка выгрузки');
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'report_visits.xlsx';
              a.click();
              URL.revokeObjectURL(a.href);
            }).catch(function () { alert('Ошибка выгрузки отчёта.'); });
          };
        }
      }

      function loadSectionReportDashboard() {
        var content = document.getElementById('content');
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        content.innerHTML = '<div class="card"><h2>Сводная аналитика</h2>' +
          '<div class="dashboard-filters" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:20px">' +
          '<label>Дата поставки заказа с</label><input type="text" id="rd_date_from" placeholder="дд.мм.гггг" style="max-width:110px" title="Дата поставки заказа с">' +
          '<label>Дата поставки заказа по</label><input type="text" id="rd_date_to" placeholder="дд.мм.гггг" style="max-width:110px" title="Дата поставки заказа по">' +
          '<label>Статусы</label><select id="rd_status"><option value="">Открыто, Доставка, Доставлен</option><option value="open">Открыто</option><option value="delivery">Доставка</option><option value="completed">Доставлен</option></select>' +
          '<label>Категория</label><select id="rd_category"><option value="">Все</option></select>' +
          '<button type="button" class="btn btn-primary" id="rd_load">Применить</button>' +
          '</div>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;margin-bottom:20px">' +
          '<div id="rd_summary" class="dashboard-summary" style="padding:24px;background:linear-gradient(135deg,#0d9488 0%,#0f766e 100%);border-radius:12px;color:#fff;min-height:120px"><div style="font-size:14px;opacity:0.9">Загрузка...</div></div>' +
          '<div id="rd_chart_wrap" style="height:200px;min-width:200px"><canvas id="rd_chart"></canvas></div>' +
          '</div>' +
          '<div id="rd_table_wrap"><h3 style="margin:0 0 12px 0">По категориям продуктов</h3>' +
          '<p><button type="button" class="btn btn-secondary btn-small" id="rd_excel">Экспорт в Excel</button></p>' +
          '<div id="rd_table"></div></div>' +
          '<div id="rd_territory_wrap" style="margin-top:24px"><h3 style="margin:0 0 12px 0">По территориям</h3>' +
          '<p><button type="button" class="btn btn-secondary btn-small" id="rd_excel_territory">Экспорт в Excel</button></p>' +
          '<div id="rd_territory_table"></div></div>';
        var rdFrom = document.getElementById('rd_date_from');
        var rdTo = document.getElementById('rd_date_to');
        if (window.flatpickr) {
          if (rdFrom) window.flatpickr(rdFrom, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', defaultDate: todayStr, allowInput: true });
          if (rdTo) window.flatpickr(rdTo, { locale: 'ru', dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', defaultDate: todayStr, allowInput: true });
        }
        var CATEGORY_LABELS = { 'Tvorog': 'Творог', 'Yogurt': 'Йогурт', 'Tara': 'Тара', 'Milk': 'Молоко', 'Kefir': 'Кефир', 'Smetana': 'Сметана', 'Maslo': 'Масло' };
        api('/api/v1/dictionary/products/types').catch(function () { return []; }).then(function (types) {
          var sel = document.getElementById('rd_category');
          if (sel && types && types.length) types.forEach(function (t) { var o = document.createElement('option'); o.value = t.name; o.textContent = CATEGORY_LABELS[t.name] || t.name || t.description || ''; sel.appendChild(o); });
        });
        var rdChart = null;
        function render(res) {
          var err = (res && res.error) ? res.error : null;
          if (err) { document.getElementById('rd_summary').innerHTML = '<p class="err">Ошибка: ' + escAttr(err) + '</p>'; return; }
          var total = (res && res.total_orders_sum) ? Number(res.total_orders_sum) : 0;
          var totalCount = (res && res.total_orders_count) ? Number(res.total_orders_count) : 0;
          var f = (res && res.filters) ? res.filters : {};
          var dateLabel = (f.date_from || f.date_to) ? ('с ' + (f.date_from || '') + ' по ' + (f.date_to || '')) : 'сегодня';
          document.getElementById('rd_summary').innerHTML = '<div style="font-size:16px;opacity:0.95">Всего <strong style="font-size:24px;font-weight:700">' + totalCount + '</strong> заказов ' + dateLabel + '<br/>- на сумму <strong style="font-size:24px;font-weight:700">' + (total ? total.toLocaleString('ru-RU', {minimumFractionDigits:2,maximumFractionDigits:2}) : '0') + '</strong> сум</div>';
          var byCat = (res && res.by_category) ? res.by_category : [];
          try {
            if (window.Chart && document.getElementById('rd_chart')) {
              var ctx = document.getElementById('rd_chart').getContext('2d');
              if (rdChart) rdChart.destroy();
              var labels = byCat.map(function (c) { return c.category; });
              var data = byCat.map(function (c) { return c.share_pct; });
              if (!labels.length) { labels = ['Нет данных']; data = [100]; }
              var colors = ['#60a5fa','#34d399','#fbbf24','#f87171','#a78bfa','#22d3ee'];
              var maxLen = Math.max(data.length, 1);
              var chartOpts = {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: colors.slice(0, maxLen), borderWidth: 0 }] },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { labels: { generateLabels: function(chart) { var ds = chart.data; return (ds.labels || []).map(function(l, i) { return { text: l + ' (' + (ds.datasets[0].data[i] || 0) + '%)', fillStyle: ds.datasets[0].backgroundColor[i] }; }); } } },
                    tooltip: { callbacks: { label: function(ctx) { var pct = ctx.parsed ? ctx.parsed : 0; return (ctx.label || '') + ': ' + pct.toFixed(1) + '%'; } } },
                    datalabels: { formatter: function(v) { return v ? v.toFixed(1) + '%' : ''; }, color: '#fff', font: { size: 13, weight: 'bold' } }
                  }
                }
              };
              if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
              rdChart = new Chart(ctx, chartOpts);
            }
          } catch (chartErr) { if (console && console.warn) console.warn('Chart:', chartErr); }
          var byTerr = (res && res.by_territory) ? res.by_territory : [];
          var terrTb = '<div style="overflow-x:auto"><table style="text-align:center"><thead><tr><th>Город</th><th>Территория</th><th>Количество клиентов</th><th>Количество заказов</th><th>Сумма</th></tr></thead><tbody>';
          byTerr.forEach(function (r) {
            terrTb += '<tr><td>' + escAttr(r.city || '') + '</td><td>' + escAttr(r.territory || '') + '</td><td>' + (r.customers_count || 0) + '</td><td>' + (r.orders_count || 0) + '</td><td>' + (r.orders_sum != null ? Number(r.orders_sum).toLocaleString('ru-RU', {minimumFractionDigits:2}) : '0') + '</td></tr>';
          });
          terrTb += '</tbody></table></div>';
          var rtEl = document.getElementById('rd_territory_table');
          if (rtEl) rtEl.innerHTML = terrTb;
          var tb = '<div style="overflow-x:auto"><table style="text-align:center"><thead><tr><th>Категория</th><th>Доля %</th><th>Сумма</th><th>Объём</th></tr></thead><tbody>';
          var totalSum = 0, totalQty = 0;
          byCat.forEach(function (r) { totalSum += Number(r.sum_amount || 0); totalQty += Number(r.quantity || 0); });
          byCat.forEach(function (r) {
            tb += '<tr><td>' + escAttr(r.category || '') + '</td><td>' + (r.share_pct != null ? r.share_pct.toFixed(2) : '0') + '</td><td>' + (r.sum_amount != null ? Number(r.sum_amount).toLocaleString('ru-RU', {minimumFractionDigits:2}) : '0') + '</td><td>' + (r.quantity || 0) + '</td></tr>';
          });
          tb += '<tr style="font-weight:600;background:#f8fafc"><td>Итог</td><td>100</td><td>' + totalSum.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td><td>' + totalQty + '</td></tr>';
          tb += '</tbody></table></div>';
          document.getElementById('rd_table').innerHTML = byCat.length ? tb : '<p>Нет данных по категориям.</p>';
        }
        function load() {
          var df = dateToApiFormat((document.getElementById('rd_date_from') && document.getElementById('rd_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('rd_date_to') && document.getElementById('rd_date_to').value) || '');
          var status = document.getElementById('rd_status') && document.getElementById('rd_status').value;
          var cat = document.getElementById('rd_category') && document.getElementById('rd_category').value;
          var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt)); if (status) params.push('status_codes=' + encodeURIComponent(status)); if (cat) params.push('product_category=' + encodeURIComponent(cat));
          var url = '/api/v1/reports/dashboard'; if (params.length) url += '?' + params.join('&');
          api(url).then(render).catch(function (e) { render({ error: (e && e.data && e.data.detail) ? String(e.data.detail) : 'Ошибка загрузки' }); });
        }
        document.getElementById('rd_load').onclick = load;
        setTimeout(load, 100);
        document.getElementById('rd_excel').onclick = function () {
          var df = dateToApiFormat((document.getElementById('rd_date_from') && document.getElementById('rd_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('rd_date_to') && document.getElementById('rd_date_to').value) || '');
          var status = document.getElementById('rd_status') && document.getElementById('rd_status').value;
          var cat = document.getElementById('rd_category') && document.getElementById('rd_category').value;
          var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt)); if (status) params.push('status_codes=' + encodeURIComponent(status)); if (cat) params.push('product_category=' + encodeURIComponent(cat));
          var url = '/api/v1/reports/dashboard/export'; if (params.length) url += '?' + params.join('&');
          fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) { if (!r.ok) throw new Error(); return r.blob(); }).then(function (blob) { var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dashboard_categories.xlsx'; a.click(); URL.revokeObjectURL(a.href); }).catch(function () { alert('Ошибка выгрузки'); });
        };
        var rdExcelTerr = document.getElementById('rd_excel_territory');
        if (rdExcelTerr) rdExcelTerr.onclick = function () {
          var df = dateToApiFormat((document.getElementById('rd_date_from') && document.getElementById('rd_date_from').value) || '');
          var dt = dateToApiFormat((document.getElementById('rd_date_to') && document.getElementById('rd_date_to').value) || '');
          var status = document.getElementById('rd_status') && document.getElementById('rd_status').value;
          var cat = document.getElementById('rd_category') && document.getElementById('rd_category').value;
          var params = []; if (df) params.push('date_from=' + encodeURIComponent(df)); if (dt) params.push('date_to=' + encodeURIComponent(dt)); if (status) params.push('status_codes=' + encodeURIComponent(status)); if (cat) params.push('product_category=' + encodeURIComponent(cat));
          var url = '/api/v1/reports/dashboard/export'; if (params.length) url += '?' + params.join('&');
          fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) { if (!r.ok) throw new Error(); return r.blob(); }).then(function (blob) { var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dashboard_territories.xlsx'; a.click(); URL.revokeObjectURL(a.href); }).catch(function () { alert('Ошибка выгрузки'); });
        };
      }

      function loadSectionReportPhotos() {
        var content = document.getElementById('content');
        content.innerHTML = '<div class="card"><h2>Отчёт: Фотографии клиентов</h2><p><button type="button" class="btn btn-primary" id="rp_load">Показать</button> <button type="button" class="btn btn-secondary" id="rp_export">Экспорт в Excel</button></p><div id="rp_stats"></div><div id="rp_table_wrap"></div></div>';
        var rpSortCol = null, rpSortDir = 1;
        function run() {
          document.getElementById('rp_stats').innerHTML = '<p>Загрузка...</p>';
          document.getElementById('rp_table_wrap').innerHTML = '';
          api('/api/v1/reports/photos').then(function (res) {
            var stats = (res && res.statistics) ? res.statistics : {};
            document.getElementById('rp_stats').innerHTML = '<p><strong>Всего фото:</strong> ' + (stats.total_photos || 0) + ', Клиентов с фото: ' + (stats.customers_with_photos || 0) + ', Без фото: ' + (stats.customers_without_photos || 0) + '</p>';
            var without = (res && res.customers_without_photos) ? res.customers_without_photos : [];
            var recent = (res && res.recent_uploads) ? res.recent_uploads : [];
            var sortData = function (data, col, dir) {
              if (!col) return data;
              return data.slice().sort(function (a, b) {
                var av = (a[col] || '').toString().toLowerCase();
                var bv = (b[col] || '').toString().toLowerCase();
                return av === bv ? 0 : (av < bv ? -1 : 1) * dir;
              });
            };
            var buildTable = function (data, fields, headers, includeDate) {
              var tb = '<div style="overflow-x:auto;margin-top:16px"><table><thead><tr>';
              for (var i = 0; i < headers.length; i++) {
                var hdr = headers[i];
                var col = fields[i];
                tb += '<th' + (col ? ' data-col="' + col + '" style="cursor:pointer"' : '') + '>' + hdr + (col && rpSortCol === col ? (rpSortDir === 1 ? ' ▲' : ' ▼') : '') + '</th>';
              }
              tb += '</tr></thead><tbody>';
              data.forEach(function (row) {
                tb += '<tr>';
                for (var i = 0; i < fields.length; i++) {
                  var val = row[fields[i]];
                  if (includeDate && fields[i] === 'uploaded_at' && val) val = val.replace('T', ' ').substring(0, 19);
                  tb += '<td>' + escAttr(val || '') + '</td>';
                }
                tb += '</tr>';
              });
              tb += '</tbody></table></div>';
              return tb;
            };
            var recentSorted = sortData(recent, rpSortCol, rpSortDir);
            var tb = buildTable(recentSorted, ['customer_name', 'address', 'city', 'territory', 'phone', 'contact_person', 'tax_id', 'uploaded_at', 'uploaded_by'], ['Клиент', 'Адрес', 'Город', 'Территория', 'Телефон', 'Контактное лицо', 'ИНН', 'Дата загрузки', 'Загружено'], true);
            var withoutSorted = sortData(without, rpSortCol, rpSortDir);
            var tb2 = buildTable(withoutSorted, ['customer_name', 'address', 'city', 'territory', 'phone', 'contact_person', 'tax_id'], ['Клиент', 'Адрес', 'Город', 'Территория', 'Телефон', 'Контактное лицо', 'ИНН'], false);
            var html = '';
            if (without.length) {
              html += '<h3 style="margin:16px 0 8px 0">Клиенты без фото</h3>' + tb2;
            }
            html += '<h3 style="margin:16px 0 8px 0">Последние загрузки</h3>' + (recent.length ? tb : '<p>Нет недавних загрузок.</p>');
            document.getElementById('rp_table_wrap').innerHTML = html;
            var ths = document.querySelectorAll('#rp_table_wrap th[data-col]');
            ths.forEach(function (th) {
              th.onclick = function () {
                var col = th.getAttribute('data-col');
                if (rpSortCol === col) rpSortDir = -rpSortDir;
                else { rpSortCol = col; rpSortDir = 1; }
                run();
              };
            });
          }).catch(function (e) {
            document.getElementById('rp_stats').innerHTML = '<p class="err">Ошибка загрузки</p>';
          });
        }
        document.getElementById('rp_load').onclick = run;
        run();
        var rpExport = document.getElementById('rp_export');
        if (rpExport) {
          rpExport.onclick = function () {
            fetch('/api/v1/reports/photos/export', { method: 'GET', headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('sds_token') || '') } }).then(function (r) {
              if (!r.ok) throw new Error('Ошибка выгрузки');
              return r.blob();
            }).then(function (blob) {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'report_photos.xlsx';
              a.click();
              URL.revokeObjectURL(a.href);
            }).catch(function () { alert('Ошибка выгрузки отчёта.'); });
          };
        }
      }

      // ========================================
      // СПРАВОЧНИК: Города
      // ========================================
      function loadSectionCities() {
        api('/api/v1/dictionary/cities').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="cityAdd">Добавить город</button>' : '';
          var html = '<div class="card"><h2>Справочник: Города</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="citiesTable"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('citiesTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindCityAdd(); return; }
          var t = '<table><thead><tr><th>ID</th><th>Название</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (city) {
            t += '<tr><td>' + city.id + '</td><td>' + escAttr(city.name || '') + '</td><td>';
            if (isAdmin()) {
              t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-id="' + city.id + '" data-name="' + escAttr(city.name || '') + '">Изменить</button> ';
              t += '<button type="button" class="btn btn-secondary btn-small" data-del data-id="' + city.id + '" data-name="' + escAttr(city.name || '') + '">Удалить</button>';
            }
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindCityAdd();
          tableDiv.querySelectorAll('[data-edit]').forEach(function (btn) {
            btn.onclick = function () {
              var cityId = btn.getAttribute('data-id');
              var cityName = btn.getAttribute('data-name');
              showModal('Изменить город', '<div class="form-group"><label>Название города</label><input type="text" id="cityName" value="' + cityName.replace(/&quot;/g, '"') + '"></div>', function () {
                var name = document.getElementById('cityName').value.trim();
                if (!name) { alert('Введите название'); return Promise.reject(); }
                return api('/api/v1/dictionary/cities/' + cityId, { method: 'PUT', body: JSON.stringify({ name: name }) }).then(function () { loadSectionCities(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-del]').forEach(function (btn) {
            btn.onclick = function () {
              var cityName = btn.getAttribute('data-name');
              if (!confirm('Удалить город «' + cityName + '»?')) return;
              api('/api/v1/dictionary/cities/' + btn.getAttribute('data-id'), { method: 'DELETE' }).then(function () { loadSectionCities(); }).catch(function (e) {
                alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка удаления');
              });
            };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки городов.</p></div>'; });
        function bindCityAdd() {
          var btn = document.getElementById('cityAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить город', '<div class="form-group"><label>Название города</label><input type="text" id="cityName" placeholder="Например: Ташкент"></div>', function () {
              var name = document.getElementById('cityName').value.trim();
              if (!name) { alert('Введите название'); return Promise.reject(); }
              return api('/api/v1/dictionary/cities', { method: 'POST', body: JSON.stringify({ name: name }) }).then(function () { loadSectionCities(); });
            });
          };
        }
      }

      // ========================================
      // СПРАВОЧНИК: Территории
      // ========================================
      function loadSectionTerritories() {
        api('/api/v1/dictionary/territories').then(function (list) {
          var content = document.getElementById('content');
          if (!content) return;
          var addBtn = isAdmin() ? '<button type="button" class="btn btn-primary" id="territoryAdd">Добавить территорию</button>' : '';
          var html = '<div class="card"><h2>Справочник: Территории</h2><p style="margin:0 0 12px 0">' + addBtn + '</p><div id="territoriesTable"></div></div>';
          content.innerHTML = html;
          var tableDiv = document.getElementById('territoriesTable');
          if (!Array.isArray(list) || !list.length) { tableDiv.innerHTML = '<p>Нет данных.</p>'; bindTerritoryAdd(); return; }
          var t = '<table><thead><tr><th>ID</th><th>Название</th><th>Действия</th></tr></thead><tbody>';
          list.forEach(function (territory) {
            t += '<tr><td>' + territory.id + '</td><td>' + escAttr(territory.name || '') + '</td><td>';
            if (isAdmin()) {
              t += '<button type="button" class="btn btn-secondary btn-small" data-edit data-id="' + territory.id + '" data-name="' + escAttr(territory.name || '') + '">Изменить</button> ';
              t += '<button type="button" class="btn btn-secondary btn-small" data-del data-id="' + territory.id + '" data-name="' + escAttr(territory.name || '') + '">Удалить</button>';
            }
            t += '</td></tr>';
          });
          t += '</tbody></table>';
          tableDiv.innerHTML = t;
          bindTerritoryAdd();
          tableDiv.querySelectorAll('[data-edit]').forEach(function (btn) {
            btn.onclick = function () {
              var territoryId = btn.getAttribute('data-id');
              var territoryName = btn.getAttribute('data-name');
              showModal('Изменить территорию', '<div class="form-group"><label>Название территории</label><input type="text" id="territoryName" value="' + territoryName.replace(/&quot;/g, '"') + '"></div>', function () {
                var name = document.getElementById('territoryName').value.trim();
                if (!name) { alert('Введите название'); return Promise.reject(); }
                return api('/api/v1/dictionary/territories/' + territoryId, { method: 'PUT', body: JSON.stringify({ name: name }) }).then(function () { loadSectionTerritories(); });
              });
            };
          });
          tableDiv.querySelectorAll('[data-del]').forEach(function (btn) {
            btn.onclick = function () {
              var territoryName = btn.getAttribute('data-name');
              if (!confirm('Удалить территорию «' + territoryName + '»?')) return;
              api('/api/v1/dictionary/territories/' + btn.getAttribute('data-id'), { method: 'DELETE' }).then(function () { loadSectionTerritories(); }).catch(function (e) {
                alert((e.data && e.data.detail) ? (typeof e.data.detail === 'string' ? e.data.detail : JSON.stringify(e.data.detail)) : 'Ошибка удаления');
              });
            };
          });
        }).catch(function () { document.getElementById('content').innerHTML = '<div class="card"><p class="err">Ошибка загрузки территорий.</p></div>'; });
        function bindTerritoryAdd() {
          var btn = document.getElementById('territoryAdd');
          if (!btn || !isAdmin()) return;
          btn.onclick = function () {
            showModal('Добавить территорию', '<div class="form-group"><label>Название территории</label><input type="text" id="territoryName" placeholder="Например: Центр"></div>', function () {
              var name = document.getElementById('territoryName').value.trim();
              if (!name) { alert('Введите название'); return Promise.reject(); }
              return api('/api/v1/dictionary/territories', { method: 'POST', body: JSON.stringify({ name: name }) }).then(function () { loadSectionTerritories(); });
            });
          };
        }
      }

      document.getElementById('btnLogout').onclick = function () { localStorage.removeItem('sds_token'); window.location.href = '/login'; };
      var btnAbout = document.getElementById('btnAbout');
      if (btnAbout) {
        btnAbout.onclick = function () {
          var bodyHtml = '' +
            '<p><strong>Система управления продажами и дистрибуцией</strong></p>' +
            '<p style="margin-top:8px;margin-bottom:4px">Разработано:</p>' +
            '<p style="margin:0 0 12px 0">Захаренков Дмитрий</p>' +
            '<p style="margin:0 0 4px 0"><strong>Контакты разработчика:</strong></p>' +
            '<p style="margin:0 0 4px 0">📧 Email: <a href="mailto:dima@zakharenkov.ru">dima@zakharenkov.ru</a></p>' +
            '<p style="margin:0 0 4px 0">🌐 Сайт: <a href="https://zakharenkov.ru" target="_blank" rel="noopener">zakharenkov.ru</a></p>' +
            '<p style="margin:0 0 4px 0">💼 LinkedIn: <a href="https://www.linkedin.com/in/dmity-zakharenkov/" target="_blank" rel="noopener">linkedin.com/in/dmity-zakharenkov</a></p>' +
            '<p style="margin:0 0 0 0">📱 Telegram: <a href="https://t.me/dmitry_zakharenkov" target="_blank" rel="noopener">@dmitry_zakharenkov</a></p>';
          showModal('О системе', bodyHtml, function () { return Promise.resolve(); }, { closeOnly: true });
        };
      }
      var sidebarEl = document.querySelector('.sidebar');
      if (sidebarEl) {
        sidebarEl.addEventListener('click', function (e) {
          var a = e.target && e.target.closest ? e.target.closest('a') : null;
          if (!a || !a.getAttribute('data-section')) return;
          e.preventDefault();
          var s = a.getAttribute('data-section');
          if (s === 'ref_parent' || s === 'customers_parent' || s === 'visits_parent' || s === 'orders_parent' || s === 'ops_parent' || s === 'cash_parent' || s === 'reports_parent') {
            var sub = document.getElementById(a.id === 'refParent' ? 'refSubmenu' : a.id === 'customersParent' ? 'customersSubmenu' : a.id === 'visitsParent' ? 'visitsSubmenu' : a.id === 'ordersParent' ? 'ordersSubmenu' : a.id === 'opsParent' ? 'opsSubmenu' : a.id === 'cashParent' ? 'cashSubmenu' : a.id === 'reportsParent' ? 'reportsSubmenu' : null);
            if (sub) sub.classList.toggle('open');
            a.classList.toggle('open');
          } else {
            showSection(s);
          }
        });
      }

      document.getElementById('userName').textContent = 'Загрузка...';
      loadMe().then(function () { return loadMenu(); }).then(function () {
        var first = (menuItems && menuItems[0]) ? (SIDEBAR_SECTIONS[menuItems[0].code] || 'users') : 'users';
        showSection(first);
      }).catch(function () { document.getElementById('userName').textContent = 'Ошибка'; loadMenu().then(function () { showSection(menuItems[0] ? SIDEBAR_SECTIONS[menuItems[0].code] : 'users'); }); });
    })();
  </script>
</body>
</html>
